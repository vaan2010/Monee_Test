<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a84ff">
    <title>Monee</title>
    
    <!-- Firebase SDK -->
    
    <!-- Favicon -->
    <!-- 使用絕對路徑，確保在 GitHub Pages 上能正確載入 -->
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon.png">
    <link rel="shortcut icon" type="image/png" href="./favicon.png">
    <meta name="msapplication-TileImage" content="./favicon.png">
    
    <!-- 備選方案：如果本地文件載入失敗，使用外部 URL -->
    <script>
        (function() {
            // 等待 DOM 載入完成
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initFavicon);
            } else {
                initFavicon();
            }
            
            function initFavicon() {
                const externalUrl = 'https://meee.com.tw/QZEW2Ba';
                const faviconPath = './favico.png';
                
                // 檢查本地 favicon 是否存在
                const testImg = new Image();
                testImg.onerror = function() {
                    // 本地文件不存在或載入失敗，使用外部 URL
                    updateFaviconLinks(externalUrl);
                    updateLogoImages(externalUrl);
                };
                testImg.onload = function() {
                    // 本地文件存在，確保使用本地路徑
                    updateFaviconLinks(faviconPath);
                    updateLogoImages(faviconPath);
                };
                // 添加時間戳避免快取問題
                testImg.src = faviconPath + '?t=' + Date.now();
            }
            
            function updateLogoImages(url) {
                // 更新載入遮罩中的圖片
                const loadingImage = document.querySelector('.loading-image');
                if(loadingImage) {
                    loadingImage.src = url;
                }
                
                // 更新標題中的圖片
                const titleLogos = document.querySelectorAll('.title-logo');
                titleLogos.forEach(logo => {
                    logo.src = url;
                });
            }
            
            function updateFaviconLinks(url) {
                const faviconLinks = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"], link[rel="shortcut icon"]');
                faviconLinks.forEach(link => {
                    if (link.href.includes('favicon.png') || link.href === url) {
                        link.href = url;
                    }
                });
                const tileMeta = document.querySelector('meta[name="msapplication-TileImage"]');
                if (tileMeta) {
                    tileMeta.content = url;
                }
            }
        })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000; --card-bg: #1c1c1e; --text-primary: #ffffff; --text-secondary: #8e8e93; --text-third: #57575e;
            --color-bank: #64d2ff; --color-stock: #bf5af2; --color-twstock: #0a84ff; --color-crypto: #ff9f0a; --color-debt: #ff453a;
            --color-up: #30d158; --color-down: #ff453a; --border-color: #2c2c2e; --active-bg: #3a3a3c;
        }
        :root[data-theme="light"] {
            --bg-color: #ffffff; --card-bg: #f5f5f7; --text-primary: #000000; --text-secondary: #999999; --text-third: #c7c7cc;
            --color-bank: #007aff; --color-stock: #af52de; --color-twstock: #007aff; --color-crypto: #ff9500; --color-debt: #ff3b30;
            --color-up: #34c759; --color-down: #ff3b30; --border-color: #d1d1d6; --active-bg: #e5e5ea;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; overflow-x: hidden; }
        body::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; }
        body { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        *::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        *::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        *::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        *::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; -ms-overflow-style: none; -webkit-overflow-scrolling: touch; width: 100%; padding-top: 150px; padding-bottom: 0; }
        .main-content::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        .main-content::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        .main-content::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        
        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: var(--card-bg); z-index: 999; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 2px 0 15px rgba(0,0,0,0.5); padding-top: max(20px, env(safe-area-inset-top)); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar.active { left: 0; }
        @media (min-width: 768px) {
            .sidebar-overlay { display: block !important; }
            .sidebar { position: fixed; left: -280px; z-index: 999; }
            .sidebar.active { left: 0; }
            .sidebar:not(.collapsed):not(.active) { left: 0; }
            .sidebar.collapsed { left: -280px; }
        }
        
        .content-grid { display: flex; flex-direction: column; width: 100%; max-width: 100%; overflow-x: hidden; min-height: 0; }
        .chart-section { display: flex; flex-direction: column; flex-shrink: 0; width: 100%; max-width: 100%; min-width: 0; }
        .list-section { flex: 0 1 auto; overflow-y: visible; min-height: 0; position: relative; width: 100%; max-width: 100%; min-width: 0; }
        /* 手機版：確保 page-item 內容緊貼，避免多餘空白 */
        @media (max-width: 767px) {
            .page-item { 
                display: flex; 
                flex-direction: column; 
                padding-bottom: 60px; /* 為底部 tab-bar 留空間，替代 mobile-spacer */
            }
            .page-item .mobile-spacer {
                display: none; /* 隱藏 mobile-spacer，使用 padding-bottom 代替 */
            }
        }
        .list-section::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        .list-section::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        .list-section::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        .page-nav-arrow { display: none; }
        
        @media (min-width: 768px) {
            .list-section { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
            .list-container { position: relative; margin: 0 60px 10px 60px !important; }
            .page-nav-arrow { 
                display: flex; 
                position: absolute; 
                top: 50%; 
                transform: translateY(-50%); 
                z-index: 100; 
                width: 50px; 
                height: 50px; 
                border-radius: 50%; 
                background: transparent; 
                border: none; 
                color: rgba(255, 255, 255, 0.5); 
                font-size: 28px; 
                cursor: pointer; 
                align-items: center; 
                justify-content: center; 
                transition: all 0.3s; 
            }
            .page-nav-arrow:hover { 
                color: rgba(255, 255, 255, 0.9); 
                background: rgba(255, 255, 255, 0.05); 
                transform: translateY(-50%) scale(1.1); 
            }
            .page-nav-arrow:active { 
                transform: translateY(-50%) scale(0.95); 
            }
            .page-nav-arrow.disabled { 
                opacity: 0.15; 
                cursor: not-allowed; 
                pointer-events: none; 
            }
            .page-nav-arrow.prev { left: 5px; }
            .page-nav-arrow.next { right: 5px; }
            .hamburger-btn { display: none !important; }
            .sidebar-toggle-btn-desktop { display: block !important; }
            .sidebar.collapsed .sidebar-header, .sidebar.collapsed .sidebar-menu { opacity: 0; pointer-events: none; }
            .main-content { display: grid; grid-template-rows: auto 1fr; overflow: hidden; width: 100%; padding-top: 150px; }
            .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; overflow-y: auto; height: 100%; scrollbar-width: none; -ms-overflow-style: none; align-items: start; }
            .content-grid::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
            .content-grid::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
            .content-grid::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
            .chart-section { height: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
            .summary-card { text-align: center !important; padding: 0 !important; margin-bottom: 20px; width: 100%; }
            .list-section { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; }
            .list-section .page-container { width: 100%; }
            .list-section .group-header { text-align: left; }
            .list-section .page-container > div:first-child.group-header { margin-top: 0; }
            body { padding-bottom: 0; }
            .tab-bar { position: fixed; bottom: 0; width: 100%; left: 0; background: var(--card-bg); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 40px; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); z-index: 200; }
            .tab-bar .tab-item { width: auto; padding: 0 30px; font-size: 14px; }
            .tab-bar .tab-item i { font-size: 18px; }
            .modal { align-items: center; justify-content: center; display: flex; }
            .modal-content-wrapper { width: 500px !important; height: 80% !important; max-height: 700px; border-radius: 16px; border: 1px solid var(--border-color); position: relative !important; overflow: hidden; display: flex; flex-direction: column; }
            #chartWrapper { max-width: 100%; overflow: hidden; padding: 0 10px; flex: 0 0 auto; min-height: 320px; width: 100%; }
            #assetChart { max-width: 100% !important; width: 100% !important; height: 100% !important; min-width: 0; min-height: 0; }
            #chartWrapper .highcharts-container { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
            #chartWrapper .highcharts-root { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
            #chartWrapper svg { max-width: 100% !important; height: auto !important; }
        }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--bg-color); position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 60px; width: 100%; }
        .navbar h1 { font-size: 20px; margin: 0; font-weight: 700; position: absolute; left: calc(50% - 15px); transform: translateX(-50%); white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .navbar h1 .title-logo { width: 40px; height: 40px; object-fit: contain; }
        .btn-group { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; color: #0a84ff; font-size: 20px; cursor: pointer; padding: 5px; }
        .btn-icon.active { color: var(--color-up); }

        .sidebar-toggle-btn-desktop { display: none; }
        .sidebar-toggle-btn-navbar { display: none; }
        @media (min-width: 768px) {
            .sidebar-toggle-btn-desktop { display: block !important; position: fixed; top: 15px; left: 20px; z-index: 1001; }
            .sidebar.collapsed .sidebar-toggle-btn-desktop { display: none !important; }
            .sidebar-toggle-btn-navbar { display: none !important; }
            .sidebar.collapsed ~ .main-content .sidebar-toggle-btn-navbar { display: block !important; position: absolute; top: 50%; transform: translateY(-50%); left: 20px; z-index: 1001; }
            .navbar .btn-group { margin-left: 50px; }
        }
        .sidebar-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s; display: flex; align-items: center; justify-content: space-between; }
        .sidebar-header h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-primary); flex: 1; }
        .user-avatar-container { position: relative; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid #0a84ff; object-fit: cover; transition: all 0.2s; display: flex; align-items: center; justify-content: center; background: var(--border-color); font-size: 24px; }
        .user-avatar-container:hover .user-avatar { transform: scale(1.1); border-color: #64d2ff; }
        .user-avatar-container:active .user-avatar { transform: scale(0.95); }
        .sidebar-menu { padding: 10px 0; flex: 1; overflow-y: auto; transition: opacity 0.3s; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; font-size: 17px; color: var(--text-primary); cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: var(--border-color); }
        .menu-item i { margin-right: 15px; width: 24px; text-align: center; color: #0a84ff; font-size: 20px; }
        .menu-text { flex: 1; }
        .menu-label { 
            padding: 15px 25px 5px; 
            font-size: 17px; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            margin-top: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
            user-select: none;
        }
        .menu-label:hover { color: var(--text-primary); }
        .menu-label .collapse-icon { 
            font-size: 12px; 
            transition: transform 0.3s; 
            margin-left: 10px;
        }
        .menu-label.collapsed .collapse-icon { transform: rotate(-90deg); }
        .menu-section { overflow: hidden; transition: max-height 0.3s ease-out; }
        .menu-section.collapsed { max-height: 0; }
        .menu-section:not(.collapsed) { max-height: 1000px; }
        .page-visibility-item { padding: 12px 25px; display: flex; align-items: center; font-size: 16px; color: var(--text-primary); }
        .page-visibility-item label { display: flex; align-items: center; cursor: pointer; width: 100%; flex: 1; }
        .page-visibility-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; accent-color: #0a84ff; }
        .page-visibility-item span { flex: 1; }
        .page-visibility-item .drag-handle { 
            color: #666; 
            font-size: 18px; 
            margin-right: 10px; 
            cursor: grab; 
            display: block !important;
            user-select: none;
            -webkit-user-select: none;
        }
        .page-visibility-item .drag-handle:active { cursor: grabbing; }
        .page-visibility-item.sortable-chosen { opacity: 0.5; background: rgba(255, 255, 255, 0.05); }
        .page-visibility-item.sortable-ghost { opacity: 0.3; }

        /* chart-section 樣式在 content-grid 中定義 */
        .summary-card { padding: 5px 20px 0 20px; text-align: center; position: relative; z-index: 90; flex-shrink: 0; min-height: 0; }
        .total-label-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .total-label { color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .total-amount-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .total-amount { font-size: 40px; font-weight: 700; margin: 5px 0 3px 0; font-family: 'Roboto', sans-serif; position: relative; display: inline-block; }
        .eye-toggle-btn { 
            background: none; 
            border: none; 
            color: #0a84ff; 
            font-size: 16px; 
            cursor: pointer; 
            padding: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            outline: none;
        }
        .eye-toggle-btn:hover { opacity: 0.8; }
        .eye-toggle-btn:active {
            transform: none;
            opacity: 0.9;
        }
        
        /* 隱藏數字樣式 */
        .numbers-hidden .numbers-content {
            visibility: hidden;
            position: relative;
        }
        .numbers-hidden .numbers-content::after {
            content: '****';
            visibility: visible;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: inherit;
            font-weight: inherit;
            border-radius: inherit;
        }
        /* 只有原本有背景的元素才顯示背景 */
        .numbers-hidden .rate-badge::after,
        .numbers-hidden .pnl-badge::after {
            background-color: var(--card-bg);
        }
        .numbers-hidden .total-amount::after { font-size: 40px; }
        .numbers-hidden .pnl-badge::after { font-size: 14px; }
        .numbers-hidden .rate-badge::after { font-size: 12px; }
        .numbers-hidden .group-total::after { font-size: inherit; }
        .numbers-hidden .group-pnl::after { font-size: 11px; }
        
        /* 列表項目單獨隱藏 */
        .item-hidden .item-numbers {
            font-size: 0 !important;
            line-height: 0;
            color: transparent;
            position: relative;
            display: inline-block;
            width: auto;
            min-width: 0;
            padding: 0;
            margin: 0;
        }
        .item-hidden .item-numbers::after {
            content: '****';
            font-size: inherit;
            line-height: inherit;
            color: var(--text-secondary);
            position: static;
            display: inline-block;
            visibility: visible;
            white-space: nowrap;
            font-weight: inherit;
            vertical-align: baseline;
        }
        .item-hidden .amount-val.item-numbers { 
            font-size: 0 !important;
            display: inline-block;
            width: auto;
        }
        .item-hidden .amount-val.item-numbers::after { 
            font-size: 17px !important; 
            line-height: 1.3;
            position: static;
            display: inline-block;
        }
        .item-hidden .amount-pnl.item-numbers { 
            font-size: 0 !important;
            display: inline-block;
            width: auto;
        }
        .item-hidden .amount-pnl.item-numbers::after { 
            font-size: 11px !important; 
            line-height: 1.3;
            position: static;
            display: inline-block;
        }
        /* 當數字隱藏時，確保按鈕對齊正確 */
        .item-hidden .amount-val-wrapper {
            align-items: center;
        }
        .item-eye-btn {
            background: none;
            border: none;
            color: #0a84ff;
            font-size: clamp(10px, 1.5vw, 14px);
            cursor: pointer;
            padding: clamp(2px, 0.3vw, 4px);
            margin-left: clamp(1px, 0.3vw, 4px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
            width: clamp(20px, 2.8vw, 28px);
            height: clamp(20px, 2.8vw, 28px);
            min-width: clamp(20px, 2.8vw, 28px);
            min-height: clamp(20px, 2.8vw, 28px);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            outline: none;
            box-sizing: border-box;
        }
        .item-eye-btn i {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .item-eye-btn:hover {
            opacity: 1;
        }
        .item-eye-btn:active {
            transform: none;
            opacity: 0.9;
            position: relative;
        }
        .item-amount-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 4px;
        }
        .pnl-badge { font-size: 14px; font-weight: 600; margin-bottom: 5px; display: inline-block; padding: 4px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        .pnl-up { color: var(--color-up); } .pnl-down { color: var(--color-down); }
        .rate-info { display: flex; justify-content: center; gap: 10px; margin-top: 3px; margin-bottom: 5px; }
        .rate-badge { display: inline-flex; align-items: center; font-size: 12px; color: var(--text-secondary); background: var(--card-bg); padding: 4px 10px; border-radius: 12px; }
        .rate-badge i { font-size: 10px; margin-right: 5px; color: #ffcc00; }

        #chartWrapper { flex: 0 0 auto; background: transparent; position: relative; min-height: 280px; max-height: 40vh; width: 100%; max-width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; z-index: 80; box-sizing: border-box; padding: 0 10px; margin: auto 0; }
        #assetChart { max-width: 100% !important; box-sizing: border-box !important; width: 100% !important; height: 100% !important; min-width: 0; min-height: 0; }
        #chartWrapper .highcharts-container { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
        #chartWrapper .highcharts-root { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
        #chartWrapper svg { max-width: 100% !important; height: auto !important; }
        #chartWrapper .highcharts-point { transition: none !important; pointer-events: auto !important; }
        #chartWrapper .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper .highcharts-series .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper svg .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper .highcharts-point * { pointer-events: none !important; }
        #chartWrapper .highcharts-data-label { opacity: 1 !important; transition: none !important; }
        #chartWrapper .highcharts-point:hover ~ .highcharts-data-label,
        #chartWrapper .highcharts-point:hover + .highcharts-data-label,
        #chartWrapper .highcharts-point:hover .highcharts-data-label { opacity: 1 !important; }
        #chartWrapper .highcharts-data-label text { fill: #fff !important; opacity: 1 !important; }
        #chartWrapper .highcharts-point:hover ~ .highcharts-data-label text,
        #chartWrapper .highcharts-point:hover + .highcharts-data-label text,
        #chartWrapper .highcharts-point:hover .highcharts-data-label text { fill: #fff !important; opacity: 1 !important; }
        
        #customTooltip { position: absolute; background: var(--card-bg); color: var(--text-primary); padding: 10px 14px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); pointer-events: none; z-index: 200; display: none; white-space: nowrap; top: 0; left: 0; transform: translate(-50%, -100%); transition: opacity 0.15s, top 0.15s, left 0.15s; margin-top: -15px; border: 1px solid var(--border-color); }
        #customTooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: var(--card-bg) transparent transparent transparent; }
        #customTooltip.bottom { transform: translate(-50%, 0); margin-top: 20px; }
        #customTooltip.bottom::after { top: -12px; border-color: transparent transparent var(--card-bg) transparent; }
        .tt-header { font-size: 11px; color: var(--text-secondary); margin-bottom: 2px; font-weight: 500; }
        .tt-body { font-size: 15px; color: var(--text-primary); font-weight: 700; display: flex; align-items: center; }
        .tt-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .chart-back-btn { position: absolute; top: 10px; left: 20px; z-index: 201; background: rgba(44, 44, 46, 0.9); color: #0a84ff; border: 1px solid #333; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: none; backdrop-filter: blur(10px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .group-header { padding: 15px 20px 8px 20px; font-size: 13px; color: var(--text-secondary); background-color: var(--bg-color); display: flex; justify-content: space-between; text-transform: uppercase; }
        .group-total { color: var(--text-primary); font-weight: 600; display: block;} .group-pnl { font-size: 11px; display: block; margin-top: 2px; text-align: right;}
        .list-container { background-color: var(--card-bg); border-radius: 12px; margin: 0 16px 10px 16px; overflow: hidden; }
        .list-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: var(--card-bg); min-width: 0; position: relative; }
        /* 總覽頁面：讓標題和金額對齊 */
        #group-overview .list-item { align-items: center; }
        .list-item:last-child { border-bottom: none; } .list-item:active { background-color: var(--active-bg); }
        .list-item:has(.item-name-row) { padding-top: 40px; }
        /* 負債項目不可拖動 */
        #group-debt .list-item { cursor: pointer !important; }
        #group-debt .list-item.sortable-chosen { cursor: pointer !important; }
        .list-item:has(.item-name-row) .item-icon { align-self: flex-start; margin-top: 0; }
        .item-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; flex-shrink: 0; align-self: flex-start; margin-top: 0; overflow: hidden; }
        .item-icon img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .icon-bank { color: var(--color-bank); background: rgba(100, 210, 255, 0.15); } .icon-crypto { color: var(--color-crypto); background: rgba(255, 159, 10, 0.15); } .icon-stock { color: var(--color-stock); background: rgba(191, 90, 242, 0.15); } .icon-twstock { color: var(--color-twstock); background: rgba(10, 132, 255, 0.15); } .icon-debt { color: var(--color-debt); background: rgba(255, 69, 58, 0.15); }
        .item-content { flex: 1 1 0%; min-width: 0; display: flex; flex-direction: column; justify-content: flex-start; }
        .item-name-row { display: flex; align-items: center; margin-bottom: 0; position: absolute; left: 0; right: 0; padding-left: 67px; padding-right: 50px; top: 12px; z-index: 1; }
        .item-name-row .item-name { font-size: 19px; font-weight: 500; line-height: 1.3; flex: 1; }
        .item-name-row .item-eye-wrapper { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); z-index: 3; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .item-name-row .item-eye-btn { margin: 0; }
        .item-name-row .item-balance-below-eye { font-size: 12px; color: var(--text-secondary); opacity: 0.7; white-space: nowrap; }
        .item-symbol-row { font-size: 13px; color: var(--text-secondary); opacity: 0.7; margin-top: 0; margin-bottom: 0; padding-left: 67px; padding-right: 16px; position: absolute; top: 38px; left: 0; right: 0; z-index: 1; display: flex; flex-direction: column; gap: 0; }
        .item-symbol-row .symbol-text-row { min-height: 18px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .item-symbol-row .symbol-text { font-size: 13px; color: var(--text-secondary); opacity: 0.7; display: inline-block; }
        .item-symbol-row .symbol-balance { font-size: 13px; color: var(--text-secondary); opacity: 0.7; margin-left: auto; }
        .item-symbol-row .symbol-spacer { height: 3px; visibility: hidden; }
        /* 美股：增加 symbol-spacer 的高度，增加垂直間距 */
        #group-stock .item-symbol-row .symbol-spacer { height: 6px; }
        /* 台股：比照美股，增加 symbol-spacer 的高度 */
        #group-twstock .item-symbol-row .symbol-spacer { height: 6px; }
        /* 美股：確保右側空白行與左側 symbol-spacer 對齊 */
        #group-stock .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        /* 台股：比照美股，確保右側空白行與左側 symbol-spacer 對齊 */
        #group-twstock .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        /* 加密貨幣：比照美股，確保右側空白行與左側 symbol-spacer 對齊 */
        #group-crypto .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        .item-symbol-row > div { min-height: 18px; display: flex; align-items: center; }
        .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 20px; }
        /* 美股：增加更多垂直空間，避免內容溢出 */
        #group-stock .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 30px; min-height: 140px; }
        /* 台股：比照美股，增加更多垂直空間，避免內容溢出 */
        #group-twstock .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 30px; min-height: 140px; }
        .list-item:has(.item-name-row) .item-icon { position: absolute; left: 16px; top: 20px; z-index: 2; display: flex; align-items: center; justify-content: center; }
        .item-detail-row { display: flex; flex-direction: column; margin-top: 3px; gap: 0; }
        .item-detail-row > div { min-height: 18px; display: flex; align-items: center; }
        .list-item:has(.item-name-row) .item-amount-name-row { height: 0; margin-bottom: 0; }
        .item-amount-name-row { height: 19px; margin-bottom: 3px; flex-shrink: 0; }
        .item-name { font-size: 19px; font-weight: 500; margin-bottom: 3px; line-height: 1.3; }
        .item-name .symbol-small { font-size: 13px; font-weight: 400; opacity: 0.7; margin-left: 6px; }
        .item-row { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; margin-bottom: 2px; }
        .item-row-compact { font-size: 11px; color: var(--text-secondary); line-height: 1.25; margin-bottom: 2px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; width: 100%; }
        .account-tag { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; margin-top: 4px; margin-right: 6px; line-height: 1.4; }
        .account-tag:last-child { margin-right: 0; }
        /* 分類標籤：不同類型不同顏色 */
        .account-tag-bank { background: #e3f2fd; color: #1565c0; } /* 銀行：淡藍底 */
        .account-tag-credit { background: #fce4ec; color: #c2185b; } /* 信用卡：淡粉底 */
        .account-tag-debit { background: #f3e5f5; color: #7b1fa2; } /* 簽帳金融卡：淡紫底 */
        .account-tag-account { background: #fff9c4; color: #f57f17; } /* 帳戶：淡黃底 */
        .account-tag-debt { background: #ffebee; color: #c62828; } /* 負債：淡紅底 */
        /* 銀行名稱標籤 */
        .account-tag-bank-name { background: #b3e5fc; color: #01579b; } /* 銀行名稱：淡藍底 */
        
        /* 計算機按鈕樣式 */
        .calc-btn {
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .calc-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .calc-btn:hover {
            background: var(--bg-color);
        }
        
        /* 銀行搜尋結果項目 */
        .bank-search-item:hover {
            background: var(--bg-color);
        }
        .item-row-compact .item-label { opacity: 0.7; flex-shrink: 0; }
        .item-row-compact span { white-space: nowrap; min-width: 0; }
        .item-row-compact .price-label { margin-right: 4px; }
        .item-row-compact > span:last-child { margin-left: auto; }
        .price-label { font-size: 11px; color: var(--text-secondary); opacity: 0.7; margin-right: 4px; flex-shrink: 0; }
        .item-amount-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 0; margin-left: 8px; flex-shrink: 0; }
        .item-amount-name-row { height: 19px; margin-bottom: 3px; }
        .item-amount { text-align: right; display: flex; flex-direction: column; justify-content: flex-start; min-width: 0; gap: 0; align-items: flex-end; }
        .item-amount > div { min-height: 18px; display: flex; align-items: center; justify-content: flex-end; width: 100%; }
        .amount-val-wrapper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        /* 總覽和錢包分頁：讓眼睛按鈕對齊到金額中線 */
        #group-overview .amount-val-wrapper, #group-bank .amount-val-wrapper { align-items: center; }
        #group-overview .item-eye-btn, #group-bank .item-eye-btn { 
            align-self: center;
            flex-shrink: 0;
        }
        /* 確保按鈕在所有情況下都保持固定位置 */
        .amount-val-wrapper .item-eye-btn {
            flex-shrink: 0;
            position: relative;
        }
        .amount-val { 
            font-size: 18px; 
            font-weight: 500; 
            font-family: 'Roboto', sans-serif; 
            line-height: 1.3; 
            margin-bottom: 3px; 
            white-space: nowrap; 
            position: relative;
        }
        /* 當數字隱藏時，讓 **** 的寬度與按鈕對齊 */
        .item-hidden .amount-val-wrapper {
            position: relative;
        }
        .item-hidden .amount-val::after {
            position: relative;
            display: inline-block;
        }
        /* 總覽頁面：讓金額和標題對齊 */
        #group-overview .list-item { align-items: baseline; }
        #group-overview .item-content { display: flex; flex-direction: column; justify-content: flex-start; }
        #group-overview .item-amount-wrapper { align-items: flex-start; }
        #group-overview .amount-val-wrapper { align-items: baseline; }
        #group-overview .amount-val { font-size: 19px; line-height: 1.3; margin-bottom: 3px; }
        /* 錢包分頁：讓金額和標題對齊 */
        #group-bank .list-item { align-items: baseline; }
        #group-bank .item-content { display: flex; flex-direction: column; justify-content: flex-start; }
        #group-bank .item-amount-wrapper { align-items: flex-start; }
        #group-bank .amount-val-wrapper { align-items: baseline; }
        #group-bank .amount-val { font-size: 19px; line-height: 1.3; margin-bottom: 3px; }
        .amount-pnl { font-size: 11px; margin-top: 0; margin-bottom: 1px; font-weight: 500; line-height: 1.3; white-space: nowrap; text-align: right; }
        /* 美股：增加行間距 */
        #group-stock .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        /* 台股：比照美股，增加行間距 */
        #group-twstock .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        /* 加密貨幣：比照美股，增加行間距 */
        #group-crypto .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        
        .amount-spacer { font-size: 13px; line-height: 1.35; color: transparent; margin: 0; padding: 0; min-height: 1.35em; display: block; }
        .amount-spacer::before { content: '\00a0'; }
        .amount-spacer { font-size: 13px; line-height: 1.35; visibility: hidden; height: 0; }
        .amount-green { color: var(--color-up); } .amount-red { color: var(--color-down); } .sub-green { color: var(--color-up); } .sub-red { color: var(--color-down); }
        .drag-handle { display: none; color: #666; font-size: 20px; padding-left: 15px; cursor: grab; }
        /* 排序模式下，整個卡片可以拖動 */
        .list-item:has(.drag-handle) { cursor: grab; }
        .list-item:has(.drag-handle):active { cursor: grabbing; }
        /* 負債項目即使有 drag-handle 也不可拖動 */
        #group-debt .list-item:has(.drag-handle) { cursor: pointer !important; }
        #group-debt .list-item:has(.drag-handle):active { cursor: pointer !important; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 200; }
        .tab-item { color: var(--text-secondary); text-align: center; font-size: 10px; background: none; border: none; width: 30%; }
        .tab-item i { font-size: 20px; margin-bottom: 4px; display: block; } .tab-item.active { color: #0a84ff; }
        .fa-spin-fast { animation: fa-spin 1s infinite linear; }
        
        /* Currency Toggle Button */
        .currency-toggle-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            gap: 2px;
        }
        .currency-toggle-btn:hover {
            transform: scale(1.05);
            background: var(--active-bg);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .currency-toggle-btn:active {
            transform: scale(0.95);
        }
        .currency-toggle-btn i {
            font-size: 18px;
            margin: 0;
        }
        .currency-toggle-btn span {
            font-size: 11px;
            line-height: 1;
        }
        @media (max-width: 767px) {
            .currency-toggle-btn {
                bottom: 90px; /* 提高位置，確保在 tab-bar 上方且不被遮蓋 */
                right: 15px;
                width: 56px;
                height: 56px;
                z-index: 10001; /* 確保在最上層 */
            }
        }

        /* Page Swiper */
        .page-swiper { position: relative; width: 100%; overflow: hidden; touch-action: pan-y; }
        @media (max-width: 767px) {
            .list-section.page-swiper { overflow: visible; touch-action: auto; }
        }
        /* 月圖表滾動容器特殊處理 */
        #monthlyChartSwiper {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            max-height: calc(100vh - 300px);
            touch-action: pan-y pan-x !important;
            -webkit-overflow-scrolling: touch;
        }
        @media (max-width: 767px) {
            #monthlyChartSwiper {
                max-height: calc(100vh - 250px);
            }
        }
        .page-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); will-change: transform; }
        .page-container.swiping { transition: none; } /* 滑動過程中禁用過渡，實現實時跟隨 */
        .page-item { min-width: 100%; flex-shrink: 0; }
        .page-indicator { 
            display: flex; 
            justify-content: center;
            align-items: center;
            gap: 6px; 
            padding: 18px 20px 16px 20px; 
            position: fixed; 
            top: 60px; 
            left: 0;
            right: 0;
            z-index: 95; 
            background: linear-gradient(to bottom, var(--bg-color) 0%, var(--bg-color) 90%, transparent 100%);
            backdrop-filter: blur(10px);
            overflow-x: auto;
            overflow-y: hidden;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            scroll-behavior: smooth;
        }
        .page-indicator::before,
        .page-indicator::after {
            content: '';
            flex: 1 1 auto;
            min-width: 0;
            max-width: calc((100% - 300px) / 2);
        }
        @media (max-width: 600px) {
            .page-indicator::before,
            .page-indicator::after {
                display: none;
            }
            .page-indicator {
                justify-content: flex-start;
            }
        }
        .page-indicator::-webkit-scrollbar {
            display: none !important; /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }
        .page-indicator::-webkit-scrollbar-track {
            display: none !important;
            background: transparent !important;
        }
        .page-indicator::-webkit-scrollbar-thumb {
            display: none !important;
            background: transparent !important;
        }
        .page-tab { 
            padding: 14px 22px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            background: rgba(142, 142, 147, 0.1);
            border: none;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            flex-shrink: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .page-tab.active { 
            color: #ffffff;
            background: #0a84ff;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(10, 132, 255, 0.3);
        }
        
        @media (min-width: 480px) {
            .page-tab { 
                padding: 16px 28px;
                font-size: 20px;
            }
            .page-tab.active { 
                font-size: 20px;
            }
        }
        .page-tab:active {
            transform: scale(0.95);
        }
        .page-tab:not(.active):hover {
            background: rgba(142, 142, 147, 0.2);
        }

        /* Calendar */
        .calendar-container { max-width: 600px; margin: 0 auto; background: var(--card-bg); border-radius: 12px; padding: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-nav-btn { background: transparent; border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; padding: 6px; }
        .calendar-nav-btn:hover { color: #0a84ff; }
        .calendar-month-year { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .calendar-dropdown { font-size: 12px; opacity: 0.6; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 6px; }
        .calendar-weekday { text-align: center; font-size: 13px; color: var(--text-secondary); font-weight: 500; padding: 3px 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.2s; color: var(--text-primary); background: transparent; border: none; }
        .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: 0.3s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        .switch input:checked + .slider { background-color: #0a84ff; }
        .switch input:checked + .slider:before { transform: translateX(18px); }
        .calendar-day:hover { background: rgba(142, 142, 147, 0.2); }
        .calendar-day.other-month { color: var(--text-secondary); opacity: 0.4; }
        .calendar-day.today { background: #0a84ff; color: #fff; font-weight: 600; }
        .calendar-day.selected { background: rgba(10, 132, 255, 0.2); color: #0a84ff; font-weight: 600; }
        .calendar-day.has-event { position: relative; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: #30d158; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow: hidden; transition: background 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #accountModal { z-index: 2001; } /* 確保編輯模態框在詳情視圖之上 */
        #calculatorModal { z-index: 2012; } /* 確保計算機模態框在編輯模態框之上 */
        #accountModal .modal-content-wrapper { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #accountModal[style*="display: block"] .modal-content-wrapper, #accountModal[style*="display:flex"] .modal-content-wrapper { transform: translateX(0); }
        #accountModal .modal-content-wrapper.swiping { transition: none; } /* 滑動過程中禁用過渡 */
        #accountModal.closing { background: transparent; } /* 關閉時背景變透明 */
        .modal-content-wrapper { width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--card-bg); align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-title { font-size: 17px; font-weight: 600; }
        .modal-tabs { display: flex; padding: 10px 16px; gap: 10px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); flex-shrink: 0; }
        .modal-tab { flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--border-color); cursor: pointer; }
        .modal-tab.active { background: var(--card-bg); color: var(--text-primary); }
        .tab-content { display: none; padding-bottom: 40px; flex: 1; overflow-y: auto; } .tab-content.active { display: block; }
        
        /* 載入遮罩 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.3s ease-out;
            pointer-events: all;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .loading-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-image {
            width: 80px;
            height: 80px;
            opacity: 0;
            animation: fadeInUpImage 1s ease-out 0s forwards, pulse 2s ease-in-out 1s infinite;
            object-fit: contain;
        }
        .loading-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            opacity: 0;
            animation: fadeInUp 1s ease-out 0s forwards;
        }
        @keyframes fadeInUpImage {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(1);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .loading-text {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-group { background: var(--card-bg); margin-top: 20px; border-radius: 12px; overflow: hidden; margin-left: 16px; margin-right: 16px; }
        .form-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .form-row:last-child { border-bottom: none; }
        .form-label { font-size: 16px; color: var(--text-primary); min-width: 80px; }
        .form-input { background: transparent; border: none; color: var(--text-secondary); text-align: right; font-size: 16px; outline: none; width: 100%; }
        select.form-input { appearance: none; direction: rtl; }
        .calc-btn { background: var(--border-color); border: none; color: #0a84ff; font-size: 18px; cursor: pointer; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .calc-btn:hover { background: var(--card-bg); transform: scale(1.05); }
        .calc-btn:active { transform: scale(0.95); }
        
        /* Calculator Styles */
        .calc-key { background: var(--border-color); border: none; color: var(--text-primary); font-size: 24px; font-weight: 400; cursor: pointer; padding: 20px; border-radius: 12px; transition: all 0.15s; user-select: none; touch-action: manipulation; }
        .calc-key:active { background: var(--card-bg); transform: scale(0.95); }
        .calc-key:hover { background: var(--card-bg); }
        .calc-key-function { background: var(--card-bg); color: #0a84ff; font-size: 18px; }
        .calc-key-operator { background: #0a84ff; color: #fff; font-size: 24px; font-weight: 500; }
        .calc-key-operator:active { background: #0970d6; }
        .calc-key-equals { background: #0a84ff; color: #fff; font-size: 24px; font-weight: 500; }
        .calc-key-equals:active { background: #0970d6; }
        .delete-btn-area { margin-top: 30px; padding: 0 16px; padding-bottom: 50px; }
        .btn-delete { width: 100%; background: var(--card-bg); color: var(--color-debt); border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 500; }
        .hint-text { color: var(--text-secondary); font-size: 12px; margin-top: 8px; padding: 0 20px; opacity: 0.7; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #30d158; color: #000; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 14px; z-index: 2000; display: none; }
        .ai-btn-area { margin: 15px 16px 0 16px; }
        .btn-ai { width: 100%; background: linear-gradient(135deg, #0a84ff, #5e5ce6); color: #fff; border: none; padding: 12px; border-radius: 12px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-ai:disabled { background: var(--card-bg); color: var(--text-secondary); cursor: not-allowed; opacity: 0.6; }
        .progress-container { width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0a84ff, #5e5ce6); width: 0%; transition: width 0.3s ease; border-radius: 2px; }

        /* Detail View */
        #detailView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; }
        #detailView.active { transform: translateX(0); }
        #detailView.swiping { transition: none; } /* 滑動過程中禁用過渡，實現實時跟隨 */
        .detail-header { padding: 10px 20px 20px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); flex-shrink: 0; }
        #detailView .navbar { position: relative; z-index: 1; }
        .detail-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 5px; }
        .detail-subtitle { font-size: 14px; color: var(--text-secondary); }
        .detail-stats { display: flex; justify-content: space-between; margin-top: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-val { font-size: 18px; font-weight: 600; display: block; color: var(--text-primary); }
        .stat-lbl { font-size: 12px; color: var(--text-secondary); margin-top: 4px; display: block; }
        .val-green { color: var(--color-up); } .val-red { color: var(--color-down); }
        .detail-list { flex: 1; overflow-y: auto; padding: 15px; }
        .tx-item { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .tx-header-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .tx-badge { background: #64d2ff; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .tx-date { color: var(--text-secondary); font-size: 13px; }
        .tx-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; }
        .tx-label { color: var(--text-secondary); }
        .tx-val { color: var(--text-primary); font-weight: 500; }
        .tx-val.val-green { color: var(--color-up) !important; }
        .tx-val.val-red { color: var(--color-down) !important; }
        .tx-pnl { font-weight: bold; font-size: 14px; }
        .tx-no-data { text-align: center; color: var(--text-secondary); padding: 30px 0; font-size: 14px; }
    </style>
</head>
<body>
    <!-- 載入遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-header">
                <img src="./favico.png" alt="Loading" class="loading-image">
                <div class="loading-title">Monee</div>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">讀取中...</div>
        </div>
    </div>
    
    <div id="migrationToast" class="toast">資料已還原</div>
    <div id="importProgressToast" class="toast" style="background: #0a84ff; display: none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                <div id="importProgressBar" style="height: 100%; background: #fff; width: 0%; transition: width 0.3s;"></div>
            </div>
            <span id="importProgressText">匯入中...</span>
        </div>
    </div>
    <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleFileImport(event)">
    <div id="refreshStockOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1999; display: none; backdrop-filter: blur(4px);"></div>
    <div id="importOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1999; display: none; backdrop-filter: blur(4px);"></div>
    <div id="refreshStockProgressToast" class="toast" style="background: #0a84ff; display: none; z-index: 2001;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                <div id="refreshStockProgressBar" style="height: 100%; background: #fff; width: 0%; transition: width 0.3s;"></div>
            </div>
            <span id="refreshStockProgressText">重新整理中...</span>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar & Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="sidebar">
            <button class="btn-icon sidebar-toggle-btn-desktop" id="sidebarToggleBtn" onclick="toggleSidebarCollapse()" title="收合/展開選單"><i class="fas fa-bars"></i></button>
            <div class="sidebar-header">
                <h2>功能選單</h2>
                <div class="user-avatar-container" onclick="openUserSelector()" title="切換使用者">
                    <div id="currentUserAvatar" class="user-avatar"></div>
                </div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-label collapsed" onclick="toggleMenuSection('update')">
                    <span>更新</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="menu-section collapsed" id="menuSection-update">
                    <div class="menu-item" onclick="refreshAllData(); toggleSidebar();"><i class="fas fa-sync-alt"></i><span class="menu-text">立即更新</span></div>
                    <div class="menu-item" onclick="refreshStockInfo(); toggleSidebar();"><i class="fas fa-redo"></i><span class="menu-text">重新整理</span></div>
                </div>
                <div class="menu-label collapsed" onclick="toggleMenuSection('data')">
                    <span>資料管理</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="menu-section collapsed" id="menuSection-data">
                    <div class="menu-item" onclick="exportData(); toggleSidebar();"><i class="fas fa-file-export"></i><span class="menu-text">匯出備份</span></div>
                    <div class="menu-item" onclick="importData(); toggleSidebar();"><i class="fas fa-file-import"></i><span class="menu-text">匯入還原</span></div>
                    <div class="menu-item" onclick="setupCloudBackup(); toggleSidebar();"><i class="fas fa-cloud"></i><span class="menu-text">雲端備份設定</span></div>
                </div>
                <div class="menu-label collapsed" onclick="toggleMenuSection('pnl')">
                    <span>損益管理</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="menu-section collapsed" id="menuSection-pnl">
                    <div class="menu-item" onclick="resetPnL(); toggleSidebar();"><i class="fas fa-redo"></i><span class="menu-text">損益歸零</span></div>
                    <div class="menu-item" onclick="restorePnL(); toggleSidebar();"><i class="fas fa-undo"></i><span class="menu-text">恢復損益</span></div>
                </div>
                <div class="menu-label collapsed" onclick="toggleMenuSection('api')">
                    <span>API 設定</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="menu-section collapsed" id="menuSection-api">
                    <div class="menu-item" onclick="setApiKey('finnhub'); toggleSidebar();"><i class="fas fa-chart-line"></i><span class="menu-text">Finnhub Key (美股報價)</span></div>
                    <div class="menu-item" onclick="setApiKey('fugle'); toggleSidebar();"><i class="fas fa-chart-line"></i><span class="menu-text">Fugle Key (台股報價)</span></div>
                    <div class="menu-item" onclick="setApiKey('gemini'); toggleSidebar();"><i class="fas fa-robot"></i><span class="menu-text">Gemini Key (讀圖)</span></div>
                </div>
                <div class="menu-label collapsed" onclick="toggleMenuSection('pages')">
                    <span>分頁顯示</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="menu-section collapsed" id="menuSection-pages">
                    <div id="pageVisibilitySettings"></div>
                </div>
                <div class="menu-item" onclick="toggleTheme(); toggleSidebar();"><i class="fas fa-moon" id="themeIcon"></i><span class="menu-text" id="themeText">深色模式</span></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="navbar">
                <button class="btn-icon hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h1><img src="./favico.png" alt="Logo" class="title-logo">Monee</h1>
                <div class="btn-group">
                    <button class="btn-icon sidebar-toggle-btn-navbar" id="sidebarToggleBtnNavbar" onclick="toggleSidebarCollapse()" title="展開選單"><i class="fas fa-bars"></i></button>
                    <button class="btn-icon" id="sortBtn" onclick="toggleEditMode()"><i class="fas fa-sort-amount-down"></i></button>
                    <button class="btn-icon" id="addBtn" onclick="openModal()"><i class="fas fa-plus"></i></button>
                    <button class="btn-icon" id="calendarChartBtn" onclick="toggleJournalChartView()" style="display: none;"><i class="fas fa-chart-pie"></i></button>
                    <button class="btn-icon" id="calendarSettingsBtn" onclick="openNewExpenseFromCalendar()" style="display: none;"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="page-indicator" style="display: none;">
                <!-- 分頁按鈕將由 JavaScript 動態生成 -->
            </div>

            <div class="content-grid">
                <div class="chart-section">
                    <div class="summary-card">
                        <div class="total-label-wrapper">
                            <div class="total-label" id="summaryLabel">總淨資產</div>
                            <button class="eye-toggle-btn" id="toggleNumbersBtn" onclick="toggleNumbers()" title="隱藏/顯示數字">
                                <i class="fas fa-eye" id="toggleNumbersIcon"></i>
                            </button>
                        </div>
                        <div class="total-amount-wrapper">
                            <div class="total-amount numbers-content" id="totalNetWorth">--</div>
                        </div>
                        <div id="totalPnLBlock" style="display:none;"><div class="pnl-badge numbers-content" id="totalPnLBadge">今日: +0</div></div>
                        <div class="rate-info">
                            <div class="rate-badge numbers-content"><i class="fas fa-coins"></i><span id="rateUsdt">USDT ...</span></div>
                            <div class="rate-badge numbers-content"><i class="fas fa-exchange-alt"></i><span id="rateUsd">USD ...</span></div>
                        </div>
                    </div>

                    <div id="chartWrapper">
                        <div id="customTooltip"><div class="tt-header">類別</div><div class="tt-body"><span class="tt-dot"></span>資產: 0</div></div>
                        <div id="assetChart" style="width:100%; height:100%;"></div>
                    </div>
                    
                    <!-- Currency Toggle Button -->
                    <button id="currencyToggleBtn" class="currency-toggle-btn" onclick="event.stopPropagation(); toggleCurrency();" title="切換幣別">
                        <i class="fas fa-exchange-alt"></i>
                        <span id="currencyToggleText">TWD</span>
                    </button>
                </div>

                <div class="list-section page-swiper" id="pageSwiper">
                    <button class="page-nav-arrow prev" id="prevPageBtn" onclick="switchToPrevPage()" aria-label="上一頁">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="page-nav-arrow next" id="nextPageBtn" onclick="switchToNextPage()" aria-label="下一頁">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="page-container" id="pageContainer">
                        <div class="page-item" data-page="0">
                            <div id="assetsContainer"></div>
                            <div class="debt-container" id="debtContainer0" style="margin-top: 20px;"></div>
                            <div style="height: 60px;" class="mobile-spacer"></div>
                        </div>
                        <div class="page-item" data-page="1">
                            <div id="assetsContainer1"></div>
                            <div class="debt-container" id="debtContainer1" style="margin-top: 20px;"></div>
                            <div style="height: 60px;" class="mobile-spacer"></div>
                        </div>
                        <div class="page-item" data-page="2">
                            <div id="assetsContainer2"></div>
                            <div class="debt-container" id="debtContainer2" style="margin-top: 20px;"></div>
                            <div style="height: 60px;" class="mobile-spacer"></div>
                        </div>
                        <div class="page-item" data-page="3">
                            <div id="assetsContainer3"></div>
                            <div class="debt-container" id="debtContainer3" style="margin-top: 20px;"></div>
                            <div style="height: 60px;" class="mobile-spacer"></div>
                        </div>
                        <div class="page-item" data-page="4">
                            <div id="assetsContainer4"></div>
                            <div class="debt-container" id="debtContainer4" style="margin-top: 20px;"></div>
                            <div style="height: 60px;" class="mobile-spacer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" style="display: none; padding: 10px 20px 20px 20px; overflow-y: visible; height: calc(100% - 60px); margin-top: 0; background: var(--bg-color); position: fixed; top: 60px; left: 0; right: 0; bottom: 60px;">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div class="calendar-month-year">
                            <span id="calendarMonthYear">2025年11月</span>
                            <i class="fas fa-chevron-down calendar-dropdown"></i>
                        </div>
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarTodayDate" style="display: none;"></div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">週日</div>
                        <div class="calendar-weekday">週一</div>
                        <div class="calendar-weekday">週二</div>
                        <div class="calendar-weekday">週三</div>
                        <div class="calendar-weekday">週四</div>
                        <div class="calendar-weekday">週五</div>
                        <div class="calendar-weekday">週六</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <!-- 月份圓餅圖容器 -->
                <div id="monthlyChartContainer" style="display: none; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto; width: 100%; box-sizing: border-box;">
                    <div class="list-section page-swiper" id="monthlyChartSwiper" style="position: relative; width: 100%;">
                        <div class="page-container" id="monthlyChartPageContainer" style="display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); width: 200%;">
                            <!-- 支出圓餅圖 -->
                            <div class="page-item" style="width: 50%; flex-shrink: 0; min-width: 0; padding: 20px; background: var(--card-bg); border-radius: 12px; overflow: visible; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px;" id="monthlyExpenseChartPage">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); text-align: center;">支出</div>
                                <div style="display: flex; flex-direction: column; gap: 20px; flex: 1;">
                                    <div>
                                        <div id="monthlyExpenseTotal" style="font-size: 16px; font-weight: 600; color: var(--color-down); text-align: center; margin-bottom: 10px;">總支出：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">原始支出+代墊</div>
                                        <div id="monthlyExpenseTotalChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                                    </div>
                                    <div>
                                        <div id="monthlyExpenseNormalTotal" style="font-size: 16px; font-weight: 600; color: var(--color-down); text-align: center; margin-bottom: 10px;">原始支出：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">原始支出</div>
                                        <div id="monthlyExpenseChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                                    </div>
                                    <div>
                                        <div id="monthlyExpenseAdvanceTotal" style="font-size: 16px; font-weight: 600; color: var(--color-down); text-align: center; margin-bottom: 10px;">代墊：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">代墊</div>
                                        <div id="monthlyExpenseAdvanceChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- 收入圓餅圖 -->
                            <div class="page-item" style="width: 50%; flex-shrink: 0; min-width: 0; padding: 20px; background: var(--card-bg); border-radius: 12px; overflow: visible; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px;" id="monthlyIncomeChartPage">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); text-align: center;">收入</div>
                                <div style="display: flex; flex-direction: column; gap: 20px; flex: 1;">
                                    <div>
                                        <div id="monthlyIncomeTotal" style="font-size: 16px; font-weight: 600; color: var(--color-up); text-align: center; margin-bottom: 10px;">總收入：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">原始收入+代墊</div>
                                        <div id="monthlyIncomeTotalChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                            </div>
                                    <div>
                                        <div id="monthlyIncomeNormalTotal" style="font-size: 16px; font-weight: 600; color: var(--color-up); text-align: center; margin-bottom: 10px;">原始收入：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">原始收入</div>
                                        <div id="monthlyIncomeChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                                    </div>
                                    <div>
                                        <div id="monthlyIncomeAdvanceTotal" style="font-size: 16px; font-weight: 600; color: var(--color-up); text-align: center; margin-bottom: 10px;">代墊：$0</div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">代墊</div>
                                        <div id="monthlyIncomeAdvanceChart" style="width: 100%; height: 300px; box-sizing: border-box; overflow: visible;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="calendarTransferDetails" style="margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto; display: none; width: 100%; box-sizing: border-box; overflow: visible;">
                    <div class="list-section page-swiper" id="journalSwiper" style="position: relative; width: 100%; overflow: hidden; touch-action: pan-x pan-y;">
                        <div class="page-container" id="journalPageContainer" style="display: flex; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); width: 300%;">
                            <!-- 支出分頁 -->
                            <div class="page-item" data-journal-page="expense" style="width: 33.333%; flex-shrink: 0; min-width: 0; padding: 0; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-sizing: border-box; display: flex; flex-direction: column;" id="journalExpensePage">
                                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 16px; font-weight: 600; color: var(--text-primary); padding: 15px 15px 10px 15px; position: sticky; top: 0; background: var(--card-bg); z-index: 10; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                                    <span>支出</span>
                                    <span id="journalExpenseTotal" style="font-size: 14px; font-weight: 600; color: var(--color-down);">$0</span>
                                </div>
                                <div id="journalExpenseChart" style="width: 100%; height: 200px; padding: 15px; flex-shrink: 0; box-sizing: border-box;"></div>
                                <div id="journalExpenseList" style="display: flex; flex-direction: column; gap: 12px; width: 100%; box-sizing: border-box; padding: 15px; overflow-y: auto; overflow-x: visible; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch;">
                                    <!-- 支出記錄將在這裡動態生成 -->
                                </div>
                            </div>
                            <!-- 收入分頁 -->
                            <div class="page-item" data-journal-page="income" style="width: 33.333%; flex-shrink: 0; min-width: 0; padding: 0; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-sizing: border-box; display: flex; flex-direction: column;" id="journalIncomePage">
                                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 16px; font-weight: 600; color: var(--text-primary); padding: 15px 15px 10px 15px; position: sticky; top: 0; background: var(--card-bg); z-index: 10; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                                    <span>收入</span>
                                    <span id="journalIncomeTotal" style="font-size: 14px; font-weight: 600; color: var(--color-up);">$0</span>
                                </div>
                                <div id="journalIncomeChart" style="width: 100%; height: 200px; padding: 15px; flex-shrink: 0; box-sizing: border-box;"></div>
                                <div id="journalIncomeList" style="display: flex; flex-direction: column; gap: 12px; width: 100%; box-sizing: border-box; padding: 15px; overflow-y: auto; overflow-x: visible; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch;">
                                    <!-- 收入記錄將在這裡動態生成 -->
                                </div>
                            </div>
                            <!-- 轉帳分頁 -->
                            <div class="page-item" data-journal-page="transfer" style="width: 33.333%; flex-shrink: 0; min-width: 0; padding: 0; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-sizing: border-box; display: flex; flex-direction: column;" id="journalTransferPage">
                                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 16px; font-weight: 600; color: var(--text-primary); padding: 15px 15px 10px 15px; position: sticky; top: 0; background: var(--card-bg); z-index: 10; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                                    <span>轉帳</span>
                                    <span id="journalTransferTotal" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0</span>
                                </div>
                                <div id="journalTransferList" style="display: flex; flex-direction: column; gap: 12px; width: 100%; box-sizing: border-box; padding: 15px; overflow-y: auto; overflow-x: visible; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch;">
                                    <!-- 轉帳記錄將在這裡動態生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-bar">
                <button class="tab-item active" id="assetListTab" onclick="switchToCalendarPage(false)"><i class="fas fa-wallet"></i>資產</button>
                <button class="tab-item" id="calendarTabBtn" onclick="switchToCalendarPage(true)"><i class="fas fa-book"></i>記帳</button>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView">
        <div class="navbar">
            <button class="btn-icon" onclick="closeDetailView()"><i class="fas fa-arrow-left"></i></button>
            <h1 id="detailTitleName">資產詳情</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn-icon" onclick="deleteCurrentAsset()" style="color: #ff453a;" title="刪除"><i class="fas fa-trash"></i></button>
            <button class="btn-icon" onclick="editCurrentAsset()"><i class="fas fa-edit"></i></button>
            </div>
        </div>
        <div class="detail-header">
            <div class="detail-title" id="dName">NVDA</div>
            <div class="detail-subtitle" id="dSymbol">NVIDIA Corp</div>
            <div class="detail-stats">
                <div class="stat-item"><span class="stat-val" id="dQty">0</span><span class="stat-lbl">持有股數</span></div>
                <div class="stat-item"><span class="stat-val" id="dPrice">0</span><span class="stat-lbl">現價 (USD)</span></div>
                <div class="stat-item"><span class="stat-val" id="dVal">0</span><span class="stat-lbl">參考市值</span></div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <div id="dDailyPnl" style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: 600;">當天損益</div>
                    <span id="dDailyPnlVal" style="font-size: 20px; font-weight: 700;">+0</span>
                </div>
                <div id="dCostPnl">
                    <div style="font-size: 18px; font-weight: 600;">持股成本損益</div>
                    <span id="dCostPnlVal" style="font-size: 24px; font-weight: 700;">+0 (0%)</span>
                <div style="font-size: 12px; color: #8e8e93; margin-top: 5px;">參考損益 (含手續費)</div>
                </div>
            </div>
        </div>
        <div class="detail-list" id="detailTxList"></div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <button class="btn-icon" onclick="closeModal()">取消</button>
                <span class="modal-title" id="modalTitle">帳戶編輯</span>
                <button class="btn-icon" style="font-weight:bold;" onclick="saveAccount()">儲存</button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('basic')" id="tabBasic">基本設定</div>
                <div class="modal-tab" onclick="switchTab('detail')" id="tabDetail">庫存明細</div>
            </div>
            <div id="contentBasic" class="tab-content active">
                <div class="ai-btn-area" id="aiArea" style="display:none;">
                    <div style="margin-bottom: 10px; padding: 0 5px;">
                        <span style="font-size: 12px; color: #8e8e93;">選擇券商 (手續費率)</span>
                        <select id="brokerSelect" class="form-input" style="background: var(--border-color); border-radius: 8px; padding: 5px; margin-top: 5px;" onchange="updateFeeDisplay()">
                            <option value="cathay">國泰證券 (1.425%)</option>
                            <option value="cathay_fixed">國泰證券 (定期定額 固定1元)</option>
                            <option value="fubon">富邦證券 (0.25%)</option>
                            <option value="custom">自訂...</option>
                        </select>
                    </div>
                    <button class="btn-ai" id="btnAI" onclick="triggerImageUpload()"><i class="fas fa-camera"></i> 匯入截圖 (AI 辨識)</button>
                    <input type="file" id="imgUpload" multiple accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                    <div id="aiStatus" style="text-align:center; color:#aaa; font-size:12px; margin-top:5px;"></div>
                    <div class="progress-container" id="aiProgress">
                        <div class="progress-bar" id="aiProgressBar"></div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row"><span class="form-label">類型</span><select id="inpType" class="form-input" onchange="handleTypeChange()"><option value="bank">錢包</option><option value="crypto">加密貨幣</option><option value="stock">美股</option><option value="twstock">台股</option><option value="debt">負債</option></select></div>
                    <div class="form-row" id="rowBankTag" style="display:none;"><span class="form-label">標籤</span><select id="inpBankTag" class="form-input" onchange="handleBankTagChange()"><option value="現金">現金</option><option value="銀行">銀行</option><option value="信用卡">信用卡</option><option value="電子貨幣">電子貨幣</option><option value="簽帳金融卡">簽帳金融卡</option></select></div>
                    <div class="form-row" id="rowBankName" style="display:none;">
                        <span class="form-label">銀行</span>
                        <div style="position: relative; flex: 1; min-width: 0;">
                            <input type="text" id="inpBankName" class="form-input" placeholder="請輸入銀行名稱或代碼搜尋" autocomplete="off" style="text-align: right; padding-right: 40px; width: 100%; box-sizing: border-box;">
                            <div id="bankSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 10000; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                    </div>
                    <div class="form-row" id="rowName"><span class="form-label">名稱</span><input type="text" id="inpName" class="form-input"></div>
                    <div class="form-row" id="rowSymbol" style="display:none;"><span class="form-label">代碼</span><input type="text" id="inpSymbol" class="form-input" placeholder="例如: NVDA" oninput="syncNameFromSymbol(); updateAIButtonState();"></div>
                    <div class="form-row" id="rowCurrency"><span class="form-label">幣別</span><select id="inpCurrency" class="form-input"><option value="TWD">TWD (新台幣)</option><option value="USD">USD (美金)</option></select></div>
                    <div class="form-row"><span class="form-label" id="lblBalance">股數</span><div style="display: flex; align-items: center; gap: 8px; width: 100%;"><input type="number" id="inpBalance" class="form-input" placeholder="0" style="flex: 1;"><button class="calc-btn" onclick="openCalculator('inpBalance')" type="button" title="計算機"><i class="fas fa-calculator"></i></button></div></div>
                    <div class="form-row" id="rowCost" style="display:none;"><span class="form-label">平均成本</span><div style="display: flex; align-items: center; gap: 8px; width: 100%;"><input type="number" id="inpCost" class="form-input" placeholder="0" style="flex: 1;"><button class="calc-btn" onclick="openCalculator('inpCost')" type="button" title="計算機"><i class="fas fa-calculator"></i></button></div></div>
                </div>
                <div id="symbolHint" class="hint-text" style="display:none;">* 輸入代碼，預設使用美金報價</div>
                <div class="delete-btn-area"><button id="btnDelete" class="btn-delete" onclick="deleteAccount()">刪除</button></div>
            </div>
            <div id="contentDetail" class="tab-content">
                <div class="tx-list" id="txListContainer"><div class="tx-no-data">尚未匯入明細資料</div></div>
            </div>
        </div>
    </div>

    <!-- Calendar Journal Modal (新增支出/收入) -->
    
    <div id="calendarJournalModal" class="modal" style="z-index: 2003;" onclick="event.target.id === 'calendarJournalModal' && closeCalendarJournalModal()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div class="modal-tabs" style="display: flex; padding: 10px 16px; gap: 10px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); flex-shrink: 0;">
                <div class="modal-tab journal-tab active" onclick="switchJournalTab('expense')" id="journalTabExpense" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--border-color); cursor: pointer;">支出</div>
                <div class="modal-tab journal-tab" onclick="switchJournalTab('income')" id="journalTabIncome" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--border-color); cursor: pointer;">收入</div>
                <div class="modal-tab journal-tab" onclick="switchJournalTab('transfer')" id="journalTabTransfer" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--border-color); cursor: pointer;">轉帳</div>
                <div class="modal-tab journal-tab" onclick="switchJournalTab('fixed')" id="journalTabFixed" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--border-color); cursor: pointer;">固定轉帳</div>
            </div>
            <div style="padding: 20px;">
                <div id="journalTabContentExpense" class="journal-tab-content active" style="display: block;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="closeCalendarJournalModal(); openNewExpense();">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-arrow-down" style="color: var(--color-down); font-size: 20px;"></i>
                                <span style="color: var(--text-primary); font-size: 16px;">新增支出</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <div id="journalTabContentIncome" class="journal-tab-content" style="display: none;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="closeCalendarJournalModal(); openNewIncome();">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-arrow-up" style="color: var(--color-up); font-size: 20px;"></i>
                                <span style="color: var(--text-primary); font-size: 16px;">新增收入</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <div id="journalTabContentTransfer" class="journal-tab-content" style="display: none;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="closeCalendarJournalModal(); openNewTransfer();">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-exchange-alt" style="color: var(--text-primary); font-size: 20px;"></i>
                                <span style="color: var(--text-primary); font-size: 16px;">轉帳</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <div id="journalTabContentFixed" class="journal-tab-content" style="display: none;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="closeCalendarJournalModal(); openFixedTransferListFromJournal();">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-calendar-check" style="color: var(--text-primary); font-size: 20px;"></i>
                                <span style="color: var(--text-primary); font-size: 16px;">固定轉帳</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Settings Menu Modal (保留用於固定轉帳) -->
    <div id="calendarSettingsModal" class="modal" style="z-index: 2003;" onclick="event.target.id === 'calendarSettingsModal' && closeCalendarSettingsModal()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;">設定</div>
                <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="openFixedTransferList()">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-exchange-alt" style="color: var(--text-primary); font-size: 20px;"></i>
                            <span style="color: var(--text-primary); font-size: 16px;">固定轉帳</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Transfer List Modal -->
    <div id="fixedTransferListModal" class="modal" style="z-index: 2004;" onclick="event.target.id === 'fixedTransferListModal' && closeFixedTransferListModal()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <!-- 頂部導航欄已移除 -->
            
            <div style="padding: 0 20px 20px 20px; position: relative;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; padding-top: 20px;">
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">固定轉帳</div>
                </div>
                <div id="fixedTransferListContainer" style="max-height: 60vh; overflow-y: auto; padding-bottom: 80px;">
                    <!-- 固定轉帳列表將在這裡動態生成 -->
                </div>
                <button onclick="addNewFixedTransfer()" style="position: absolute; bottom: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: #ffd60a; color: #000; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Repeat Selector Modal -->
    <div id="repeatSelectorModal" class="modal" style="z-index: 2020;" onclick="event.target.id === 'repeatSelectorModal' && closeRepeatSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;">選擇重複頻率</div>
                <div id="repeatSelectorList" style="max-height: 60vh; overflow-y: auto;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="selectRepeat('daily')">
                        <div style="color: var(--text-primary); font-size: 16px;">每日</div>
                    </div>
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="selectRepeat('weekly')">
                        <div style="color: var(--text-primary); font-size: 16px;">每星期</div>
                    </div>
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="selectRepeat('monthly')">
                        <div style="color: var(--text-primary); font-size: 16px;">每月</div>
                    </div>
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="selectRepeat('yearly')">
                        <div style="color: var(--text-primary); font-size: 16px;">每年</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="datePickerModal" class="modal" style="z-index: 2020;" onclick="event.target.id === 'datePickerModal' && closeDatePicker()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 60vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;" id="datePickerTitle">選擇日期</div>
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px; height: 200px; overflow: hidden; position: relative;">
                    <div style="flex: 1; position: relative; overflow: hidden; border-right: 1px solid var(--border-color);">
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 40px; transform: translateY(-50%); background: rgba(10, 132, 255, 0.1); pointer-events: none; z-index: 1;"></div>
                        <div id="yearPicker" style="height: 100%; overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; padding: 80px 0;"></div>
                    </div>
                    <div style="flex: 1; position: relative; overflow: hidden; border-right: 1px solid var(--border-color);">
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 40px; transform: translateY(-50%); background: rgba(10, 132, 255, 0.1); pointer-events: none; z-index: 1;"></div>
                        <div id="monthPicker" style="height: 100%; overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; padding: 80px 0;"></div>
                    </div>
                    <div style="flex: 1; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 40px; transform: translateY(-50%); background: rgba(10, 132, 255, 0.1); pointer-events: none; z-index: 1;"></div>
                        <div id="dayPicker" style="height: 100%; overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; padding: 80px 0;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeDatePicker()" style="flex: 1; padding: 12px; background: var(--border-color); color: var(--text-primary); border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">取消</button>
                    <button onclick="confirmDatePicker()" style="flex: 1; padding: 12px; background: #0a84ff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Color Selector Modal -->
    <div id="tagColorSelectorModal" class="modal" style="z-index: 2020;" onclick="event.target.id === 'tagColorSelectorModal' && closeTagColorSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;">選擇標籤顏色</div>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; max-height: 60vh; overflow-y: auto;">
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ff453a; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ff453a')" onmouseover="this.style.borderColor='#ff453a'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ff9f0a; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ff9f0a')" onmouseover="this.style.borderColor='#ff9f0a'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ffd60a; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ffd60a')" onmouseover="this.style.borderColor='#ffd60a'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #30d158; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#30d158')" onmouseover="this.style.borderColor='#30d158'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #64d2ff; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#64d2ff')" onmouseover="this.style.borderColor='#64d2ff'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #0a84ff; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#0a84ff')" onmouseover="this.style.borderColor='#0a84ff'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #5e5ce6; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#5e5ce6')" onmouseover="this.style.borderColor='#5e5ce6'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #bf5af2; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#bf5af2')" onmouseover="this.style.borderColor='#bf5af2'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ff375f; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ff375f')" onmouseover="this.style.borderColor='#ff375f'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ff9500; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ff9500')" onmouseover="this.style.borderColor='#ff9500'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #ffcc00; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#ffcc00')" onmouseover="this.style.borderColor='#ffcc00'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                    <div style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; background: #34c759; border: 3px solid transparent; transition: all 0.2s;" onclick="selectTagColor('#34c759')" onmouseover="this.style.borderColor='#34c759'; this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Holiday Adjust Selector Modal -->
    <div id="holidayAdjustSelectorModal" class="modal" style="z-index: 2020;" onclick="event.target.id === 'holidayAdjustSelectorModal' && closeHolidayAdjustSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;">選擇假日調整</div>
                <div id="holidayAdjustSelectorList" style="max-height: 60vh; overflow-y: auto;">
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="selectHolidayAdjust('none')">
                        <div style="color: var(--text-primary); font-size: 16px;">不調整</div>
                    </div>
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;" onclick="selectHolidayAdjust('advance')">
                        <div style="color: var(--text-primary); font-size: 16px;">提前</div>
                    </div>
                    <div style="cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color);" onclick="selectHolidayAdjust('delay')">
                        <div style="color: var(--text-primary); font-size: 16px;">延後</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 日期記事編輯模態框 -->
    <div id="dateNoteModal" class="modal" style="z-index: 2011;" onclick="event.target.id === 'dateNoteModal' && closeDateNoteEditor()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 400px; margin: auto; border-radius: 20px; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;" id="dateNoteTitle">記事</div>
                <div style="margin-bottom: 15px;">
                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;" id="dateNoteDateDisplay"></div>
                    <textarea id="dateNoteInput" style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-primary); font-size: 16px; resize: vertical; box-sizing: border-box;" placeholder="輸入記事內容..."></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="saveDateNoteFromEditor()" style="flex: 1; padding: 12px; background: #0a84ff; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">儲存</button>
                    <button onclick="closeDateNoteEditor()" style="flex: 1; padding: 12px; background: var(--bg-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Selector Modal -->
    <div id="accountSelectorModal" class="modal" style="z-index: 2020;" onclick="event.target.id === 'accountSelectorModal' && closeAccountSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: var(--card-bg); position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; text-align: center;" id="accountSelectorTitle">選擇帳戶</div>
                <div id="accountSelectorList" style="max-height: 60vh; overflow-y: auto;">
                    <!-- 帳戶列表將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Income Modal (收入) -->
    <div id="incomeModal" class="modal" style="z-index: 2007;" onclick="event.target.id === 'incomeModal' && closeIncomeModal()">
        <!-- 右下角浮動按鈕 (進入固定轉帳) -->
        <button onclick="event.stopPropagation(); openFixedTransferListFromJournal()" style="position: fixed; bottom: 30px; right: 20px; width: auto; min-width: 56px; height: 56px; border-radius: 28px; background: #ffd60a; color: #000; border: none; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
            <i class="fas fa-sync-alt" style="font-size: 18px;"></i>
            <span>固定轉帳</span>
        </button>
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: 100%; margin: 0; border-radius: 0; background: #000000; overflow-y: auto;" onclick="event.stopPropagation()">
            <!-- 分頁選單 -->
            <div class="modal-tabs" style="display: flex; padding: 10px 16px; gap: 10px; background: #000000; flex-shrink: 0; position: sticky; top: 0; z-index: 11;" onclick="event.stopPropagation()">
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('expense')" id="journalFormTabExpense" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">支出</div>
                <div class="modal-tab journal-form-tab active" onclick="event.stopPropagation(); switchJournalFormTab('income')" id="journalFormTabIncome" style="flex: 1; text-align: center; padding: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer; border: 2px solid var(--color-up);">收入</div>
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('transfer')" id="journalFormTabTransfer" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">轉帳</div>
            </div>
            <div class="modal-header" style="position: sticky; top: 56px; z-index: 10; background: #000000; border-bottom: none; display: flex; justify-content: space-between; align-items: center; padding: 10px 16px;">
                <button class="btn-icon" onclick="closeIncomeModal()" style="color: #98989d; font-size: 17px;">取消</button>
                <!-- 中間標題移除 -->
                <button class="btn-icon" style="font-weight:bold; color: var(--color-up);" onclick="saveIncome()">儲存</button>
            </div>
            <div style="padding: 0 20px 40px 20px;">
                <!-- 大標題區域 -->
                <div style="margin-bottom: 20px; padding-top: 10px;">
                    <h1 style="font-size: 34px; font-weight: 700; color: var(--text-primary); margin: 0 0 4px 0;">新增收入</h1>
                    <div id="incomeDate" style="font-size: 15px; color: var(--text-secondary); font-weight: 400;"></div>
                </div>

                <!-- 表單群組容器 -->
                <div class="form-group" style="background: #1c1c1e; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                    
                    <!-- 日期 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openIncomeDateSelector()">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-calendar-alt" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">日期</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="incomeDateDisplay" style="color: var(--text-secondary); font-size: 17px;"></span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 標題 -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-heading" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">標題</span>
                            </div>
                            <input type="text" id="incomeTitle" class="form-input" placeholder="輸入標題" style="text-align: right; font-size: 17px; border: none; background: transparent; padding: 0; color: var(--text-primary); flex: 1; margin-left: 20px;">
                        </div>
                    </div>

                    <!-- 金額 -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;">
                        <div style="display: flex; flex-direction: column; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-coins" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">金額</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-left: 36px;">
                                <span style="color: var(--text-secondary); font-size: 24px; font-weight: 500;">$</span>
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end;">
                                    <input type="text" id="incomeAmount" class="form-input" placeholder="0" style="flex: 1; background: transparent; border: none; text-align: right; color: var(--text-primary); padding: 0; cursor: pointer; font-size: 40px; font-weight: 500; height: auto;" readonly>
                                    <button class="calc-btn" onclick="event.stopPropagation(); openCalculatorModal('incomeAmount')" type="button" title="計算機" style="background: rgba(10, 132, 255, 0.15); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;"><i class="fas fa-calculator" style="color: #0a84ff; font-size: 18px;"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 類別 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openCategorySelector('income')">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-dollar-sign" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">類別</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="incomeCategory" style="color: var(--text-secondary); font-size: 17px;">選擇類別</span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 帳戶 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openJournalAccountSelector('income')">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-university" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">帳戶</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="incomeAccount" style="color: var(--text-secondary); font-size: 17px;">選擇帳戶</span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 代墊 -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: none; border-radius: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-receipt" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">代墊</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="incomeIsAdvance">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal (支出) -->
    <div id="expenseModal" class="modal" style="z-index: 2007;" onclick="event.target.id === 'expenseModal' && closeExpenseModal()">
        <!-- 右下角浮動按鈕 (進入固定轉帳) -->
        <button onclick="event.stopPropagation(); openFixedTransferListFromJournal()" style="position: fixed; bottom: 30px; right: 20px; width: auto; min-width: 56px; height: 56px; border-radius: 28px; background: #ffd60a; color: #000; border: none; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
            <i class="fas fa-sync-alt" style="font-size: 18px;"></i>
            <span>固定轉帳</span>
        </button>
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: 100%; margin: 0; border-radius: 0; background: #000000; overflow-y: auto;" onclick="event.stopPropagation()">
            <!-- 分頁選單 -->
            <div class="modal-tabs" style="display: flex; padding: 10px 16px; gap: 10px; background: #000000; flex-shrink: 0; position: sticky; top: 0; z-index: 11;" onclick="event.stopPropagation()">
                <div class="modal-tab journal-form-tab active" onclick="event.stopPropagation(); switchJournalFormTab('expense')" id="journalFormTabExpense" style="flex: 1; text-align: center; padding: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer; border: 2px solid var(--color-down);">支出</div>
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('income')" id="journalFormTabIncome" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">收入</div>
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('transfer')" id="journalFormTabTransfer" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">轉帳</div>
            </div>
            <div class="modal-header" style="position: sticky; top: 56px; z-index: 10; background: #000000; border-bottom: none; display: flex; justify-content: space-between; align-items: center; padding: 10px 16px;">
                <button class="btn-icon" onclick="closeExpenseModal()" style="color: #98989d; font-size: 17px;">取消</button>
                <!-- 中間標題移除 -->
                <button class="btn-icon" style="font-weight:bold; color: var(--color-down);" onclick="saveExpense()">儲存</button>
            </div>
            <div style="padding: 0 20px 40px 20px;">
                <!-- 大標題區域 -->
                <div style="margin-bottom: 20px; padding-top: 10px;">
                    <h1 style="font-size: 34px; font-weight: 700; color: var(--text-primary); margin: 0 0 4px 0;">新增支出</h1>
                    <div id="expenseDate" style="font-size: 15px; color: var(--text-secondary); font-weight: 400;"></div>
                </div>

                <!-- 表單群組容器 -->
                <div class="form-group" style="background: #1c1c1e; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                    
                    <!-- 日期 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openExpenseDateSelector()">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-calendar-alt" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">日期</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="expenseDateDisplay" style="color: var(--text-secondary); font-size: 17px;"></span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 標題 -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-heading" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">標題</span>
                            </div>
                            <input type="text" id="expenseTitle" class="form-input" placeholder="輸入標題" style="text-align: right; font-size: 17px; border: none; background: transparent; padding: 0; color: var(--text-primary); flex: 1; margin-left: 20px;">
                        </div>
                    </div>

                    <!-- 金額 (高度較高，包含對齊優化) -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;">
                        <div style="display: flex; flex-direction: column; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-coins" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">金額</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-left: 36px;">
                                <span style="color: var(--text-secondary); font-size: 24px; font-weight: 500;">$</span>
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end;">
                                    <input type="text" id="expenseAmount" class="form-input" placeholder="0" style="flex: 1; background: transparent; border: none; text-align: right; color: var(--text-primary); padding: 0; cursor: pointer; font-size: 40px; font-weight: 500; height: auto;" readonly>
                                    <button class="calc-btn" onclick="event.stopPropagation(); openCalculatorModal('expenseAmount')" type="button" title="計算機" style="background: rgba(10, 132, 255, 0.15); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;"><i class="fas fa-calculator" style="color: #0a84ff; font-size: 18px;"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 類別 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openCategorySelector('expense')">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-tag" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">類別</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="expenseCategory" style="color: var(--text-secondary); font-size: 17px;">選擇類別</span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 帳戶 -->
                    <div class="form-row" style="cursor: pointer; background: transparent; padding: 16px; margin: 0; border-bottom: 1px solid #2c2c2e; border-radius: 0;" onclick="openJournalAccountSelector('expense')">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-university" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">帳戶</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="expenseAccount" style="color: var(--text-secondary); font-size: 17px;">選擇帳戶</span>
                                <i class="fas fa-chevron-right" style="color: var(--text-third); font-size: 14px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 代墊 (最後一項無底線) -->
                    <div class="form-row" style="background: transparent; padding: 16px; margin: 0; border-bottom: none; border-radius: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-receipt" style="color: var(--text-secondary); font-size: 20px;"></i></div>
                                <span class="form-label" style="color: var(--text-primary); font-size: 17px; margin: 0;">代墊</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="expenseIsAdvance">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Modal (轉帳) -->
    <div id="transferModal" class="modal" style="z-index: 2007;" onclick="event.target.id === 'transferModal' && closeTransferModal()">
        <!-- 右下角浮動按鈕 (進入固定轉帳) -->
        <button onclick="event.stopPropagation(); openFixedTransferListFromJournal()" style="position: fixed; bottom: 30px; right: 20px; width: auto; min-width: 56px; height: 56px; border-radius: 28px; background: #ffd60a; color: #000; border: none; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
            <i class="fas fa-sync-alt" style="font-size: 18px;"></i>
            <span>固定轉帳</span>
        </button>
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: 100%; margin: 0; border-radius: 0; background: #000000; overflow-y: auto;" onclick="event.stopPropagation()">
            <!-- 分頁選單 -->
            <div class="modal-tabs" style="display: flex; padding: 10px 16px; gap: 10px; background: #000000; flex-shrink: 0; position: sticky; top: 0; z-index: 11;" onclick="event.stopPropagation()">
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('expense')" id="journalFormTabExpense" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">支出</div>
                <div class="modal-tab journal-form-tab" onclick="event.stopPropagation(); switchJournalFormTab('income')" id="journalFormTabIncome" style="flex: 1; text-align: center; padding: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer;">收入</div>
                <div class="modal-tab journal-form-tab active" onclick="event.stopPropagation(); switchJournalFormTab('transfer')" id="journalFormTabTransfer" style="flex: 1; text-align: center; padding: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; border-radius: 8px; background: #1c1c1e; cursor: pointer; border: 2px solid var(--text-primary);">轉帳</div>
            </div>
            <div class="modal-header" style="position: sticky; top: 56px; z-index: 10; background: #000000; border-bottom: none; display: flex; justify-content: space-between; align-items: center; padding: 10px 16px;">
                <button class="btn-icon" onclick="closeTransferModal()" style="color: #98989d; font-size: 17px;">取消</button>
                <!-- 中間標題移除 -->
                <button class="btn-icon" style="font-weight:bold; color: #0a84ff;" onclick="saveTransfer()">儲存</button>
            </div>
            <div style="padding: 0 20px 20px 20px;">
                <!-- 大標題區域 -->
                <div style="margin-bottom: 20px;">
                    <h1 style="font-size: 34px; font-weight: bold; color: #ffffff; margin: 0 0 5px 0;">轉帳</h1>
                    <div id="transferDate" style="font-size: 15px; color: #8e8e93; font-weight: normal;"></div>
                </div>

                <div class="form-group" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 日期 -->
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openTransferDateSelector()">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; text-align: center;"><i class="fas fa-calendar" style="color: #8e8e93; font-size: 20px;"></i></div>
                            <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">日期</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="transferDateDisplay" style="color: #8e8e93; font-size: 17px;"></span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>

                    <!-- 標題 -->
                    <div class="form-row" style="background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; text-align: center;"><i class="fas fa-heading" style="color: #8e8e93; font-size: 20px;"></i></div>
                            <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">標題</span>
                        </div>
                        <input type="text" id="transferTitle" class="form-input" placeholder="輸入標題" style="text-align: right; background: transparent; border: none; color: #ffffff; font-size: 17px; width: 150px; padding: 0;">
                    </div>

                    <!-- 從帳戶 -->
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openJournalAccountSelector('transferFrom')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; text-align: center;"><i class="fas fa-university" style="color: #8e8e93; font-size: 20px;"></i></div>
                            <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">從帳戶</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="transferFromAccount" style="color: #8e8e93; font-size: 17px;">選擇轉出帳戶</span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>

                    <!-- 到帳戶 -->
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openJournalAccountSelector('transferTo')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; text-align: center;"><i class="fas fa-university" style="color: #8e8e93; font-size: 20px;"></i></div>
                            <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">到帳戶</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="transferToAccount" style="color: #8e8e93; font-size: 17px;">選擇轉入帳戶</span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>

                    <!-- 金額 -->
                    <div class="form-row" style="background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0;">
                        <div style="display: flex; flex-direction: column; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 24px; text-align: center;"><i class="fas fa-coins" style="color: #8e8e93; font-size: 20px;"></i></div>
                                <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">金額</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-left: 36px;">
                                <span style="color: #8e8e93; font-size: 24px; font-weight: 500;">$</span>
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end;">
                                    <input type="text" id="transferAmount" class="form-input" placeholder="0" style="flex: 1; background: transparent; border: none; text-align: right; color: #ffffff; padding: 0; cursor: pointer; font-size: 40px; font-weight: 500; height: auto;" readonly>
                                    <button class="calc-btn" onclick="event.stopPropagation(); openCalculatorModal('transferAmount')" type="button" title="計算機" style="background: #2c2c2e; border: none; border-radius: 8px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;"><i class="fas fa-calculator" style="color: #0a84ff; font-size: 20px;"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Selector Modal -->
    <div id="categorySelectorModal" class="modal" style="z-index: 2010;" onclick="event.target.id === 'categorySelectorModal' && closeCategorySelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: auto; max-height: 80vh; margin: auto; border-radius: 20px 20px 0 0; background: #1c1c1e; position: fixed; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);" onclick="event.stopPropagation()">
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 20px; text-align: center;" id="categorySelectorTitle">選擇類別</div>
                <div id="categorySelectorList" style="max-height: 60vh; overflow-y: auto;">
                    <!-- 類別列表將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Transfer Modal -->
    <div id="fixedTransferModal" class="modal" style="z-index: 2004;" onclick="event.target.id === 'fixedTransferModal' && closeFixedTransferModal()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 100%; height: 100%; margin: 0; border-radius: 0; background: #000000; overflow-y: auto;" onclick="event.stopPropagation()">
            <!-- 分頁選單已移除 -->
            <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: #000000; border-bottom: none; display: flex; justify-content: space-between; align-items: center; padding: 10px 16px;">
                <button class="btn-icon" onclick="closeFixedTransferModal()" style="color: #98989d; font-size: 17px;">取消</button>
                <!-- 中間標題移除 -->
                <button class="btn-icon" style="font-weight:bold; color: #ffd60a;" onclick="saveFixedTransfer()">儲存</button>
            </div>
            <div style="padding: 0 20px 20px 20px;">
                 <!-- 大標題區域 -->
                 <div style="margin-bottom: 20px; padding-top: 10px;">
                    <h1 style="font-size: 34px; font-weight: bold; color: #ffffff; margin: 0 0 5px 0;">固定轉帳</h1>
                </div>

                <div class="form-group" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="form-row" style="background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">標題</span>
                        <input type="text" id="fixedTransferTitle" class="form-input" placeholder="例:交通卡充值" style="text-align: right; background: transparent; border: none; color: #ffffff; font-size: 17px; width: 150px; padding: 0;">
                    </div>
                    <div class="form-row" style="background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">使用帳戶全部金額</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="fixedTransferUseAccountBalanceLabel" style="color: #8e8e93; font-size: 14px;">關閉</span>
                            <label class="switch">
                                <input type="checkbox" id="fixedTransferUseAccountBalance" onchange="updateFixedTransferAmountMode()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-row" id="fixedTransferAccountBalanceSourceRow" style="display: none; cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; align-items: center; justify-content: space-between;" onclick="toggleFixedTransferAccountBalanceSource()">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">使用帳戶</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="fixedTransferAccountBalanceSource" style="color: #8e8e93; font-size: 17px;">匯出方（從帳戶）</span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>
                    <div class="form-row" id="fixedTransferAmountRow" style="background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">金額</span>
                        <input type="number" id="fixedTransferAmount" class="form-input" placeholder="金額" style="text-align: right; background: transparent; border: none; color: #ffffff; font-size: 17px; width: 150px; padding: 0;">
                    </div>
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openAccountSelector('from')">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">從帳戶</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="fixedTransferFromAccount" style="color: #8e8e93; font-size: 17px;">從帳戶</span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openAccountSelector('to')">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">到帳戶</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="fixedTransferToAccount" style="color: #8e8e93; font-size: 17px;">到帳戶</span>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>
                    <div class="form-row" style="cursor: pointer; background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;" onclick="openTagColorSelector()">
                        <span class="form-label" style="color: #ffffff; font-size: 17px; margin: 0;">標籤</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-tag" id="fixedTransferTagIcon" style="color: #8e8e93;"></i>
                                <span id="fixedTransferTagColor" style="color: #8e8e93; font-size: 17px;">選擇顏色</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #57575e; font-size: 14px;"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 30px;">
                    <div class="form-row" style="cursor: pointer;" onclick="openRepeatSelector()"><span class="form-label">重複</span><div style="display: flex; align-items: center; justify-content: space-between; width: 100%;"><span id="fixedTransferRepeat">每月</span><i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i></div></div>
                    <div class="form-row" style="display: flex; align-items: center; justify-content: space-between;"><span class="form-label">按期數</span><div style="display: flex; align-items: center; gap: 10px;"><span id="fixedTransferPeriodCount" style="color: var(--text-secondary); font-size: 14px;"></span><label class="switch"><input type="checkbox" id="fixedTransferByPeriod" onchange="updatePeriodCount()"><span class="slider"></span></label></div></div>
                    <div class="form-row" style="cursor: pointer;" onclick="openDateSelector('start')"><span class="form-label">開始日期</span><div style="display: flex; align-items: center; justify-content: space-between; width: 100%;"><span id="fixedTransferStartDate" style="color: var(--text-secondary);">2025年12月2日 週二</span><i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i></div></div>
                    <div class="form-row" style="cursor: pointer;" onclick="openDateSelector('end')"><span class="form-label">結束日期</span><div style="display: flex; align-items: center; justify-content: space-between; width: 100%;"><span id="fixedTransferEndDate">永不結束</span><i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i></div></div>
                    <div class="form-row" style="cursor: pointer;" onclick="openHolidayAdjustSelector()"><span class="form-label">假日調整</span><div style="display: flex; align-items: center; justify-content: space-between; width: 100%;"><span id="fixedTransferHolidayAdjust">不調整</span><i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i></div></div>
                </div>
                <div style="margin-top: 30px;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px;">週期入帳日程</div>
                    <div style="color: var(--text-secondary); margin-bottom: 10px;">下回<span id="fixedTransferNextDate" style="margin-left: 10px; color: var(--text-primary);">:2025年12月2日 週二</span></div>
                    <div style="color: var(--text-secondary);">下下回<span id="fixedTransferNextNextDate" style="margin-left: 10px; color: var(--text-primary);">:2026年1月2日 週五</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="modal" style="z-index: 2012;" onclick="event.target.id === 'calculatorModal' && closeCalculator()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 400px; height: auto; max-height: 90vh; margin: auto; border-radius: 20px; background: var(--card-bg);" onclick="event.stopPropagation()">
            <div class="modal-header" style="border-radius: 20px 20px 0 0;">
                <span class="modal-title">計算機</span>
                <button class="btn-icon" onclick="closeCalculator()" style="font-weight:bold;">完成</button>
            </div>
            <div style="padding: 20px; background: var(--bg-color);">
                <div style="background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; min-height: 80px; display: flex; align-items: center; justify-content: flex-end;">
                    <div id="calcDisplay" style="color: var(--text-primary); font-size: 36px; font-weight: 300; text-align: right; word-break: break-all; width: 100%; font-family: 'SF Mono', 'Monaco', monospace;">0</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <button class="calc-key calc-key-function" onclick="calcInput('C')">C</button>
                    <button class="calc-key calc-key-function" onclick="calcInput('CE')">CE</button>
                    <button class="calc-key calc-key-function" onclick="calcInput('backspace')">⌫</button>
                    <button class="calc-key calc-key-operator" onclick="calcInput('/')">÷</button>
                    
                    <button class="calc-key" onclick="calcInput('7')">7</button>
                    <button class="calc-key" onclick="calcInput('8')">8</button>
                    <button class="calc-key" onclick="calcInput('9')">9</button>
                    <button class="calc-key calc-key-operator" onclick="calcInput('*')">×</button>
                    
                    <button class="calc-key" onclick="calcInput('4')">4</button>
                    <button class="calc-key" onclick="calcInput('5')">5</button>
                    <button class="calc-key" onclick="calcInput('6')">6</button>
                    <button class="calc-key calc-key-operator" onclick="calcInput('-')">−</button>
                    
                    <button class="calc-key" onclick="calcInput('1')">1</button>
                    <button class="calc-key" onclick="calcInput('2')">2</button>
                    <button class="calc-key" onclick="calcInput('3')">3</button>
                    <button class="calc-key calc-key-operator" onclick="calcInput('+')">+</button>
                    
                    <button class="calc-key" onclick="calcInput('±')">±</button>
                    <button class="calc-key" onclick="calcInput('0')">0</button>
                    <button class="calc-key" onclick="calcInput('.')">.</button>
                    <button class="calc-key calc-key-equals" onclick="calcInput('=')">=</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selector Modal -->
    <div id="userSelectorModal" class="modal" style="z-index: 2001;" onclick="event.target.id === 'userSelectorModal' && closeUserSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 500px; height: auto; max-height: 90vh; margin: auto; border-radius: 20px; background: var(--card-bg); overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header" style="border-radius: 20px 20px 0 0;">
                <span class="modal-title">選擇使用者</span>
                <button class="btn-icon" onclick="closeUserSelector()" style="font-weight:bold;">完成</button>
            </div>
            <div style="padding: 20px; background: var(--bg-color);">
                <div id="userListContainer" style="margin-bottom: 30px;"></div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 20px;">
                    <button class="btn-primary" onclick="createNewUser()" style="width: 100%; padding: 15px; background: #0a84ff; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">
                        <i class="fas fa-plus"></i> 新增使用者
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="userEditModal" class="modal" style="z-index: 2003;" onclick="event.target.id === 'userEditModal' && closeUserEditModal()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 400px; height: auto; max-height: 90vh; margin: auto; border-radius: 20px; background: var(--card-bg); overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header" style="border-radius: 20px 20px 0 0;">
                <span class="modal-title">編輯使用者</span>
                <button class="btn-icon" onclick="closeUserEditModal()" style="font-weight:bold;">完成</button>
            </div>
            <div style="padding: 20px; background: var(--bg-color);">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">使用者名稱</label>
                    <input type="text" id="userEditNameInput" style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px; box-sizing: border-box;" placeholder="輸入使用者名稱">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">頭像</label>
                    <button onclick="openAvatarSelectorFromEdit()" style="width: 100%; padding: 15px; background: var(--border-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-image"></i> 選擇頭像
                    </button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveUserEdit()" style="flex: 1; padding: 12px; background: #0a84ff; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">儲存</button>
                    <button onclick="closeUserEditModal(); editingUserId = null;" style="flex: 1; padding: 12px; background: var(--border-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Selector Modal -->
    <div id="avatarSelectorModal" class="modal" style="z-index: 2002;" onclick="event.target.id === 'avatarSelectorModal' && closeAvatarSelector()">
        <div class="modal-content-wrapper" style="width: 100%; max-width: 400px; height: auto; max-height: 90vh; margin: auto; border-radius: 20px; background: var(--card-bg); overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header" style="border-radius: 20px 20px 0 0;">
                <span class="modal-title">選擇頭像</span>
                <button class="btn-icon" onclick="closeAvatarSelector()" style="font-weight:bold;">完成</button>
            </div>
            <div style="padding: 20px; background: var(--bg-color);">
                <div style="margin-bottom: 20px;">
                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">預設頭像</div>
                    <div id="defaultAvatarsContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;"></div>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 20px;">
                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">上傳照片</div>
                    <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('avatarUploadInput').click()" style="width: 100%; padding: 15px; background: var(--border-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-upload"></i> 選擇照片
                    </button>
                    <div id="avatarCropContainer" style="margin-top: 20px; display: none;">
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">裁切照片（拖動調整位置，<span id="zoomHint">滾輪縮放</span>）</div>
                        <div id="avatarCropWrapper" style="position: relative; width: 100%; max-width: 300px; height: 300px; margin: 0 auto; background: var(--card-bg); border-radius: 12px; overflow: hidden; cursor: move;">
                            <canvas id="avatarCropCanvas" style="display: block; width: 100%; max-width: 300px; height: 300px; pointer-events: none;"></canvas>
                            <div id="avatarCropOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                <div id="avatarCropCircle" style="position: absolute; border: 3px solid #0a84ff; border-radius: 50%; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); pointer-events: none;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="confirmAvatarCrop()" style="flex: 1; padding: 12px; background: #0a84ff; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">確認</button>
                            <button onclick="cancelAvatarCrop()" style="flex: 1; padding: 12px; background: var(--border-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // 1. Define Constants & Globals
    const STORAGE_KEY_DATA = 'my_assets_stable_data';
    const STORAGE_KEY_SETTINGS = 'my_assets_stable_settings';
    const STORAGE_KEY_USERS = 'my_assets_users';
    const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
    const STORAGE_KEY_FIXED_TRANSFERS = 'my_assets_fixed_transfers';
    const STORAGE_KEY_JOURNAL = 'my_assets_journal'; // 收入、支出、轉帳記錄
    const STORAGE_KEY_DATE_NOTES = 'my_assets_date_notes'; // 日期記事
    
    // 銀行代碼資料（包含銀行名稱和代碼）
    const BANK_DATA = [
        { name: '台灣銀行', code: '004' },
        { name: '土地銀行', code: '005' },
        { name: '合作金庫銀行', code: '006' },
        { name: '第一銀行', code: '007' },
        { name: '華南銀行', code: '008' },
        { name: '彰化銀行', code: '009' },
        { name: '上海商業儲蓄銀行', code: '011' },
        { name: '台北富邦銀行', code: '012' },
        { name: '國泰世華銀行', code: '013' },
        { name: '兆豐銀行', code: '017' },
        { name: '花旗銀行', code: '021' },
        { name: '王道銀行', code: '048' },
        { name: '台灣中小企業銀行', code: '050' },
        { name: '渣打銀行', code: '052' },
        { name: '匯豐銀行', code: '081' },
        { name: '陽信銀行', code: '108' },
        { name: '三信商業銀行', code: '147' },
        { name: '中華郵政', code: '700' },
        { name: '聯邦銀行', code: '803' },
        { name: '遠東銀行', code: '805' },
        { name: '元大銀行', code: '806' },
        { name: '永豐銀行', code: '807' },
        { name: '玉山銀行', code: '808' },
        { name: '凱基銀行', code: '809' },
        { name: '星展銀行', code: '810' },
        { name: '台新銀行', code: '812' },
        { name: '安泰銀行', code: '816' },
        { name: '中國信託銀行', code: '822' },
        { name: '樂天銀行', code: '826' },
        { name: '其他', code: '' }
    ];
    
    // Firebase 配置
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyAyebCTYX0SdZbO_wTKVjMyQXmGsnmSkzs",
        authDomain: "travel-30c43.firebaseapp.com",
        databaseURL: "https://travel-30c43-default-rtdb.firebaseio.com",
        projectId: "travel-30c43",
        storageBucket: "travel-30c43.firebasestorage.app",
        messagingSenderId: "402035619902",
        appId: "1:402035619902:web:f492adf217821c093f396f",
        measurementId: "G-SPF452S4LR"
    };
    
    // 預設頭像（使用 emoji 或圖示）
    const DEFAULT_AVATARS = [
        '👤', '👨', '👩', '🧑', '👨‍💼', '👩‍💼'
    ];
    
    const TYPE_COLORS = { 'bank': '#64d2ff', 'stock': '#bf5af2', 'twstock': '#0a84ff', 'crypto': '#ff9f0a', 'debt': '#ff453a' };
    const TYPE_NAMES = { 'bank': '錢包', 'stock': '美股', 'twstock': '台股', 'crypto': '加密貨幣', 'debt': '負債' };
    
    // 為每個分類定義專屬主題配色（每個主題內顏色差異明顯，避免相近色，所有顏色都是淡色）
    const CHART_ITEM_COLOR_PALETTES = {
        'bank': [
            // 錢包主題 - 穩重金融風（完全避免相近色，每個顏色差異極大，淡色版）
            '#6bb5ff',  // 1. 淡藍色
            '#ffeb80',  // 2. 淡金色
            '#7ee58f',  // 3. 淡綠色
            '#ffa8a0',  // 4. 淡紅色
            '#80e5ff',  // 5. 淡天藍
            '#ffe880',  // 6. 淡金黃色
            '#c9a8f0',  // 7. 淡紫色
            '#7ee58f',  // 8. 淡翠綠色
            '#a8e8ff',  // 9. 淡淺藍色
            '#ffcc80',  // 10. 淡橘色
            '#9bb3f0',  // 11. 淡皇家藍
            '#ff9980',  // 12. 淡橙紅色
            '#b3e8ff',  // 13. 淡亮藍色
            '#80ff80',  // 14. 淡亮綠色
            '#80b5ff',  // 15. 淡系統藍
            '#ffeb80',  // 16. 淡黃色
            '#9bb3d0',  // 17. 淡鋼藍色
            '#ffb3a0',  // 18. 淡珊瑚紅
            '#9fd0ff',  // 19. 淡道奇藍
            '#a8a0e8',  // 20. 淡靛藍色
        ],
        'stock': [
            // 美股主題 - 科技金融風（完全避免相近色，每個顏色差異極大，淡色版）
            '#d9a8f8',  // 1. 淡紫色
            '#7ee58f',  // 2. 淡亮綠色
            '#a8e8ff',  // 3. 淡淺藍色
            '#ffa8a0',  // 4. 淡番茄紅
            '#6bb5ff',  // 5. 淡深藍色
            '#ffeb80',  // 6. 淡金色
            '#80e5ff',  // 7. 淡深天藍
            '#ffcc80',  // 8. 淡橘色
            '#b3e8ff',  // 9. 淡亮藍色
            '#ffeb80',  // 10. 淡黃色
            '#80b5ff',  // 11. 淡系統藍
            '#ff9980',  // 12. 淡橙紅色
            '#9bb3f0',  // 13. 淡天空藍
            '#80ff80',  // 14. 淡亮綠色
            '#a8a0e8',  // 15. 淡靛藍色
            '#ffb3a0',  // 16. 淡珊瑚紅
            '#9fd0ff',  // 17. 淡道奇藍
            '#7ee58f',  // 18. 淡翠綠色
            '#9bb3f0',  // 19. 淡皇家藍
            '#ffb380',  // 20. 淡珊瑚橘
        ],
        'twstock': [
            // 台股主題 - 東方市場風（完全避免相近色，每個顏色差異極大，淡色版）
            '#6bb5ff',  // 1. 淡深藍色
            '#7ee58f',  // 2. 淡亮綠色
            '#ffa8a0',  // 3. 淡番茄紅
            '#80e5ff',  // 4. 淡深天藍
            '#7ee58f',  // 5. 淡翠綠色
            '#ffeb80',  // 6. 淡金色
            '#80ccff',  // 7. 淡青藍色
            '#ffcc80',  // 8. 淡橘色
            '#80e5e5',  // 9. 淡青色
            '#d9a8f8',  // 10. 淡紫色
            '#a8e8ff',  // 11. 淡淺藍色
            '#ff9980',  // 12. 淡橙紅色
            '#8fd4e0',  // 13. 淡青綠色
            '#ffeb80',  // 14. 淡黃色
            '#80b3ff',  // 15. 淡深藍
            '#c9a8f0',  // 16. 淡中紫色
            '#b3e8ff',  // 17. 淡亮藍色
            '#80ff80',  // 18. 淡亮綠色
            '#80b5ff',  // 19. 淡系統藍
            '#ffb3a0',  // 20. 淡珊瑚紅
        ],
        'crypto': [
            // 加密貨幣主題 - 數位科技風（完全避免相近色，每個顏色差異極大，淡色版）
            '#ffcc80',  // 1. 淡橘色
            '#80ffff',  // 2. 淡青色
            '#ffeb80',  // 3. 淡金色
            '#80ff80',  // 4. 淡亮綠色
            '#ffa8a0',  // 5. 淡番茄紅
            '#80e5ff',  // 6. 淡深天藍
            '#ffeb80',  // 7. 淡黃色
            '#d9a8f8',  // 8. 淡紫色
            '#ff9980',  // 9. 淡橙紅色
            '#a8e8ff',  // 10. 淡淺藍色
            '#7ee58f',  // 11. 淡亮綠色
            '#6bb5ff',  // 12. 淡深藍色
            '#c9a8f0',  // 13. 淡中紫色
            '#80b5ff',  // 14. 淡系統藍
            '#7ee58f',  // 15. 淡翠綠色
            '#b3e8ff',  // 16. 淡亮藍色
            '#ffb3a0',  // 17. 淡珊瑚紅
            '#9bb3f0',  // 18. 淡天空藍
            '#9bb3f0',  // 19. 淡皇家藍
            '#a8a0e8',  // 20. 淡靛藍色
        ]
    };
    
    // 統一的備用顏色（當分類未定義時使用，淡色版）
    const CHART_ITEM_COLORS_FALLBACK = [
        '#b3e8ff',  // 淡藍色
        '#d9a8f8',  // 淡紫色
        '#ffcc80',  // 淡橘色
        '#7ee58f',  // 淡綠色
        '#ffa8a0',  // 淡紅色
        '#6bb5ff',  // 淡深藍色
        '#ffeb80',  // 淡黃色
        '#ffb3d0',  // 淡粉色
        '#a8e8ff',  // 淡淺藍色
        '#c9a8f0',  // 淡深紫色
        '#ffcc80',  // 淡深橘色
        '#7ee58f',  // 淡亮綠色
        '#ffa8c0',  // 淡玫瑰紅
        '#80b5ff',  // 淡系統藍
        '#a8a0e8',  // 淡靛藍色
        '#ff9980',  // 淡鮮紅色
        '#7ee58f',  // 淡翠綠色
        '#ffeb80',  // 淡金色
        '#ffb380',  // 淡珊瑚橘
        '#c0c0c0',  // 淡灰色
    ];

    let editingId = null;
    let chartInstance = null;
    let chartAnimationEngine = null; // 圖表動畫引擎
    let clickTimer = null; 
    let currentDetails = {};
    let chartLevel = 'root';
    let isEditMode = false;
    let sortables = [];
    let currentDetailAcc = null;
    
    // 統一的圖表動畫配置
    const CHART_ANIMATION_CONFIG = {
        animationType: 'switch',
        duration: 400,
        easing: 'easeOutQuart'
    };
    
    // Page Swiper
    let currentPage = 0;
    const PAGE_TYPES = ['overview', 'bank', 'stock', 'twstock', 'crypto'];
    
    const PAGE_NAMES = ['總覽', '錢包', '美股', '台股', '加密貨幣'];
    
    // 頁面載入時立即顯示載入遮罩
    (function() {
        // 確保 DOM 已準備好
        if(document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if(loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                }
            });
        } else {
            // DOM 已經準備好
            const loadingOverlay = document.getElementById('loadingOverlay');
            if(loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }
    })();
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;

    // 2. Define Data Loading Functions
    function safeParseFloat(val) { let v = parseFloat(val); return isNaN(v) ? 0 : v; }
    
    function tryMigrateOldData() {
        if (localStorage.getItem(STORAGE_KEY_DATA)) return;
        const oldKeys = ['myAssets_v6', 'myAssets_v5', 'myAssets_v4'];
        let found = false;
        for (let key of oldKeys) {
            let d = localStorage.getItem(key);
            if (d) { localStorage.setItem(STORAGE_KEY_DATA, d); found = true; break; }
        }
        let oldS = localStorage.getItem('myAssets_settings_v3');
        if (oldS) localStorage.setItem(STORAGE_KEY_SETTINGS, oldS);
        if (found) {
            const t = document.getElementById('migrationToast');
            t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
        }
    }
    
    // Execute Migration Immediately
    tryMigrateOldData();

    // Multi-User System
    let users = JSON.parse(localStorage.getItem(STORAGE_KEY_USERS)) || [];
    let currentUserId = localStorage.getItem(STORAGE_KEY_CURRENT_USER) || null;
    let editingUserId = null; // 用於頭像選擇器
    
    // Avatar Crop Variables
    let cropImage = null;
    let cropScale = 1;
    let cropX = 0;
    let cropY = 0;
    let cropSize = 200; // 裁切圓形直徑
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    
    // Touch events for mobile (avatar crop)
    let cropTouchStartDistance = 0;
    let cropTouchStartScale = 1;
    let cropTouchStartX = 0;
    let cropTouchStartY = 0;
    let isPinching = false;
    
    // Track if avatar selector was opened from edit modal
    let avatarSelectorFromEdit = false;

    // 如果沒有使用者，創建預設使用者
    if (users.length === 0) {
        const defaultUser = {
            id: Date.now().toString(),
            name: '使用者 1',
            avatar: DEFAULT_AVATARS[0],
            createdAt: new Date().toISOString()
        };
        users.push(defaultUser);
        currentUserId = defaultUser.id;
        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        localStorage.setItem(STORAGE_KEY_CURRENT_USER, currentUserId);
    }

    // 如果當前使用者不存在，使用第一個使用者
    if (!currentUserId || !users.find(u => u.id === currentUserId)) {
        currentUserId = users[0].id;
        localStorage.setItem(STORAGE_KEY_CURRENT_USER, currentUserId);
    }

    // Load State (多使用者版本)
    function loadUserData(userId) {
        const userDataKey = `${STORAGE_KEY_DATA}_${userId}`;
        const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${userId}`;
        
        const rawAccounts = JSON.parse(localStorage.getItem(userDataKey)) || [];
        const accounts = rawAccounts.map((a, index) => ({ 
            ...a, balance: safeParseFloat(a.balance), currentPrice: safeParseFloat(a.currentPrice), 
            dayChange: safeParseFloat(a.dayChange || 0), dayChangePercent: safeParseFloat(a.dayChangePercent || 0), 
            cost: safeParseFloat(a.cost || 0), order: (a.order!==undefined)?a.order:index, transactions: a.transactions || [] 
        }));
        
        const defaultSettings = { 
            apiKey: '', fugleKey: '', geminiKey: '', usdRate: 32.5, usdtRate: 1.0, feeRate: 0.1425, chartTextColor: 'white', theme: 'dark',
            cloudBackupEnabled: false, cloudBackupInterval: 24, cloudBackupLastTime: null, cloudBackupToken: null,
            pageVisibility: { 'overview': true, 'bank': true, 'stock': true, 'twstock': true, 'crypto': true },
            pageOrder: [0, 1, 2, 3, 4],
            displayCurrency: 'TWD'
        };
        
        // 載入用戶設定
        const savedSettings = JSON.parse(localStorage.getItem(userSettingsKey)) || {};
        const settings = { ...defaultSettings, ...savedSettings };
        
        return { accounts, settings };
    }

    // 遷移舊資料到第一個使用者（向後兼容）
    if (!localStorage.getItem(`${STORAGE_KEY_DATA}_${currentUserId}`)) {
        const oldData = localStorage.getItem(STORAGE_KEY_DATA);
        const oldSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);
        if (oldData) {
            localStorage.setItem(`${STORAGE_KEY_DATA}_${currentUserId}`, oldData);
        }
        if (oldSettings) {
            localStorage.setItem(`${STORAGE_KEY_SETTINGS}_${currentUserId}`, oldSettings);
        }
    }

    let { accounts, settings } = loadUserData(currentUserId);
    
    // Currency Display（從 settings 讀取，如果沒有則從 localStorage，都沒有則使用預設值）
    let currentDisplayCurrency = settings.displayCurrency || localStorage.getItem('displayCurrency') || 'TWD'; // 'TWD' or 'USD'
    // 如果 settings 中有值，同步到 localStorage（向後兼容）
    if(settings.displayCurrency) {
        localStorage.setItem('displayCurrency', settings.displayCurrency);
    }
    // 如果 settings 中沒有值但 localStorage 有值，更新 settings
    if(!settings.displayCurrency && localStorage.getItem('displayCurrency')) {
        settings.displayCurrency = currentDisplayCurrency;
    }
    
    // 分頁顯示設置（從 settings 讀取，如果沒有則從 localStorage，都沒有則使用預設值）
    let pageVisibility = settings.pageVisibility || JSON.parse(localStorage.getItem('pageVisibility')) || {
        'overview': true,
        'bank': true,
        'stock': true,
        'twstock': true,
        'crypto': true
    };
    // 如果 settings 中有值，同步到 localStorage（向後兼容）
    if(settings.pageVisibility) {
        localStorage.setItem('pageVisibility', JSON.stringify(settings.pageVisibility));
    }
    // 如果 settings 中沒有值但 localStorage 有值，更新 settings
    if(!settings.pageVisibility && localStorage.getItem('pageVisibility')) {
        settings.pageVisibility = pageVisibility;
    }
    
    // 分頁順序設置（從 settings 讀取，如果沒有則從 localStorage，都沒有則使用預設值）
    let pageOrder = settings.pageOrder || JSON.parse(localStorage.getItem('pageOrder')) || [0, 1, 2, 3, 4];
    
    // 【新增】用於防止切換使用者期間的意外存檔
    let isUserSwitching = false;
    // 如果 settings 中有值，同步到 localStorage（向後兼容）
    if(settings.pageOrder) {
        localStorage.setItem('pageOrder', JSON.stringify(settings.pageOrder));
    }
    // 如果 settings 中沒有值但 localStorage 有值，更新 settings
    if(!settings.pageOrder && localStorage.getItem('pageOrder')) {
        settings.pageOrder = pageOrder;
    }
    
    // 選單區塊摺疊狀態（預設全部摺疊，不記錄上次狀態）
    let menuSectionsState = {
        'update': true,
        'data': true,
        'pnl': true,
        'api': true,
        'pages': true
    };
    
    // 切換選單區塊摺疊/展開
    function toggleMenuSection(sectionId) {
        const section = document.getElementById(`menuSection-${sectionId}`);
        const label = event.currentTarget;

        if(!section) return;

        const isCollapsed = section.classList.contains('collapsed');

        if(isCollapsed) {
            section.classList.remove('collapsed');
            label.classList.remove('collapsed');
            menuSectionsState[sectionId] = false;
        } else {
            section.classList.add('collapsed');
            label.classList.add('collapsed');
            menuSectionsState[sectionId] = true;
        }

        // 不保存狀態到 localStorage，每次重新打開都會重置為摺疊
    }
    
    // 初始化選單區塊狀態（強制全部摺疊）
    function initMenuSections() {
        // 每次初始化都強制重置為摺疊狀態
        Object.keys(menuSectionsState).forEach(sectionId => {
            menuSectionsState[sectionId] = true;
        });

        Object.keys(menuSectionsState).forEach(sectionId => {
            const section = document.getElementById(`menuSection-${sectionId}`);
            // 找到對應的 label（通過查找包含該 sectionId 的 onclick 屬性）
            const labels = document.querySelectorAll('.menu-label');
            let label = null;
            labels.forEach(l => {
                if(l.getAttribute('onclick') && l.getAttribute('onclick').includes(`'${sectionId}'`)) {
                    label = l;
                }
            });

            if(section && label) {
                // 強制全部摺疊
                section.classList.add('collapsed');
                label.classList.add('collapsed');
            }
        });
    }
    
    // 獲取帳戶標籤的 class（根據帳戶類型）
    function getAccountTagClass(account) {
        const bankTag = account.bankTag || '帳戶';
        let tagClass = 'account-tag-account'; // 預設為帳戶
        if(bankTag === '銀行') {
            tagClass = 'account-tag-bank';
        } else if(bankTag === '信用卡') {
            tagClass = 'account-tag-credit';
        } else if(bankTag === '簽帳金融卡') {
            tagClass = 'account-tag-debit';
        } else if(bankTag === '帳戶') {
            tagClass = 'account-tag-account';
        } else if(bankTag === '負債') {
            tagClass = 'account-tag-debt';
        }
        return tagClass;
    }
    
    // 生成帳戶標籤 HTML（可以有多個標籤）
    function generateAccountTagHTML(account) {
        const bankTag = account.bankTag || '帳戶';
        const bankName = account.bankName || '';
        
        // 判斷是否是銀行、信用卡、簽帳金融卡
        const isBankType = bankTag === '銀行' || bankTag === '信用卡' || bankTag === '簽帳金融卡';
        
        // 根據 bankTag 決定分類標籤的 class
        let tagClass = getAccountTagClass(account);
        
        // 生成標籤 HTML 陣列
        const tags = [];
        
        if(isBankType && bankName) {
            // 如果是銀行類型且有銀行名稱，分成兩個標籤：第一個顯示 tag（根據類型不同顏色），第二個顯示銀行名稱（淡藍底）
            tags.push(`<span class="account-tag ${tagClass}">${bankTag}</span>`);
            tags.push(`<span class="account-tag account-tag-bank-name">${bankName}</span>`);
        } else {
            // 其他情況直接顯示 tag（根據類型不同顏色）
            tags.push(`<span class="account-tag ${tagClass}">${bankTag}</span>`);
        }
        
        // 返回所有標籤的 HTML（用空格分隔，讓標籤之間有間距）
        return tags.join(' ');
    }
    
    // 保存分頁顯示設置
    function savePageVisibility() {
        localStorage.setItem('pageVisibility', JSON.stringify(pageVisibility));
        // 同步到 settings 並保存到 Firestore
        settings.pageVisibility = pageVisibility;
        saveSettings();
    }
    
    // 保存分頁順序
    function savePageOrder() {
        localStorage.setItem('pageOrder', JSON.stringify(pageOrder));
        // 同步到 settings 並保存到 Firestore
        settings.pageOrder = pageOrder;
        saveSettings();
    }
    
    // 獲取排序後的分頁順序（只包含啟用的分頁）
    function getOrderedPages() {
        // 先按照 pageOrder 排序，然後過濾出啟用的分頁
        const ordered = pageOrder.filter(index => isPageEnabled(index));
        // 確保總覽始終在第一位（如果啟用）
        if(ordered.includes(0)) {
            const overviewIndex = ordered.indexOf(0);
            ordered.splice(overviewIndex, 1);
            ordered.unshift(0);
        }
        return ordered;
    }
    
    // 根據順序獲取分頁在顯示中的位置索引
    function getDisplayIndex(pageIndex) {
        const orderedPages = getOrderedPages();
        return orderedPages.indexOf(pageIndex);
    }
    
    // 根據顯示位置索引獲取實際的分頁索引
    function getPageIndexByDisplay(displayIndex) {
        const orderedPages = getOrderedPages();
        return orderedPages[displayIndex] || 0;
    }
    
    // 重新排列 page-item 的 DOM 順序，使其與 pageOrder 一致
    function reorderPageItems() {
        const container = document.getElementById('pageContainer');
        if(!container) return -1;
        
        // 獲取排序後的順序（只包含啟用的分頁）
        const orderedPages = getOrderedPages();
        
        // 獲取所有 page-item
        const pageItems = Array.from(container.children);
        
        // 按照 orderedPages 的順序重新排列
        const sortedItems = [];
        orderedPages.forEach(pageIndex => {
            const item = pageItems.find(item => parseInt(item.getAttribute('data-page')) === pageIndex);
            if(item) {
                sortedItems.push(item);
            }
        });
        
        // 將未啟用的分頁放在最後
        pageItems.forEach(item => {
            const pageIndex = parseInt(item.getAttribute('data-page'));
            if(!orderedPages.includes(pageIndex)) {
                sortedItems.push(item);
            }
        });
        
        // 重新插入到 DOM 中
        sortedItems.forEach(item => {
            container.appendChild(item);
        });
        
        // 返回當前分頁在重新排列後的 DOM 索引
        const domIndex = sortedItems.findIndex(item => parseInt(item.getAttribute('data-page')) === currentPage);
        return domIndex >= 0 ? domIndex : -1;
    }
    
    // 檢查分頁是否啟用
    function isPageEnabled(pageIndex) {
        if(pageIndex === 0) return pageVisibility['overview']; // 總覽始終可用
        const pageType = PAGE_TYPES[pageIndex];
        return pageVisibility[pageType] !== false; // 預設為 true
    }
    
    // 獲取所有啟用的分頁索引
    function getEnabledPages() {
        return PAGE_TYPES.map((type, index) => {
            if(index === 0) return pageVisibility['overview'] ? 0 : null;
            return pageVisibility[type] !== false ? index : null;
        }).filter(index => index !== null);
    }
    
    // 渲染分頁顯示設置
    function renderPageVisibilitySettings() {
        const container = document.getElementById('pageVisibilitySettings');
        if(!container) return;
        
        container.innerHTML = '';
        
        // 按照 pageOrder 順序渲染（排除總覽）
        const orderedPages = pageOrder.filter(index => index !== 0);
        
        orderedPages.forEach((pageIndex) => {
            const pageName = PAGE_NAMES[pageIndex];
            const isEnabled = isPageEnabled(pageIndex);
            
            const item = document.createElement('div');
            item.className = 'page-visibility-item';
            item.setAttribute('data-page-index', pageIndex);
            item.innerHTML = `
                <i class="fas fa-grip-vertical drag-handle"></i>
                <label>
                    <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                           onchange="togglePageVisibility(${pageIndex}, this.checked)">
                    <span>${pageName}</span>
                </label>
            `;
            container.appendChild(item);
        });
        
        // 設置拖曳排序
        // 使用 setTimeout 確保 DOM 完全渲染後再初始化 Sortable
        setTimeout(() => {
            if(typeof Sortable !== 'undefined') {
                // 銷毀舊的實例
                const existingSortable = container.sortableInstance;
                if(existingSortable) {
                    existingSortable.destroy();
                }
                
                // 創建新的 Sortable 實例
                container.sortableInstance = Sortable.create(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    filter: 'input, label', // 排除 checkbox 和 label，只允許通過 drag-handle 拖曳
                    preventOnFilter: false,
                    onStart: function() {
                        // 開始拖動時，禁用左右滑動
                        isSorting = true;
                    },
                    onEnd: function(evt) {
                        // 結束拖動時，恢復左右滑動
                        isSorting = false;
                        
                        // 獲取新的順序（使用外層的 container，這是 pageVisibilitySettings 容器）
                        const settingsContainer = container;
                        const newOrder = Array.from(settingsContainer.children).map(item => {
                            return parseInt(item.getAttribute('data-page-index'));
                        });
                        
                        // 更新 pageOrder（保持總覽在第一位）
                        pageOrder = [0, ...newOrder];
                        savePageOrder();
                        
                        // 重新排列 page-item 的 DOM 順序（必須在 renderPageIndicator 之前）
                        const domIndex = reorderPageItems();
                        
                        // 重新渲染界面（renderPageIndicator 會根據新的 pageOrder 重新渲染）
                        renderPageIndicator();
                        // 注意：不要在這裡調用 renderPageVisibilitySettings()，因為這會重新初始化 Sortable
                        // 只需要更新主畫面的順序即可
                        renderAssets();
                        updateChartData();
                        
                        // 確保當前分頁的位置正確
                        const pageContainer = document.getElementById('pageContainer');
                        if(pageContainer) {
                            const finalIndex = domIndex >= 0 ? domIndex : getDisplayIndex(currentPage);
                            pageContainer.style.transform = `translateX(-${finalIndex * 100}%)`;
                        }
                        
                        // 更新導航箭頭狀態
                        updatePageNavArrows();
                    }
                });
            } else {
                console.warn('Sortable library not loaded');
            }
        }, 100);
    }
    
    // 渲染分頁指示器（只顯示啟用的分頁，按照順序）
    function renderPageIndicator() {
        const indicator = document.querySelector('.page-indicator');
        if(!indicator) return;
        
        indicator.innerHTML = '';
        
        // 按照排序後的順序顯示
        const orderedPages = getOrderedPages();
        
        orderedPages.forEach((pageIndex) => {
            const pageName = PAGE_NAMES[pageIndex];
            const shortName = pageIndex === 0 ? '總覽' : (pageIndex === 1 ? '錢包' : (pageIndex === 2 ? '美股' : (pageIndex === 3 ? '台股' : '加密')));
            const tab = document.createElement('button');
            tab.className = `page-tab ${currentPage === pageIndex ? 'active' : ''}`;
            tab.setAttribute('data-page', pageIndex);
            tab.onclick = () => switchToPage(pageIndex);
            tab.textContent = shortName;
            indicator.appendChild(tab);
        });
        
        // 確保分頁指示器顯示（如果之前被隱藏）
        if(orderedPages.length > 0) {
            indicator.style.display = 'flex';
        }
    }
    
    // 切換分頁顯示
    function togglePageVisibility(pageIndex, enabled) {
        // 總覽分頁（index 0）不會出現在選項中，所以這裡不需要檢查
        const pageType = PAGE_TYPES[pageIndex];
        pageVisibility[pageType] = enabled;
        
        savePageVisibility();
        
        // 如果當前分頁被隱藏，切換到第一個啟用的分頁
        if(!enabled && currentPage === pageIndex) {
            const orderedPages = getOrderedPages();
            if(orderedPages.length > 0) {
                switchToPage(orderedPages[0]);
            }
        }
        
        // 重新渲染界面
        renderPageVisibilitySettings();
        renderPageIndicator();
        renderAssets();
        updateChartData();
    }

    // 3. Define ALL Functions (Chart, UI, Logic)

    // --- Helper Functions ---
    // 將十六進制顏色轉換為 HSL 色調值
    function hexToHue(hex) {
        // 移除 # 符號
        hex = hex.replace('#', '');
        
        // 轉換為 RGB
        const r = parseInt(hex.substr(0, 2), 16) / 255;
        const g = parseInt(hex.substr(2, 2), 16) / 255;
        const b = parseInt(hex.substr(4, 2), 16) / 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        const delta = max - min;
        
        let hue = 0;
        if (delta !== 0) {
            if (max === r) {
                hue = ((g - b) / delta) % 6;
            } else if (max === g) {
                hue = (b - r) / delta + 2;
            } else {
                hue = (r - g) / delta + 4;
            }
        }
        hue = Math.round(hue * 60);
        return hue < 0 ? hue + 360 : hue;
    }

    // --- Chart Animation Engine ---
    class ChartAnimationEngine {
        constructor(chart) {
            this.chart = chart;
            this.isAnimating = false;
            this.animationQueue = [];
            this.currentAnimationFrameId = null;
            this.currentTimeoutIds = [];
        }
        
        // 取消當前動畫
        cancel() {
            if (this.currentAnimationFrameId !== null) {
                cancelAnimationFrame(this.currentAnimationFrameId);
                this.currentAnimationFrameId = null;
            }
            // 清除所有 setTimeout
            this.currentTimeoutIds.forEach(id => clearTimeout(id));
            this.currentTimeoutIds = [];
            // 清空動畫隊列
            this.animationQueue = [];
            this.isAnimating = false;
        }

        // 主要的動畫方法 - 支持所有場景
        animate(options) {
            const {
                newData,
                animationType = 'switch', // 'switch', 'refresh', 'simulate'
                duration = 800,
                easing = 'easeOutQuart',
                onStart,
                onProgress,
                onComplete
            } = options;

            // 如果正在動畫中，取消當前動畫並立即開始新的動畫
            if (this.isAnimating) {
                this.cancel();
            }

            this.isAnimating = true;
            // 清除之前的動畫ID
            this.currentAnimationFrameId = null;
            this.currentTimeoutIds = [];

            if (onStart) onStart();

            switch (animationType) {
                case 'switch':
                    this.animateSwitch(newData, duration, easing, onProgress, () => {
                        this.isAnimating = false;
                        if (onComplete) onComplete();
                        this.processQueue();
                    });
                    break;

                case 'refresh':
                    this.animateRefresh(newData, duration, easing, onProgress, () => {
                        this.isAnimating = false;
                        if (onComplete) onComplete();
                        this.processQueue();
                    });
                    break;

                case 'simulate':
                    this.animateSimulate(newData, duration, easing, onProgress, () => {
                        this.isAnimating = false;
                        if (onComplete) onComplete();
                        this.processQueue();
                    });
                    break;

                default:
                    this.animateSwitch(newData, duration, easing, onProgress, () => {
                        this.isAnimating = false;
                        if (onComplete) onComplete();
                        this.processQueue();
                    });
            }
        }

        // 分類切換動畫 - 手動步進式動畫（支持不同數量項目）
        animateSwitch(newData, duration, easing, onProgress, onComplete) {
            if (!this.chart || !this.chart.series) {
                if (onComplete) onComplete();
                return;
            }
            
            // 如果沒有系列，先創建一個空系列以便動畫可以工作
            if (!this.chart.series[0] || this.chart.series[0].data.length === 0) {
                // 使用空數據初始化系列
                this.chart.addSeries({
                    name: '資產',
                    data: newData.map(item => ({ name: item.name, y: 0, color: item.color || '#667eea' })),
                    type: 'pie',
                    innerSize: '55%',
                    size: '90%',
                    center: ['50%', '50%'],
                    borderWidth: 0,
                    slicedOffset: 8,
                    animation: { duration: 0 },
                    dataLabels: { enabled: true },
                    states: { hover: { enabled: false } }
                }, false);
            }
            
            if (!this.chart.series[0]) {
                if (onComplete) onComplete();
                return;
            }

            // 獲取起始數據（按名稱建立映射）
            const startDataMap = new Map();
            this.chart.series[0].data.forEach(point => {
                startDataMap.set(point.name, {
                    name: point.name,
                    y: point.y,
                    color: point.color || point.options?.color
                });
            });

            // 建立目標數據映射
            const targetDataMap = new Map();
            newData.forEach(item => {
                targetDataMap.set(item.name, {
                    name: item.name,
                    y: item.y,
                    color: item.color
                });
            });

            // 合併所有唯一的項目名稱（起始 + 目標）
            const allNames = new Set([...startDataMap.keys(), ...targetDataMap.keys()]);
            
            // 建立動畫映射：每個項目都有起始值和目標值
            const animationMap = new Map();
            allNames.forEach(name => {
                const startPoint = startDataMap.get(name) || { name, y: 0, color: targetDataMap.get(name)?.color || '#667eea' };
                const targetPoint = targetDataMap.get(name) || { name, y: 0, color: startPoint.color };
                animationMap.set(name, {
                    start: startPoint.y,
                    target: targetPoint.y,
                    color: targetPoint.color || startPoint.color
                });
            });

            const startTime = performance.now();
            let lastUpdateTime = startTime;
            let frameCount = 0;

            const animate = (currentTime) => {
                // 檢查動畫是否已被取消
                if (!this.isAnimating) {
                    return;
                }
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = this.easeFunctions[easing] ? this.easeFunctions[easing](progress) : progress;

                // 限制更新頻率，避免過於頻繁的重繪（約60fps）
                if (currentTime - lastUpdateTime >= 16) {
                    // 計算每個項目的中間值，按照目標數據的順序排列
                    const intermediateData = [];
                    
                    // 先添加目標數據中存在的項目（按目標順序）
                    newData.forEach(targetItem => {
                        const anim = animationMap.get(targetItem.name);
                        if (anim) {
                            const currentY = anim.start + (anim.target - anim.start) * easedProgress;
                            
                            // 只包含值大於0的項目（避免顯示0值項目）
                            if (currentY > 0.1 || progress >= 1) {
                                intermediateData.push({
                                    name: targetItem.name,
                                    y: Math.max(0, currentY),
                                    color: anim.color
                                });
                            }
                        }
                    });
                    
                    // 再添加只在起始數據中存在的項目（將要消失的項目）
                    allNames.forEach(name => {
                        if (!targetDataMap.has(name) && startDataMap.has(name)) {
                            const anim = animationMap.get(name);
                            const currentY = anim.start + (anim.target - anim.start) * easedProgress;
                            
                            // 只包含值大於0的項目
                            if (currentY > 0.1) {
                                intermediateData.push({
                                    name: name,
                                    y: Math.max(0, currentY),
                                    color: anim.color
                                });
                            }
                        }
                    });

                    // 更新圖表數據，保持起始角度不變
                    try {
                        this.chart.series[0].setData(intermediateData, false);
                        this.chart.redraw(false);
                    } catch (e) {
                        console.error('動畫更新錯誤:', e);
                    }

                    lastUpdateTime = currentTime;
                }

                if (onProgress) onProgress(easedProgress);

                if (progress < 1) {
                    this.currentAnimationFrameId = requestAnimationFrame(animate);
                } else {
                    // 最終更新到精確值（只包含目標數據中存在的項目）
                    try {
                        this.chart.series[0].setData(newData, false);
                        this.chart.redraw(false);
                    } catch (e) {
                        console.error('最終更新錯誤:', e);
                    }
                    if (onProgress) onProgress(1.0);
                    onComplete();
                }
            };

            this.currentAnimationFrameId = requestAnimationFrame(animate);
        }

        // 數據重新整理動畫 - 帶載入效果
        animateRefresh(newData, duration, easing, onProgress, onComplete) {
            // 第一階段：顯示載入狀態 (淡出舊數據)
            this.fadeOutSeries(300, () => {
                // 檢查動畫是否已被取消
                if (!this.isAnimating) {
                    return;
                }
                if (onProgress) onProgress(0.3);

                // 第二階段：數據更新 (隱藏狀態)
                const timeoutId1 = setTimeout(() => {
                    // 檢查動畫是否已被取消
                    if (!this.isAnimating) {
                        return;
                    }
                    if (!this.chart || !this.chart.series || !this.chart.series[0]) {
                        if (onComplete) onComplete();
                        return;
                    }

                    this.chart.series[0].setData(newData, false);
                    this.chart.redraw(false);

                    if (onProgress) onProgress(0.7);

                    // 第三階段：淡入新數據
                    const timeoutId2 = setTimeout(() => {
                        // 檢查動畫是否已被取消
                        if (!this.isAnimating) {
                            return;
                        }
                        this.chart.series[0].setData(newData, true);
                        if (onProgress) onProgress(1.0);
                        const timeoutId3 = setTimeout(() => {
                            if (!this.isAnimating) {
                                return;
                            }
                            onComplete();
                        }, duration + 100);
                        this.currentTimeoutIds.push(timeoutId3);
                    }, 200);
                    this.currentTimeoutIds.push(timeoutId2);
                }, 200);
                this.currentTimeoutIds.push(timeoutId1);
            });
        }

        // 數據變化模擬動畫 - 步進式更新（支持不同數量的項目）
        animateSimulate(targetData, totalDuration, easing, onProgress, onComplete) {
            if (!this.chart || !this.chart.series || !this.chart.series[0]) {
                if (onComplete) onComplete();
                return;
            }

            // 獲取起始數據（按名稱建立映射）
            const startDataMap = new Map();
            this.chart.series[0].data.forEach(point => {
                startDataMap.set(point.name, {
                    name: point.name,
                    y: point.y,
                    color: point.color || point.options?.color
                });
            });

            // 建立目標數據映射
            const targetDataMap = new Map();
            targetData.forEach(item => {
                targetDataMap.set(item.name, {
                    name: item.name,
                    y: item.y,
                    color: item.color
                });
            });

            // 合併所有唯一的項目名稱（起始 + 目標）
            const allNames = new Set([...startDataMap.keys(), ...targetDataMap.keys()]);
            
            // 建立動畫映射：每個項目都有起始值和目標值
            const animationMap = new Map();
            allNames.forEach(name => {
                const startPoint = startDataMap.get(name) || { name, y: 0, color: targetDataMap.get(name)?.color || '#667eea' };
                const targetPoint = targetDataMap.get(name) || { name, y: 0, color: startPoint.color };
                animationMap.set(name, {
                    start: startPoint.y,
                    target: targetPoint.y,
                    color: targetPoint.color || startPoint.color
                });
            });

            const steps = 15;
            const stepDuration = totalDuration / steps;
            let currentStep = 0;

            const animateStep = () => {
                // 檢查動畫是否已被取消
                if (!this.isAnimating) {
                    return;
                }
                
                currentStep++;
                const progress = currentStep / steps;
                const easedProgress = this.easeFunctions[easing](progress);

                // 計算每個項目的中間值
                const intermediateData = [];
                allNames.forEach(name => {
                    const anim = animationMap.get(name);
                    const currentY = anim.start + (anim.target - anim.start) * easedProgress;
                    
                    // 只包含值大於0的項目（避免顯示0值項目）
                    if (currentY > 0.1 || currentStep === steps) {
                        intermediateData.push({
                            name: name,
                            y: Math.max(0, currentY),
                            color: anim.color
                        });
                    }
                });

                // 更新圖表（無動畫，避免閃爍）
                try {
                    this.chart.series[0].setData(intermediateData, false);
                    this.chart.redraw(false);
                } catch (e) {
                    console.error('動畫更新錯誤:', e);
                }

                if (onProgress) onProgress(easedProgress);

                if (currentStep < steps) {
                    const timeoutId = setTimeout(animateStep, stepDuration);
                    this.currentTimeoutIds.push(timeoutId);
                } else {
                    // 檢查動畫是否已被取消
                    if (!this.isAnimating) {
                        return;
                    }
                    // 最終更新到精確值（只包含目標數據中存在的項目）
                    try {
                        this.chart.series[0].setData(targetData, false);
                        this.chart.redraw(false);
                    } catch (e) {
                        console.error('最終更新錯誤:', e);
                    }
                    onComplete();
                }
            };

            animateStep();
        }

        // 淡出系列
        fadeOutSeries(duration, callback) {
            const series = this.chart.series[0];
            if (!series) {
                if (callback) callback();
                return;
            }

            // 動畫淡出
            series.points.forEach(point => {
                if (point.graphic) {
                    point.graphic.animate({
                        opacity: 0
                    }, {
                        duration: duration,
                        easing: 'easeOut'
                    });
                }
            });

            // 同時淡出標籤
            if (series.dataLabelsGroup) {
                series.dataLabelsGroup.animate({
                    opacity: 0
                }, {
                    duration: duration,
                    easing: 'easeOut'
                });
            }

            const timeoutId = setTimeout(() => {
                if (callback) callback();
            }, duration);
            this.currentTimeoutIds.push(timeoutId);
        }

        // Easing 函數
        easeFunctions = {
            linear: t => t,
            easeIn: t => t * t,
            easeOut: t => t * (2 - t),
            easeInOut: t => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
            easeOutQuart: t => 1 - Math.pow(1 - t, 4),
            easeInQuart: t => t * t * t * t,
            bounce: t => {
                if (t < 1/2.75) return 7.5625 * t * t;
                if (t < 2/2.75) return 7.5625 * (t -= 1.5/2.75) * t + 0.75;
                if (t < 2.5/2.75) return 7.5625 * (t -= 2.25/2.75) * t + 0.9375;
                return 7.5625 * (t -= 2.625/2.75) * t + 0.984375;
            }
        };

        // 處理動畫隊列
        processQueue() {
            if (this.animationQueue.length > 0) {
                const nextAnimation = this.animationQueue.shift();
                this.animate(nextAnimation);
            }
        }
    }

    // --- Chart ---
    function onPointClick(e) { 
        e.stopPropagation(); 
        if (clickTimer) { 
            clearTimeout(clickTimer); clickTimer = null; 
            if((chartLevel==='root' || currentPage === 0) && currentDetails[this.drilldown]){ 
                hideCustomTooltip(); 
                enterDetailLevel(this.drilldown, currentDetails[this.drilldown]);
            } 
        } else { 
            let t=this; let ex=e; 
            clickTimer=setTimeout(function(){ clickTimer=null; activeInactivePoints.clear(); if(t.sliced){ t.slice(false); t.setState('normal'); const prevPointEl = t.graphic?.element; if(prevPointEl) { prevPointEl.style.setProperty('opacity', '1', 'important'); } if(t.series.data) t.series.data.forEach(p=>{ if(p!==t) { p.setState('normal'); const pEl = p.graphic?.element; if(pEl) pEl.style.setProperty('opacity', '1', 'important'); } }); hideCustomTooltip(); } else { if(t.series.data) { t.series.data.forEach(p=>{ if(p!==t){ if(p.sliced) { p.slice(false); p.setState('inactive'); const pointEl = p.graphic?.element; if(pointEl) { const pointId = pointEl.getAttribute('data-highcharts-point-index') || pointEl.getAttribute('class') || `point-${p.index}`; activeInactivePoints.add(pointId); pointEl.style.setProperty('opacity', '0.3', 'important'); } } else { p.setState('inactive'); const pointEl = p.graphic?.element; if(pointEl) { const pointId = pointEl.getAttribute('data-highcharts-point-index') || pointEl.getAttribute('class') || `point-${p.index}`; activeInactivePoints.add(pointId); pointEl.style.setProperty('opacity', '0.3', 'important'); } } } }); } t.slice(true); t.setState('normal'); const newPointEl = t.graphic?.element; if(newPointEl) { newPointEl.style.setProperty('opacity', '1', 'important'); } showCustomTooltip(t, ex); } }, 250); 
        } 
    }
    
    function showCustomTooltip(p,e){ 
        const t=document.getElementById('customTooltip'); 
        const w=document.getElementById('chartWrapper'); 
        t.querySelector('.tt-header').innerText=p.name; 
        const formattedAmount = currentDisplayCurrency === 'USD' ? parseFloat(p.y).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : Math.round(p.y).toLocaleString();
        t.querySelector('.tt-body').innerHTML=`<span class="tt-dot" style="background-color:${p.color}"></span>資產: ${formattedAmount} ${currentDisplayCurrency}`; 
        t.className=''; t.style.display='block'; 
        let cx=e.chartX; let cy=e.chartY; 
        if(!cx&&e.clientX){const r=w.getBoundingClientRect();cx=e.clientX-r.left;cy=e.clientY-r.top;} 
        const tw=t.offsetWidth; const th=t.offsetHeight; 
        let top=cy-th-25; let left=cx; 
        if(cy<160){top=cy+30;t.classList.add('bottom');}else{t.classList.remove('bottom');} 
        if(left<tw/2)left=tw/2+10; if(left>w.offsetWidth-tw/2)left=w.offsetWidth-tw/2-10; 
        t.style.top=top+'px'; t.style.left=left+'px'; 
    }
    
    function hideCustomTooltip(){ document.getElementById('customTooltip').style.display='none'; }

    function updateChartData(animate = true) { 
        if(!Highcharts)return; 
        let groups={'bank':0,'stock':0,'twstock':0,'crypto':0}; 
        currentDetails={'bank':[],'stock':[],'twstock':[],'crypto':[]}; 
        
        accounts.forEach(acc=>{ 
            if(acc.type==='debt')return;
            // 排除信用卡（不納入資產分佈）
            if(acc.type === 'bank' && acc.bankTag === '信用卡') return;
            // 只計算啟用分頁的資產
            if(acc.type === 'bank' && !pageVisibility['bank']) return;
            if(acc.type === 'stock' && !pageVisibility['stock']) return;
            if(acc.type === 'twstock' && !pageVisibility['twstock']) return;
            if(acc.type === 'crypto' && !pageVisibility['crypto']) return;
            
            let val=calculateValue(acc); 
            if(val>0){ 
                if(groups[acc.type]!==undefined){ 
                    groups[acc.type]+=val; 
                    // 美股顯示代碼，台股顯示公司名稱
                    let displayName = acc.name;
                    if(acc.type === 'stock') {
                        let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                        displayName = sym || acc.name;
                    }
                    currentDetails[acc.type].push({name:displayName,y:currentDisplayCurrency === 'USD' ? parseFloat(val) : Math.round(val)}); 
                } 
            } 
        }); 
        
        // 根據當前分頁和圖表層級決定顯示的數據
        let chartData = [];
        let chartTitle = '';
        
        if(chartLevel === 'root' || (chartLevel === 'page' && currentPage === 0)) {
            // 總覽分頁：顯示四個類別的總覽，使用各分類主題的第一個顏色
            chartData = [
                {name:TYPE_NAMES['bank'],y:Math.round(groups.bank),drilldown:'bank',color:CHART_ITEM_COLOR_PALETTES['bank']?.[0] || TYPE_COLORS.bank},
                {name:TYPE_NAMES['stock'],y:Math.round(groups.stock),drilldown:'stock',color:CHART_ITEM_COLOR_PALETTES['stock']?.[0] || TYPE_COLORS.stock},
                {name:TYPE_NAMES['twstock'],y:Math.round(groups.twstock),drilldown:'twstock',color:CHART_ITEM_COLOR_PALETTES['twstock']?.[0] || TYPE_COLORS.twstock},
                {name:TYPE_NAMES['crypto'],y:Math.round(groups.crypto),drilldown:'crypto',color:CHART_ITEM_COLOR_PALETTES['crypto']?.[0] || TYPE_COLORS.crypto}
            ].filter(d=>d.y>0);
            chartTitle = '';
        } else if(chartLevel === 'page' && currentPage > 0) {
            // 分頁模式：顯示當前分頁類別內的資產分布
            const currentType = PAGE_TYPES[currentPage];
            // 使用該分類專屬的色系（循環使用）
            const colorPalette = CHART_ITEM_COLOR_PALETTES[currentType] || CHART_ITEM_COLORS_FALLBACK;
            chartData = (currentDetails[currentType] || []).map((item, index) => {
                return {
                    ...item,
                    color: colorPalette[index % colorPalette.length]
                };
            });
            chartTitle = PAGE_NAMES[currentPage];
        } else if(chartLevel === 'detail') {
            // 詳細模式：已經在enterDetailLevel中處理，不在此更新
            return;
        }
        
        // 禁用 Highcharts 內建動畫，使用自定義動畫引擎
        const animationConfig = {duration:0};
        
        // 處理空數據：如果沒有數據且已有圖表實例，清除圖表
        if (chartData.length === 0 && chartInstance) {
            // 取消當前動畫
            if (chartAnimationEngine && chartAnimationEngine.isAnimating) {
                chartAnimationEngine.cancel();
            }
            // 清除標題
            if (chartInstance) {
                chartInstance.setTitle({text:'',style:{color:'#fff',fontSize:'14px'},align:'center',verticalAlign:'middle',y:10});
                // 清除所有系列
                while(chartInstance.series.length > 0) {
                    chartInstance.series[0].remove(false);
                }
                chartInstance.redraw();
            }
            return;
        }
        
        if(!chartInstance){ 
            // 如果沒有數據，不創建圖表
            if (chartData.length === 0) {
                return;
            }
            const chartTextColor = getChartTextColor();
            chartInstance=Highcharts.chart('assetChart',{
                chart:{type:'pie',backgroundColor:'transparent',spacing:[30,20,20,20],height:'100%',width:null,reflow:true,margin:[30,20,20,20]},
                title:{text:chartTitle,style:{color:chartTextColor,fontSize:'14px'},align:'center',verticalAlign:'middle',y:10},
                credits:{enabled:false},tooltip:{enabled:false},
                plotOptions:{pie:{innerSize:'55%',size:'90%',center:['50%','50%'],borderWidth:0,slicedOffset:8,animation:animationConfig,dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:chartTextColor,textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666',softConnector:true},states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}}}},
                series:[{name:'資產',data:chartData}]
            }); 
            disableChartHover();
            // 初始化動畫引擎
            if (!chartAnimationEngine && chartInstance) {
                chartAnimationEngine = new ChartAnimationEngine(chartInstance);
            }
        } else { 
            if(chartLevel==='root' || (chartLevel==='page' && (currentPage === 0 || currentPage > 0))){ 
                const chartTextColor = getChartTextColor();
                chartInstance.setTitle({text:chartTitle,style:{color:chartTextColor,fontSize:'14px'},align:'center',verticalAlign:'middle',y:10});
                
                if(chartInstance.series.length===0){ 
                    chartInstance.addSeries({name:'資產',data:chartData,type:'pie',innerSize:'55%',size:'90%',center:['50%','50%'],borderWidth:0,slicedOffset:8,animation:{duration:0},dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:chartTextColor,textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'},states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}}}, false); 
                    disableChartHover();
                    // 初始化動畫引擎
                    if (!chartAnimationEngine) {
                        chartAnimationEngine = new ChartAnimationEngine(chartInstance);
                    }
                } else { 
                    // 使用動畫引擎更新圖表
                    if (chartAnimationEngine && animate) {
                        chartAnimationEngine.animate({
                            newData: chartData,
                            animationType: CHART_ANIMATION_CONFIG.animationType,
                            duration: CHART_ANIMATION_CONFIG.duration,
                            easing: CHART_ANIMATION_CONFIG.easing,
                            onComplete: () => {
                                // 更新圖表大小
                                chartInstance.series[0].update({size:'90%'}, false);
                            }
                        });
                    } else {
                        // 沒有動畫或動畫引擎未初始化，直接更新
                        chartInstance.series[0].setData(chartData, false);
                        chartInstance.series[0].update({size:'90%'}, false);
                    }
                } 
            } else if(chartLevel === 'detail') {
                // 詳細模式不在此更新，由enterDetailLevel處理
            } 
        } 
    }
    
    function enterDetailLevel(cat, data) { 
        chartLevel='detail'; 
        hideCustomTooltip(); 
        
        // 切換到對應的分頁（總覽是0，所以類別分頁要+1）
        const pageIndex = PAGE_TYPES.indexOf(cat);
        if(pageIndex > 0) {
            switchToPage(pageIndex);
        }
        
        // 準備數據（使用該分類專屬的色系）
        const colorPalette = CHART_ITEM_COLOR_PALETTES[cat] || CHART_ITEM_COLORS_FALLBACK;
        const formattedData = data.map((item, index) => ({
            name: item.name,
            y: item.y,
            color: item.color || colorPalette[index % colorPalette.length]
        }));
        
        if(chartInstance.series[0]) {
            // 使用動畫引擎進行切換
            if (chartAnimationEngine) {
                chartAnimationEngine.animate({
                    newData: formattedData,
                    animationType: CHART_ANIMATION_CONFIG.animationType,
                    duration: CHART_ANIMATION_CONFIG.duration,
                    easing: CHART_ANIMATION_CONFIG.easing,
                    onComplete: () => {
                        const chartTextColor = getChartTextColor();
                    chartInstance.setTitle({text:TYPE_NAMES[cat],style:{color:chartTextColor,fontSize:'14px'},align:'center',verticalAlign:'middle',y:10});
                        disableChartHover();
                    }
                });
            } else {
                // 如果動畫引擎未初始化，直接更新
                const chartTextColor = getChartTextColor();
                chartInstance.series[0].remove(false); 
                chartInstance.addSeries({ name:TYPE_NAMES[cat]||cat, data:formattedData, type:'pie', innerSize:'55%', size:'90%', center:['50%','50%'], borderWidth:0, slicedOffset:8, animation:{duration:CHART_ANIMATION_CONFIG.duration,easing:CHART_ANIMATION_CONFIG.easing}, colorByPoint:true, dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:chartTextColor,textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'}, states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}}, point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}} }, true);
                chartInstance.setTitle({text:TYPE_NAMES[cat],style:{color:chartTextColor,fontSize:'14px'},align:'center',verticalAlign:'middle',y:10}); 
                disableChartHover();
            }
        } else {
            // 如果沒有系列，直接添加
            const chartTextColor = getChartTextColor();
            chartInstance.addSeries({ name:TYPE_NAMES[cat]||cat, data:formattedData, type:'pie', innerSize:'55%', size:'90%', center:['50%','50%'], borderWidth:0, slicedOffset:8, animation:{duration:0}, colorByPoint:true, dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:chartTextColor,textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'}, states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}}, point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}} }, false);
            chartInstance.setTitle({text:TYPE_NAMES[cat],style:{color:chartTextColor,fontSize:'14px'},align:'center',verticalAlign:'middle',y:10}); 
            disableChartHover();
        }
    }
    
    let hoverCheckInterval = null;
    let activeInactivePoints = new Set();
    function disableChartHover() {
        if(!chartInstance) return;
        if(hoverCheckInterval) clearInterval(hoverCheckInterval);
        const forceResetStyle = function() {
            const points = document.querySelectorAll('#chartWrapper .highcharts-point');
            points.forEach(point => {
                const pointId = point.getAttribute('data-highcharts-point-index') || point.getAttribute('class');
                if(activeInactivePoints.has(pointId)) return;
                point.style.transition = 'none';
                const computedStyle = window.getComputedStyle(point);
                const computedOpacity = parseFloat(computedStyle.opacity);
                if(computedOpacity !== 1 && computedOpacity !== 0.3) {
                    point.style.setProperty('opacity', '1', 'important');
                }
                if(computedOpacity === 0.3) {
                    activeInactivePoints.add(pointId);
                }
                if(computedStyle.filter && computedStyle.filter !== 'none' && computedStyle.filter !== 'brightness(1)' && computedOpacity !== 0.3) {
                    point.style.setProperty('filter', 'brightness(1)', 'important');
                }
            });
            const chartTextColor = getChartTextColor();
            const dataLabels = document.querySelectorAll('#chartWrapper .highcharts-data-label, #chartWrapper .highcharts-data-label text');
            dataLabels.forEach(label => {
                label.style.setProperty('opacity', '1', 'important');
                if(label.tagName === 'text') {
                    label.style.setProperty('fill', chartTextColor, 'important');
                }
            });
        };
        setTimeout(() => {
            const points = document.querySelectorAll('#chartWrapper .highcharts-point');
            points.forEach(point => {
                const pointId = point.getAttribute('data-highcharts-point-index') || point.getAttribute('class');
                point.style.transition = 'none';
                const resetStyle = function() { 
                    const id = this.getAttribute('data-highcharts-point-index') || this.getAttribute('class');
                    const computedOpacity = parseFloat(window.getComputedStyle(this).opacity);
                    if(computedOpacity !== 0.3 && !activeInactivePoints.has(id)) {
                        this.style.setProperty('opacity', '1', 'important');
                        this.style.setProperty('filter', 'brightness(1)', 'important');
                    }
                };
                point.addEventListener('mouseenter', resetStyle, {capture: true, passive: false});
                point.addEventListener('mouseover', resetStyle, {capture: true, passive: false});
            });
            hoverCheckInterval = setInterval(forceResetStyle, 16);
        }, 100);
    }
    
    function resetChartLevel() { 
        activeInactivePoints.clear(); 
        const previousLevel = chartLevel;
        if(chartLevel === 'detail') {
            // 從詳細模式返回，根據當前分頁決定
            chartLevel = currentPage === 0 ? 'root' : 'page';
        } else {
            chartLevel = currentPage === 0 ? 'root' : 'page';
        }
        hideCustomTooltip();
        
        // 確保動畫引擎已初始化
        if (chartInstance && !chartAnimationEngine) {
            chartAnimationEngine = new ChartAnimationEngine(chartInstance);
        }
        
        // 使用動畫切換（動畫引擎會自動處理沒有起始數據的情況）
        updateChartData(true);
        disableChartHover(); 
    }
    
    function initChart() { 
        if(typeof Highcharts==='undefined')return; 
        Highcharts.setOptions({chart:{style:{fontFamily:'sans-serif'},events:{click:function(e){if(clickTimer){clearTimeout(clickTimer);clickTimer=null;}activeInactivePoints.clear();if(this.series[0]){this.series[0].points.forEach(p=>{p.slice(false);p.setState('normal');const pEl = p.graphic?.element;if(pEl) pEl.style.setProperty('opacity', '1', 'important');});}hideCustomTooltip();}}},title:{text:''},tooltip:{enabled:false},plotOptions:{pie:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}}}}}}); 
        updateChartData(); 
        // 確保圖表在初始化時正確渲染，特別是手機模式
        setTimeout(() => {
            if(chartInstance) {
                // 初始化動畫引擎
                if (!chartAnimationEngine && chartInstance) {
                    chartAnimationEngine = new ChartAnimationEngine(chartInstance);
                }
                
                const chartWrapper = document.getElementById('chartWrapper');
                if(chartWrapper) {
                    const wrapperWidth = chartWrapper.clientWidth;
                    const wrapperHeight = chartWrapper.clientHeight;
                    if(wrapperWidth > 0 && wrapperHeight > 0) {
                        chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                        chartInstance.reflow();
                        // 再次確保文字正確顯示
                        setTimeout(() => {
                            if(chartInstance) {
                                chartInstance.reflow();
                            }
                        }, 100);
                    }
                }
            }
        }, 300); 
        document.getElementById('chartWrapper').addEventListener('click',function(e){const t=e.target;if(t.tagName!=='path'&&!t.closest('.highcharts-point')&&chartInstance){if(clickTimer)clearTimeout(clickTimer);activeInactivePoints.clear();if(chartInstance.series[0]){chartInstance.series[0].points.forEach(p=>{p.slice(false);p.setState('normal');const pEl = p.graphic?.element;if(pEl) pEl.style.setProperty('opacity', '1', 'important');});}hideCustomTooltip();}}); 
    }

    // --- Calculations ---
    function calculateTWD(acc) { let val=0; if(acc.isAuto){ let p=acc.currentPrice||0; if(acc.type==='twstock')val=acc.balance*p; else if(acc.currency==='USD')val=acc.balance*p*settings.usdRate; else if(acc.type==='crypto')val=acc.balance*p*settings.usdtRate*settings.usdRate; else val=acc.balance*p*settings.usdRate; } else { if(acc.currency==='USD')val=acc.balance*settings.usdRate; else val=acc.balance; } return safeParseFloat(val); }
    function calculateUSD(acc) { let val=0; if(acc.isAuto){ let p=acc.currentPrice||0; if(acc.type==='twstock')val=acc.balance*p/settings.usdRate; else if(acc.currency==='USD')val=acc.balance*p; else if(acc.type==='crypto')val=acc.balance*p*settings.usdtRate; else val=acc.balance*p; } else { if(acc.currency==='USD')val=acc.balance; else val=acc.balance/settings.usdRate; } return safeParseFloat(val); }
    function calculateValue(acc) { return currentDisplayCurrency === 'USD' ? calculateUSD(acc) : calculateTWD(acc); }
    function calculateDailyPnL_TWD(acc) { if(!acc.isAuto||!acc.dayChange)return 0; let pnl=0; if(acc.type==='twstock')pnl=acc.balance*acc.dayChange; else if(acc.currency==='USD')pnl=acc.balance*acc.dayChange*settings.usdRate; else if(acc.type==='crypto')pnl=acc.balance*acc.dayChange*settings.usdtRate*settings.usdRate; else pnl=acc.balance*acc.dayChange*settings.usdRate; return safeParseFloat(pnl); }
    function calculateDailyPnL_USD(acc) { if(!acc.isAuto||!acc.dayChange)return 0; let pnl=0; if(acc.type==='twstock')pnl=acc.balance*acc.dayChange/settings.usdRate; else if(acc.currency==='USD')pnl=acc.balance*acc.dayChange; else if(acc.type==='crypto')pnl=acc.balance*acc.dayChange*settings.usdtRate; else pnl=acc.balance*acc.dayChange; return safeParseFloat(pnl); }
    function calculateDailyPnL(acc) { return currentDisplayCurrency === 'USD' ? calculateDailyPnL_USD(acc) : calculateDailyPnL_TWD(acc); }
    function calculateCostPnL_TWD(acc) { if(!acc.cost||acc.cost<=0||!acc.isAuto)return 0; let cur=calculateTWD(acc); let cost=acc.type==='twstock'?acc.balance*acc.cost:acc.balance*acc.cost*settings.usdRate; return safeParseFloat(cur-cost); }
    function calculateCostPnL_USD(acc) { if(!acc.cost||acc.cost<=0||!acc.isAuto)return 0; let cur=calculateUSD(acc); let cost=acc.type==='twstock'?acc.balance*acc.cost/settings.usdRate:acc.balance*acc.cost; return safeParseFloat(cur-cost); }
    function calculateCostPnL(acc) { return currentDisplayCurrency === 'USD' ? calculateCostPnL_USD(acc) : calculateCostPnL_TWD(acc); }
    function calculatePnL_TWD(acc) { if(acc.cost>0&&acc.isAuto){ return calculateCostPnL_TWD(acc); } return calculateDailyPnL_TWD(acc); }
    function calculatePnL(acc) { return currentDisplayCurrency === 'USD' ? (acc.cost>0&&acc.isAuto?calculateCostPnL_USD(acc):calculateDailyPnL_USD(acc)) : calculatePnL_TWD(acc); }
    function formatAmount(val) { 
        if(currentDisplayCurrency === 'USD') {
            return parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        } else {
            return Math.round(val).toLocaleString();
        }
    }
    function formatPnL(val) { 
        if(!val)return''; 
        const sign=val>0?'+':''; 
        const cls=val>0?'pnl-up':(val<0?'pnl-down':''); 
        const formatted = currentDisplayCurrency === 'USD' ? parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : Math.round(val).toLocaleString();
        return `<span class="${cls}">${sign}${formatted}</span>`; 
    }

    // --- UI ---
    function toggleSidebar() { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(s.classList.contains('active')){s.classList.remove('active');o.classList.remove('active');if(window.matchMedia('(min-width: 768px)').matches){s.classList.add('collapsed');} initMenuSections();}else{s.classList.add('active');o.classList.add('active');if(window.matchMedia('(min-width: 768px)').matches){s.classList.remove('collapsed');}} }
    function toggleSidebarCollapse() { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); const isCollapsed=s.classList.contains('collapsed'); if(isCollapsed){s.classList.remove('collapsed'); if(window.matchMedia('(min-width: 768px)').matches){s.classList.add('active'); o.classList.add('active');} localStorage.setItem('sidebarCollapsed','false');}else{s.classList.add('collapsed'); if(window.matchMedia('(min-width: 768px)').matches){s.classList.remove('active'); o.classList.remove('active');} localStorage.setItem('sidebarCollapsed','true');} }
    function initSidebarState() { if(window.matchMedia('(min-width: 768px)').matches){ const collapsed=localStorage.getItem('sidebarCollapsed')==='true'; const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(collapsed){s.classList.add('collapsed'); s.classList.remove('active'); o.classList.remove('active');}else{s.classList.remove('collapsed'); s.classList.add('active'); o.classList.add('active');} } }
    function toggleEditMode() { isEditMode=!isEditMode; document.getElementById('sortBtn').classList.toggle('active', isEditMode); document.getElementById('addBtn').style.display=isEditMode?'none':'block'; renderAssets(); }
    function toggleNumbers() {
        const body = document.body;
        const icon = document.getElementById('toggleNumbersIcon');
        const isHidden = body.classList.toggle('numbers-hidden');
        icon.classList.toggle('fa-eye', !isHidden);
        icon.classList.toggle('fa-eye-slash', isHidden);
        localStorage.setItem('numbersHidden', isHidden);
    }
    function initNumbersState() {
        const isHidden = localStorage.getItem('numbersHidden') === 'true';
        const body = document.body;
        const icon = document.getElementById('toggleNumbersIcon');
        if (isHidden) {
            body.classList.add('numbers-hidden');
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            body.classList.remove('numbers-hidden');
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    function toggleItemNumbers(itemId) {
        const key = `itemHidden_${itemId}`;
        const isHidden = localStorage.getItem(key) === 'true';
        localStorage.setItem(key, !isHidden);
        renderAssets();
    }
    function switchTab(t) { document.querySelectorAll('.modal-tab').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); document.getElementById('content'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); }
    function openModal() { 
        if(isEditMode)return; 
        editingId=null; 
        editingFromDetail = false; // 重置標記
        window.tempTransactions=[]; 
        renderTransactions([]); // 清空庫存明細顯示
        document.getElementById('modalTitle').innerText='新增'; 
        document.getElementById('inpName').value=''; 
        document.getElementById('inpSymbol').value=''; 
        document.getElementById('inpBalance').value='0'; // 預設金額為0
        document.getElementById('inpCost').value=''; // 清空平均成本
        // 確保名稱欄位可編輯
        const nameInput = document.getElementById('inpName');
        if(nameInput) {
            nameInput.disabled = false;
        }
        if(document.getElementById('inpBankTag')) {
            document.getElementById('inpBankTag').value = '現金'; // 預設為現金
        }
        if(document.getElementById('inpBankName')) {
            document.getElementById('inpBankName').value = '';
        }
        switchTab('basic'); 
        // 根據當前分頁自動選擇對應的類型
        if(currentPage > 0 && currentPage < PAGE_TYPES.length) {
            const pageType = PAGE_TYPES[currentPage]; // 'bank', 'stock', 'twstock', 'crypto'
            const typeSelect = document.getElementById('inpType');
            if(typeSelect && pageType !== 'overview') {
                typeSelect.value = pageType;
            }
        }
        handleTypeChange(); 
        if(document.getElementById('inpType').value === 'bank') {
            handleBankTagChange();
        } 
        const accountModal = document.getElementById('accountModal');
        const modalWrapper = accountModal.querySelector('.modal-content-wrapper');
        
        // 先設置初始狀態（在屏幕右側）
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping'); // 確保過渡動畫啟用
        }
        
        accountModal.style.display='block';
        accountModal.classList.remove('closing');
        // 背景設為透明，避免主畫面變暗
        accountModal.style.background = 'transparent';
        
        // 使用 requestAnimationFrame 確保瀏覽器已經渲染初始狀態
        requestAnimationFrame(() => {
            setTimeout(() => { 
                initEditModalSwipe(); 
                if(modalWrapper) { 
                    modalWrapper.style.transform = 'translateX(0)'; 
                } 
            }, 10);
        });
    }
    function editAccount(id) { 
        if(isEditMode)return; 
        editingId=id; 
        const a=accounts.find(x=>x.id===id); 
        document.getElementById('modalTitle').innerText='編輯'; 
        document.getElementById('inpType').value=a.type; 
        document.getElementById('inpName').value=a.name; 
        document.getElementById('inpSymbol').value=a.symbol; 
        if(a.logo) document.getElementById('inpSymbol').setAttribute('data-logo', a.logo); 
        document.getElementById('inpBalance').value=a.balance; 
        document.getElementById('inpCost').value=a.cost||''; 
        document.getElementById('inpCurrency').value=a.currency; 
        if(a.bankTag && document.getElementById('inpBankTag')) {
            document.getElementById('inpBankTag').value = a.bankTag;
        }
        if(a.bankName && document.getElementById('inpBankName')) {
            const bankNameInput = document.getElementById('inpBankName');
            bankNameInput.value = a.bankName;
        }
        window.tempTransactions=a.transactions||[]; 
        renderTransactions(window.tempTransactions); 
        switchTab('basic'); 
        handleTypeChange();
        if(a.type === 'bank') {
            handleBankTagChange();
        } 
        const accountModal = document.getElementById('accountModal'); 
        const modalWrapper = accountModal.querySelector('.modal-content-wrapper');
        
        // 先設置初始狀態（在屏幕右側）
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping'); // 確保過渡動畫啟用
        }
        
        accountModal.style.display='block'; 
        accountModal.classList.remove('closing'); 
        // 如果從詳情頁面進入，確保詳情頁面的狀態正確
        if(editingFromDetail) {
            const detailView = document.getElementById('detailView');
            if(detailView) {
                // 確保詳情頁面在編輯模態框下面（z-index 較低）
                detailView.style.zIndex = '2000';
                // 詳情頁面保持在正確位置（已經顯示，不需要動畫）
                detailView.style.transform = 'translateX(0)';
            }
            // 從詳情頁面進入時，背景設為透明，避免詳情頁面變暗
            accountModal.style.background = 'transparent';
        } else {
            // 從主畫面進入時，背景設為透明，避免主畫面變暗
            accountModal.style.background = 'transparent';
        }
        
        // 使用 requestAnimationFrame 確保瀏覽器已經渲染初始狀態
        requestAnimationFrame(() => {
            setTimeout(() => { 
                initEditModalSwipe(); 
                if(modalWrapper) { 
                    modalWrapper.style.transform = 'translateX(0)'; 
                } 
            }, 10);
        }); 
    }
    function closeModal() { 
        const accountModal = document.getElementById('accountModal');
        const modalWrapper = accountModal ? accountModal.querySelector('.modal-content-wrapper') : null;
        
        // 如果從詳情頁面進入，先確保詳情頁面在編輯模態框之下，這樣才能看到編輯模態框的滑出動畫
        if(editingFromDetail && currentDetailAcc) {
            const detailView = document.getElementById('detailView');
            if(detailView) {
                // 確保詳情頁面在編輯模態框之下（z-index 較低），這樣才能看到編輯模態框的滑出動畫
                detailView.style.zIndex = '2000';
                // 確保詳情頁面已經打開並在正確位置
                if(!detailView.classList.contains('active')) {
                    detailView.classList.add('active');
                }
                detailView.style.transform = 'translateX(0)';
            }
            // 立即讓背景變透明（在動畫開始前）
            accountModal.style.background = 'transparent';
            accountModal.classList.add('closing');
        } else {
            // 如果不是從詳情頁面進入，也要立即讓背景變透明，避免主畫面變暗
            accountModal.style.background = 'transparent';
            accountModal.classList.add('closing');
        }
        
        if(modalWrapper) {
            // 確保過渡動畫啟用
            modalWrapper.classList.remove('swiping');
            
            // 然後動畫滑出
            modalWrapper.style.transform = 'translateX(100%)';
            setTimeout(() => {
                accountModal.style.display = 'none';
                accountModal.classList.remove('closing');
                accountModal.style.background = ''; // 重置背景，以便下次打開時使用預設背景
                // 重置 transform 以便下次打開時動畫正常
                modalWrapper.style.transform = 'translateX(100%)';
                
                // 如果從詳情頁面進入，恢復詳情頁面的 z-index
                if(editingFromDetail && currentDetailAcc) {
                    const detailView = document.getElementById('detailView');
                    if(detailView) {
                        detailView.style.zIndex = '2000';
                    }
                }
                
                // 如果從記帳頁面打開的帳戶選擇器，保存後返回記帳頁面
                if(pendingJournalModalType) {
                    const modalType = pendingJournalModalType;
                    pendingJournalModalType = null; // 清除標記
                    
                    setTimeout(() => {
                        if(modalType === 'income') {
                            openIncomeModal(null, pendingJournalFormData);
                        } else if(modalType === 'expense') {
                            openExpenseModal(null, pendingJournalFormData);
                        } else if(modalType === 'transferFrom' || modalType === 'transferTo') {
                            openTransferModal(null, pendingJournalFormData);
                        } else if(modalType === 'from' || modalType === 'to') {
                            // 固定轉帳的情況，重新打開固定轉帳模態框
                            const fixedTransferModal = document.getElementById('fixedTransferModal');
                            if(fixedTransferModal) {
                                // 重新打開固定轉帳模態框
                                openFixedTransferModal(editingFixedTransferId);
                                // 然後重新打開帳戶選擇器
                                setTimeout(() => {
                                    openAccountSelector(modalType);
                                }, 100);
                            }
                        }
                    }, 100);
                }
            }, 400);
        } else {
            accountModal.style.display = 'none';
            accountModal.style.background = ''; // 重置背景
        }
        
        // 如果從詳情頁面進入，關閉編輯頁面後更新詳情頁面數據
        if(editingFromDetail && currentDetailAcc) {
            const detailId = currentDetailAcc.id;
            editingFromDetail = false;
            const detailView = document.getElementById('detailView');
            
            // 確保詳情頁面在編輯模態框滑出時保持可見
            if(detailView) {
                // 確保詳情頁面已經打開並且在正確位置
                if(!detailView.classList.contains('active')) {
                    detailView.classList.add('active');
                }
                // 確保 transform 是正確的（完全顯示）
                detailView.style.transform = 'translateX(0)';
            }
            
            // 直接更新詳情頁面數據，不調用 openDetailView（避免觸發動畫）
            setTimeout(() => {
                // 重新獲取最新的資產數據
                currentDetailAcc = accounts.find(x => x.id === detailId);
                if(currentDetailAcc) {
                    // 更新詳情頁面內容
                    let displayName = currentDetailAcc.name;
                    if(currentDetailAcc.type === 'stock') {
                        displayName = cleanCompanyName(currentDetailAcc.name);
                    } else if(currentDetailAcc.type === 'twstock') {
                        displayName = currentDetailAcc.name;
                    }
                    document.getElementById('dName').innerText = displayName;
                    document.getElementById('dSymbol').innerText = '';
                    document.getElementById('dSymbol').style.display = 'none';
                    document.getElementById('dQty').innerText = currentDetailAcc.balance;
                    let price = currentDetailAcc.currentPrice || 0;
                    document.getElementById('dPrice').innerText = `${price.toLocaleString()}`;
                    let val = calculateValue(currentDetailAcc);
                    document.getElementById('dVal').innerText = formatAmount(val);
                    let cost = currentDetailAcc.cost || 0;
                    let fee = settings.feeRate || 0.1;
                    
                    // 更新損益數據
                    let dailyPnL = calculateDailyPnL(currentDetailAcc);
                    let dailySign = dailyPnL >= 0 ? '+' : '';
                    let dailyColor = dailyPnL >= 0 ? 'var(--color-up)' : (dailyPnL < 0 ? 'var(--color-down)' : '#fff');
                    document.getElementById('dDailyPnlVal').innerHTML = `<span style="color:${dailyColor}">${dailySign}${formatAmount(dailyPnL)}</span>`;
                    
                    let costPnL = calculateCostPnL(currentDetailAcc);
                    let costPnlPct = (cost > 0) ? ((price - cost) / cost) * 100 : 0;
                    let costSign = costPnL >= 0 ? '+' : '';
                    let costColor = '#fff';
                    if (cost > 0) {
                        costColor = costPnL >= 0 ? 'var(--color-up)' : 'var(--color-down)';
                    }
                    if (cost > 0) {
                        document.getElementById('dCostPnl').style.display = 'block';
                        document.getElementById('dCostPnlVal').innerHTML = `<span style="color:${costColor}">${costSign}${formatAmount(costPnL)} (${costPnlPct.toFixed(2)}%)</span>`;
                    } else {
                        document.getElementById('dCostPnl').style.display = 'none';
                    }
                    
                    // 更新交易清單
                    const txList = document.getElementById('detailTxList');
                    txList.innerHTML = '';
                    if (currentDetailAcc.transactions && currentDetailAcc.transactions.length > 0) {
                        currentDetailAcc.transactions.forEach(tx => {
                            let txPnlHtml = '';
                            let txPriceColor = '';
                            if (price > 0 && tx.price > 0) {
                                let txCost = tx.price * (1 + fee/100);
                                let txProfit = (price - txCost) * tx.shares;
                                let txProfitConverted = currentDetailAcc.type === 'twstock' ? (currentDisplayCurrency === 'USD' ? txProfit / settings.usdRate : txProfit) : (currentDisplayCurrency === 'USD' ? txProfit : txProfit * settings.usdRate);
                                let txSign = txProfitConverted >= 0 ? '+' : '';
                                let txColor = txProfitConverted >= 0 ? 'val-green' : 'val-red';
                                let txPct = ((price - txCost) / txCost) * 100;
                                txPnlHtml = `<div class="tx-row"><span class="tx-label">損益</span><span class="tx-val ${txColor}">${txSign}${formatAmount(txProfitConverted)} (${txPct.toFixed(1)}%)</span></div>`;
                                if (price > tx.price) {
                                    txPriceColor = 'val-green';
                                } else if (price < tx.price) {
                                    txPriceColor = 'val-red';
                                }
                            } else if (cost > 0 && tx.price > 0) {
                                if (cost > tx.price) {
                                    txPriceColor = 'val-green';
                                } else if (cost < tx.price) {
                                    txPriceColor = 'val-red';
                                }
                            }
                            const priceClass = txPriceColor ? ` ${txPriceColor}` : '';
                            txList.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val${priceClass}">$${tx.price.toFixed(2)}</span></div>${txPnlHtml}</div>`;
                        });
                    } else {
                        txList.innerHTML = '<div class="tx-no-data">無詳細交易紀錄<br>請在編輯模式匯入截圖</div>';
                    }
                }
            }, 450);
        } else {
            editingFromDetail = false;
        }
    }
    
    // --- Calculator Functions ---
    let currentCalcTarget = null; // 當前要填入的輸入欄位ID
    let calcState = {
        display: '0',
        previousValue: null,
        operator: null,
        waitingForOperand: false
    };
    
    function openCalculator(targetInputId) {
        currentCalcTarget = targetInputId;
        const input = document.getElementById(targetInputId);
        const currentValue = input.value || '0';
        
        // 初始化計算機狀態
        calcState.display = currentValue === '' ? '0' : currentValue;
        calcState.previousValue = null;
        calcState.operator = null;
        calcState.waitingForOperand = false;
        
        updateCalcDisplay();
        const calculatorModal = document.getElementById('calculatorModal');
        if(calculatorModal) {
            calculatorModal.style.display = 'flex';
            calculatorModal.style.zIndex = '2012'; // 確保在編輯模態框之上
        }
    }
    
    function closeCalculator() {
        // 將計算結果填入目標輸入欄位
        if (currentCalcTarget) {
            const input = document.getElementById(currentCalcTarget);
            if (input) {
                let finalValue = calcState.display;
                
                // 處理錯誤或無效值
                if (finalValue === '錯誤' || finalValue === 'Infinity' || finalValue === 'NaN' || isNaN(parseFloat(finalValue))) {
                    finalValue = input.value || '0'; // 保持原值
                } else {
                    // 格式化數值
                    const numValue = parseFloat(finalValue);
                    if (!isNaN(numValue)) {
                        // 如果是整數，不顯示小數點
                        finalValue = numValue % 1 === 0 ? String(numValue) : String(numValue);
                    }
                }
                
                input.value = finalValue;
                // 觸發輸入事件，確保其他邏輯能正確運行
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
        currentCalcTarget = null;
        document.getElementById('calculatorModal').style.display = 'none';
    }
    
    function updateCalcDisplay() {
        const display = document.getElementById('calcDisplay');
        if (display) {
            // 格式化顯示
            let formatted = calcState.display;
            
            // 處理負號和數字
            if (formatted === '-') {
                formatted = '-0';
            }
            
            // 處理 Infinity 或 NaN
            if (formatted === 'Infinity' || formatted === 'NaN' || isNaN(parseFloat(formatted))) {
                formatted = '錯誤';
                calcState.display = '0';
                calcState.previousValue = null;
                calcState.operator = null;
                calcState.waitingForOperand = true;
            }
            
            // 限制顯示長度，避免過長
            if (formatted.length > 15 && formatted !== '錯誤') {
                const num = parseFloat(formatted);
                if (!isNaN(num)) {
                    formatted = num.toExponential(8);
                }
            }
            
            display.textContent = formatted;
        }
    }
    
    function calcInput(value) {
        switch(value) {
            case 'C': // Clear All
                calcState.display = '0';
                calcState.previousValue = null;
                calcState.operator = null;
                calcState.waitingForOperand = false;
                break;
                
            case 'CE': // Clear Entry
                calcState.display = '0';
                break;
                
            case 'backspace':
                if (calcState.display.length > 1) {
                    calcState.display = calcState.display.slice(0, -1);
                } else {
                    calcState.display = '0';
                }
                break;
                
            case '±': // Toggle Sign
                if (calcState.display !== '0') {
                    calcState.display = calcState.display.startsWith('-') 
                        ? calcState.display.slice(1) 
                        : '-' + calcState.display;
                }
                break;
                
            case '.':
                if (calcState.waitingForOperand) {
                    calcState.display = '0.';
                    calcState.waitingForOperand = false;
                } else if (!calcState.display.includes('.')) {
                    calcState.display += '.';
                }
                break;
                
            case '=':
                if (calcState.operator && calcState.previousValue !== null) {
                    const result = performCalculation();
                    calcState.display = formatCalcResult(result);
                    calcState.previousValue = null;
                    calcState.operator = null;
                    calcState.waitingForOperand = true;
                }
                break;
                
            case '+':
            case '-':
            case '*':
            case '/':
                handleOperator(value);
                break;
                
            default: // Numbers 0-9
                if (calcState.waitingForOperand) {
                    calcState.display = value;
                    calcState.waitingForOperand = false;
                } else {
                    calcState.display = calcState.display === '0' ? value : calcState.display + value;
                }
                break;
        }
        
        updateCalcDisplay();
    }
    
    function handleOperator(nextOperator) {
        const inputValue = parseFloat(calcState.display);
        
        if (calcState.previousValue === null) {
            calcState.previousValue = inputValue;
        } else if (calcState.operator) {
            const result = performCalculation();
            calcState.display = formatCalcResult(result);
            calcState.previousValue = result;
        }
        
        calcState.waitingForOperand = true;
        calcState.operator = nextOperator;
    }
    
    function performCalculation() {
        const prev = parseFloat(calcState.previousValue);
        const current = parseFloat(calcState.display);
        
        if (isNaN(prev) || isNaN(current)) return current;
        
        let result;
        switch(calcState.operator) {
            case '+':
                result = prev + current;
                break;
            case '-':
                result = prev - current;
                break;
            case '*':
                result = prev * current;
                break;
            case '/':
                if (current === 0) {
                    return Infinity; // 返回 Infinity，讓顯示層處理
                }
                result = prev / current;
                break;
            default:
                return current;
        }
        
        // 格式化結果，避免過多小數位
        if (result % 1 === 0) {
            return result;
        } else {
            // 保留最多10位小數，但移除尾部的0
            return parseFloat(result.toFixed(10));
        }
    }
    
    function formatCalcResult(value) {
        if (value % 1 === 0) {
            return String(value);
        }
        // 移除尾部多餘的0
        return String(parseFloat(value.toFixed(10)));
    }
    function updateBrokerOptions() {
        const t = document.getElementById('inpType').value;
        const brokerSelect = document.getElementById('brokerSelect');
        if (!brokerSelect) return;
        brokerSelect.innerHTML = '';
        if (t === 'twstock') {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (1.425%)</option><option value="cathay_fixed">國泰證券 (定期定額 固定1元)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        } else if (t === 'stock') {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (0.1%)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        } else if (t === 'crypto') {
            brokerSelect.innerHTML = '<option value="none" selected>無手續費 (0%)</option>';
        } else {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (0.1%)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        }
    }
    function handleTypeChange() { 
        const t=document.getElementById('inpType').value; 
        const auto=(t==='stock'||t==='twstock'||t==='crypto'); 
        document.getElementById('rowSymbol').style.display=auto?'flex':'none'; 
        document.getElementById('rowName').style.display=auto?'none':'flex'; 
        document.getElementById('rowCurrency').style.display=auto?'none':'flex'; 
        document.getElementById('rowCost').style.display=(auto && t!=='crypto')?'flex':'none'; 
        document.getElementById('rowBankTag').style.display=(t==='bank')?'flex':'none'; 
        document.getElementById('rowBankName').style.display='none'; 
        document.getElementById('aiArea').style.display=auto?'block':'none'; 
        document.getElementById('lblBalance').innerText=(t==='crypto')?'數量':(auto?'股數':'金額'); 
        if(auto) { 
            updateBrokerOptions(); 
            syncNameFromSymbol(); 
            updateAIButtonState(); 
        } else { 
            document.getElementById('btnAI').disabled=false; 
        } 
        if(t==='bank') { 
            handleBankTagChange(); 
        } else if(t==='debt') {
            // 負債類型：確保名稱欄位可編輯
            const nameInput = document.getElementById('inpName');
            if(nameInput) {
                nameInput.disabled = false;
                // 如果是新增模式且名稱為空或為「現金」，清空名稱欄位
                if(!editingId && (nameInput.value === '' || nameInput.value === '現金')) {
                    nameInput.value = '';
                }
            }
        }
    }
    function handleBankTagChange() {
        const tag = document.getElementById('inpBankTag') ? document.getElementById('inpBankTag').value : '現金';
        const nameInput = document.getElementById('inpName');
        const bankNameRow = document.getElementById('rowBankName');
        const bankNameInput = document.getElementById('inpBankName');
        const isEditing = editingId !== null; // 判斷是編輯還是新增模式
        const currentName = nameInput ? nameInput.value : ''; // 保存當前名稱
        
        if(tag === '現金') {
            // 現金：名稱固定為"現金"
            if(nameInput) {
                nameInput.value = '現金';
                nameInput.disabled = true;
            }
            if(bankNameRow) bankNameRow.style.display = 'none';
            if(bankNameInput) bankNameInput.value = '';
        } else if(tag === '銀行' || tag === '信用卡' || tag === '簽帳金融卡') {
            // 銀行、信用卡、簽帳金融卡：顯示銀行選擇欄位，名稱可編輯
            if(nameInput) {
                // 編輯模式下保持原有名稱，新增模式下清空
                if(!isEditing) {
                    nameInput.value = '';
                }
                nameInput.disabled = false;
            }
            if(bankNameRow) bankNameRow.style.display = 'flex';
            // 初始化銀行搜尋功能
            if(bankNameInput) {
                initBankSearch(bankNameInput);
            }
        } else {
            // 電子貨幣等其他標籤：名稱可編輯，不顯示銀行選擇
            if(nameInput) {
                // 編輯模式下保持原有名稱，新增模式下清空
                if(!isEditing) {
                    nameInput.value = '';
                }
                nameInput.disabled = false;
            }
            if(bankNameRow) bankNameRow.style.display = 'none';
            if(bankNameInput) bankNameInput.value = '';
        }
    }
    
    // 初始化銀行搜尋功能
    function initBankSearch(inputElement) {
        if(!inputElement) return;
        
        const resultsDiv = document.getElementById('bankSearchResults');
        let selectedBank = null;
        
        // 移除舊的事件監聽器（如果有的話）
        const newInput = inputElement.cloneNode(true);
        inputElement.parentNode.replaceChild(newInput, inputElement);
        const bankInput = document.getElementById('inpBankName');
        
        // 輸入事件：搜尋銀行
        bankInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if(query === '') {
                resultsDiv.style.display = 'none';
                selectedBank = null;
                return;
            }
            
            // 搜尋銀行（名稱或代碼）
            const matches = BANK_DATA.filter(bank => 
                bank.name.includes(query) || bank.code.includes(query)
            );
            
            if(matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); text-align: center;">找不到符合的銀行</div>';
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = matches.map(bank => {
                    return `<div class="bank-search-item" style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color);" data-bank-name="${bank.name}" data-bank-code="${bank.code}">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="color: var(--text-primary); font-size: 16px; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; line-height: 1.5;">${bank.name}</div>
                            ${bank.code ? `<div style="color: var(--text-secondary); font-size: 14px; font-weight: 500; flex-shrink: 0; text-align: right; width: 60px; line-height: 1.5;">${bank.code}</div>` : ''}
                        </div>
                    </div>`;
                }).join('');
                resultsDiv.style.display = 'block';
                
                // 綁定點擊事件
                resultsDiv.querySelectorAll('.bank-search-item').forEach(item => {
                    item.addEventListener('click', function() {
                        selectedBank = {
                            name: this.getAttribute('data-bank-name'),
                            code: this.getAttribute('data-bank-code')
                        };
                        bankInput.value = selectedBank.name;
                        resultsDiv.style.display = 'none';
                    });
                });
            }
        });
        
        // 點擊外部關閉搜尋結果
        document.addEventListener('click', function(e) {
            if(!bankInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
        
        // 獲取選中的銀行名稱（用於保存）
        window.getSelectedBankName = function() {
            return bankInput.value || selectedBank?.name || '';
        };
    }
    function updateAIButtonState() { const btnAI=document.getElementById('btnAI'); if(btnAI) btnAI.disabled=false; }
    let nameQueryTimer = null;
    async function fetchTWStockName(symbol) {
        if(!settings.fugleKey || !symbol) return null;
        // 驗證台股代號格式（通常是4位數字）
        if(!/^\d{4}$/.test(symbol)) return null;
        try {
            // 使用 Fugle quote 端點獲取股票基本資料
            const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${symbol}`, {
                headers: {'X-API-KEY': settings.fugleKey}
            });
            if (!res.ok) return null;
            const j = await res.json();
            // 根據參考代碼，回應中直接有 name 欄位
            if(j && j.name) {
                return j.name;
            }
            return null;
        } catch(e) {
            console.error('Failed to fetch stock name:', e);
            return null;
        }
    }
    function cleanCompanyName(name) {
        if(!name) return name;
        // 移除常見的公司後綴（不區分大小寫）
        // 處理有逗號的情況：", INC" 或 ", INC."
        name = name.replace(/,\s*(INC|INCORPORATED|CORP|CORPORATION|LTD|LIMITED|LLC|CO|COMPANY|PLC|SA|AG|NV|BV|LP|LLP)\.?$/i, '');
        // 處理沒有逗號的情況：" INC" 或 " INC." 或 "INC"
        name = name.replace(/\s+(INC|INCORPORATED|CORP|CORPORATION|LTD|LIMITED|LLC|CO|COMPANY|PLC|SA|AG|NV|BV|LP|LLP)\.?$/i, '');
        return name.trim();
    }
    async function fetchUSStockProfile(symbol) {
        if(!settings.apiKey || !symbol) return null;
        try {
            const res = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${settings.apiKey}`);
            if (!res.ok) return null;
            const j = await res.json();
            // 檢查是否回傳空物件（代表查無此股）
            if (Object.keys(j).length === 0) return null;
            return {
                name: cleanCompanyName(j.name) || symbol,
                logo: j.logo || null
            };
        } catch(e) {
            console.error('Failed to fetch US stock profile:', e);
            return null;
        }
    }
    async function fetchCryptoLogo(symbol) {
        if(!symbol) return null;
        try {
            // 清理代號 (移除 USD, USDT 等後綴，CoinCap 只需要純代號)
            const cleanSymbol = symbol.replace('COINBASE:', '').replace('-USD', '').replace('-USDT', '').toUpperCase();
            // 組合 CoinCap 網址 (必須轉小寫)
            const logoUrl = `https://assets.coincap.io/assets/icons/${cleanSymbol.toLowerCase()}@2x.png`;
            // 嘗試載入圖片來驗證是否存在
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(logoUrl);
                img.onerror = () => resolve(null);
                img.src = logoUrl;
            });
        } catch(e) {
            console.error('Failed to fetch crypto logo:', e);
            return null;
        }
    }
    async function syncNameFromSymbol() { 
        const t=document.getElementById('inpType').value; 
        if(t==='stock'||t==='twstock'||t==='crypto'){ 
            const s=document.getElementById('inpSymbol').value.trim().toUpperCase(); 
            if(s) { 
                if(t==='twstock') {
                    // 台股：先顯示代號
                    document.getElementById('inpName').value = s;
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 驗證代號格式（4位數字）才查詢
                    if(/^\d{4}$/.test(s)) {
                        // 延遲查詢，避免頻繁請求（增加到800ms，確保輸入完成）
                        nameQueryTimer = setTimeout(async () => {
                            const companyName = await fetchTWStockName(s);
                            if(companyName) {
                                document.getElementById('inpName').value = companyName;
                            }
                        }, 800);
                    }
                } else if(t==='stock') { 
                    // 美股：先顯示代號
                    document.getElementById('inpName').value = s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 延遲查詢，避免頻繁請求
                    nameQueryTimer = setTimeout(async () => {
                        const profile = await fetchUSStockProfile(s);
                        if(profile && profile.name) {
                            document.getElementById('inpName').value = profile.name;
                            // 儲存 logo URL 到隱藏欄位或直接保存（稍後在 saveAccount 中處理）
                            if(profile.logo) {
                                document.getElementById('inpSymbol').setAttribute('data-logo', profile.logo);
                            }
                        }
                    }, 800);
                } else if(t==='crypto') { 
                    // 加密貨幣：先顯示代號
                    document.getElementById('inpName').value=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 延遲查詢，避免頻繁請求
                    nameQueryTimer = setTimeout(async () => {
                        const logoUrl = await fetchCryptoLogo(s);
                        if(logoUrl) {
                            document.getElementById('inpSymbol').setAttribute('data-logo', logoUrl);
                        }
                    }, 800);
                } 
            } 
        } 
    }
    function saveAccount() { const t=document.getElementById('inpType').value; let s=document.getElementById('inpSymbol').value.trim().toUpperCase(); let n=document.getElementById('inpName').value.trim(); let c=document.getElementById('inpCurrency').value; const balanceInput = document.getElementById('inpBalance').value.trim(); const b = balanceInput === '' ? 0 : (parseFloat(balanceInput) || 0); const costInput = document.getElementById('inpCost').value.trim(); let cost = costInput === '' ? 0 : (parseFloat(costInput) || 0); const auto=(t==='stock'||t==='twstock'||t==='crypto'); const bankTag = t === 'bank' ? (document.getElementById('inpBankTag') ? document.getElementById('inpBankTag').value : '現金') : null; const bankName = t === 'bank' && (bankTag === '銀行' || bankTag === '信用卡' || bankTag === '簽帳金融卡') ? (window.getSelectedBankName ? window.getSelectedBankName() : (document.getElementById('inpBankName') ? document.getElementById('inpBankName').value : '')) : null; let logoUrl = null; if(t==='stock'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入股數"); if(!cost)return alert("請輸入平均成本"); if(!n) n=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); else n=cleanCompanyName(n); logoUrl = document.getElementById('inpSymbol').getAttribute('data-logo') || null; c='USD'; } else if(t==='twstock'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入股數"); if(!cost)return alert("請輸入平均成本"); if(!n) n=s; c='TWD'; } else if(t==='crypto'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入數量"); cost=0; if(!s.includes(':'))s=`COINBASE:${s}-USD`; if(!n) n=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); logoUrl = document.getElementById('inpSymbol').getAttribute('data-logo') || null; c='USD'; } if(!auto && !n)return alert("請輸入名稱"); if(t === 'bank' && (bankTag === '銀行' || bankTag === '信用卡' || bankTag === '簽帳金融卡') && !bankName)return alert("請選擇銀行"); const existingAcc = editingId ? accounts.find(x=>x.id===editingId) : null; const newA={ id:editingId||Date.now(), type:t, name:n, symbol:s, currency:c, balance:b, cost:cost, isAuto:auto, logo: logoUrl || (existingAcc && existingAcc.logo) || null, currentPrice:existingAcc?(existingAcc.currentPrice||0):0, dayChange:existingAcc?(existingAcc.dayChange||0):0, dayChangePercent:existingAcc?(existingAcc.dayChangePercent||0):0, order:existingAcc?(existingAcc.order||0):9999, transactions: window.tempTransactions||[], bankTag: bankTag || (existingAcc && existingAcc.bankTag) || null, bankName: bankName || (existingAcc && existingAcc.bankName) || null }; if(editingId)accounts[accounts.findIndex(x=>x.id===editingId)]=newA; else accounts.push(newA); saveData(); const wasEditingFromDetail = editingFromDetail; const detailAccId = currentDetailAcc ? currentDetailAcc.id : null; closeModal(); if(wasEditingFromDetail && detailAccId && newA.id === detailAccId && newA.isAuto) { openDetailView(newA.id); } else if(wasEditingFromDetail && detailAccId && !newA.isAuto) { closeDetailView(); currentDetailAcc = null; } else if(currentDetailAcc && currentDetailAcc.id === newA.id && newA.isAuto) { openDetailView(newA.id); } else if(currentDetailAcc && !newA.isAuto) { closeDetailView(); currentDetailAcc = null; } if(auto)refreshAllData(); else { renderAssets(); updateChartData(); } }
    function deleteAccount() { 
        const acc = accounts.find(x => x.id === editingId);
        if (!acc) return;
        const name = acc.name || '此資產';
        if (!confirm(`確定要刪除「${name}」嗎？`)) return;
        if (!confirm(`再次確認：確定要刪除「${name}」嗎？\n此操作無法復原！`)) return;
        accounts = accounts.filter(x => x.id !== editingId);
        saveData();
        closeModal();
        closeDetailView();
        renderAssets();
    }
    function saveData() { 
        if (isUserSwitching) return; // 鎖定攔截
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserId}`;
        localStorage.setItem(userDataKey, JSON.stringify(accounts)); 
        if (window.syncAccountsToFirestore && window.firebaseUserLoggedIn) {
            window.syncAccountsToFirestore(accounts);
        }
    }
    
    function saveSettings() {
        if (isUserSwitching) return; // 鎖定攔截
        const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${currentUserId}`;
        localStorage.setItem(userSettingsKey, JSON.stringify(settings));
        if (window.syncSettingsToFirestore && window.firebaseUserLoggedIn) {
            window.syncSettingsToFirestore(settings);
        }
    }
    function updateOrder(type,container){ let ids=Array.from(container.children).map(c=>parseInt(c.getAttribute('data-id'))); ids.forEach((id,idx)=>{ let a=accounts.find(x=>x.id===id); if(a)a.order=idx; }); saveData(); }
    function setApiKey(t) { if(t==='finnhub'){const k=prompt("Finnhub Key:", settings.apiKey);if(k)settings.apiKey=k.trim();} else if(t==='fugle'){const k=prompt("Fugle Key:", settings.fugleKey);if(k)settings.fugleKey=k.trim();} else {const k=prompt("Gemini Key:", settings.geminiKey);if(k)settings.geminiKey=k.trim();} saveSettings(); refreshAllData(); }
    function setFeeRate() { const k=prompt("手續費率 (%):", settings.feeRate); if(k)settings.feeRate=parseFloat(k); saveSettings(); }
    function updateFeeDisplay() { const s=document.getElementById('brokerSelect'); if(s.value==='custom'){ const r=prompt("自訂費率 (%):", settings.feeRate||0.1); if(r)settings.feeRate=parseFloat(r); saveSettings(); } }
    function exportData() { 
        // 匯出所有使用者資料
        const allUsersData = {};
        users.forEach(user => {
            const userDataKey = `${STORAGE_KEY_DATA}_${user.id}`;
            const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${user.id}`;
            const userJournalKey = `${STORAGE_KEY_JOURNAL}_${user.id}`;
            const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${user.id}`;
            const userDateNotesKey = `${STORAGE_KEY_DATE_NOTES}_${user.id}`;
            const userAccounts = JSON.parse(localStorage.getItem(userDataKey)) || [];
            const userSettings = JSON.parse(localStorage.getItem(userSettingsKey)) || {};
            const userJournal = JSON.parse(localStorage.getItem(userJournalKey)) || [];
            const userFixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey)) || [];
            const userDateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
            allUsersData[user.id] = {
                user: user,
                data: userAccounts,
                settings: userSettings,
                journal: userJournal,
                fixedTransfers: userFixedTransfers,
                dateNotes: userDateNotes
            };
        });
        
        const exportData = {
            version: '2.0',
            users: users,
            usersData: allUsersData,
            exportDate: new Date().toISOString()
        };
        
        const jsonStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // 生成包含日期和時間的檔名，格式：my_assets_backup_2025-12-04_12-20-34.json
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // 2025-12-04
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // 12:20:34 -> 12-20-34
        a.download = `my_assets_backup_${dateStr}_${timeStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // 雲端備份功能
    async function setupCloudBackup() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.zIndex = '3000';
        modal.innerHTML = `
            <div class="modal-content-wrapper" style="max-width: 400px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column; background: var(--card-bg); border-radius: 12px;">
                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); padding: 20px 20px 15px 20px; flex-shrink: 0; border-bottom: 1px solid var(--border-color);">雲端備份設定</div>
                <div class="form-group" style="flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; padding: 15px 20px; -webkit-overflow-scrolling: touch;">
                    <div class="form-row" style="display: flex; align-items: center; justify-content: space-between;">
                        <span class="form-label">啟用自動備份</span>
                        <label class="switch">
                            <input type="checkbox" id="cloudBackupEnabled" ${settings.cloudBackupEnabled ? 'checked' : ''} onchange="updateCloudBackupSetting()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-row" id="cloudBackupIntervalRow" style="${settings.cloudBackupEnabled ? '' : 'display: none;'}">
                        <span class="form-label">備份頻率（小時）</span>
                        <input type="number" id="cloudBackupInterval" class="form-input" value="${settings.cloudBackupInterval || 24}" min="1" max="168" style="text-align: right; width: 100px;" onchange="updateCloudBackupSetting()">
                    </div>
                    <div class="form-row" style="${settings.cloudBackupEnabled ? '' : 'display: none;'}" id="cloudBackupStatusRow">
                        <span class="form-label">上次備份</span>
                        <span id="cloudBackupLastTime" style="color: var(--text-secondary);">${settings.cloudBackupLastTime ? new Date(settings.cloudBackupLastTime).toLocaleString('zh-TW') : '尚未備份'}</span>
                    </div>
                    <div class="form-row" style="margin-top: 20px;">
                        <div id="firebase-login-status" style="margin-bottom: 10px; padding: 10px; background: var(--card-bg); border-radius: 8px;">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Firebase 登入狀態</div>
                            <div id="firebase-user-info" style="font-size: 16px; color: var(--text-primary);">未登入</div>
                        </div>
                        <button id="btn-firebase-login" onclick="handleFirebaseLogin()" style="width: 100%; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            <i class="fab fa-google"></i> Google 登入 Firebase
                        </button>
                        <button id="btn-firebase-logout" onclick="handleFirebaseLogout()" style="width: 100%; padding: 12px; background: var(--color-down); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; display: none;">
                            <i class="fas fa-sign-out-alt"></i> 登出
                        </button>
                    </div>
                    <div id="firebase-backup-actions" class="form-row" style="margin-top: 10px; display: none;">
                        <button onclick="handleFirebaseListBackups()" style="width: 100%; padding: 12px; background: var(--color-up); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                            <i class="fas fa-list"></i> 查看備份列表
                        </button>
                    </div>
                    <div class="form-row" style="margin-top: 10px;">
                        <button onclick="testCloudBackup()" style="width: 100%; padding: 12px; background: var(--color-up); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt"></i> 立即備份
                        </button>
                    </div>
                </div>
                <div style="padding: 15px 20px; text-align: center; flex-shrink: 0; border-top: 1px solid var(--border-color);">
                    <button onclick="closeCloudBackupModal()" style="padding: 10px 20px; background: var(--border-color); color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">關閉</button>
                </div>
            </div>
        `;
        modal.onclick = (e) => {
            if(e.target === modal) closeCloudBackupModal();
        };
        document.body.appendChild(modal);
        window.cloudBackupModal = modal;
        modal.style.display = 'block';
        
        // 初始化 Firebase UI
                    setTimeout(() => {
            updateFirebaseUI();
        }, 100);
    }
    
    function closeCloudBackupModal() {
        if(window.cloudBackupModal) {
            window.cloudBackupModal.style.display = 'none';
                            setTimeout(() => {
                if(window.cloudBackupModal && window.cloudBackupModal.parentNode) {
                    window.cloudBackupModal.parentNode.removeChild(window.cloudBackupModal);
                }
            }, 300);
        }
    }
    
    // Firebase 登入/登出處理
    async function handleFirebaseLogin() {
        try {
            if (window.firebaseSignIn) {
                await window.firebaseSignIn();
            } else {
                alert('Firebase 功能尚未載入，請重新整理頁面');
            }
        } catch (error) {
            alert('登入失敗：' + error.message);
        }
    }
    
    async function handleFirebaseLogout() {
        try {
            if (window.firebaseSignOut) {
                await window.firebaseSignOut();
                settings.cloudBackupToken = null;
                saveSettings();
                updateFirebaseUI();
            }
        } catch (error) {
            alert('登出失敗：' + error.message);
        }
    }
    
    function handleFirebaseListBackups() {
        if (window.firebaseListBackups) {
            window.firebaseListBackups();
        } else {
            alert('Firebase 功能尚未載入，請重新整理頁面');
        }
    }
    
    function updateFirebaseUI() {
        const userInfo = document.getElementById('firebase-user-info');
        const loginBtn = document.getElementById('btn-firebase-login');
        const logoutBtn = document.getElementById('btn-firebase-logout');
        const backupActions = document.getElementById('firebase-backup-actions');
        
        if (window.getCurrentFirebaseUser && window.getCurrentFirebaseUser()) {
            const user = window.getCurrentFirebaseUser();
            if (userInfo) userInfo.textContent = `已登入：${user.displayName || user.email}`;
            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (backupActions) backupActions.style.display = 'block';
            settings.cloudBackupToken = 'firebase';
            saveSettings();
        } else {
            if (userInfo) userInfo.textContent = '未登入';
            if (loginBtn) loginBtn.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (backupActions) backupActions.style.display = 'none';
        }
    }
    
    // 監聽 Firebase 登入狀態變化
    window.addEventListener('firebaseAuthStateChanged', (e) => {
        updateFirebaseUI();
    });
    
    // 監聽 Firebase 資料載入完成事件
    window.addEventListener('firebaseDataLoaded', () => {
        // 重新載入資料並渲染
        if (typeof loadUserData === 'function' && typeof renderAssets === 'function') {
            const userData = loadUserData(currentUserId);
            if (userData) {
                accounts = userData.accounts;
                settings = userData.settings;
                
                // 同步 UI 狀態（從 settings 讀取）
                if (settings.pageVisibility) pageVisibility = settings.pageVisibility; 
                if (settings.pageOrder) pageOrder = settings.pageOrder; 
                if (settings.displayCurrency) currentDisplayCurrency = settings.displayCurrency;
                
                // 更新幣別顯示
                const ctt = document.getElementById('currencyToggleText');
                if (ctt) ctt.textContent = currentDisplayCurrency;
                
                // 更新主題
                if (typeof applyTheme === 'function') applyTheme();
                
                // 更新使用者頭像
                if (typeof updateUserAvatar === 'function') updateUserAvatar();
                
                // 刷新資產列表
                renderAssets();
                
                // 更新圖表
                if (typeof updateChartData === 'function') updateChartData();
                
                // 更新分頁順序
                if (typeof reorderPageItems === 'function') reorderPageItems();
                
                // 更新分頁指示器
                if (typeof renderPageIndicator === 'function') renderPageIndicator();
                
                // 更新分頁顯示設定
                if (typeof renderPageVisibilitySettings === 'function') renderPageVisibilitySettings();
                
                // 更新日曆
                if (typeof renderCalendar === 'function') renderCalendar();
                
                // 更新固定轉帳列表
                if (typeof renderFixedTransferList === 'function') renderFixedTransferList();
                
                // 如果當前正在顯示記帳分頁，更新記帳詳情
                if (typeof showFixedTransferDetailsForDate === 'function' && selectedDate) {
                    showFixedTransferDetailsForDate(selectedDate);
                }
                
                // 清除記帳日期快取
                if (typeof clearJournalDatesCache === 'function') clearJournalDatesCache();
            }
        }
    });
    
    function updateCloudBackupSetting() {
        const enabled = document.getElementById('cloudBackupEnabled').checked;
        const interval = parseInt(document.getElementById('cloudBackupInterval').value) || 24;
        settings.cloudBackupEnabled = enabled;
        settings.cloudBackupInterval = interval;
        saveSettings();
        
        const intervalRow = document.getElementById('cloudBackupIntervalRow');
        const statusRow = document.getElementById('cloudBackupStatusRow');
        if(intervalRow) intervalRow.style.display = enabled ? 'flex' : 'none';
        if(statusRow) statusRow.style.display = enabled ? 'flex' : 'none';
        
        if(enabled) {
            startCloudBackupTimer();
                        } else {
            stopCloudBackupTimer();
        }
    }
    
    let cloudBackupTimer = null;
    
    function startCloudBackupTimer() {
        stopCloudBackupTimer();
        if(!settings.cloudBackupEnabled || !settings.cloudBackupToken) return;
        // Firebase 使用自己的定時器，不需要額外的定時器
        if(settings.cloudBackupToken === 'firebase') return;
        
        const intervalMs = (settings.cloudBackupInterval || 24) * 60 * 60 * 1000;
        cloudBackupTimer = setInterval(() => {
            performCloudBackup();
        }, intervalMs);
        
        // 檢查是否需要立即備份
        if(!settings.cloudBackupLastTime || 
           (Date.now() - new Date(settings.cloudBackupLastTime).getTime()) >= intervalMs) {
            performCloudBackup();
        }
        
        // 註冊背景同步（如果支援）
        if('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
            navigator.serviceWorker.ready.then((registration) => {
                // 定期註冊背景同步
                setInterval(() => {
                    registration.sync.register('cloud-backup').catch((err) => {
                        console.log('背景同步註冊失敗（可能不支援）:', err);
                    });
                }, intervalMs);
            });
        }
    }
    
    function stopCloudBackupTimer() {
        if(cloudBackupTimer) {
            clearInterval(cloudBackupTimer);
            cloudBackupTimer = null;
        }
    }
    
    // Google Drive 相關函數已完全移除，改用 Firebase
    
    async function performCloudBackup() {
        if(!settings.cloudBackupEnabled) return;
        
        try {
            // 生成備份資料
            const backupData = await generateBackupData();
            const jsonStr = JSON.stringify(backupData, null, 2);
            // 生成包含日期和時間的檔名，格式：my_assets_backup_2025-12-04_12-20-34.json
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // 2025-12-04
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // 12:20:34 -> 12-20-34
            const filename = `my_assets_backup_${dateStr}_${timeStr}.json`;
            
            if(settings.cloudBackupToken === 'local_storage_backup') {
                // 簡化版本：備份到 localStorage
                // 使用完整的檔名（包含日期和時間）作為 key
                localStorage.setItem(`cloud_backup_${dateStr}_${timeStr}`, jsonStr);
                // 只保留最近 10 個備份
                const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('cloud_backup_')).sort().reverse();
                if(backupKeys.length > 10) {
                    backupKeys.slice(10).forEach(k => localStorage.removeItem(k));
                }
                settings.cloudBackupLastTime = new Date().toISOString();
                saveSettings();
                console.log('雲端備份完成（本地）:', filename);
            } else if(settings.cloudBackupToken === 'firebase') {
                // Firebase 備份
                if (window.firebasePerformBackup) {
                    await window.firebasePerformBackup(jsonStr, false);
                    settings.cloudBackupLastTime = new Date().toISOString();
                    saveSettings();
        } else {
                    throw new Error('Firebase 功能尚未載入，請重新整理頁面');
                }
            }
        } catch(e) {
            console.error('雲端備份失敗:', e);
        }
    }
    
    async function generateBackupData() {
        const allUsersData = {};
        users.forEach(user => {
            const userDataKey = `${STORAGE_KEY_DATA}_${user.id}`;
            const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${user.id}`;
            const userJournalKey = `${STORAGE_KEY_JOURNAL}_${user.id}`;
            const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${user.id}`;
            const userAccounts = JSON.parse(localStorage.getItem(userDataKey)) || [];
            const userSettings = JSON.parse(localStorage.getItem(userSettingsKey)) || {};
            const userJournal = JSON.parse(localStorage.getItem(userJournalKey)) || [];
            const userFixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey)) || [];
            const userDateNotesKey = `${STORAGE_KEY_DATE_NOTES}_${user.id}`;
            const userDateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
            allUsersData[user.id] = {
                user: user,
                data: userAccounts,
                settings: userSettings,
                journal: userJournal,
                fixedTransfers: userFixedTransfers,
                dateNotes: userDateNotes
            };
        });
        
        return {
            version: '2.0',
            users: users,
            usersData: allUsersData,
            exportDate: new Date().toISOString()
        };
    }
    
    // Google Drive 相關函數已完全移除，改用 Firebase
    
    async function testCloudBackup() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 備份中...';
        btn.disabled = true;
        
        try {
            await performCloudBackup();
            alert('備份完成！');
            if(window.cloudBackupModal) {
                const lastTimeEl = document.getElementById('cloudBackupLastTime');
                if(lastTimeEl) {
                    lastTimeEl.textContent = settings.cloudBackupLastTime ? new Date(settings.cloudBackupLastTime).toLocaleString('zh-TW') : '尚未備份';
                }
            }
        } catch(e) {
            alert('備份失敗：' + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    function importData() { 
        // 直接觸發檔案選擇，不再提供貼上文字的選項
        document.getElementById('importFileInput').click();
    }
    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const progressToast = document.getElementById('importProgressToast');
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');
        const importOverlay = document.getElementById('importOverlay');
        
        // 顯示遮罩層和進度條
        if(importOverlay) importOverlay.style.display = 'block';
        progressToast.style.display = 'block';
        progressBar.style.width = '20%';
        progressText.innerText = '讀取檔案中...';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            progressBar.style.width = '50%';
            progressText.innerText = '解析JSON中...';
            try {
                setTimeout(async () => {
                    progressBar.style.width = '70%';
                    progressText.innerText = '驗證資料中...';
                    const d = JSON.parse(e.target.result);
                    
                    // 準備要切換的主要使用者 ID
                    let primaryUserId = null;

                    if (d.version === '2.0' && d.users && d.usersData) {
                        progressBar.style.width = '90%';
                        progressText.innerText = '寫入資料中...';
                        
                        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(d.users));
                        
                        if (d.users.length > 0) {
                            primaryUserId = d.users[0].id;
                            localStorage.setItem(STORAGE_KEY_CURRENT_USER, primaryUserId);
                            currentUserId = primaryUserId;
                        }

                        Object.keys(d.usersData).forEach(userId => {
                            const userData = d.usersData[userId];
                            localStorage.setItem(`${STORAGE_KEY_DATA}_${userId}`, JSON.stringify(userData.data || []));
                            localStorage.setItem(`${STORAGE_KEY_SETTINGS}_${userId}`, JSON.stringify(userData.settings || {}));
                            // 修正：確保即使是 undefined 也要存成空陣列，避免讀取錯誤
                            localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${userId}`, JSON.stringify(userData.journal || []));
                            localStorage.setItem(`${STORAGE_KEY_FIXED_TRANSFERS}_${userId}`, JSON.stringify(userData.fixedTransfers || []));
                            // 匯入日期記事
                            if (userData.dateNotes !== undefined) {
                                localStorage.setItem(`${STORAGE_KEY_DATE_NOTES}_${userId}`, JSON.stringify(userData.dateNotes || {}));
                            }
                        });

                    } else if (d.data && d.settings) {
                        progressBar.style.width = '90%';
                        progressText.innerText = '寫入資料中...';
                        primaryUserId = currentUserId; 
                        localStorage.setItem(`${STORAGE_KEY_DATA}_${primaryUserId}`, JSON.stringify(d.data));
                        localStorage.setItem(`${STORAGE_KEY_SETTINGS}_${primaryUserId}`, JSON.stringify(d.settings));
                    } else {
                        throw new Error("檔案格式錯誤");
                    }

                    if (window.firebaseUserLoggedIn) {
                        progressText.innerText = '同步到雲端...';
                        try {
                            if (d.users && window.syncUsersToFirestore) {
                                await window.syncUsersToFirestore(d.users);
                            }
                            // 關鍵：更新雲端紀錄的「當前使用者」，防止重新整理後跳回舊帳號
                            if (primaryUserId && window.syncCurrentUserToFirestore) {
                                await window.syncCurrentUserToFirestore(primaryUserId);
                            }
                            if (window.syncAllDataToFirestore) {
                                await window.syncAllDataToFirestore();
                            }
                            progressText.innerText = '同步完成！';
                        } catch (err) {
                            console.error('同步到 Firestore 失敗:', err);
                        }
                    }
                    
                    progressBar.style.width = '100%';
                    progressText.innerText = '完成！';
                    
                    // 延遲重新整理，確保資料寫入完成
                    setTimeout(() => location.reload(), 500);

                }, 100);
            } catch(err) {
                if(importOverlay) importOverlay.style.display = 'none';
                progressToast.style.display = 'none';
                progressBar.style.width = '0%';
                alert("讀取檔案失敗: " + err.message);
                console.error(err);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // User Management Functions
    function updateUserAvatar() {
        const currentUser = users.find(u => u.id === currentUserId);
        const avatarContainer = document.querySelector('.user-avatar-container');
        if (currentUser && avatarContainer) {
            let avatarEl = document.getElementById('currentUserAvatar');
            if (!avatarEl) {
                avatarEl = document.createElement('div');
                avatarEl.id = 'currentUserAvatar';
                avatarEl.className = 'user-avatar';
                avatarContainer.innerHTML = '';
                avatarContainer.appendChild(avatarEl);
            }
            
            // 清除舊內容
            avatarEl.innerHTML = '';
            
            if (currentUser.avatar.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = currentUser.avatar;
                img.style.cssText = 'width: 100%; height: 100%; border-radius: 50%; object-fit: cover;';
                avatarEl.appendChild(img);
            } else {
                // 使用 emoji
                avatarEl.textContent = currentUser.avatar;
            }
        }
    }

    function openUserSelector() {
        renderUserList();
        document.getElementById('userSelectorModal').style.display = 'flex';
    }

    function closeUserSelector() {
        document.getElementById('userSelectorModal').style.display = 'none';
    }

    function renderUserList() {
        const container = document.getElementById('userListContainer');
        container.innerHTML = '';
        
        users.forEach(user => {
            const isCurrent = user.id === currentUserId;
            const userItem = document.createElement('div');
            userItem.style.cssText = 'display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background: var(--card-bg); border-radius: 12px; cursor: pointer; border: 2px solid ' + (isCurrent ? '#0a84ff' : 'transparent') + ';';
            userItem.onclick = () => switchUser(user.id);
            
            const avatar = document.createElement('div');
            avatar.style.cssText = 'width: 50px; height: 50px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; border: 2px solid ' + (isCurrent ? '#0a84ff' : 'var(--border-color)') + ';';
            if (user.avatar.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = user.avatar;
                img.style.cssText = 'width: 100%; height: 100%; border-radius: 50%; object-fit: cover;';
                avatar.appendChild(img);
            } else {
                avatar.textContent = user.avatar;
            }
            
            const info = document.createElement('div');
            info.style.cssText = 'flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; padding: 0;';
            const name = document.createElement('div');
            name.style.cssText = 'color: var(--text-primary); font-size: 16px; font-weight: 600; margin: 0 0 4px 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left;';
            name.textContent = user.name;
            const date = document.createElement('div');
            date.style.cssText = 'color: var(--text-secondary); font-size: 12px; line-height: 1.2; white-space: nowrap; margin: 0; text-align: left;';
            date.textContent = new Date(user.createdAt).toLocaleDateString('zh-TW');
            info.appendChild(name);
            info.appendChild(date);
            
            const btnGroup = document.createElement('div');
            btnGroup.style.cssText = 'display: flex; gap: 10px; align-items: center;';
            
            const editBtn = document.createElement('button');
            editBtn.style.cssText = 'background: none; border: none; color: #0a84ff; font-size: 18px; padding: 5px 10px; cursor: pointer;';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.onclick = (e) => { e.stopPropagation(); openUserEditModal(user.id); };
            editBtn.title = '編輯使用者';
            
            const deleteBtn = document.createElement('button');
            // 如果是當前使用者，禁用刪除按鈕
            if (isCurrent) {
                deleteBtn.style.cssText = 'background: none; border: none; color: #666; font-size: 18px; padding: 5px 10px; cursor: not-allowed; opacity: 0.5;';
                deleteBtn.disabled = true;
                deleteBtn.title = '無法刪除當前使用者';
            } else {
                deleteBtn.style.cssText = 'background: none; border: none; color: #ff453a; font-size: 18px; padding: 5px 10px; cursor: pointer;';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteUser(user.id); };
                deleteBtn.title = '刪除使用者';
            }
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            
            btnGroup.appendChild(editBtn);
            btnGroup.appendChild(deleteBtn);
            
            userItem.appendChild(avatar);
            userItem.appendChild(info);
            userItem.appendChild(btnGroup);
            container.appendChild(userItem);
        });
    }

    function createNewUser() {
        const userName = prompt('輸入使用者名稱:', `使用者 ${users.length + 1}`);
        if (!userName) return;
        
        const newUser = {
            id: Date.now().toString(),
            name: userName.trim() || `使用者 ${users.length + 1}`,
            avatar: DEFAULT_AVATARS[users.length % DEFAULT_AVATARS.length],
            createdAt: new Date().toISOString()
        };
        
        users.push(newUser);
        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        // 同步到 Firestore
        if (window.syncUsersToFirestore && window.firebaseUserLoggedIn) {
            window.syncUsersToFirestore(users);
        }
        
        // 切換到新使用者
        switchUser(newUser.id);
        closeUserSelector();
    }

    async function switchUser(userId) {
        console.log(`[切換使用者] 開始切換至: ${userId}`);
        
        // 1. 最後一次安全存檔
        saveData();
        saveSettings();
        
        // 2. 【開啟鎖定】禁止任何寫入操作
        isUserSwitching = true;
        
        // 3. 停止監聽（必須先停止，確保 firestoreSyncEnabled 被重置）
        if (window.firebaseUserLoggedIn && typeof stopFirestoreSync === 'function') {
            stopFirestoreSync();
        }
        
        // 4. 清空記憶體與快取
        accounts = [];
        settings = {}; 
        if (typeof clearJournalDatesCache === 'function') clearJournalDatesCache();
        // 重置選中日期，避免殘留
        selectedDate = new Date(); 
        selectedDate.setHours(0,0,0,0);
        
        // 5. 切換 ID（必須先更新 localStorage，這樣 startFirestoreSync 才能讀取到正確的值）
        currentUserId = userId;
        localStorage.setItem(STORAGE_KEY_CURRENT_USER, currentUserId);
        
        // 6. 載入新資料
        const localData = loadUserData(currentUserId);
        accounts = localData.accounts;
        settings = localData.settings;
        
        // 7. 更新所有畫面 (包含記帳與日曆)
        updateUserAvatar();
        renderAssets();
        updateChartData();
        if (typeof renderCalendar === 'function') renderCalendar();
        // 重新顯示今天(或預設日期)的記帳詳情，確保列表也是新的
        if (typeof showFixedTransferDetailsForDate === 'function') {
            showFixedTransferDetailsForDate(selectedDate);
        }
        
        // 8. 處理雲端同步
        if (window.firebaseUserLoggedIn) {
            if (window.syncCurrentUserToFirestore) {
                window.syncCurrentUserToFirestore(currentUserId).catch(e => console.error(e));
            }
            
            // 延遲啟動監聽，確保 stopFirestoreSync 已完成，且 localStorage 已更新
            if (typeof startFirestoreSync === 'function') {
                setTimeout(() => {
                    console.log(`[切換使用者] 準備啟動新使用者的監聽器，當前 localStorage 中的 currentUserId: ${localStorage.getItem(STORAGE_KEY_CURRENT_USER)}`);
                    startFirestoreSync();
                }, 200); // 增加延遲時間，確保舊監聽器完全停止
            }
            
            // 下載雲端資料
            if (typeof loadDataFromFirestore === 'function') {
                try {
                    await loadDataFromFirestore();
                    // 下載後再次刷新
                    const finalData = loadUserData(currentUserId);
                    accounts = finalData.accounts;
                    settings = finalData.settings;
                    if (typeof clearJournalDatesCache === 'function') clearJournalDatesCache();
                    renderAssets();
                    updateChartData();
                    if (typeof renderCalendar === 'function') renderCalendar();
                    if (typeof showFixedTransferDetailsForDate === 'function') {
                        showFixedTransferDetailsForDate(selectedDate);
                    }
                } catch (e) {
                    console.error("雲端載入失敗", e);
                }
            }
        }
        
        closeUserSelector();
        
        // 9. 【解除鎖定】
        setTimeout(() => {
            isUserSwitching = false;
            console.log('[切換使用者] 鎖定解除');
        }, 500);
    }

    function deleteUser(userId) {
        if (users.length <= 1) {
            alert('至少需要保留一個使用者');
            return;
        }
        
        // 檢查是否嘗試刪除當前使用者
        if (userId === currentUserId) {
            alert('無法刪除當前正在使用的使用者，請先切換到其他使用者');
            return;
        }
        
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (!confirm(`確定要刪除使用者「${user.name}」嗎？\n此操作無法復原，該使用者的所有資料將被永久刪除。`)) {
            return;
        }
        
        // 刪除使用者的資料
        const userDataKey = `${STORAGE_KEY_DATA}_${userId}`;
        const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${userId}`;
        const userJournalKey = `${STORAGE_KEY_JOURNAL}_${userId}`;
        const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${userId}`;
        
        // 刪除 localStorage 資料
        localStorage.removeItem(userDataKey);
        localStorage.removeItem(userSettingsKey);
        localStorage.removeItem(userJournalKey);
        localStorage.removeItem(userFixedTransfersKey);
        
        // 刪除 Firestore 資料
        if (window.firebaseUserLoggedIn && window.firebaseDb && window.getCurrentFirebaseUser && window.firebaseDeleteDoc && window.firebaseDoc) {
            const firebaseUser = window.getCurrentFirebaseUser();
            if (firebaseUser) {
                try {
                    const userDataRef = window.firebaseDoc(window.firebaseDb, "users", firebaseUser.uid, "appUsers", userId);
                    window.firebaseDeleteDoc(userDataRef).then(() => {
                        console.log(`已刪除使用者 ${userId} 的 Firestore 資料`);
                    }).catch((err) => {
                        console.error('刪除 Firestore 資料失敗:', err);
                    });
                } catch (err) {
                    console.error('刪除 Firestore 資料失敗:', err);
                }
            }
        }
        
        // 從使用者列表中移除
        users = users.filter(u => u.id !== userId);
        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        // 同步到 Firestore
        if (window.syncUsersToFirestore && window.firebaseUserLoggedIn) {
            window.syncUsersToFirestore(users);
        }
        
        // 如果刪除的是當前使用者，切換到第一個使用者
        if (currentUserId === userId) {
            if (users.length > 0) {
                switchUser(users[0].id);
            }
        }
        
        // 更新使用者列表顯示
        renderUserList();
    }

    function openUserEditModal(userId) {
        editingUserId = userId;
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const nameInput = document.getElementById('userEditNameInput');
        if (nameInput) {
            nameInput.value = user.name;
        }
        
        document.getElementById('userEditModal').style.display = 'flex';
        closeUserSelector();
    }


    function closeUserEditModal() {
        document.getElementById('userEditModal').style.display = 'none';
        // 注意：不要在這裡清空 editingUserId，因為可能還需要重新打開
        // editingUserId 會在真正關閉時由調用者清空
    }

    function saveUserEdit() {
        if (!editingUserId) return;
        
        const user = users.find(u => u.id === editingUserId);
        if (!user) return;
        
        const nameInput = document.getElementById('userEditNameInput');
        if (nameInput) {
            const newName = nameInput.value.trim();
            if (!newName) {
                alert('名稱不能為空');
                return;
            }
            user.name = newName;
        }
        
        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        // 同步到 Firestore
        if (window.syncUsersToFirestore && window.firebaseUserLoggedIn) {
            window.syncUsersToFirestore(users);
        }
        
        // 更新顯示
        renderUserList();
        if (editingUserId === currentUserId) {
            updateUserAvatar();
        }
        
        editingUserId = null; // 清空 editingUserId
        closeUserEditModal();
    }

    function openAvatarSelectorFromEdit() {
        if (!editingUserId) return;
        avatarSelectorFromEdit = true;
        document.getElementById('avatarSelectorModal').style.display = 'flex';
        closeUserEditModal();
        // 確保模態框顯示後再渲染
        setTimeout(() => {
            renderAvatarSelector();
        }, 50);
    }

    function editUserAvatar(userId) {
        editingUserId = userId;
        document.getElementById('avatarSelectorModal').style.display = 'flex';
        closeUserSelector();
        // 確保模態框顯示後再渲染
        setTimeout(() => {
            renderAvatarSelector();
        }, 50);
    }

    function editUserName(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const newName = prompt('輸入新的使用者名稱:', user.name);
        if (newName === null) return; // 用戶取消
        
        const trimmedName = newName.trim();
        if (!trimmedName) {
            alert('名稱不能為空');
            return;
        }
        
        if (trimmedName === user.name) return; // 沒有變更
        
        user.name = trimmedName;
        localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
        
        // 更新使用者列表顯示
        renderUserList();
    }

    function closeAvatarSelector() {
        const modal = document.getElementById('avatarSelectorModal');
        if (modal) modal.style.display = 'none';
        
        // 注意：不再在這裡處理重新打開編輯模態框的邏輯
        // 這個邏輯已經移到 selectAvatar 和 confirmAvatarCrop 中
        
        avatarSelectorFromEdit = false;
        const preview = document.getElementById('uploadedAvatarPreview');
        if (preview) preview.style.display = 'none';
        const container = document.getElementById('avatarCropContainer');
        if (container) container.style.display = 'none';
        const input = document.getElementById('avatarUploadInput');
        if (input) input.value = '';
        cropImage = null;
    }

    function renderAvatarSelector() {
        const container = document.getElementById('defaultAvatarsContainer');
        if (!container) {
            console.error('defaultAvatarsContainer not found');
            return;
        }
        
        container.innerHTML = '';
        
        if (!DEFAULT_AVATARS || DEFAULT_AVATARS.length === 0) {
            console.error('DEFAULT_AVATARS is not defined or empty');
            return;
        }
        
        DEFAULT_AVATARS.forEach((avatar, index) => {
            const avatarBtn = document.createElement('button');
            avatarBtn.style.cssText = 'width: 80px; height: 80px; border-radius: 50%; background: #2c2c2e; border: 2px solid #3a3a3c; font-size: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;';
            avatarBtn.textContent = avatar;
            avatarBtn.onmouseover = () => { avatarBtn.style.borderColor = '#0a84ff'; avatarBtn.style.transform = 'scale(1.1)'; };
            avatarBtn.onmouseout = () => { avatarBtn.style.borderColor = '#3a3a3c'; avatarBtn.style.transform = 'scale(1)'; };
            avatarBtn.onclick = () => selectAvatar(avatar);
            container.appendChild(avatarBtn);
        });
    }

    function selectAvatar(avatar) {
        if (!editingUserId) return;
        
        const user = users.find(u => u.id === editingUserId);
        if (user) {
            user.avatar = avatar;
            localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
            // 同步到 Firestore
            if (window.syncUsersToFirestore && window.firebaseUserLoggedIn) {
                window.syncUsersToFirestore(users);
            }
            
            // 更新顯示
            if (editingUserId === currentUserId) {
                updateUserAvatar();
            }
            
            // 更新使用者列表（如果使用者選擇器是打開的）
            if (document.getElementById('userSelectorModal').style.display === 'flex') {
                renderUserList();
            }
            
            // 如果從編輯模態框打開的，保存 editingUserId 以便重新打開
            const wasFromEdit = avatarSelectorFromEdit;
            const userId = editingUserId;
            
            closeAvatarSelector();
            
            // 如果從編輯模態框打開的，重新打開編輯模態框
            if (wasFromEdit && userId) {
                setTimeout(() => {
                    editingUserId = userId; // 確保 editingUserId 沒有被清空
                    openUserEditModal(userId);
                }, 150);
            }
        }
    }

    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('請選擇圖片檔案');
            return;
        }
        
        // 確保模態框已打開
        const modal = document.getElementById('avatarSelectorModal');
        if (modal) {
            modal.style.display = 'flex';
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            // 確保 DOM 元素已存在後再初始化
            setTimeout(() => {
                initAvatarCrop(imageData);
            }, 100);
        };
        reader.readAsDataURL(file);
    }

    function initAvatarCrop(imageSrc) {
        cropImage = new Image();
        cropImage.onload = function() {
            // 使用函數確保元素存在
            function tryInitCrop() {
                const canvas = document.getElementById('avatarCropCanvas');
                const wrapper = document.getElementById('avatarCropWrapper');
                const container = document.getElementById('avatarCropContainer');
                
                // 檢查元素是否存在
                if (!canvas || !wrapper || !container) {
                    // 如果元素還不存在，稍後再試
                    setTimeout(tryInitCrop, 50);
                    return;
                }
                
                // 設置畫布大小（固定大小）
                const maxWidth = 300;
                canvas.width = maxWidth;
                canvas.height = maxWidth;
                canvas.style.width = maxWidth + 'px';
                canvas.style.height = maxWidth + 'px';
                
                // 初始化裁切參數
                // 計算初始縮放比例，使圖片能填滿畫布
                const scaleToFit = Math.max(canvas.width / cropImage.width, canvas.height / cropImage.height);
                cropScale = scaleToFit * 1.2; // 稍微放大一點
                
                // 裁切圓形大小（固定）
                cropSize = maxWidth * 0.8;
                
                // 初始化圖片位置（居中）
                const imgWidth = cropImage.width * cropScale;
                const imgHeight = cropImage.height * cropScale;
                cropX = (canvas.width - imgWidth) / 2;
                cropY = (canvas.height - imgHeight) / 2;
                
                // 設置裁切圓形位置
                updateCropCircle();
                
                // 繪製圖片
                drawCropImage();
                
                // 顯示裁切界面
                container.style.display = 'block';
                const preview = document.getElementById('uploadedAvatarPreview');
                if (preview) {
                    preview.style.display = 'none';
                }
                
                // 添加事件監聽
                setupCropEvents();
                
                // 更新縮放提示文字（手機版顯示雙指縮放）
                const zoomHint = document.getElementById('zoomHint');
                if (zoomHint) {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
                    zoomHint.textContent = isMobile ? '雙指縮放' : '滾輪縮放';
                }
            }
            
            // 開始嘗試初始化
            tryInitCrop();
        };
        cropImage.onerror = function() {
            alert('圖片載入失敗，請重新選擇');
        };
        cropImage.src = imageSrc;
    }

    function drawCropImage() {
        const canvas = document.getElementById('avatarCropCanvas');
        const ctx = canvas.getContext('2d');
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 計算縮放後的圖片尺寸
        const imgWidth = cropImage.width * cropScale;
        const imgHeight = cropImage.height * cropScale;
        
        // 計算圖片位置（相對於畫布）
        const imgX = cropX;
        const imgY = cropY;
        
        // 繪製圖片
        ctx.drawImage(cropImage, imgX, imgY, imgWidth, imgHeight);
        
        // 更新裁切圓形位置（圓形居中固定）
        updateCropCircle();
    }

    function updateCropCircle() {
        const circle = document.getElementById('avatarCropCircle');
        const wrapper = document.getElementById('avatarCropWrapper');
        
        if (!circle || !wrapper) return;
        
        // 圓形居中顯示
        const wrapperWidth = wrapper.offsetWidth || 300;
        const wrapperHeight = wrapper.offsetHeight || 300;
        
        circle.style.left = (wrapperWidth - cropSize) / 2 + 'px';
        circle.style.top = (wrapperHeight - cropSize) / 2 + 'px';
        circle.style.width = cropSize + 'px';
        circle.style.height = cropSize + 'px';
    }

    // 縮放處理函數（共用）
    function handleZoom(centerX, centerY, scaleChange) {
        const canvas = document.getElementById('avatarCropCanvas');
        if (!canvas) return;
        
        // centerX 和 centerY 已經是相對於畫布的座標
        const mouseX = centerX;
        const mouseY = centerY;
        
        const oldScale = cropScale;
        const newScale = Math.max(0.5, Math.min(5, cropScale * scaleChange));
        const scaleRatio = newScale / oldScale;
        
        // 調整圖片位置，使縮放中心點保持不變
        const relativeX = mouseX - cropX;
        const relativeY = mouseY - cropY;
        
        cropX = mouseX - relativeX * scaleRatio;
        cropY = mouseY - relativeY * scaleRatio;
        
        cropScale = newScale;
        
        // 限制圖片位置
        const imgWidth = cropImage.width * cropScale;
        const imgHeight = cropImage.height * cropScale;
        const minX = canvas.width - imgWidth;
        const maxX = 0;
        const minY = canvas.height - imgHeight;
        const maxY = 0;
        
        cropX = Math.max(minX, Math.min(cropX, maxX));
        cropY = Math.max(minY, Math.min(cropY, maxY));
        
        drawCropImage();
    }

    function setupCropEvents() {
        const canvas = document.getElementById('avatarCropCanvas');
        const wrapper = document.getElementById('avatarCropWrapper');
        
        if (!canvas || !wrapper) return;
        
        // 移除舊的事件監聽（如果有的話）
        canvas.onmousedown = null;
        canvas.onmousemove = null;
        canvas.onmouseup = null;
        canvas.onwheel = null;
        wrapper.onmousedown = null;
        wrapper.onmousemove = null;
        wrapper.onmouseup = null;
        wrapper.onwheel = null;
        wrapper.ontouchstart = null;
        wrapper.ontouchmove = null;
        wrapper.ontouchend = null;
        wrapper.ontouchcancel = null;
        
        // 拖動事件（拖動圖片）
        wrapper.onmousedown = function(e) {
            isDragging = true;
            const rect = canvas.getBoundingClientRect();
            dragStartX = e.clientX - rect.left - cropX;
            dragStartY = e.clientY - rect.top - cropY;
        };
        
        wrapper.onmousemove = function(e) {
            if (!isDragging) return;
            
            const rect = canvas.getBoundingClientRect();
            const newX = e.clientX - rect.left - dragStartX;
            const newY = e.clientY - rect.top - dragStartY;
            
            // 計算圖片尺寸
            const imgWidth = cropImage.width * cropScale;
            const imgHeight = cropImage.height * cropScale;
            
            // 限制圖片位置，確保裁切圓形區域內有圖片內容
            const minX = canvas.width - imgWidth;
            const maxX = 0;
            const minY = canvas.height - imgHeight;
            const maxY = 0;
            
            cropX = Math.max(minX, Math.min(newX, maxX));
            cropY = Math.max(minY, Math.min(newY, maxY));
            
            drawCropImage();
        };
        
        wrapper.onmouseup = function() {
            isDragging = false;
        };
        
        wrapper.onmouseleave = function() {
            isDragging = false;
        };
        
        // 滾輪縮放圖片（桌面版）
        wrapper.onwheel = function(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            handleZoom(mouseX, mouseY, e.deltaY > 0 ? 0.95 : 1.05);
        };
        
        // 觸控事件（手機版）
        wrapper.ontouchstart = function(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                // 單指拖動
                isDragging = true;
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                dragStartX = touch.clientX - rect.left - cropX;
                dragStartY = touch.clientY - rect.top - cropY;
            } else if (e.touches.length === 2) {
                // 雙指縮放
                isPinching = true;
                isDragging = false;
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                cropTouchStartDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                cropTouchStartScale = cropScale;
                
                // 計算雙指中心點
                const rect = canvas.getBoundingClientRect();
                cropTouchStartX = ((touch1.clientX + touch2.clientX) / 2) - rect.left;
                cropTouchStartY = ((touch1.clientY + touch2.clientY) / 2) - rect.top;
            }
        };
        
        wrapper.ontouchmove = function(e) {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging && !isPinching) {
                // 單指拖動
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const newX = touch.clientX - rect.left - dragStartX;
                const newY = touch.clientY - rect.top - dragStartY;
                
                // 計算圖片尺寸
                const imgWidth = cropImage.width * cropScale;
                const imgHeight = cropImage.height * cropScale;
                
                // 限制圖片位置
                const minX = canvas.width - imgWidth;
                const maxX = 0;
                const minY = canvas.height - imgHeight;
                const maxY = 0;
                
                cropX = Math.max(minX, Math.min(newX, maxX));
                cropY = Math.max(minY, Math.min(newY, maxY));
                
                drawCropImage();
            } else if (e.touches.length === 2 && isPinching) {
                // 雙指縮放
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (cropTouchStartDistance > 0) {
                    const scaleChange = currentDistance / cropTouchStartDistance;
                    const newScale = Math.max(0.5, Math.min(5, cropTouchStartScale * scaleChange));
                    
                    // 計算當前雙指中心點（相對於畫布）
                    const rect = canvas.getBoundingClientRect();
                    const currentCenterX = ((touch1.clientX + touch2.clientX) / 2) - rect.left;
                    const currentCenterY = ((touch1.clientY + touch2.clientY) / 2) - rect.top;
                    
                    // 使用當前雙指中心點作為縮放中心
                    handleZoom(currentCenterX, currentCenterY, newScale / cropScale);
                }
            }
        };
        
        wrapper.ontouchend = function(e) {
            if (e.touches.length === 0) {
                isDragging = false;
                isPinching = false;
            } else if (e.touches.length === 1) {
                // 從雙指變單指，切換到拖動模式
                isPinching = false;
                isDragging = true;
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                dragStartX = touch.clientX - rect.left - cropX;
                dragStartY = touch.clientY - rect.top - cropY;
            }
        };
        
        wrapper.ontouchcancel = function() {
            isDragging = false;
            isPinching = false;
        };
    }

    function confirmAvatarCrop() {
        if (!cropImage || !editingUserId) return;
        
        const canvas = document.getElementById('avatarCropCanvas');
        
        // 創建一個新的畫布用於裁切
        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = cropSize;
        cropCanvas.height = cropSize;
        const cropCtx = cropCanvas.getContext('2d');
        
        // 創建圓形裁切路徑
        cropCtx.beginPath();
        cropCtx.arc(cropSize / 2, cropSize / 2, cropSize / 2, 0, Math.PI * 2);
        cropCtx.clip();
        
        // 計算裁切圓形在畫布中的位置（居中）
        const circleX = (canvas.width - cropSize) / 2;
        const circleY = (canvas.height - cropSize) / 2;
        
        // 計算在原始圖片中的裁切區域
        // 裁切圓形相對於畫布的座標
        const relativeX = circleX - cropX;
        const relativeY = circleY - cropY;
        
        // 轉換為原始圖片的座標
        const sourceX = (relativeX / cropScale);
        const sourceY = (relativeY / cropScale);
        const sourceSize = cropSize / cropScale;
        
        // 繪製裁切後的圖片
        cropCtx.drawImage(
            cropImage,
            sourceX, sourceY, sourceSize, sourceSize,
            0, 0, cropSize, cropSize
        );
        
        // 轉換為 base64
        const croppedImageData = cropCanvas.toDataURL('image/png');
        
        // 保存頭像
        const user = users.find(u => u.id === editingUserId);
        if (user) {
            user.avatar = croppedImageData;
            localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
            // 同步到 Firestore
            if (window.syncUsersToFirestore && window.firebaseUserLoggedIn) {
                window.syncUsersToFirestore(users);
            }
            
            // 更新顯示
            if (editingUserId === currentUserId) {
                updateUserAvatar();
            }
            
            // 更新使用者列表（如果使用者選擇器是打開的）
            if (document.getElementById('userSelectorModal').style.display === 'flex') {
                renderUserList();
            }
            
            // 如果從編輯模態框打開的，保存 editingUserId 以便重新打開
            const wasFromEdit = avatarSelectorFromEdit;
            const userId = editingUserId;
            
            closeAvatarSelector();
            
            // 如果從編輯模態框打開的，重新打開編輯模態框
            if (wasFromEdit && userId) {
                setTimeout(() => {
                    editingUserId = userId; // 確保 editingUserId 沒有被清空
                    openUserEditModal(userId);
                }, 150);
            }
        }
    }

    function cancelAvatarCrop() {
        document.getElementById('avatarCropContainer').style.display = 'none';
        document.getElementById('avatarUploadInput').value = '';
        cropImage = null;
    }

    // Detail View
    function openDetailView(id) {
        if (isEditMode) return;
        currentDetailAcc = accounts.find(x => x.id === id);
        if (!currentDetailAcc) return;
        if (!currentDetailAcc.isAuto) { editAccount(id); return; }
        // 美股和台股：只顯示公司名稱，不顯示代碼
        let displayName = currentDetailAcc.name;
        if(currentDetailAcc.type === 'stock') {
            displayName = cleanCompanyName(currentDetailAcc.name);
        } else if(currentDetailAcc.type === 'twstock') {
            displayName = currentDetailAcc.name;
        }
        document.getElementById('dName').innerText = displayName; 
        document.getElementById('dSymbol').innerText = ''; // 清空代碼內容
        document.getElementById('dSymbol').style.display = 'none'; // 隱藏代碼
        document.getElementById('dQty').innerText = currentDetailAcc.balance;
        let price = currentDetailAcc.currentPrice || 0; let priceUnit = currentDetailAcc.type === 'twstock' ? 'TWD' : 'USD'; document.getElementById('dPrice').innerText = `${price.toLocaleString()}`;
        let val = calculateValue(currentDetailAcc); document.getElementById('dVal').innerText = formatAmount(val);
        let cost = currentDetailAcc.cost || 0; let fee = settings.feeRate || 0.1;
        
        // 當天損益
        let dailyPnL = calculateDailyPnL(currentDetailAcc);
        let dailySign = dailyPnL >= 0 ? '+' : '';
        let dailyColor = dailyPnL >= 0 ? 'var(--color-up)' : (dailyPnL < 0 ? 'var(--color-down)' : '#fff');
        document.getElementById('dDailyPnlVal').innerHTML = `<span style="color:${dailyColor}">${dailySign}${formatAmount(dailyPnL)}</span>`;
        
        // 持股成本損益
        let costPnL = calculateCostPnL(currentDetailAcc);
        let costPnlPct = (cost > 0) ? ((price - cost) / cost) * 100 : 0;
        let costSign = costPnL >= 0 ? '+' : '';
        let costColor = '#fff';
        if (cost > 0) {
            costColor = costPnL >= 0 ? 'var(--color-up)' : 'var(--color-down)';
        }
        if (cost > 0) {
            document.getElementById('dCostPnl').style.display = 'block';
            document.getElementById('dCostPnlVal').innerHTML = `<span style="color:${costColor}">${costSign}${formatAmount(costPnL)} (${costPnlPct.toFixed(2)}%)</span>`;
        } else {
            document.getElementById('dCostPnl').style.display = 'none';
        }
        const txList = document.getElementById('detailTxList'); txList.innerHTML = '';
        if (currentDetailAcc.transactions && currentDetailAcc.transactions.length > 0) {
            currentDetailAcc.transactions.forEach(tx => {
                let txPnlHtml = '';
                let txPriceColor = '';
                // 成交價顏色：與現價比較，現價高於成交價用綠色（漲），現價低於成交價用紅色（跌）
                if (price > 0 && tx.price > 0) {
                     let txCost = tx.price * (1 + fee/100); let txProfit = (price - txCost) * tx.shares; 
                     let txProfitConverted = currentDetailAcc.type === 'twstock' ? (currentDisplayCurrency === 'USD' ? txProfit / settings.usdRate : txProfit) : (currentDisplayCurrency === 'USD' ? txProfit : txProfit * settings.usdRate);
                     let txSign = txProfitConverted >= 0 ? '+' : ''; let txColor = txProfitConverted >= 0 ? 'val-green' : 'val-red'; let txPct = ((price - txCost) / txCost) * 100;
                     txPnlHtml = `<div class="tx-row"><span class="tx-label">損益</span><span class="tx-val ${txColor}">${txSign}${formatAmount(txProfitConverted)} (${txPct.toFixed(1)}%)</span></div>`;
                     // 成交價顏色：與現價比較，現價高於成交價用綠色（漲），現價低於成交價用紅色（跌）
                     if (price > tx.price) {
                         txPriceColor = 'val-green';
                     } else if (price < tx.price) {
                         txPriceColor = 'val-red';
                     }
                } else if (cost > 0 && tx.price > 0) {
                     // 如果沒有現價，使用平均成本來比較
                     if (cost > tx.price) {
                         txPriceColor = 'val-green';
                     } else if (cost < tx.price) {
                         txPriceColor = 'val-red';
                     }
                }
                // 確保顏色類被正確應用
                const priceClass = txPriceColor ? ` ${txPriceColor}` : '';
                txList.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val${priceClass}">$${tx.price.toFixed(2)}</span></div>${txPnlHtml}</div>`;
            });
        } else { txList.innerHTML = '<div class="tx-no-data">無詳細交易紀錄<br>請在編輯模式匯入截圖</div>'; }
        const detailView = document.getElementById('detailView');
        if(detailView) {
            // 檢查詳情頁面是否已經打開（通過檢查 active 類和 display 樣式）
            const isAlreadyOpen = detailView.classList.contains('active') && 
                                  (detailView.style.transform === 'translateX(0px)' || 
                                   detailView.style.transform === '' ||
                                   getComputedStyle(detailView).transform === 'matrix(1, 0, 0, 1, 0, 0)');
            
            if(!isAlreadyOpen) {
                // 先設置初始位置
                detailView.style.transform = 'translateX(100%)';
                detailView.classList.add('active');
                // 然後動畫滑入
                setTimeout(() => {
                    detailView.style.transform = 'translateX(0)';
                }, 10);
            }
            // 如果已經打開，不重新設置 transform，避免觸發動畫
        }
        initDetailViewSwipe();
    }
    function closeDetailView() { 
        const detailView = document.getElementById('detailView');
        if(detailView) {
            // 先動畫滑出
            detailView.style.transform = 'translateX(100%)';
            setTimeout(() => {
                detailView.classList.remove('active');
                // 重置 transform 以便下次打開時動畫正常
                detailView.style.transform = 'translateX(100%)';
            }, 400);
        }
    }
    
    // Detail View Swipe Gesture
    let detailTouchStartX = 0;
    let detailTouchEndX = 0;
    let detailTouchStartY = 0;
    let detailTouchEndY = 0;
    
    let isDetailSwiping = false;
    let detailStartTransform = 0;
    
    function initDetailViewSwipe() {
        const detailView = document.getElementById('detailView');
        if(!detailView) return;
        
        // 移除舊的事件監聽器（如果有的話）
        detailView.removeEventListener('touchstart', handleDetailTouchStart);
        detailView.removeEventListener('touchmove', handleDetailTouchMove);
        detailView.removeEventListener('touchend', handleDetailTouchEnd);
        
        // 添加新的事件監聽器
        detailView.addEventListener('touchstart', handleDetailTouchStart, { passive: true });
        detailView.addEventListener('touchmove', handleDetailTouchMove, { passive: true });
        detailView.addEventListener('touchend', handleDetailTouchEnd, { passive: true });
    }
    
    function handleDetailTouchStart(e) {
        detailTouchStartX = e.touches[0].clientX;
        detailTouchStartY = e.touches[0].clientY;
        isDetailSwiping = false;
        detailStartTransform = 0; // 詳情頁面從 0 開始（已顯示）
    }
    
    function handleDetailTouchMove(e) {
        if(!detailTouchStartX || !detailTouchStartY) return;
        
        const detailView = document.getElementById('detailView');
        if(!detailView || !detailView.classList.contains('active')) return;
        
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = detailTouchStartX - currentX;
        const diffY = detailTouchStartY - currentY;
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，不處理
        if(absDiffY > absDiffX) return;
        
        // 如果水平滑動距離足夠大，標記為滑動中
        if(absDiffX > 10) {
            isDetailSwiping = true;
            detailView.classList.add('swiping');
            
            // 計算滑動百分比
            // diffX = touchStartX - currentX
            // 向右滑動（關閉）：diffX < 0，transform 應該變正（向右移動）
            // 向左滑動（不允許）：diffX > 0，應該回彈
            const swipePercent = -(diffX / detailView.offsetWidth) * 100;
            
            // 限制範圍：0 到 100%（0 是完全顯示，100% 是完全隱藏）
            // 只允許向右滑動（關閉），向左滑動時回彈
            let newTransform = 0;
            if(swipePercent > 0) {
                // 向右滑動，允許顯示動畫
                newTransform = Math.min(100, swipePercent);
            } else {
                // 向左滑動，添加阻力效果
                newTransform = swipePercent * 0.3;
            }
            
            detailView.style.transform = `translateX(${newTransform}%)`;
        }
    }
    
    function handleDetailTouchEnd(e) {
        detailTouchEndX = e.changedTouches[0].clientX;
        detailTouchEndY = e.changedTouches[0].clientY;
        
        const detailView = document.getElementById('detailView');
        if(detailView && isDetailSwiping) {
            detailView.classList.remove('swiping');
        }
        
        if(isDetailSwiping) {
            handleDetailSwipe();
        } else {
            handleDetailSwipe();
        }
        
        isDetailSwiping = false;
    }
    
    function handleDetailSwipe() {
        const swipeThreshold = 50;
        const diffX = detailTouchStartX - detailTouchEndX;
        const diffY = detailTouchStartY - detailTouchEndY;
        
        // 計算水平和垂直滑動的絕對值
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，則不觸發（避免與滾動衝突）
        if(absDiffY > absDiffX) {
            return;
        }
        
        // 向右滑動（touchEndX > touchStartX，即 diffX < 0）
        if(diffX < -swipeThreshold && absDiffX > swipeThreshold) {
            closeDetailView();
        } else if(isDetailSwiping) {
            // 如果滑動距離不夠，回彈到原位置
            const detailView = document.getElementById('detailView');
            if(detailView) {
                detailView.style.transform = 'translateX(0)';
            }
        }
    }
    let editingFromDetail = false; // 標記是否從詳情頁面進入編輯
    
    // Edit Modal Swipe Gesture
    let editModalTouchStartX = 0;
    let editModalTouchEndX = 0;
    let editModalTouchStartY = 0;
    let editModalTouchEndY = 0;
    
    let isEditModalSwiping = false;
    let editModalStartTransform = 0;
    
    function initEditModalSwipe() {
        const accountModal = document.getElementById('accountModal');
        if(!accountModal) return;
        const modalWrapper = accountModal.querySelector('.modal-content-wrapper');
        if(!modalWrapper) return;
        
        // 移除舊的事件監聽器（如果有的話）
        accountModal.removeEventListener('touchstart', handleEditModalTouchStart);
        accountModal.removeEventListener('touchmove', handleEditModalTouchMove);
        accountModal.removeEventListener('touchend', handleEditModalTouchEnd);
        
        // 添加新的事件監聽器
        accountModal.addEventListener('touchstart', handleEditModalTouchStart, { passive: true });
        accountModal.addEventListener('touchmove', handleEditModalTouchMove, { passive: true });
        accountModal.addEventListener('touchend', handleEditModalTouchEnd, { passive: true });
    }
    
    function handleEditModalTouchStart(e) {
        editModalTouchStartX = e.touches[0].clientX;
        editModalTouchStartY = e.touches[0].clientY;
        isEditModalSwiping = false;
        editModalStartTransform = 0; // 編輯模態框從 0 開始（已顯示）
    }
    
    function handleEditModalTouchMove(e) {
        if(!editModalTouchStartX || !editModalTouchStartY) return;
        
        const accountModal = document.getElementById('accountModal');
        if(!accountModal || accountModal.style.display === 'none') return;
        
        const modalWrapper = accountModal.querySelector('.modal-content-wrapper');
        if(!modalWrapper) return;
        
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = editModalTouchStartX - currentX;
        const diffY = editModalTouchStartY - currentY;
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，不處理
        if(absDiffY > absDiffX) return;
        
        // 如果水平滑動距離足夠大，標記為滑動中
        if(absDiffX > 10) {
            isEditModalSwiping = true;
            modalWrapper.classList.add('swiping');
            
            // 在滑動開始時立即讓背景變透明，避免主畫面變暗
            accountModal.style.background = 'transparent';
            accountModal.classList.add('closing');
            
            // 如果從詳情頁面進入，確保詳情頁面在編輯模態框之下，這樣才能看到編輯模態框的滑出動畫
            if(editingFromDetail && currentDetailAcc) {
                const detailView = document.getElementById('detailView');
                if(detailView) {
                    // 確保詳情頁面已經打開
                    if(!detailView.classList.contains('active')) {
                        detailView.classList.add('active');
                    }
                    // 確保詳情頁面在編輯模態框之下（z-index 較低），這樣才能看到編輯模態框的滑出動畫
                    detailView.style.zIndex = '2000';
                    // 確保詳情頁面在正確位置（完全顯示）
                    detailView.style.transform = 'translateX(0)';
                }
            }
            
            // 計算滑動百分比
            // diffX = touchStartX - currentX
            // 向右滑動（關閉）：diffX < 0，transform 應該變正（向右移動）
            // 向左滑動（不允許）：diffX > 0，應該回彈
            const swipePercent = -(diffX / accountModal.offsetWidth) * 100;
            
            // 限制範圍：0 到 100%（0 是完全顯示，100% 是完全隱藏）
            // 只允許向右滑動（關閉），向左滑動時回彈
            let newTransform = 0;
            if(swipePercent > 0) {
                // 向右滑動，允許顯示動畫
                newTransform = Math.min(100, swipePercent);
            } else {
                // 向左滑動，添加阻力效果
                newTransform = swipePercent * 0.3;
            }
            
            modalWrapper.style.transform = `translateX(${newTransform}%)`;
        }
    }
    
    function handleEditModalTouchEnd(e) {
        editModalTouchEndX = e.changedTouches[0].clientX;
        editModalTouchEndY = e.changedTouches[0].clientY;
        
        const accountModal = document.getElementById('accountModal');
        const modalWrapper = accountModal ? accountModal.querySelector('.modal-content-wrapper') : null;
        if(modalWrapper && isEditModalSwiping) {
            modalWrapper.classList.remove('swiping');
        }
        
        // 如果沒有滑動，恢復背景和 z-index
        if(!isEditModalSwiping) {
            accountModal.style.background = '';
            accountModal.classList.remove('closing');
            // 如果從詳情頁面進入，恢復詳情頁面的 z-index
            if(editingFromDetail && currentDetailAcc) {
                const detailView = document.getElementById('detailView');
                if(detailView) {
                    detailView.style.zIndex = '2000';
                }
            }
        }
        
        if(isEditModalSwiping) {
            handleEditModalSwipe();
        } else {
            handleEditModalSwipe();
        }
        
        isEditModalSwiping = false;
    }
    
    function handleEditModalSwipe() {
        const swipeThreshold = 50;
        const diffX = editModalTouchStartX - editModalTouchEndX;
        const diffY = editModalTouchStartY - editModalTouchEndY;
        
        // 計算水平和垂直滑動的絕對值
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，則不觸發（避免與滾動衝突）
        if(absDiffY > absDiffX) {
            // 恢復背景和 z-index
            const accountModal = document.getElementById('accountModal');
            if(accountModal) {
                accountModal.style.background = '';
                accountModal.classList.remove('closing');
            }
            // 如果從詳情頁面進入，恢復詳情頁面的 z-index
            if(editingFromDetail && currentDetailAcc) {
                const detailView = document.getElementById('detailView');
                if(detailView) {
                    detailView.style.zIndex = '2000';
                }
            }
            return;
        }
        
        // 向右滑動（touchEndX > touchStartX，即 diffX < 0）
        if(diffX < -swipeThreshold && absDiffX > swipeThreshold) {
            closeModal();
        } else if(isEditModalSwiping) {
            // 如果滑動距離不夠，回彈到原位置
            const accountModal = document.getElementById('accountModal');
            const modalWrapper = accountModal ? accountModal.querySelector('.modal-content-wrapper') : null;
            if(modalWrapper) {
                modalWrapper.style.transform = 'translateX(0)';
            }
            // 恢復背景和 z-index
            if(accountModal) {
                accountModal.style.background = '';
                accountModal.classList.remove('closing');
            }
            // 如果從詳情頁面進入，恢復詳情頁面的 z-index
            if(editingFromDetail && currentDetailAcc) {
                const detailView = document.getElementById('detailView');
                if(detailView) {
                    detailView.style.zIndex = '2000';
                }
            }
        }
    }
    function editCurrentAsset() { 
        if(currentDetailAcc) { 
            editingFromDetail = true; // 標記是從詳情頁面進入
            editAccount(currentDetailAcc.id); 
        } 
    }
    
    function deleteCurrentAsset() {
        if (!currentDetailAcc) return;
        
        const name = currentDetailAcc.name || '此資產';
        if (!confirm(`確定要刪除「${name}」嗎？`)) return;
        if (!confirm(`再次確認：確定要刪除「${name}」嗎？\n此操作無法復原！`)) return;
        
        // 從 accounts 中刪除
        accounts = accounts.filter(x => x.id !== currentDetailAcc.id);
        saveData();
        
        // 關閉詳情頁面
        closeDetailView();
        currentDetailAcc = null;
        
        // 刷新列表和圖表
        renderAssets();
        updateChartData();
    }

    // AI
    function triggerImageUpload() { if(!settings.geminiKey)return alert("請先設定 Gemini Key"); document.getElementById('imgUpload').click(); }
    async function handleImageUpload(input) {
        if(!input.files || input.files.length === 0) return;
        const status = document.getElementById('aiStatus'); 
        const progressContainer = document.getElementById('aiProgress');
        const progressBar = document.getElementById('aiProgressBar');
        status.innerText = `讀取圖片中...`; status.style.color = "#aaa";
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        try {
            const files = Array.from(input.files);
            const promises = files.map((f, idx) => new Promise((res,rej)=>{
                const r=new FileReader();
                r.onload=e=>{
                    progressBar.style.width = `${20 + (idx + 1) * 30 / files.length}%`;
                    res({inlineData:{mimeType:f.type,data:e.target.result.split(',')[1]}});
                };
                r.onerror=rej;
                r.readAsDataURL(f);
            }));
            const images = await Promise.all(promises);
            progressBar.style.width = '60%';
            status.innerText = `AI 分析中...`; status.style.color = "#0a84ff";
            const broker = document.getElementById('brokerSelect').value;
            const accountType = document.getElementById('inpType').value;
            const isTWStock = accountType === 'twstock';
            const isUSStock = accountType === 'stock';
            const isCrypto = accountType === 'crypto';
            const isFixedFee = isTWStock && broker === 'cathay_fixed'; // 台股國泰定期定額固定1元
            let fee = isCrypto ? 0 : 0.1; // 加密貨幣預設手續費為0 
            if (isTWStock && broker === 'cathay') {
                fee = 1.425; // 台股國泰一般交易1.425%
            } else if (isTWStock && broker === 'cathay_fixed') {
                fee = 0; // 台股國泰定期定額固定1元，fee設為0（會在計算時直接加1元）
            } else if (isUSStock && broker === 'cathay') {
                fee = 0.1; // 美股國泰0.1%
            } else if (broker === 'fubon') {
                fee = 0.25;
            } else if (broker === 'custom') {
                fee = settings.feeRate || 0.1;
            }
            let prompt = '';
            if(accountType === 'crypto') {
                // 加密貨幣：看圖左邊的代碼/名字和圖左邊下面的數量
                prompt = `Analyze cryptocurrency wallet/exchange screenshots. 1. Extract cryptocurrency symbol/name from the LEFT side of the image (look for crypto symbols like BTC, ETH, SOL, etc. or names like Bitcoin, Ethereum, etc.). 2. Extract the QUANTITY/AMOUNT from BELOW the symbol/name on the LEFT side. Return JSON: {"symbol": "crypto symbol/name if found", "quantity": number}`;
            } else {
                // 美股、台股：原有邏輯
                prompt = `Analyze brokerage screenshots. 1. Extract stock symbol/code if visible (look for stock ticker symbols like NVDA, TSLA, 2330, etc.). 2. Extract transaction list: [{"date": "MM/DD", "shares": number, "price": number (raw price without fee)}] 3. Calculate TOTAL shares. 4. Calculate Weighted Average Cost PER SHARE. IMPORTANT: For each transaction, Cost = Price${isFixedFee ? ' + 1' : ` * (1 + ${fee}/100)`}. Final Avg Cost = (Sum of (Shares * Cost)) / Total Shares. Return JSON: {"symbol": "stock symbol if found", "transactions": [...], "totalShares": number, "avgCost": number}`;
            }
            progressBar.style.width = '80%';
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${settings.geminiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...images] }] }) });
            progressBar.style.width = '90%';
            status.innerText = `處理結果中...`; status.style.color = "#0a84ff";
            const data = await resp.json(); if(data.error) throw new Error(data.error.message);
            if(!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0] || !data.candidates[0].content.parts[0].text) {
                throw new Error("AI 回應格式錯誤，請重試");
            }
            const txt = data.candidates[0].content.parts[0].text; 
            // 嘗試提取 JSON，使用更寬鬆的匹配
            let match = txt.match(/\{[\s\S]*\}/);
            if(!match) {
                // 如果沒有找到 JSON，嘗試尋找 JSON 陣列
                match = txt.match(/\[[\s\S]*\]/);
            }
            if(match) {
                let res;
                try {
                    res = JSON.parse(match[0]);
                } catch(parseError) {
                    // 如果解析失敗，嘗試清理文字後再解析
                    let cleanedJson = match[0].replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                    // 移除 JSON 後面的非 JSON 字符
                    cleanedJson = cleanedJson.replace(/\}[^}]*$/, '}');
                    try {
                        res = JSON.parse(cleanedJson);
                    } catch(e) {
                        throw new Error("無法解析 AI 回應的 JSON 格式，請重試或檢查圖片內容");
                    }
                }
                if(accountType === 'crypto') {
                    // 加密貨幣：處理 symbol 和 quantity
                    if(res.symbol && res.symbol.trim()) {
                        const symbolInput = document.getElementById('inpSymbol');
                        if(symbolInput && !symbolInput.value.trim()) {
                            symbolInput.value = res.symbol.trim().toUpperCase();
                            syncNameFromSymbol();
                        }
                    }
                    if(res.quantity !== undefined && res.quantity !== null) {
                        document.getElementById('inpBalance').value = parseFloat(res.quantity) || 0;
                    }
                    progressBar.style.width = '100%';
                    status.innerText = `成功! 已辨識代碼: ${res.symbol || '未找到'}，數量: ${res.quantity || 0}`; status.style.color = "#30d158"; 
                    setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 1000);
                } else if(res.transactions && res.transactions.length > 0) {
                    // 美股、台股：處理交易明細
                    // 如果有提取到股票代碼，自動填入
                    if(res.symbol && res.symbol.trim()) {
                        const symbolInput = document.getElementById('inpSymbol');
                        if(symbolInput && !symbolInput.value.trim()) {
                            symbolInput.value = res.symbol.trim().toUpperCase();
                            syncNameFromSymbol();
                        }
                    }
                    // 累積到現有交易明細
                    const existingTx = window.tempTransactions || [];
                    const newTx = res.transactions || [];
                    const allTx = [...existingTx, ...newTx];
                    
                    // 重新計算總股數和加權平均成本
                    let totalShares = 0;
                    let totalCost = 0;
                    allTx.forEach(tx => {
                        const shares = parseFloat(tx.shares) || 0;
                        const price = parseFloat(tx.price) || 0;
                        let costPerShare;
                        if (isFixedFee) {
                            costPerShare = price + 1; // 台股定期定額固定加1元
                        } else {
                            costPerShare = price * (1 + fee / 100);
                        }
                        totalShares += shares;
                        totalCost += shares * costPerShare;
                    });
                    const avgCost = totalShares > 0 ? totalCost / totalShares : 0;
                    
                    // 更新顯示
                    window.tempTransactions = allTx;
                    document.getElementById('inpBalance').value = totalShares;
                    document.getElementById('inpCost').value = avgCost.toFixed(4);
                    renderTransactions(window.tempTransactions);
                    progressBar.style.width = '100%';
                    const feeText = isFixedFee ? '固定1元' : `${fee}%`;
                    status.innerText = `成功! 已累積 ${allTx.length} 筆交易，總股數: ${totalShares}，已含 ${feeText} 手續費`; status.style.color = "#30d158"; 
                    setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 1000);
                    switchTab('detail');
                } else { 
                    throw new Error("AI 未辨識到資料，請確認圖片內容");
                }
            } else {
                throw new Error("AI 回應中未找到有效的 JSON 資料，請重試");
            }
        } catch(e) { 
            console.error(e); 
            status.innerText = "失敗: " + e.message; 
            status.style.color = "red"; 
            progressContainer.style.display = 'none'; 
            progressBar.style.width = '0%'; 
        } 
        input.value = '';
    }
    function renderTransactions(list) { 
        const c = document.getElementById('txListContainer'); 
        c.innerHTML = ''; 
        if(!list || list.length === 0) { 
            c.innerHTML = '<div class="tx-no-data">無明細</div>'; 
            return; 
        } 
        
        // 獲取當前編輯的帳戶信息，用於比較價格
        let price = 0;
        let cost = 0;
        if(editingId) {
            const acc = accounts.find(x => x.id === editingId);
            if(acc) {
                price = acc.currentPrice || 0;
                cost = acc.cost || 0;
            }
        }
        
        list.forEach(tx => { 
            let txPriceColor = '';
            // 成交價顏色：與現價比較，現價高於成交價用綠色（漲），現價低於成交價用紅色（跌）
            if (price > 0 && tx.price > 0) {
                if (price > tx.price) {
                    txPriceColor = 'val-green';
                } else if (price < tx.price) {
                    txPriceColor = 'val-red';
                }
            } else if (cost > 0 && tx.price > 0) {
                // 如果沒有現價，使用平均成本來比較
                if (cost > tx.price) {
                    txPriceColor = 'val-green';
                } else if (cost < tx.price) {
                    txPriceColor = 'val-red';
                }
            }
            const priceClass = txPriceColor ? ` ${txPriceColor}` : '';
            c.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val${priceClass}">$${tx.price}</span></div></div>`; 
        }); 
    }

    // Async Updates
    async function refreshAllData(updateChart = true) { const icon=document.getElementById('refreshIcon'); if(icon) icon.classList.add('fa-spin-fast'); await updateRates(); if(settings.apiKey||settings.fugleKey)await fetchPrices(); if(updateChart) updateChartData(); setTimeout(()=>{if(icon) icon.classList.remove('fa-spin-fast');},500); }
    async function updateRates() { try{const r=await fetch('https://api.exchangerate-api.com/v4/latest/USD');const d=await r.json();if(d.rates?.TWD)settings.usdRate=d.rates.TWD;}catch(e){} if(settings.apiKey){try{const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=COINBASE:USDT-USD&token=${settings.apiKey}`);const j=await r.json();if(j.c)settings.usdtRate=j.c;}catch(e){}} saveSettings(); document.getElementById('rateUsd').innerText=`USD ≈ ${settings.usdRate.toFixed(2)}`; document.getElementById('rateUsdt').innerText=`USDT ≈ ${settings.usdtRate.toFixed(3)} USD`; renderAssets(); }
    async function refreshStockInfo() {
        const stockAccounts = accounts.filter(acc => acc.type === 'stock' && acc.symbol);
        const twstockAccounts = accounts.filter(acc => acc.type === 'twstock' && acc.symbol);
        const cryptoAccounts = accounts.filter(acc => acc.type === 'crypto' && acc.symbol);
        
        if(stockAccounts.length === 0 && twstockAccounts.length === 0 && cryptoAccounts.length === 0) {
            alert('沒有需要重新整理的股票資訊');
            return;
        }
        
        // 顯示遮罩層和進度條
        const overlay = document.getElementById('refreshStockOverlay');
        const progressToast = document.getElementById('refreshStockProgressToast');
        const progressBar = document.getElementById('refreshStockProgressBar');
        const progressText = document.getElementById('refreshStockProgressText');
        overlay.style.display = 'block';
        progressToast.style.display = 'block';
        progressBar.style.width = '5%';
        progressText.innerText = '準備中...';
        
        let updated = 0;
        let total = stockAccounts.length + twstockAccounts.length + cryptoAccounts.length;
        let current = 0;
        
        // 重新整理美股資訊
        for(let acc of stockAccounts) {
            current++;
            progressBar.style.width = `${5 + (current / total) * 33}%`;
            progressText.innerText = `更新美股: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                const profile = await fetchUSStockProfile(sym);
                if(profile) {
                    if(profile.name) acc.name = profile.name;
                    if(profile.logo) acc.logo = profile.logo;
                    updated++;
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 200));
            } catch(e) {
                console.error(`Failed to refresh stock info for ${acc.symbol}:`, e);
            }
        }
        
        // 重新整理台股資訊
        for(let acc of twstockAccounts) {
            current++;
            progressBar.style.width = `${38 + ((current - stockAccounts.length) / Math.max(twstockAccounts.length, 1)) * 33}%`;
            progressText.innerText = `更新台股: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol;
                if(/^\d{4}$/.test(sym)) {
                    const companyName = await fetchTWStockName(sym);
                    if(companyName) {
                        acc.name = companyName;
                        updated++;
                    }
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 150));
            } catch(e) {
                console.error(`Failed to refresh twstock info for ${acc.symbol}:`, e);
            }
        }
        
        // 重新整理加密貨幣資訊
        for(let acc of cryptoAccounts) {
            current++;
            progressBar.style.width = `${71 + ((current - stockAccounts.length - twstockAccounts.length) / Math.max(cryptoAccounts.length, 1)) * 24}%`;
            progressText.innerText = `更新加密貨幣: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol;
                const logoUrl = await fetchCryptoLogo(sym);
                if(logoUrl) {
                    acc.logo = logoUrl;
                    updated++;
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 150));
            } catch(e) {
                console.error(`Failed to refresh crypto info for ${acc.symbol}:`, e);
            }
        }
        
        // 保存更新後的資料
        progressBar.style.width = '95%';
        progressText.innerText = '儲存資料中...';
        saveData();
        
        // 重新渲染列表和圖表
        progressBar.style.width = '100%';
        progressText.innerText = '完成！';
        renderAssets();
        updateChartData();
        
        // 延遲後隱藏遮罩層和進度條
        setTimeout(() => {
            overlay.style.display = 'none';
            progressToast.style.display = 'none';
            progressBar.style.width = '0%';
            alert(`已重新整理 ${updated}/${total} 個股票資訊`);
        }, 500);
    }
    async function fetchPrices() { const autos=accounts.filter(a=>a.isAuto&&a.symbol); for(let acc of autos){ try{ if(acc.type==='twstock'){ if(!settings.fugleKey)continue; await new Promise(r=>setTimeout(r,150)); const res=await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${acc.symbol}`,{headers:{'X-API-KEY':settings.fugleKey}}); const j=await res.json(); if(j){ const price=j.lastPrice||(j.trade&&j.trade.price)||(j.trades&&j.trades[0]&&j.trades[0].price)||0; const changePercent=j.changePercent||(j.trade&&j.trade.changePercent)||0; const prevClose=j.previousClose||(price&&changePercent?price/(1+changePercent/100):price)||price; acc.currentPrice=price; acc.dayChangePercent=changePercent||0; acc.dayChange=(price-prevClose)||0; } } else { if(!settings.apiKey)continue; let sym=acc.symbol; if(acc.type==='crypto'){ if(acc.symbol==='USDT'||acc.symbol==='USDC'){acc.currentPrice=1;acc.dayChange=0;acc.dayChangePercent=0;continue;} if(!sym.includes(':'))sym=`COINBASE:${sym}-USD`; } await new Promise(r=>setTimeout(r,150)); const res=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${settings.apiKey}`); const j=await res.json(); if(j.c){ acc.currentPrice=j.c; acc.dayChange=j.d||0; acc.dayChangePercent=j.dp||0; } } }catch(e){} } saveData(); renderAssets(); }
    // Page Swiper Functions
    function switchToPage(pageIndex) {
        if(pageIndex < 0 || pageIndex >= PAGE_TYPES.length) return;
        // 檢查分頁是否啟用
        if(!isPageEnabled(pageIndex)) {
            // 如果分頁未啟用，切換到第一個啟用的分頁
            const enabledPages = getEnabledPages();
            if(enabledPages.length > 0) {
                pageIndex = enabledPages[0];
            } else {
                pageIndex = 0; // 如果沒有啟用的分頁，默認顯示總覽
            }
        }
        currentPage = pageIndex;

        // 在渲染前先將滾動位置重置到頂端，避免先顯示中間內容再滾動
        const scrollContainer = document.querySelector('.content-grid');
        if(scrollContainer) {
            scrollContainer.scrollTop = 0;
        }

        // 重新排列 page-item 的 DOM 順序，使其與 pageOrder 一致
        const domIndex = reorderPageItems();
        
        const container = document.getElementById('pageContainer');
        if(container) {
            // 重新排列後，直接使用 DOM 索引（因為 DOM 已經按照順序排列了）
            const finalIndex = domIndex >= 0 ? domIndex : getDisplayIndex(pageIndex);
            container.style.transform = `translateX(-${finalIndex * 100}%)`;
        }
        
        // 更新分頁指示器（使用 data-page 屬性匹配，而不是 DOM 索引）
        document.querySelectorAll('.page-tab').forEach((tab) => {
            const tabPageIndex = parseInt(tab.getAttribute('data-page'));
            tab.classList.toggle('active', tabPageIndex === pageIndex);
        });
        
        // 確保選中的標籤在可見範圍內（但不居中）
        const ensureTabVisible = () => {
            const activeTab = document.querySelector(`.page-tab[data-page="${pageIndex}"]`);
            const indicator = document.querySelector('.page-indicator');
            
            if(!activeTab || !indicator) return;
            
            const tabRect = activeTab.getBoundingClientRect();
            const indicatorRect = indicator.getBoundingClientRect();
            
            // 檢查標籤是否在可見範圍內
            const isVisible = tabRect.left >= indicatorRect.left && tabRect.right <= indicatorRect.right;
            
            if(!isVisible) {
                // 如果標籤在左側被切掉，滾動到左側
                if(tabRect.left < indicatorRect.left) {
                    indicator.scrollTo({
                        left: activeTab.offsetLeft - 10,
                        behavior: 'smooth'
                    });
                }
                // 如果標籤在右側被切掉，滾動到右側
                else if(tabRect.right > indicatorRect.right) {
                    const scrollLeft = activeTab.offsetLeft + activeTab.offsetWidth - indicator.clientWidth + 10;
                    indicator.scrollTo({
                        left: Math.max(0, scrollLeft),
                        behavior: 'smooth'
                    });
                }
            }
        };
        
        // 延遲執行，確保DOM更新完成
        requestAnimationFrame(() => {
            ensureTabVisible();
            setTimeout(ensureTabVisible, 100);
        });
        
        // 更新箭頭按鈕狀態（桌面版）
        updatePageNavArrows();
        
        // 隱藏圖表點擊後顯示的資訊
        hideCustomTooltip();
        
        // 清除圖表的點擊狀態（恢復所有點的狀態）
        if(chartInstance && chartInstance.series.length > 0) {
            chartInstance.series.forEach(series => {
                if(series.points) {
                    series.points.forEach(point => {
                        if(point.sliced) {
                            point.slice(false);
                        }
                        point.setState('normal');
                        const pointEl = point.graphic?.element;
                        if(pointEl) {
                            pointEl.style.setProperty('opacity', '1', 'important');
                        }
                    });
                }
            });
        }
        activeInactivePoints.clear();
        
        // 更新圖表和列表 - 切換分頁時退出 detail 模式
        chartLevel = pageIndex === 0 ? 'root' : 'page';
        
        // 取消當前正在進行的動畫（如果有的話）
        if (chartAnimationEngine && chartAnimationEngine.isAnimating) {
            chartAnimationEngine.cancel();
        }
        
        // 確保動畫引擎已初始化
        if (chartInstance && !chartAnimationEngine) {
            chartAnimationEngine = new ChartAnimationEngine(chartInstance);
        }
        
        // 使用動畫更新圖表（動畫引擎會處理沒有起始數據的情況）
        updateChartData(true);
        renderAssets();
    }
    
    // 切換到上一頁
    function switchToPrevPage() {
        const orderedPages = getOrderedPages();
        const currentIndex = orderedPages.indexOf(currentPage);
        if(currentIndex > 0) {
            switchToPage(orderedPages[currentIndex - 1]);
        }
    }
    
    // 切換到下一頁
    function switchToNextPage() {
        const orderedPages = getOrderedPages();
        const currentIndex = orderedPages.indexOf(currentPage);
        if(currentIndex < orderedPages.length - 1) {
            switchToPage(orderedPages[currentIndex + 1]);
        }
    }
    
    // 更新箭頭按鈕的禁用狀態
    function updatePageNavArrows() {
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const orderedPages = getOrderedPages();
        const currentIndex = orderedPages.indexOf(currentPage);
        
        if(prevBtn) {
            if(currentIndex <= 0) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
        }
        
        if(nextBtn) {
            if(currentIndex >= orderedPages.length - 1) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }
    }
    
    let isSwiping = false;
    let currentTransform = 0;
    let swipeStartIndex = 0;
    let isSorting = false; // 追蹤是否正在拖動排序
    
    function initSwiper() {
        const swiper = document.getElementById('pageSwiper');
        if(!swiper) return;
        const container = document.getElementById('pageContainer');
        if(!container) return;
        
        swiper.addEventListener('touchstart', (e) => {
            // 如果正在拖動排序，不處理滑動
            if(isSorting) return;
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
            
            // 獲取當前 transform 值
            const orderedPages = getOrderedPages();
            swipeStartIndex = orderedPages.indexOf(currentPage);
            if(swipeStartIndex >= 0) {
                currentTransform = -swipeStartIndex * 100;
            }
        }, { passive: true });
        
        swiper.addEventListener('touchmove', (e) => {
            // 如果正在拖動排序，不處理滑動
            if(isSorting) return;
            
            if(!touchStartX || !touchStartY) return;
            
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = touchStartX - currentX;
            const diffY = touchStartY - currentY;
            const absDiffX = Math.abs(diffX);
            const absDiffY = Math.abs(diffY);
            
            // 如果垂直滑動距離大於水平滑動距離，不處理
            if(absDiffY > absDiffX) return;
            
            // 如果水平滑動距離足夠大，標記為滑動中
            if(absDiffX > 10) {
                isSwiping = true;
                container.classList.add('swiping');
                
                // 計算滑動百分比
                // diffX = touchStartX - currentX
                // 手指向左滑動（顯示下一個頁面）：diffX > 0，應該增加負值（向右移動）
                // 手指向右滑動（顯示上一個頁面）：diffX < 0，應該減少負值（向左移動）
                const swipePercent = -(diffX / swiper.offsetWidth) * 100;
                const orderedPages = getOrderedPages();
                const minIndex = 0;
                const maxIndex = orderedPages.length - 1;
                
                // 計算新的 transform 值，限制範圍
                // currentTransform 是負數，向左滑動時應該變得更負（向右移動顯示下一個）
                let newTransform = currentTransform + swipePercent;
                const minTransform = -maxIndex * 100;
                const maxTransform = 0;
                
                // 檢查是否在邊界
                const isAtLeftBoundary = swipeStartIndex <= 0 && diffX < 0; // 總覽頁面向右滑動
                const isAtRightBoundary = swipeStartIndex >= maxIndex && diffX > 0; // 最後一頁向左滑動
                
                // 在邊界時禁用動畫（不允許滑動）
                if(isAtLeftBoundary || isAtRightBoundary) {
                    return; // 不更新 transform，保持原位置
                }
                
                // 添加阻力效果（在接近邊界時）
                if(newTransform > maxTransform) {
                    newTransform = maxTransform + (newTransform - maxTransform) * 0.3;
                } else if(newTransform < minTransform) {
                    newTransform = minTransform + (newTransform - minTransform) * 0.3;
                }
                
                container.style.transform = `translateX(${newTransform}%)`;
            }
        }, { passive: true });
        
        swiper.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].clientX;
            touchEndY = e.changedTouches[0].clientY;
            
            if(isSwiping) {
                container.classList.remove('swiping');
            handleSwipe();
            } else {
                handleSwipe();
            }
            
            isSwiping = false;
            // 重置變量
            touchStartX = 0;
            touchStartY = 0;
        }, { passive: true });
        
        // 為圖表區域也添加滑動手勢支持
        const chartSection = document.querySelector('.chart-section');
        if(chartSection) {
            chartSection.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
            }, { passive: true });
            
            chartSection.addEventListener('touchmove', (e) => {
                if(!touchStartX || !touchStartY) return;
                
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = touchStartX - currentX;
                const diffY = touchStartY - currentY;
                const absDiffX = Math.abs(diffX);
                const absDiffY = Math.abs(diffY);
                
                if(absDiffY > absDiffX) return;
                
                if(absDiffX > 10) {
                    isSwiping = true;
                    const container = document.getElementById('pageContainer');
                    if(container) {
                        container.classList.add('swiping');
                        // 修正方向：手指向左滑動時顯示下一個頁面（向右移動）
                        const swipePercent = -(diffX / chartSection.offsetWidth) * 100;
                        const orderedPages = getOrderedPages();
                        const swipeStartIndex = orderedPages.indexOf(currentPage);
                        if(swipeStartIndex >= 0) {
                            const maxIndex = orderedPages.length - 1;
                            
                            // 檢查是否在邊界
                            const isAtLeftBoundary = swipeStartIndex <= 0 && diffX < 0; // 總覽頁面向右滑動
                            const isAtRightBoundary = swipeStartIndex >= maxIndex && diffX > 0; // 最後一頁向左滑動
                            
                            // 在邊界時禁用動畫（不允許滑動）
                            if(isAtLeftBoundary || isAtRightBoundary) {
                                return; // 不更新 transform，保持原位置
                            }
                            
                            let newTransform = -swipeStartIndex * 100 + swipePercent;
                            const minTransform = -maxIndex * 100;
                            const maxTransform = 0;
                            
                            // 添加阻力效果（在接近邊界時）
                            if(newTransform > maxTransform) {
                                newTransform = maxTransform + (newTransform - maxTransform) * 0.3;
                            } else if(newTransform < minTransform) {
                                newTransform = minTransform + (newTransform - minTransform) * 0.3;
                            }
                            
                            container.style.transform = `translateX(${newTransform}%)`;
                        }
                    }
                }
            }, { passive: true });
            
            chartSection.addEventListener('touchend', (e) => {
                // 如果正在拖動排序，不處理滑動
                if(isSorting) {
                    touchStartX = null;
                    touchStartY = null;
                    return;
                }
                
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                const container = document.getElementById('pageContainer');
                if(container && isSwiping) {
                    container.classList.remove('swiping');
                }
                if(isSwiping) {
                handleSwipe();
                }
                isSwiping = false;
            }, { passive: true });
        }
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        const orderedPages = getOrderedPages();
        const currentIndex = orderedPages.indexOf(currentPage);
        const maxIndex = orderedPages.length - 1;
        
        // 計算水平和垂直滑動的絕對值
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，則不觸發分頁切換（鎖住左右滑動）
        if(absDiffY > absDiffX) {
            // 回彈到原位置
            if(isSwiping) {
                const container = document.getElementById('pageContainer');
                if(container) {
                    container.style.transform = `translateX(-${currentIndex * 100}%)`;
                }
            }
            return;
        }
        
        // 檢查是否在邊界
        const isAtLeftBoundary = currentIndex <= 0 && diffX < 0; // 總覽頁面向右滑動
        const isAtRightBoundary = currentIndex >= maxIndex && diffX > 0; // 最後一頁向左滑動
        
        // 在邊界時回彈到原位置，不觸發切換
        if(isAtLeftBoundary || isAtRightBoundary) {
            const container = document.getElementById('pageContainer');
            if(container) {
                container.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
            return;
        }
        
        // 只有當水平滑動距離足夠大時才觸發分頁切換
        if(absDiffX > swipeThreshold) {
            if(diffX > 0) {
                // 手指向左滑動（touchStartX > touchEndX），顯示下一個分頁
                if(currentIndex < maxIndex) {
                    switchToPage(orderedPages[currentIndex + 1]);
                }
            } else {
                // 手指向右滑動（touchStartX < touchEndX），顯示上一個分頁
                if(currentIndex > 0) {
                    switchToPage(orderedPages[currentIndex - 1]);
                }
            }
        } else if(isSwiping) {
            // 滑動距離不夠，回彈到原位置
            const container = document.getElementById('pageContainer');
            if(container) {
                container.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
        }
    }
    
    function renderAssets() { 
        sortables.forEach(s=>s.destroy()); 
        sortables=[]; 
        
        // 在桌面模式下，動態計算並對齊列表標題與圓餅圖中心
        if(window.matchMedia('(min-width: 768px)').matches) {
            setTimeout(() => {
                const chartWrapper = document.querySelector('#chartWrapper');
                const firstGroupHeader = document.querySelector('.list-section .page-container > div:first-child.group-header');
                if(chartWrapper && firstGroupHeader) {
                    // 取得圓餅圖的中心位置（相對於視窗）
                    const chartRect = chartWrapper.getBoundingClientRect();
                    const chartCenterY = chartRect.top + (chartRect.height / 2);
                    
                    // 取得列表標題的位置（相對於視窗）
                    const headerRect = firstGroupHeader.getBoundingClientRect();
                    const headerTopY = headerRect.top;
                    
                    // 計算需要補償的高度差：讓 group-header 的頂部與圓餅圖中心對齊
                    const offset = chartCenterY - headerTopY;
                    if(offset > 0) {
                        firstGroupHeader.style.marginTop = `${offset}px`;
                    } else {
                        firstGroupHeader.style.marginTop = '0px';
                    }
                }
            }, 300);
        }
        
        let displayAmount = 0;
        let totalDailyPnL = 0;
        
        if(currentPage === 0) {
            // 總覽分頁：計算總淨資產（只包含啟用分頁的資產減去負債）
            accounts.forEach(acc => {
                // 只計算啟用分頁的資產
                if(acc.type !== 'debt') {
                    if(acc.type === 'bank' && !pageVisibility['bank']) return;
                    if(acc.type === 'stock' && !pageVisibility['stock']) return;
                    if(acc.type === 'twstock' && !pageVisibility['twstock']) return;
                    if(acc.type === 'crypto' && !pageVisibility['crypto']) return;
                }
                let val = calculateValue(acc);
                if(acc.type === 'debt') displayAmount -= val;
                else displayAmount += val;
                if(acc.isAuto) totalDailyPnL += calculateDailyPnL(acc);
            });
        } else {
            // 其他分頁：只計算該分頁類別的總額
            const currentType = PAGE_TYPES[currentPage];
            accounts.forEach(acc => {
                if(acc.type === currentType) {
                    let val = calculateValue(acc);
                    displayAmount += val;
                    if(acc.isAuto) totalDailyPnL += calculateDailyPnL(acc);
                }
            });
        }
        
        // 計算總損益
        let totalCostPnL = 0;
        accounts.forEach(acc => {
            if(acc.isAuto) {
                if(currentPage === 0) {
                    // 總覽分頁：只計算啟用分頁的資產
                    if(acc.type !== 'debt') {
                        if(acc.type === 'bank' && !pageVisibility['bank']) return;
                        if(acc.type === 'stock' && !pageVisibility['stock']) return;
                        if(acc.type === 'twstock' && !pageVisibility['twstock']) return;
                        if(acc.type === 'crypto' && !pageVisibility['crypto']) return;
                    }
                    totalCostPnL += calculateCostPnL(acc);
                } else {
                    // 其他分頁：只計算該分頁類別的資產
                    const currentType = PAGE_TYPES[currentPage];
                    if(acc.type === currentType) {
                        totalCostPnL += calculateCostPnL(acc);
                    }
                }
            }
        });
        
        // 計算記帳盈虧並加入總計
        if(currentPage === 0) {
            // 總覽頁面：股票盈虧 + 記帳盈虧
            const journalDailyPnL = calculateJournalDailyPnL();
            const journalTotalPnL = calculateJournalTotalPnL();
            // 應用偏移值（如果已歸零）
            totalDailyPnL += journalDailyPnL + getDailyPnLOffset();
            totalCostPnL += journalTotalPnL + getTotalPnLOffset();
        } else if(currentPage === 1) {
            // 錢包頁面：只顯示記帳盈虧
            const journalDailyPnL = calculateJournalDailyPnL();
            const journalTotalPnL = calculateJournalTotalPnL();
            // 應用偏移值（如果已歸零）
            totalDailyPnL = journalDailyPnL + getDailyPnLOffset();
            totalCostPnL = journalTotalPnL + getTotalPnLOffset();
        }
        // 股票頁面（第2、3、4頁）保持原有邏輯，不加入記帳盈虧

        // 更新總資產顯示
        document.getElementById('totalNetWorth').innerText = formatAmount(displayAmount);
        const b = document.getElementById('totalPnLBlock');
        const bd = document.getElementById('totalPnLBadge');
        if(Math.abs(totalDailyPnL) > 1 || Math.abs(totalCostPnL) > 1) {
            b.style.display = 'block';
            // 重置樣式，確保損益正常顯示
            bd.style.visibility = 'visible';
            bd.style.height = '';
            bd.style.margin = '';
            bd.style.padding = '';
            let pnlHtml = '';
            // 顯示當日損益
            if(Math.abs(totalDailyPnL) > 1) {
                const s = totalDailyPnL > 0 ? '+' : '';
                const c = totalDailyPnL > 0 ? 'pnl-up' : 'pnl-down';
                pnlHtml += `今日: <span class="${c}">${s}${formatAmount(totalDailyPnL)}</span>`;
            }
            // 顯示總損益
            if(Math.abs(totalCostPnL) > 1) {
                if(pnlHtml) pnlHtml += ' / ';
                const s = totalCostPnL > 0 ? '+' : '';
                const c = totalCostPnL > 0 ? 'pnl-up' : 'pnl-down';
                pnlHtml += `總計: <span class="${c}">${s}${formatAmount(totalCostPnL)}</span>`;
            }
            bd.innerHTML = pnlHtml;
        } else {
            // 即使沒有損益也顯示空白區塊，保持與其他分頁對齊（完全不可見但佔位）
            b.style.display = 'block';
            bd.style.visibility = 'hidden';
            bd.style.height = '0';
            bd.style.margin = '0';
            bd.style.padding = '0';
            bd.innerHTML = '';
        }
        
        // 更新摘要標籤
        const summaryLabelEl = document.getElementById('summaryLabel');
        if(currentPage === 0) {
            if(summaryLabelEl) summaryLabelEl.innerText = '總淨資產';
        } else {
            if(summaryLabelEl) summaryLabelEl.innerText = `${PAGE_NAMES[currentPage]} 總額`;
        }
        
        // 渲染總覽分頁（第0頁）- 顯示各類別卡片（與其他分頁格式一致）
        if(currentPage === 0) {
            const c = document.getElementById('assetsContainer');
            if(c) {
                c.innerHTML = '';
                const categoryConfig = {
                    'bank': {t:'錢包', i:'fa-university', s:'icon-bank'},
                    'stock': {t:'美股', i:'fa-chart-line', s:'icon-stock'},
                    'twstock': {t:'台股', i:'fa-chart-line', s:'icon-twstock'},
                    'crypto': {t:'加密貨幣', i:'fa-bitcoin', s:'icon-crypto'}
                };
                
                // 按照 pageOrder 順序獲取分類類型（排除總覽，只包含啟用的分頁）
                const orderedCategoryTypes = pageOrder
                    .filter(index => index !== 0) // 排除總覽
                    .map(index => PAGE_TYPES[index]) // 轉換為類型名稱
                    .filter(type => pageVisibility[type] !== false); // 只包含啟用的分頁
                
                let allItems = [];
                orderedCategoryTypes.forEach(type => {
                    
                    const g = categoryConfig[type];
                    if(!g) return;
                    let items = accounts.filter(a => a.type === type);
                    let sum = 0;
                    let groupPnL = 0;
                    items.forEach(acc => {
                        let val = calculateValue(acc);
                        sum += val;
                        groupPnL += calculatePnL(acc);
                    });
                    // 即使沒有資產也要顯示，顯示為 0
                    allItems.push({type: type, name: g.t, icon: g.i, iconClass: g.s, sum: sum, pnl: groupPnL});
                });
                
                // 所有分類都會顯示，不需要檢查是否為空
                
                let totalSum = 0;
                let totalPnL = 0;
                let html = '';
                
                allItems.forEach(item => {
                    totalSum += item.sum;
                    totalPnL += item.pnl;
                    
                    let htmlContent = `<div class="item-name">${item.name}</div><div class="item-row">總覽</div>`;
                    let color = 'amount-green';
                    
                    // 檢查該項目是否被隱藏
                    let itemHidden = localStorage.getItem(`itemHidden_category-${item.type}`) === 'true';
                    let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
                    
                    let pnlHtml = '';
                    if(Math.abs(item.pnl) > 0.01) {
                        pnlHtml = `<div class="amount-pnl item-numbers">${formatPnL(item.pnl)}</div>`;
                    }
                    
                    let categoryClick = isEditMode ? '' : `onclick="switchToPage(${PAGE_TYPES.indexOf(item.type)})"`;
                    html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${categoryClick} data-id="category-${item.type}"><div class="item-icon ${item.iconClass}"><i class="fas ${item.icon}"></i></div><div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val-wrapper"><div class="amount-val item-numbers ${color}">${formatAmount(item.sum)}</div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers('category-${item.type}')" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div>${pnlHtml}</div></div></div>`;
                });
                
                let pHtml = totalPnL !== 0 ? `<span class="group-pnl numbers-content">${formatPnL(totalPnL)}</span>` : '';
                c.innerHTML = `<div class="group-header"><span>總覽</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(totalSum)}</span>${pHtml}</div></div><div class="list-container" id="group-overview">${html}</div>`;
                
                // 設置總覽分頁的拖曳排序（類別卡片排序）
                if(isEditMode) {
                    let el = document.getElementById('group-overview');
                    if(el) {
                        sortables.push(Sortable.create(el, {
                            animation: 150,
                            onStart: function() {
                                // 開始拖動時，禁用左右滑動
                                isSorting = true;
                            },
                            onEnd: function(evt) { 
                                // 結束拖動時，恢復左右滑動
                                isSorting = false;
                                
                                // 獲取新的類別順序
                                let newCategoryOrder = Array.from(evt.from.children).map(c => {
                                    let dataId = c.getAttribute('data-id');
                                    if(dataId && dataId.startsWith('category-')) {
                                        return dataId.replace('category-', '');
                                    }
                                    return null;
                                }).filter(id => id !== null);
                                
                                // 將類別順序轉換為分頁索引順序，更新 pageOrder
                                const newPageOrder = [0]; // 總覽始終在第一位
                                newCategoryOrder.forEach(type => {
                                    const pageIndex = PAGE_TYPES.indexOf(type);
                                    if(pageIndex > 0) {
                                        newPageOrder.push(pageIndex);
                                    }
                                });
                                
                                // 更新 pageOrder
                                pageOrder = newPageOrder;
                                savePageOrder();
                                
                                // 重新排列 page-item 的 DOM 順序
                                const domIndex = reorderPageItems();
                                
                                // 重新渲染界面以反映新的順序
                                renderPageIndicator();
                                renderPageVisibilitySettings();
                                
                                // 確保當前分頁的位置正確
                                const container = document.getElementById('pageContainer');
                                if(container) {
                                    const finalIndex = domIndex >= 0 ? domIndex : getDisplayIndex(currentPage);
                                    container.style.transform = `translateX(-${finalIndex * 100}%)`;
                                }
                            }
                        }));
                    }
                }
            }
        }
        
        // 渲染其他分頁（第1-4頁）
        PAGE_TYPES.forEach((type, pageIdx) => {
            if(pageIdx === 0) return; // 跳過總覽分頁
            
            // 只渲染啟用的分頁
            if(!isPageEnabled(pageIdx)) {
                const containerId = pageIdx === 1 ? 'assetsContainer1' : (pageIdx === 2 ? 'assetsContainer2' : (pageIdx === 3 ? 'assetsContainer3' : 'assetsContainer4'));
                const c = document.getElementById(containerId);
                if(c) c.innerHTML = '';
                return;
            }
            
            const containerId = pageIdx === 1 ? 'assetsContainer1' : (pageIdx === 2 ? 'assetsContainer2' : (pageIdx === 3 ? 'assetsContainer3' : 'assetsContainer4'));
            const c = document.getElementById(containerId);
            if(!c) return;
            
            const groupConfig = {
                'bank': {t:'錢包', i:'fa-university', s:'icon-bank'},
                'stock': {t:'美股', i:'fa-chart-line', s:'icon-stock'},
                'twstock': {t:'台股', i:'fa-chart-line', s:'icon-twstock'},
                'crypto': {t:'加密貨幣', i:'fa-bitcoin', s:'icon-crypto'}
            };
            const g = groupConfig[type];
            if(!g) return;
            
            // 分頁模式：顯示該類別內的資產列表
            c.innerHTML = '';
            let items = accounts.filter(a => a.type === type).sort((a,b) => (a.order||0) - (b.order||0));
            if(items.length === 0) {
                c.innerHTML = '<div style="text-align:center; color:#666; padding:30px 0;">暫無資產</div>';
                return;
            }
            
            let sum = 0;
            let groupPnL = 0;
            let html = '';
            
            // 直接顯示所有帳戶，不按銀行分組
            items.forEach(acc => {
                let val = calculateValue(acc);
                let pnl = calculatePnL(acc);
                sum += val;
                groupPnL += pnl;
                
                let htmlContent = '';
                if(acc.isAuto) {
                    let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 台股和美股/加密貨幣都統一格式，不使用前綴
                    let pricePrefix = '';
                    // 簡化價格顯示，去掉單位（台股和美股都統一格式），沒有資料時顯示 N/A
                    // 對於 USDT/USDC 等穩定幣，價格顯示為 1.00
                    let price = '';
                    if(acc.currentPrice) {
                        if((sym === 'USDT' || sym === 'USDC') && acc.currentPrice === 1) {
                            price = '1.00';
                        } else {
                            price = `${pricePrefix}${acc.currentPrice.toLocaleString()}`;
                        }
                    } else {
                        price = 'N/A';
                    }
                    let chg = '';
                    if(acc.dayChangePercent !== undefined && acc.dayChangePercent !== null) {
                        // 對於 USDT/USDC 等穩定幣，如果漲跌幅為 0，不顯示
                        if((sym === 'USDT' || sym === 'USDC') && acc.dayChangePercent === 0) {
                            chg = '';
                        } else {
                            let s = acc.dayChangePercent > 0 ? '+' : '';
                            let c = acc.dayChangePercent > 0 ? 'sub-green' : 'sub-red';
                            chg = `<span class="${c}">${s}${acc.dayChangePercent.toFixed(2)}%</span>`;
                        }
                    } else if(acc.currentPrice && (sym !== 'USDT' && sym !== 'USDC')) {
                        // 有價格但沒有漲跌幅，且不是穩定幣，顯示 N/A
                        chg = `<span>N/A</span>`;
                    }
                    // 計算盈虧（用於顯示在當日和成本行的右邊）
                    let dailyPnL = acc.isAuto ? calculateDailyPnL(acc) : 0;
                    let costPnL = acc.isAuto ? calculateCostPnL(acc) : 0;
                    let dailyPnLHtml = '';
                    let costPnLHtml = '';
                    
                    // 美股、台股、加密貨幣：將盈虧顯示在當日和成本行的最右邊
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        if(Math.abs(dailyPnL) > 0.01) {
                            dailyPnLHtml = `<span style="margin-left: auto;">${formatPnL(dailyPnL)}</span>`;
                        }
                        if(acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0 && Math.abs(costPnL) > 0.01) {
                            costPnLHtml = `<span style="margin-left: auto;">${formatPnL(costPnL)}</span>`;
                        }
                    }
                    
                    // 第一行：當日標籤 + 價格 + 當天漲跌幅 + 當日盈虧（美股、台股、加密貨幣）
                    // USDT/USDC 特別處理：不顯示當日和成本行
                    let line1 = '';
                    let line2 = '';
                    if(sym !== 'USDT' && sym !== 'USDC') {
                        line1 = chg ? `<div class="item-row-compact"><span class="price-label">當日</span><span>${price}</span>${chg}${dailyPnLHtml}</div>` : `<div class="item-row-compact"><span class="price-label">當日</span><span>${price}</span>${dailyPnLHtml}</div>`;
                        // 第二行：成本標籤 + 成本 + 成本百分比 + 成本盈虧（美股、台股；加密貨幣不顯示成本）
                        if(acc.type !== 'crypto' && acc.cost && acc.cost > 0) {
                            if(acc.currentPrice && acc.currentPrice > 0) {
                                let pnlPct = ((acc.currentPrice - acc.cost) / acc.cost) * 100;
                                let s = pnlPct >= 0 ? '+' : '';
                                let c = pnlPct >= 0 ? 'sub-green' : 'sub-red';
                                let costPrefix = '';
                                // 簡化：只顯示成本和百分比，加上"成本"標籤
                                // 美股、台股：line2 不包含股數，股數會放在代碼行
                                line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>${costPrefix}${acc.cost.toFixed(2)}</span><span class="${c}">${s}${pnlPct.toFixed(1)}%</span>${costPnLHtml}</div>`;
                            } else {
                                // 有成本但沒有當前價格，顯示成本和 N/A
                                let costPrefix = '';
                                line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>${costPrefix}${acc.cost.toFixed(2)}</span><span>N/A</span>${costPnLHtml}</div>`;
                            }
                        } else if(acc.type !== 'crypto') {
                            // 沒有成本時，顯示 N/A（加密貨幣不顯示）
                            line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>N/A</span></div>`;
                        }
                    }
                    // 美股、台股、加密貨幣：分開顯示公司名稱和代號
                    let displayName = acc.type === 'stock' ? cleanCompanyName(acc.name) : acc.name;
                    // 美股、台股、加密貨幣使用新佈局：第一行公司名稱，第二行代號+價格資訊
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        // 檢查該項目是否被隱藏（需要在這裡檢查，因為後面會用到 eyeIcon）
                        let itemHiddenTemp = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
                        let eyeIconTemp = itemHiddenTemp ? 'fa-eye-slash' : 'fa-eye';
                        // 第二行：代號，第三行開始：價格資訊（line1 和 line2）
                        let symbolRow = '';
                        // 美股、台股、加密貨幣：即使 displayName === sym 也要顯示代碼行（因為需要顯示股數和正確的排版）
                        if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                            // 美股、台股、加密貨幣：股數放在代碼同一行的最右邊，當日和成本往下移兩行
                            let balanceUnit = acc.type === 'crypto' ? '' : '股';
                            // USDT/USDC 特別處理：不顯示當日和成本行，所以不需要 spacer
                            let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                            // 加密貨幣沒有成本行（line2），但 line1 要顯示在 line2 的位置，所以需要兩個 spacer
                            let spacerHtml = '';
                            let displayLine1 = '';
                            let displayLine2 = '';
                            if(isStableCoin) {
                                spacerHtml = '';
                                displayLine1 = '';
                                displayLine2 = '';
                            } else if(acc.type === 'crypto') {
                                spacerHtml = '<div class="symbol-spacer"></div><div class="symbol-spacer"></div>'; // 加密貨幣需要兩個 spacer，讓 line1 顯示在 line2 的位置
                                displayLine1 = ''; // 第一個 spacer 位置留空
                                displayLine2 = line1; // line1 顯示在 line2 的位置
                            } else {
                                spacerHtml = '<div class="symbol-spacer"></div><div class="symbol-spacer"></div>'; // 美股、台股有 line1 和 line2，所以需要兩個 spacer
                                displayLine1 = line1;
                                displayLine2 = line2;
                            }
                            if(sym) {
                                symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">${sym || 'N/A'}</span><span class="symbol-balance">${acc.balance || 'N/A'}${balanceUnit}</span></div>${spacerHtml}${displayLine1}${displayLine2}</div>`;
                            } else {
                                // 沒有代碼時，也要保持排版結構，但代碼顯示 N/A
                                symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">N/A</span><span class="symbol-balance">${acc.balance || 'N/A'}${balanceUnit}</span></div>${spacerHtml}${displayLine1}${displayLine2}</div>`;
                            }
                        } else if(sym && displayName !== sym) {
                            // 其他類型：只有當 displayName !== sym 時才顯示代碼行
                            symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">${sym}</span></div><div class="symbol-spacer"></div>${line1}${line2}</div>`;
                        } else {
                            // 沒有代碼時，直接顯示價格資訊
                            symbolRow = `<div class="item-symbol-row">${line1}${line2}</div>`;
                        }
                        // 股數顯示位置
                        let balanceDisplay = '';
                        if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                            // 美股、台股、加密貨幣：股數已移到代碼行，眼睛下方不顯示
                            balanceDisplay = '';
                        } else {
                            // 其他類型：股數放在眼睛按鈕下方
                            balanceDisplay = `<div class="item-balance-below-eye">${acc.balance || 'N/A'}</div>`;
                        }
                        htmlContent = `<div class="item-name-row"><div class="item-name">${displayName}</div><div class="item-eye-wrapper"><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIconTemp}"></i></button>${balanceDisplay}</div></div>${symbolRow}`;
                    } else {
                        // 其他分類保持原來的佈局
                        htmlContent = `<div class="item-name">${displayName}</div>${line1}${line2}`;
                    }
                 } else {
                     // 錢包項目：移除幣別顯示，顯示標籤（使用新的標籤格式）
                     const tagHTML = generateAccountTagHTML(acc);
                     htmlContent = `<div class="item-name">${acc.name}</div><div class="item-row">${tagHTML}</div>`;
                 }
                
                // 如果是信用卡類型，使用紅色；否則使用綠色
                let color = (acc.type === 'bank' && acc.bankTag === '信用卡') ? 'amount-red' : 'amount-green';
                let hdl = isEditMode ? `<div class="drag-handle"><i class="fas fa-bars"></i></div>` : '';
                let clk = isEditMode ? '' : `onclick="openDetailView(${acc.id})"`;
                let dailyPnL = acc.isAuto ? calculateDailyPnL(acc) : 0;
                let costPnL = acc.isAuto ? calculateCostPnL(acc) : 0;
                let pnlHtml = '';
                
                if(acc.isAuto) {
                    // 美股、台股、加密貨幣：盈虧已經顯示在當日和成本行的右邊，所以右側不需要顯示盈虧
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        // USDT/USDC 特別處理：不顯示當日和成本行，所以不需要 spacer
                        let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                        let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                        if(isStableCoin) {
                            pnlHtml = '';
                        } else if(acc.type === 'crypto') {
                            // 加密貨幣只有一行（當日顯示在 line2 位置），所以只需要一個 spacer（對應第二個 symbol-spacer）
                            pnlHtml = `<div class="amount-spacer"></div>`;
                        } else {
                            // 美股、台股有 line1 和 line2，所以需要兩個 spacer
                            pnlHtml = `<div class="amount-spacer"></div><div class="amount-spacer"></div>`;
                        }
                    } else {
                        // 其他類型：保持原樣，在右側顯示盈虧
                        let hasLine3 = (acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0);
                        let pnlLines = [];
                        // 同時顯示當日損益和總損益
                        if(Math.abs(dailyPnL) > 0.01) {
                            pnlLines.push(`<span style="font-size: 10px; color: #8e8e93;">今日</span><br>${formatPnL(dailyPnL)}`);
                        }
                        if(hasLine3 && Math.abs(costPnL) > 0.01) {
                            pnlLines.push(`<span style="font-size: 10px; color: #8e8e93;">總計</span><br>${formatPnL(costPnL)}`);
                        }
                        if(pnlLines.length > 0) {
                            pnlHtml = pnlLines.map(value => `<div class="amount-pnl item-numbers">${value}</div>`).join('');
                        } else {
                            pnlHtml = `<div class="amount-spacer"></div><div class="amount-spacer"></div>`;
                        }
                    }
                } else {
                    pnlHtml = `<div class="amount-spacer"></div>`;
                    if(pnl !== 0) {
                        pnlHtml += `<div class="amount-pnl item-numbers">${formatPnL(pnl)}</div>`;
                    } else {
                        pnlHtml += '';
                    }
                }
                
                // 檢查該項目是否被隱藏
                let itemHidden = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
                let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
                
                // 美股和加密貨幣且有 logo 時顯示 logo，否則顯示 icon
                let iconHtml = '';
                if((acc.type === 'stock' || acc.type === 'crypto') && acc.logo) {
                    iconHtml = `<div class="item-icon ${g.s}"><img src="${acc.logo}" alt="${acc.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas ${g.i}\\'></i>';"></div>`;
                } else {
                    iconHtml = `<div class="item-icon ${g.s}"><i class="fas ${g.i}"></i></div>`;
                }
                 // 美股、台股、加密貨幣使用新佈局：第一行只顯示公司名稱，金額從第二行開始
                 if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                     // 檢查是否為 USDT/USDC 穩定幣
                     let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                     let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                     // 美股、台股、加密貨幣：現值金額往下移一行（對齊代碼+股數）
                     // USDT/USDC 特別處理：不顯示當日和成本行，所以只需要一個空白行，不需要兩個 spacer
                     let nameRowHeight = (acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') ? '19px' : '0';
                     let pnlSpacer = isStableCoin ? '' : ((acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') ? '<div class="amount-spacer"></div><div class="amount-spacer"></div>' : '');
                     // 美股、台股、加密貨幣：現值金額放在第二行（對齊代碼+股數），需要 item-amount-name-row
                     html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${clk} data-id="${acc.id}">${iconHtml}<div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount-name-row" style="height: ${nameRowHeight}; margin-bottom: ${nameRowHeight === '19px' ? '3px' : '0'};"></div><div class="item-amount"><div class="amount-val item-numbers ${color}">${formatAmount(val)}</div>${pnlSpacer}${pnlHtml}</div></div>${hdl}</div>`;
                } else {
                    // 其他分類（錢包等）：眼睛按鈕放在金額右邊
                    html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${clk} data-id="${acc.id}">${iconHtml}<div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val-wrapper"><div class="amount-val item-numbers ${color}">${formatAmount(val)}</div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div>${pnlHtml}</div></div>${hdl}</div>`;
                }
            });
            
            let pHtml = groupPnL !== 0 ? `<span class="group-pnl numbers-content">${formatPnL(groupPnL)}</span>` : '';
            c.innerHTML = `<div class="group-header"><span>${g.t}</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(sum)}</span>${pHtml}</div></div><div class="list-container" id="group-${type}">${html}</div>`;
            
            // 設置拖曳排序
            if(isEditMode) {
                let el = document.getElementById(`group-${type}`);
                if(el) {
                    sortables.push(Sortable.create(el, {
                        animation: 150,
                        onStart: function() {
                            // 開始拖動時，禁用左右滑動
                            isSorting = true;
                        },
                        onEnd: function(evt) {
                            // 結束拖動時，恢復左右滑動
                            isSorting = false;
                            updateOrder(type, evt.from);
                        }
                    }));
                }
            }
        });
        
        // 渲染負債（始終顯示）
        renderDebt();
        
        // 更新圖表
        updateChartData();
    }
    
    function renderDebt(containerId = null) {
        // 如果沒有指定容器，為每個分頁渲染負債
        if(!containerId) {
            for(let i = 0; i < 5; i++) {
                renderDebt(`debtContainer${i}`);
            }
            return;
        }
        
        const debtContainer = document.getElementById(containerId);
        if(!debtContainer) return;
        
        let debtItems = accounts.filter(a => a.type === 'debt').sort((a,b) => (a.order||0) - (b.order||0));
        if(debtItems.length === 0) {
            debtContainer.innerHTML = '';
            return;
        }
        
        let totalDebt = 0;
        let html = '';
        
        debtItems.forEach(acc => {
            let val = calculateValue(acc);
            totalDebt += val;
            // 檢查該項目是否被隱藏
            let itemHidden = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
            let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
            
            // 顯示當前選擇的顯示幣別，而不是帳戶的原始幣別
            let displayCurrency = currentDisplayCurrency;
            
            let debtClick = isEditMode ? '' : `onclick="openDetailView(${acc.id})"`;
            html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${debtClick} data-id="${acc.id}"><div class="item-icon icon-debt"><i class="fas fa-hand-holding-usd"></i></div><div class="item-content"><div class="item-name">${acc.name}</div><div class="item-row">${displayCurrency}</div></div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val item-numbers amount-red">${formatAmount(val)}</div></div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div></div>`;
        });
        
        debtContainer.innerHTML = `<div class="group-header"><span>負債</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(totalDebt)}</span></div></div><div class="list-container" id="group-debt-${containerId}">${html}</div>`;
        
        // 負債不允許拖動排序，即使是在編輯模式下
        // 負債始終鎖定在最底部
    }

    // Currency Toggle Function
    function toggleCurrency() {
        currentDisplayCurrency = currentDisplayCurrency === 'TWD' ? 'USD' : 'TWD';
        localStorage.setItem('displayCurrency', currentDisplayCurrency);
        // 同步到 settings 並保存到 Firestore
        settings.displayCurrency = currentDisplayCurrency;
        saveSettings();
        updateCurrencyButton();
        renderAssets();
        // 只有在詳細視圖已經打開的情況下才更新詳細視圖，不要重新打開已關閉的視圖
        const detailView = document.getElementById('detailView');
        if(currentDetailAcc && detailView && detailView.classList.contains('active')) {
            openDetailView(currentDetailAcc.id);
        }
    }
    
    function updateCurrencyButton() {
        const btn = document.getElementById('currencyToggleBtn');
        const text = document.getElementById('currencyToggleText');
        if(btn && text) {
            // 顯示當前幣別
            text.innerText = currentDisplayCurrency;
            btn.title = `當前顯示: ${currentDisplayCurrency}，點擊切換至 ${currentDisplayCurrency === 'TWD' ? 'USD' : 'TWD'}`;
        }
    }
    
    
    function toggleTheme() {
        if(!settings.theme) {
            settings.theme = 'dark';
        }
        settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
        
        // 根據主題自動切換圖表字體顏色
        if(settings.theme === 'dark') {
            settings.chartTextColor = 'white';
        } else {
            settings.chartTextColor = 'black';
        }
        
        saveSettings();
        applyTheme();
        updateThemeButton();
        updateChartTextColor();
    }
    
    function applyTheme() {
        const root = document.documentElement;
        const currentTheme = settings.theme || 'dark';
        root.setAttribute('data-theme', currentTheme);
    }
    
    function updateThemeButton() {
        const icon = document.getElementById('themeIcon');
        const text = document.getElementById('themeText');
        const currentTheme = settings.theme || 'dark';
        
        if(icon && text) {
            if(currentTheme === 'dark') {
                icon.className = 'fas fa-moon';
                text.innerText = '深色模式';
            } else {
                icon.className = 'fas fa-sun';
                text.innerText = '淺色模式';
            }
        }
    }
    
    // 根據主題獲取圖表文字顏色
    function getChartTextColor() {
        const currentTheme = settings.theme || 'dark';
        return currentTheme === 'dark' ? '#fff' : '#000';
    }
    
    function updateChartTextColor() {
        if(!chartInstance) return;
        
        const textColor = getChartTextColor();
        
        // 更新標題顏色
        if(chartInstance.title) {
            chartInstance.setTitle({
                text: chartInstance.title.textStr || '',
                style: { color: textColor, fontSize: '14px' }
            }, false);
        }
        
        // 更新數據標籤顏色
        if(chartInstance.series && chartInstance.series.length > 0) {
            chartInstance.series.forEach(series => {
                if(series.options && series.options.dataLabels) {
                    series.update({
                        dataLabels: {
                            ...series.options.dataLabels,
                            style: {
                                ...series.options.dataLabels.style,
                                color: textColor
                            }
                        }
                    }, false);
                }
            });
        }
        
        // 強制更新所有文字元素的顏色
        setTimeout(() => {
            const dataLabels = document.querySelectorAll('#chartWrapper .highcharts-data-label text, #chartWrapper .highcharts-title text');
            dataLabels.forEach(label => {
                label.style.setProperty('fill', textColor, 'important');
            });
            
            // 更新 disableChartHover 中的顏色設置
            const hoverLabels = document.querySelectorAll('#chartWrapper .highcharts-data-label, #chartWrapper .highcharts-data-label text');
            hoverLabels.forEach(label => {
                if(label.tagName === 'text') {
                    label.style.setProperty('fill', textColor, 'important');
                }
            });
        }, 100);
        
        chartInstance.redraw();
    }
    
    // 4. Start the app only after everything is defined
    async function init() {
        // 獲取載入遮罩元素（在整個函數中都可使用）
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // 確保載入遮罩顯示
        if(loadingOverlay) {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.style.display = 'flex';
        }
        
        initSidebarState();
        initNumbersState();
        initSwiper();
        initJournalSwipe(); // 初始化記帳詳情的滑動手勢
        applyTheme();
        updateThemeButton();
        updateCurrencyButton();
        chartLevel = 'root';
        currentPage = 0;
        renderAssets();
        
        // 檢查並執行固定轉帳（自動日期匯款）
        checkAndExecuteFixedTransfers();
        // 初始化箭頭按鈕狀態
        updatePageNavArrows();
        setTimeout(() => { 
            initChart(); 
            // 初始化時不自動居中，只在用戶切換分頁時才居中
            // 確保圖表在手機模式下正確渲染
            setTimeout(() => {
                if(chartInstance) {
                    const chartWrapper = document.getElementById('chartWrapper');
                    if(chartWrapper) {
                        const wrapperWidth = chartWrapper.clientWidth;
                        const wrapperHeight = chartWrapper.clientHeight;
                        if(wrapperWidth > 0 && wrapperHeight > 0) {
                            chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            chartInstance.reflow();
                            // 再次確保文字正確顯示
                            setTimeout(() => {
                                if(chartInstance) {
                                    chartInstance.reflow();
                                }
                            }, 100);
                        }
                    }
                }
            }, 200);
        }, 500);
        
        // 監聽窗口大小改變，重新調整圖表
        let resizeTimer;
        let lastWidth = window.innerWidth;
        let lastIsDesktop = window.innerWidth >= 768;
        
        const handleResize = () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const currentWidth = window.innerWidth;
                const currentIsDesktop = currentWidth >= 768;
                const widthChanged = Math.abs(currentWidth - lastWidth) > 50;
                const mediaQueryChanged = lastIsDesktop !== currentIsDesktop;
                
                lastWidth = currentWidth;
                lastIsDesktop = currentIsDesktop;
                
                if(chartInstance) {
                    const chartWrapper = document.getElementById('chartWrapper');
                    const assetChart = document.getElementById('assetChart');
                    if(chartWrapper && assetChart) {
                        // 觸發重排，確保CSS媒體查詢已應用
                        chartWrapper.offsetHeight;
                        assetChart.offsetHeight;
                        
                        // 獲取容器的實際寬度和高度
                        const wrapperWidth = chartWrapper.clientWidth;
                        const wrapperHeight = chartWrapper.clientHeight;
                        
                        // 如果媒體查詢改變或寬度變化較大，需要更徹底地重新渲染
                        if(mediaQueryChanged || widthChanged) {
                            // 強制清除圖表的固定尺寸
                            const svg = chartWrapper.querySelector('svg');
                            if(svg) {
                                svg.removeAttribute('width');
                                svg.removeAttribute('height');
                                svg.style.width = '100%';
                                svg.style.height = '100%';
                                svg.style.maxWidth = '100%';
                            }
                            
                            // 強制設置圖表大小
                            if(wrapperWidth > 0 && wrapperHeight > 0) {
                                chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            }
                            
                            // 強制重新計算圖表大小
                            chartInstance.reflow();
                            
                            // 多次嘗試確保更新完成
                            requestAnimationFrame(() => {
                                if(chartInstance) {
                                    const newWidth = chartWrapper.clientWidth;
                                    const newHeight = chartWrapper.clientHeight;
                                    if(newWidth > 0 && newHeight > 0) {
                                        chartInstance.setSize(newWidth, newHeight, false);
                                        chartInstance.reflow();
                                        setTimeout(() => {
                                            if(chartInstance) {
                                                const finalWidth = chartWrapper.clientWidth;
                                                const finalHeight = chartWrapper.clientHeight;
                                                if(finalWidth > 0 && finalHeight > 0) {
                                                    chartInstance.setSize(finalWidth, finalHeight, false);
                                                    chartInstance.reflow();
                                                    // 最後一次確保 SVG 尺寸正確
                                                    requestAnimationFrame(() => {
                                                        if(chartInstance) {
                                                            chartInstance.reflow();
                                                            const svg = chartWrapper.querySelector('svg');
                                                            if(svg) {
                                                                svg.style.width = '100%';
                                                                svg.style.height = '100%';
                                                                svg.style.maxWidth = '100%';
                                                            }
                                                        }
                                                    });
                                                }
                                            }
                                        }, 150);
                                    }
                                }
                            });
                        } else {
                            // 小幅度變化，簡單重新計算
                            if(wrapperWidth > 0 && wrapperHeight > 0) {
                                chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            }
                            chartInstance.reflow();
                            setTimeout(() => {
                                if(chartInstance) {
                                    const newWidth = chartWrapper.clientWidth;
                                    const newHeight = chartWrapper.clientHeight;
                                    if(newWidth > 0 && newHeight > 0) {
                                        chartInstance.setSize(newWidth, newHeight, false);
                                        chartInstance.reflow();
                                    }
                                }
                            }, 100);
                        }
                    }
                }
            }, 200);
        };
        
        window.addEventListener('resize', handleResize);
        
        // 監聽窗口大小改變，更新記帳詳情區域高度
        window.addEventListener('resize', () => {
            const detailsContainer = document.getElementById('calendarTransferDetails');
            if(detailsContainer && detailsContainer.style.display !== 'none') {
                updateJournalDetailsHeight();
            }
        });
        
        // 監聽媒體查詢變化（更可靠的方式）
        if(window.matchMedia) {
            const mediaQuery = window.matchMedia('(min-width: 768px)');
            mediaQuery.addEventListener('change', () => {
                handleResize();
            });
        }
        
        await updateRates(); 
        if(settings.apiKey||settings.fugleKey) fetchPrices();
        setInterval(() => { refreshAllData(false); }, 5000);
        
        // 註冊 Service Worker（支援背景執行）
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then((registration) => {
                    console.log('Service Worker 註冊成功:', registration.scope);
                    
                    // 監聽 Service Worker 更新
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if(newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('Service Worker 有新版本可用');
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.log('Service Worker 註冊失敗:', error);
                });
            
            // 監聽來自 Service Worker 的消息（背景備份）
            navigator.serviceWorker.addEventListener('message', (event) => {
                if(event.data && event.data.type === 'BACKGROUND_BACKUP') {
                    console.log('收到背景備份請求');
                    if(settings.cloudBackupEnabled) {
                        performCloudBackup().catch(err => {
                            console.error('背景備份失敗:', err);
                        });
                    }
                }
            });
        }
        
        // 啟動雲端自動備份
        if(settings.cloudBackupEnabled) {
            startCloudBackupTimer();
        }
        
        
        // 初始化選單區塊狀態
        initMenuSections();
        
        // 初始化使用者頭像
        updateUserAvatar();
        
        // 初始化分頁顯示設置
        renderPageVisibilitySettings();
        
        // 初始化時確保 pageOrder 包含所有分頁
        if(pageOrder.length !== PAGE_TYPES.length) {
            // 如果順序不完整，補充缺失的分頁
            PAGE_TYPES.forEach((type, index) => {
                if(!pageOrder.includes(index)) {
                    pageOrder.push(index);
                }
            });
            savePageOrder();
        }
        
        // 重新排列 page-item 的 DOM 順序
        const domIndex = reorderPageItems();
        
        // 渲染分頁指示器
        renderPageIndicator();
        
        // 確保當前分頁是啟用的
        if(!isPageEnabled(currentPage)) {
            const orderedPages = getOrderedPages();
            if(orderedPages.length > 0) {
                switchToPage(orderedPages[0]);
            }
        } else {
            // 確保當前分頁的位置正確
            const container = document.getElementById('pageContainer');
            if(container) {
                const finalIndex = domIndex >= 0 ? domIndex : getDisplayIndex(currentPage);
                container.style.transform = `translateX(-${finalIndex * 100}%)`;
            }
        }
        
        // 載入完成，等待 Monee 字樣動畫完成後再隱藏載入遮罩
        if(loadingOverlay) {
            // Monee 字樣動畫：1s 動畫時間
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                // 完全隱藏後移除元素（可選，如果想保留 DOM 可以註解掉）
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300); // 等待淡出動畫完成
            }, 1000); // 等待 Monee 字樣動畫完成（1s 動畫）
        }
    }
    
    // Calendar Functions
    let currentCalendarDate = new Date();
    let selectedDate = null;
    function switchToCalendarPage(showCalendar) {
        const calendarPage = document.getElementById('calendarPage');
        const contentGrid = document.querySelector('.content-grid');
        const assetListTab = document.getElementById('assetListTab');
        const calendarTabBtn = document.getElementById('calendarTabBtn');
        const pageIndicator = document.querySelector('.page-indicator');
        const navbarTitle = document.querySelector('.navbar h1');
        if(showCalendar) {
            // 切換到記帳頁面時，強制設置為日曆模式
            journalViewMode = 'calendar';
            calendarPage.style.display = 'block';
            if(contentGrid) contentGrid.style.display = 'none';
            assetListTab?.classList.remove('active');
            calendarTabBtn?.classList.add('active');
            if(pageIndicator) {
                pageIndicator.innerHTML = '';
                pageIndicator.style.display = 'none';  // 完全隱藏頁面指示器
            }
            if(navbarTitle) {
                navbarTitle.innerHTML = '<img src="./favico.png" alt="Logo" class="title-logo">記帳';
            }
            // 隱藏右上角的新增和排序按鈕，顯示圖表按鈕和新增按鈕
            const addBtn = document.getElementById('addBtn');
            const sortBtn = document.getElementById('sortBtn');
            const chartBtn = document.getElementById('calendarChartBtn');
            const settingsBtn = document.getElementById('calendarSettingsBtn');
            if(addBtn) addBtn.style.display = 'none';
            if(sortBtn) sortBtn.style.display = 'none';
            if(chartBtn) {
                chartBtn.style.display = 'block';
                // 根據當前模式設置按鈕圖標（現在應該是日曆模式）
                chartBtn.innerHTML = '<i class="fas fa-chart-pie"></i>';
            }
            if(settingsBtn) {
                settingsBtn.style.display = 'block';
            }
            // 初始化顯示模式（現在強制為日曆模式）
            if(journalViewMode === 'chart') {
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarWeekdays = document.querySelector('.calendar-weekdays');
                const monthlyChartContainer = document.getElementById('monthlyChartContainer');
                const calendarTransferDetails = document.getElementById('calendarTransferDetails');
                if(calendarGrid) calendarGrid.style.display = 'none';
                if(calendarWeekdays) calendarWeekdays.style.display = 'none';
                if(monthlyChartContainer) {
                    monthlyChartContainer.style.display = 'block';
                    renderMonthlyCharts();
                    initMonthlyChartSwipe();
                }
                if(calendarTransferDetails) calendarTransferDetails.style.display = 'none';
            } else {
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarWeekdays = document.querySelector('.calendar-weekdays');
                const monthlyChartContainer = document.getElementById('monthlyChartContainer');
                if(calendarGrid) calendarGrid.style.display = 'grid';
                if(calendarWeekdays) calendarWeekdays.style.display = 'grid';  // 使用 grid 而不是 flex，與日曆網格對齊
                if(monthlyChartContainer) monthlyChartContainer.style.display = 'none';
                renderCalendar();
            }
            // 不顯示今日日期
            const todayDateEl = document.getElementById('calendarTodayDate');
            if(todayDateEl) {
                todayDateEl.style.display = 'none';
            }
            
            // 自動選中今天並顯示詳情（如果沒有選中其他日期）
                const today = new Date();
            today.setHours(0, 0, 0, 0);
            if(!selectedDate) {
                // 如果沒有選中日期，自動選中今天並顯示詳情
                selectedDate = new Date(today);
            renderCalendar();
                showFixedTransferDetailsForDate(today);
            } else {
                // 如果有選中日期，顯示該日期的詳情
                showFixedTransferDetailsForDate(selectedDate);
            }
        } else {
            calendarPage.style.display = 'none';
            if(contentGrid) contentGrid.style.display = '';
            assetListTab?.classList.add('active');
            calendarTabBtn?.classList.remove('active');
            if(pageIndicator) {
                // 顯示頁面指示器
                pageIndicator.style.display = 'flex';  // 恢復顯示
                // 保存當前頁面索引，避免閃爍
                const savedPage = currentPage;
                // 根據 pageVisibility 動態生成分頁按鈕，只顯示啟用的分頁
                let tabsHTML = '';
                PAGE_TYPES.forEach((type, index) => {
                    if(isPageEnabled(index)) {
                        const pageName = PAGE_NAMES[index];
                        const isActive = index === savedPage ? 'active' : '';
                        tabsHTML += `<button class="page-tab ${isActive}" data-page="${index}" onclick="switchToPage(${index})">${pageName}</button>`;
                    }
                });
                pageIndicator.innerHTML = tabsHTML;
                // 然後調用 switchToPage 來更新內容
                switchToPage(savedPage);
            }
            if(navbarTitle) {
                navbarTitle.innerHTML = '<img src="./favico.png" alt="Logo" class="title-logo">Monee';
            }
            // 顯示右上角的新增和排序按鈕，隱藏圖表按鈕和新增按鈕
            const addBtn = document.getElementById('addBtn');
            const sortBtn = document.getElementById('sortBtn');
            const chartBtn = document.getElementById('calendarChartBtn');
            const settingsBtn = document.getElementById('calendarSettingsBtn');
            if(addBtn && !isEditMode) addBtn.style.display = 'block';
            if(sortBtn) sortBtn.style.display = 'block';
            if(chartBtn) chartBtn.style.display = 'none';
            if(settingsBtn) settingsBtn.style.display = 'none';
        }
    }
    function changeCalendarMonth(delta) {
        // 只在日曆模式下才能切換月份
        if(journalViewMode !== 'calendar') {
            // 如果在圖表模式下，切換月份並重新渲染圓餅圖
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderMonthlyCharts();
            // 更新月份顯示
            const monthYear = document.getElementById('calendarMonthYear');
            if(monthYear) {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                monthYear.textContent = `${year}年${month + 1}月`;
            }
            return;
        }
        
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
        // 不顯示今日日期
        const todayDateEl = document.getElementById('calendarTodayDate');
        if(todayDateEl) {
            todayDateEl.style.display = 'none';
        }
        
        // 如果之前有選中的日期，重新顯示詳情
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        } else {
            // 如果沒有選中日期，檢查今天是否有固定轉帳
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTransfers = getFixedTransfersForDate(today);
            if(todayTransfers.length > 0) {
                // 如果今天有固定轉帳，自動選中今天並顯示詳情
                selectedDate = new Date(today);
                renderCalendar();
                showFixedTransferDetailsForDate(today);
            }
        }
    }
    
    // ========== 日期記事功能（必須在 renderCalendar 之前定義）==========
    function formatDateKey(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function loadDateNotes() {
        const notesKey = `${STORAGE_KEY_DATE_NOTES}_${currentUserId}`;
        return JSON.parse(localStorage.getItem(notesKey) || '{}');
    }
    
    function getDateNote(date) {
        const notes = loadDateNotes();
        const dateStr = formatDateKey(date);
        return notes[dateStr] || '';
    }
    
    function hasDateNote(date) {
        return getDateNote(date) !== '';
    }
    
    let currentNoteDate = null;
    
    function openDateNoteEditor(date) {
        currentNoteDate = new Date(date);
        currentNoteDate.setHours(0, 0, 0, 0);
        
        const modal = document.getElementById('dateNoteModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = document.getElementById('dateNoteTitle');
        const dateDisplay = document.getElementById('dateNoteDateDisplay');
        const noteInput = document.getElementById('dateNoteInput');
        
        if(title) {
            title.textContent = '記事';
        }
        
        if(dateDisplay) {
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const dateStr = `${currentNoteDate.getFullYear()}年${currentNoteDate.getMonth() + 1}月${currentNoteDate.getDate()}日 ${weekdays[currentNoteDate.getDay()]}`;
            dateDisplay.textContent = dateStr;
        }
        
        if(noteInput) {
            noteInput.value = getDateNote(currentNoteDate);
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
                if(noteInput) {
                    noteInput.focus();
                }
            }, 10);
        });
    }
    
    function closeDateNoteEditor() {
        const modal = document.getElementById('dateNoteModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
        currentNoteDate = null;
    }
    
    function saveDateNoteFromEditor() {
        if(!currentNoteDate) return;
        
        const noteInput = document.getElementById('dateNoteInput');
        const note = noteInput ? noteInput.value.trim() : '';
        
        saveDateNote(currentNoteDate, note);
        renderCalendar(); // 重新渲染日曆以顯示星號
        closeDateNoteEditor();
    }
    
    function saveDateNote(date, note) {
        if (isUserSwitching) return; // 鎖定攔截
        const notesKey = `${STORAGE_KEY_DATE_NOTES}_${currentUserId}`;
        const notes = loadDateNotes();
        const dateStr = formatDateKey(date);
        if(note && note.trim()) {
            notes[dateStr] = note.trim();
        } else {
            delete notes[dateStr];
        }
        localStorage.setItem(notesKey, JSON.stringify(notes));
        
        // 同步到 Firestore
        if (window.syncDateNotesToFirestore && window.firebaseUserLoggedIn) {
            window.syncDateNotesToFirestore(notes);
        }
    }
    
    // ========== 記帳類型選擇器（必須在 openNewExpenseFromCalendar 之前定義）==========
    function openJournalTypeSelector() {
        // 直接打開支出表單，而不是顯示選擇器
        openNewExpense();
    }
    
    // 切換記帳表單分頁（在表單上方）
    function switchJournalFormTab(tab) {
        // 檢查是否已經在當前分頁
        if (tab === 'expense' && currentJournalType === 'expense') return;
        if (tab === 'income' && currentJournalType === 'income') return;
        if (tab === 'transfer' && currentJournalType === 'transfer') return;
        // 固定轉帳比較特殊，它可能沒有 currentJournalType 或者有單獨的狀態
        const fixedTransferListModal = document.getElementById('fixedTransferListModal');
        if (tab === 'fixed' && fixedTransferListModal && fixedTransferListModal.style.display === 'block') return;

        // 直接打開對應的表單，不先隱藏舊的，避免露出底層
        if(tab === 'expense') {
            openNewExpense();
        } else if(tab === 'income') {
            openNewIncome();
        } else if(tab === 'transfer') {
            openNewTransfer();
        } else if(tab === 'fixed') {
            openFixedTransferListFromJournal();
        }
        
        // 延遲隱藏其他模態框，讓新的模態框有時間覆蓋上來
        // 同時更新分頁樣式
        setTimeout(() => {
            const allModals = ['expenseModal', 'incomeModal', 'transferModal', 'fixedTransferModal', 'fixedTransferListModal'];
            
            // 找出當前應該顯示的模態框 ID
            let currentModalId = '';
            if(tab === 'expense') currentModalId = 'expenseModal';
            else if(tab === 'income') currentModalId = 'incomeModal';
            else if(tab === 'transfer') currentModalId = 'transferModal';
            else if(tab === 'fixed') currentModalId = 'fixedTransferListModal';

            allModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    // 如果不是當前要顯示的模態框，則隱藏它
                    if (modalId !== currentModalId) {
                        modal.style.display = 'none';
                        const modalWrapper = modal.querySelector('.modal-content-wrapper');
                        if(modalWrapper) {
                            // 重置位置，以免下次打開時動畫異常
                            modalWrapper.style.transform = 'translateX(100%)';
                        }
                    }

                    // 更新分頁樣式 (針對所有模態框，確保一致性)
                    const tabs = modal.querySelectorAll('.journal-form-tab');
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = 'var(--border-color)';
                        t.style.color = 'var(--text-secondary)';
                        t.style.border = 'none';
                    });
                    
                    // 設置當前分頁為 active
                    tabs.forEach(t => {
                        const text = t.textContent.trim();
                        if ((tab === 'expense' && text === '支出') ||
                            (tab === 'income' && text === '收入') ||
                            (tab === 'transfer' && text === '轉帳') ||
                            (tab === 'fixed' && text === '固定轉帳')) {
                            
                            t.classList.add('active');
                            t.style.background = 'var(--card-bg)';
                            
                            if(tab === 'expense') {
                                t.style.color = 'var(--color-down)'; // 紅色
                                t.style.border = '2px solid var(--color-down)';
                            } else if(tab === 'income') {
                                t.style.color = 'var(--color-up)'; // 綠色
                                t.style.border = '2px solid var(--color-up)';
                            } else if(tab === 'transfer') {
                                t.style.color = '#0a84ff'; // 藍色
                                t.style.border = '2px solid #0a84ff';
                            } else if(tab === 'fixed') {
                                t.style.color = '#ffd60a'; // 黃色
                                t.style.border = '2px solid #ffd60a';
                            }
                        }
                    });
                }
            });
        }, 50);
    }
    
    // 切換記帳分頁
    function switchJournalTab(tab) {
        // 更新 tab 樣式
        document.querySelectorAll('.journal-tab').forEach(t => {
            t.classList.remove('active');
            t.style.background = 'var(--border-color)';
            t.style.color = 'var(--text-secondary)';
        });
        
        const activeTab = document.getElementById(`journalTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        if(activeTab) {
            activeTab.classList.add('active');
            activeTab.style.background = 'var(--card-bg)';
            activeTab.style.color = 'var(--text-primary)';
        }
        
        // 更新內容顯示
        document.querySelectorAll('.journal-tab-content').forEach(c => {
            c.style.display = 'none';
        });
        
        const activeContent = document.getElementById(`journalTabContent${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        if(activeContent) {
            activeContent.style.display = 'block';
        }
    }
    
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYear = document.getElementById('calendarMonthYear');
        if(!grid || !monthYear) return;
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        monthYear.textContent = `${year}年${month + 1}月`;
        grid.innerHTML = '';
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        // 計算需要的總天數：從上個月的第一天到當月的最後一天（不包含下個月的日期）
        const lastDayOfMonth = lastDay.getDate();
        const daysInPrevMonth = firstDay.getDay(); // 上個月需要顯示的天數
        const totalDays = daysInPrevMonth + lastDayOfMonth; // 不包含下個月的日期
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const selected = selectedDate ? new Date(selectedDate) : null;
        if(selected) selected.setHours(0, 0, 0, 0);
        for(let i = 0; i < totalDays; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            date.setHours(0, 0, 0, 0); // 確保時間部分為0，以便正確比較
            const day = date.getDate();
            const isOtherMonth = date.getMonth() !== month;
            const isToday = date.getTime() === today.getTime();
            const isSelected = selected && date.getTime() === selected.getTime();
            const dayBtn = document.createElement('button');
            dayBtn.className = 'calendar-day';
            dayBtn.textContent = day;
            if(isOtherMonth) dayBtn.classList.add('other-month');
            if(isToday) dayBtn.classList.add('today');
            if(isSelected) dayBtn.classList.add('selected');
            
            // 檢查是否有固定轉帳在這個日期
            const transfers = loadFixedTransfers();
            const dateStr = formatLocalDate(date);
            const dateObj = new Date(date);
            dateObj.setHours(0, 0, 0, 0);
            
            let hasTransfer = false;
            transfers.forEach(transfer => {
                const startDate = new Date(transfer.startDate);
                startDate.setHours(0, 0, 0, 0);
                const endDate = transfer.endDate ? new Date(transfer.endDate) : null;
                if(endDate) endDate.setHours(0, 0, 0, 0);
                
                // 檢查日期是否在範圍內
                if(dateObj >= startDate && (!endDate || dateObj <= endDate)) {
                    // 檢查是否符合重複規則
                    let matches = false;
                    const daysDiff = Math.floor((dateObj - startDate) / (1000 * 60 * 60 * 24));
                    
                    switch(transfer.repeat) {
                        case 'daily':
                            matches = true;
                            break;
                        case 'weekly':
                            matches = (daysDiff % 7 === 0);
                            break;
                        case 'monthly':
                            matches = (dateObj.getDate() === startDate.getDate());
                            break;
                        case 'yearly':
                            matches = (dateObj.getMonth() === startDate.getMonth() && dateObj.getDate() === startDate.getDate());
                            break;
                    }
                    
                    if(matches) {
                        hasTransfer = true;
                        dayBtn.classList.add('has-fixed-transfer');
                        dayBtn.style.borderBottom = `3px solid ${transfer.tagColor}`;
                    }
                }
            });
            
            // 檢查是否有記帳記錄在這個日期（使用緩存提高性能）
            const journalDatesSet = getJournalDatesSet();
            const hasJournalRecord = journalDatesSet.has(dateStr);
            if(hasJournalRecord && !hasTransfer) {
                // 如果有記帳記錄但沒有固定轉帳，顯示一個通用標記
                dayBtn.classList.add('has-fixed-transfer');
                dayBtn.style.borderBottom = '3px solid #0a84ff';
            } else if(hasJournalRecord && hasTransfer) {
                // 如果兩者都有，保持固定轉帳的顏色標記
            }
            
            // 檢查是否有記事，如果有則顯示星號框住日期
            if(hasDateNote(date)) {
                dayBtn.style.border = '2px solid #ffd700';
                dayBtn.style.borderRadius = '8px';
                dayBtn.style.boxSizing = 'border-box';
            }
            
            // 使用計時器區分單擊和雙擊
            let clickTimer = null;
            let clickCount = 0;
            dayBtn.addEventListener('click', (e) => {
                clickCount++;
                if(clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        // 單擊：選中日期
                        selectDate(date);
                        clickCount = 0;
                    }, 300); // 300ms 內沒有第二次點擊，視為單擊
                } else if(clickCount === 2) {
                    // 雙擊：打開記事編輯
                    clearTimeout(clickTimer);
                    e.stopPropagation();
                    // 先選中該日期
                    selectDate(date);
                    // 然後打開記事編輯
                    setTimeout(() => {
                        openDateNoteEditor(date);
                    }, 100);
                    clickCount = 0;
                }
            });
            grid.appendChild(dayBtn);
        }
    }
    function selectDate(date) {
        selectedDate = new Date(date);
        selectedDate.setHours(0, 0, 0, 0); // 確保時間部分為 00:00:00
        renderCalendar();
        console.log('Selected date:', selectedDate.toLocaleDateString('zh-TW'));
        
        // 顯示該日期的固定轉帳詳情
        showFixedTransferDetailsForDate(date);
    }
    
    // 當前記帳詳情的分頁索引（0: 支出, 1: 收入, 2: 轉帳）
    let currentJournalPageIndex = 0;
    // 記帳顯示模式：'calendar' 或 'chart'
    let journalViewMode = 'calendar';
    // 月份圓餅圖當前分頁索引（0: 支出, 1: 收入）
    let currentMonthlyChartIndex = 0;
    // 記帳日程圖表動畫引擎
    let monthlyExpenseChartAnimationEngine = null;
    let monthlyExpenseAdvanceChartAnimationEngine = null;
    let monthlyIncomeChartAnimationEngine = null;
    let monthlyIncomeAdvanceChartAnimationEngine = null;
    
    // 切換記帳顯示模式（日曆/圓餅圖）
    function toggleJournalChartView() {
        journalViewMode = journalViewMode === 'calendar' ? 'chart' : 'calendar';
        
        // 更新按鈕圖標
        const chartBtn = document.getElementById('calendarChartBtn');
        if(chartBtn) {
            if(journalViewMode === 'chart') {
                chartBtn.innerHTML = '<i class="fas fa-calendar"></i>';
            } else {
                chartBtn.innerHTML = '<i class="fas fa-chart-pie"></i>';
            }
        }
        
        // 切換日曆和圓餅圖的顯示
        const calendarContainer = document.querySelector('.calendar-container');
        const monthlyChartContainer = document.getElementById('monthlyChartContainer');
        const calendarTransferDetails = document.getElementById('calendarTransferDetails');
        
        if(journalViewMode === 'chart') {
            // 顯示圓餅圖，隱藏日曆網格和詳情，但保留月份切換按鈕
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarWeekdays = document.querySelector('.calendar-weekdays');
            if(calendarGrid) calendarGrid.style.display = 'none';
            if(calendarWeekdays) calendarWeekdays.style.display = 'none';
            if(monthlyChartContainer) {
                monthlyChartContainer.style.display = 'block';
                renderMonthlyCharts();
                initMonthlyChartSwipe();
            }
            if(calendarTransferDetails) calendarTransferDetails.style.display = 'none';
        } else {
            // 顯示日曆，隱藏圓餅圖
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarWeekdays = document.querySelector('.calendar-weekdays');
            if(calendarGrid) calendarGrid.style.display = 'grid';
            if(calendarWeekdays) calendarWeekdays.style.display = 'grid';  // 使用 grid 與日曆網格對齊
            if(monthlyChartContainer) monthlyChartContainer.style.display = 'none';
            renderCalendar();
            // 如果有選中日期，顯示詳情
            if(selectedDate) {
                showFixedTransferDetailsForDate(selectedDate);
            }
        }
    }
    
    // 渲染月份圓餅圖
    function renderMonthlyCharts() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        // 獲取該月份的所有記帳記錄
        const records = loadJournalRecords();
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        monthStart.setHours(0, 0, 0, 0);
        monthEnd.setHours(23, 59, 59, 999);
        
        const monthRecords = records.filter(record => {
            if(!record.date) return false;
            const recordDate = new Date(record.date);
            recordDate.setHours(0, 0, 0, 0);
            return recordDate >= monthStart && recordDate <= monthEnd;
        });
        
        // 分類記錄
        const expenseRecords = monthRecords.filter(r => r.type === 'expense');
        const incomeRecords = monthRecords.filter(r => r.type === 'income');
        
        // 根據代墊狀態分類
        const expenseRecordsNormal = expenseRecords.filter(r => !r.isAdvance);
        const expenseRecordsAdvance = expenseRecords.filter(r => r.isAdvance);
        const incomeRecordsNormal = incomeRecords.filter(r => !r.isAdvance);
        const incomeRecordsAdvance = incomeRecords.filter(r => r.isAdvance);
        
        // 計算各類別的總金額
        const totalExpense = expenseRecords.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        const totalExpenseNormal = expenseRecordsNormal.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        const totalExpenseAdvance = expenseRecordsAdvance.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        
        const totalIncome = incomeRecords.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        const totalIncomeNormal = incomeRecordsNormal.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        const totalIncomeAdvance = incomeRecordsAdvance.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        
        // 更新總金額顯示
        const expenseTotalElement = document.getElementById('monthlyExpenseTotal');
        const expenseNormalTotalElement = document.getElementById('monthlyExpenseNormalTotal');
        const expenseAdvanceTotalElement = document.getElementById('monthlyExpenseAdvanceTotal');
        const incomeTotalElement = document.getElementById('monthlyIncomeTotal');
        const incomeNormalTotalElement = document.getElementById('monthlyIncomeNormalTotal');
        const incomeAdvanceTotalElement = document.getElementById('monthlyIncomeAdvanceTotal');
        
        if(expenseTotalElement) {
            expenseTotalElement.textContent = `總支出：$${totalExpense.toLocaleString()}`;
        }
        if(expenseNormalTotalElement) {
            expenseNormalTotalElement.textContent = `原始支出：$${totalExpenseNormal.toLocaleString()}`;
        }
        if(expenseAdvanceTotalElement) {
            expenseAdvanceTotalElement.textContent = `代墊：$${totalExpenseAdvance.toLocaleString()}`;
        }
        if(incomeTotalElement) {
            incomeTotalElement.textContent = `總收入：$${totalIncome.toLocaleString()}`;
        }
        if(incomeNormalTotalElement) {
            incomeNormalTotalElement.textContent = `原始收入：$${totalIncomeNormal.toLocaleString()}`;
        }
        if(incomeAdvanceTotalElement) {
            incomeAdvanceTotalElement.textContent = `代墊：$${totalIncomeAdvance.toLocaleString()}`;
        }
        
        // 渲染支出圓餅圖（合計、一般、代墊）
        renderMonthlyPieChart('expense', expenseRecords, 'monthlyExpenseTotalChart');
        renderMonthlyPieChart('expense', expenseRecordsNormal, 'monthlyExpenseChart');
        renderMonthlyPieChart('expense', expenseRecordsAdvance, 'monthlyExpenseAdvanceChart');
        
        // 渲染收入圓餅圖（合計、一般、代墊）
        renderMonthlyPieChart('income', incomeRecords, 'monthlyIncomeTotalChart');
        renderMonthlyPieChart('income', incomeRecordsNormal, 'monthlyIncomeChart');
        renderMonthlyPieChart('income', incomeRecordsAdvance, 'monthlyIncomeAdvanceChart');
        
        // 確保切換到當前顯示的圖表
        switchMonthlyChartPage(currentMonthlyChartIndex);
    }
    
    // 渲染單個月份圓餅圖
    function renderMonthlyPieChart(type, records, chartId) {
        const chartContainer = document.getElementById(chartId);
        if(!chartContainer || typeof Highcharts === 'undefined') {
            return;
        }
        
        // 如果沒有記錄，銷毀圖表並顯示提示文字
        if(!records || records.length === 0) {
            // 銷毀圖表實例（如果存在）
            if(chartContainer.chartInstance) {
                chartContainer.chartInstance.destroy();
                chartContainer.chartInstance = null;
            }
            
            // 清除動畫引擎引用
            if(chartId === 'monthlyExpenseChart') {
                monthlyExpenseChartAnimationEngine = null;
            } else if(chartId === 'monthlyExpenseAdvanceChart') {
                monthlyExpenseAdvanceChartAnimationEngine = null;
            } else if(chartId === 'monthlyIncomeChart') {
                monthlyIncomeChartAnimationEngine = null;
            } else if(chartId === 'monthlyIncomeAdvanceChart') {
                monthlyIncomeAdvanceChartAnimationEngine = null;
            }
            
            // 清除容器並顯示提示文字
            chartContainer.innerHTML = '';
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = 'text-align: center; padding: 50px; color: var(--text-secondary);';
            emptyDiv.textContent = '該月份沒有' + (type === 'expense' ? '支出' : '收入') + '記錄';
            chartContainer.appendChild(emptyDiv);
            return;
        }
        
        // 按分類統計
        const categoryData = {};
        records.forEach(record => {
            const category = record.category || '其他';
            if(!categoryData[category]) {
                categoryData[category] = 0;
            }
            categoryData[category] += parseFloat(record.amount) || 0;
        });
        
        // 顏色配置
        const colors = type === 'expense' 
            ? ['#ff453a', '#ff9500', '#ffcc00', '#34c759', '#5ac8fa', '#007aff', '#5856d6', '#af52de', '#ff2d55']  // 支出：多色系
            : ['#34c759', '#5ac8fa', '#007aff', '#0a84ff', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#ef4444', '#f97316', '#fbbf24', '#30d158', '#32d74b', '#4ade80', '#22c55e'];  // 收入：綠色+藍色+彩虹色
        
        // 轉換為Highcharts格式（不在此處指定顏色，使用plotOptions中的colors數組）
        const chartData = Object.keys(categoryData).map(category => ({
            name: category,
            y: categoryData[category]
        }));
        
        // 轉換為帶顏色的數據格式
        const chartDataWithColors = chartData.map((item, index) => ({
            name: item.name,
            y: item.y,
            color: colors[index % colors.length]
        }));
        
        const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#ffffff';
        // 確保圖表容器允許內容溢出
        if(chartContainer) {
            chartContainer.style.overflow = 'visible';
            chartContainer.style.position = 'relative';
        }
        
        // 先清除所有提示文字（無論圖表實例是否存在）
        const emptyMessageDiv = chartContainer.querySelector('div');
        if(emptyMessageDiv && emptyMessageDiv.textContent && emptyMessageDiv.textContent.includes('該月份沒有')) {
            emptyMessageDiv.remove();
        }
        // 如果容器中有提示文字但沒有圖表 SVG，清除所有內容
        if(chartContainer.innerHTML && !chartContainer.querySelector('svg')) {
            chartContainer.innerHTML = '';
        }
        
        // 如果圖表已存在且有系列，使用動畫引擎更新
        if(chartContainer.chartInstance && chartContainer.chartInstance.series && chartContainer.chartInstance.series.length > 0) {
            // 初始化動畫引擎（如果還沒有）
            let animationEngine = null;
            if(chartId === 'monthlyExpenseChart') {
                if(!monthlyExpenseChartAnimationEngine) {
                    monthlyExpenseChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
                }
                animationEngine = monthlyExpenseChartAnimationEngine;
            } else if(chartId === 'monthlyExpenseAdvanceChart') {
                if(!monthlyExpenseAdvanceChartAnimationEngine) {
                    monthlyExpenseAdvanceChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
                }
                animationEngine = monthlyExpenseAdvanceChartAnimationEngine;
            } else if(chartId === 'monthlyIncomeChart') {
                if(!monthlyIncomeChartAnimationEngine) {
                    monthlyIncomeChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
                }
                animationEngine = monthlyIncomeChartAnimationEngine;
            } else if(chartId === 'monthlyIncomeAdvanceChart') {
                if(!monthlyIncomeAdvanceChartAnimationEngine) {
                    monthlyIncomeAdvanceChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
                }
                animationEngine = monthlyIncomeAdvanceChartAnimationEngine;
            }
            
            // 使用動畫引擎更新圖表
            if(animationEngine) {
                animationEngine.animate({
                    newData: chartDataWithColors,
                    animationType: 'switch',
                    duration: CHART_ANIMATION_CONFIG.duration,
                    easing: CHART_ANIMATION_CONFIG.easing
                });
                return; // 動畫引擎會處理更新，不需要重新創建圖表
            }
        }
        
        // 銷毀舊圖表（如果存在）
        if(chartContainer.chartInstance) {
            chartContainer.chartInstance.destroy();
            chartContainer.chartInstance = null;
        }
        
        // 清除動畫引擎引用（如果圖表被銷毀）
        if(chartId === 'monthlyExpenseChart') {
            monthlyExpenseChartAnimationEngine = null;
        } else if(chartId === 'monthlyExpenseAdvanceChart') {
            monthlyExpenseAdvanceChartAnimationEngine = null;
        } else if(chartId === 'monthlyIncomeChart') {
            monthlyIncomeChartAnimationEngine = null;
        } else if(chartId === 'monthlyIncomeAdvanceChart') {
            monthlyIncomeAdvanceChartAnimationEngine = null;
        }
        
        // 確保容器完全清空（包括任何提示文字和DOM元素）
        while(chartContainer.firstChild) {
            chartContainer.removeChild(chartContainer.firstChild);
        }
        
        // 創建新圖表
        chartContainer.chartInstance = Highcharts.chart(chartId, {
            chart: {
                type: 'pie',
                backgroundColor: 'transparent',
                height: 300,  // 調整高度以適應上下兩個圖表
                spacing: [40, 60, 40, 60],  // 調整間距
                margin: [20, 50, 20, 50],  // 調整邊距
                plotBackgroundColor: 'transparent',
                plotBorderWidth: 0
            },
            title: { text: '' },
            credits: { enabled: false },
            tooltip: {
                pointFormat: '<b>{point.percentage:.1f}%</b><br/>${point.y:,.0f}'
            },
            plotOptions: {
                pie: {
                    size: '85%',
                    innerSize: '60%',
                    dataLabels: {
                        enabled: true,
                        distance: 35,
                        format: '{point.name}<br/><span style="opacity:0.7">{point.percentage:.1f}%</span><br/><span style="font-size:11px;opacity:0.6;">${point.y:,.0f}</span>',
                        style: {
                            color: chartTextColor,
                            fontSize: '12px',
                            fontWeight: 'normal',
                            textOutline: 'none',
                            whiteSpace: 'nowrap'  // 防止文字換行
                        },
                        allowOverlap: true,
                        minFontSize: 8,
                        maxFontSize: 14,
                        connectorWidth: 1,
                        connectorColor: chartTextColor,
                        softConnector: true,
                        crop: false,  // 不裁剪標籤
                        overflow: 'allow',  // 允許標籤超出圖表區域
                            useHTML: true,  // 使用HTML渲染以支持金額顯示
                        padding: 0  // 移除內邊距
                    },
                    colors: colors,  // 設置顏色數組
                    states: {
                        hover: {
                            enabled: false,
                            opacity: 1
                        },
                        inactive: {
                            enabled: false,
                            opacity: 1
                        }
                    },
                    point: {
                        events: {
                            click: function() {
                                // 禁用點擊事件
                                return false;
                            }
                        },
                        states: {
                            hover: {
                                enabled: false,
                                opacity: 1,
                                brightness: 0
                            },
                            inactive: {
                                enabled: false,
                                opacity: 1
                            },
                            select: {
                                enabled: false,
                                opacity: 1
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            },
            series: [{
                name: type === 'expense' ? '支出' : '收入',
                data: chartDataWithColors,
                animation: {
                    duration: 0  // 禁用初始動畫，使用動畫引擎
                }
            }]
        });
        
        // 初始化動畫引擎
        if(chartId === 'monthlyExpenseChart') {
            monthlyExpenseChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
        } else if(chartId === 'monthlyIncomeChart') {
            monthlyIncomeChartAnimationEngine = new ChartAnimationEngine(chartContainer.chartInstance);
        }
    }
    
    // 初始化月份圓餅圖滑動手勢
    let monthlyChartTouchStartX = null;
    let monthlyChartIsSwiping = false;
    let monthlyChartCurrentTransform = 0;
    
    function initMonthlyChartSwipe() {
        const swiper = document.getElementById('monthlyChartSwiper');
        if(!swiper) return;
        
        swiper.removeEventListener('touchstart', handleMonthlyChartTouchStart);
        swiper.removeEventListener('touchmove', handleMonthlyChartTouchMove);
        swiper.removeEventListener('touchend', handleMonthlyChartTouchEnd);
        
        swiper.addEventListener('touchstart', handleMonthlyChartTouchStart, { passive: true });
        swiper.addEventListener('touchmove', handleMonthlyChartTouchMove, { passive: true });
        swiper.addEventListener('touchend', handleMonthlyChartTouchEnd, { passive: true });
    }
    
    function handleMonthlyChartTouchStart(e) {
        monthlyChartTouchStartX = e.touches[0].clientX;
        monthlyChartIsSwiping = false;
        const container = document.getElementById('monthlyChartPageContainer');
        if(container) {
            const transform = container.style.transform || 'translateX(0%)';
            const match = transform.match(/translateX\((-?\d+\.?\d*)%\)/);
            monthlyChartCurrentTransform = match ? parseFloat(match[1]) : 0;
        }
    }
    
    function handleMonthlyChartTouchMove(e) {
        if(!monthlyChartTouchStartX) return;
        
        const currentX = e.touches[0].clientX;
        const diffX = monthlyChartTouchStartX - currentX;
        const absDiffX = Math.abs(diffX);
        
        if(absDiffX > 10) {
            monthlyChartIsSwiping = true;
            const container = document.getElementById('monthlyChartPageContainer');
            const swiper = document.getElementById('monthlyChartSwiper');
            if(container && swiper) {
                container.classList.add('swiping');
                const swipePercent = -(diffX / swiper.offsetWidth) * 100;
                let newTransform = monthlyChartCurrentTransform + swipePercent;
                
                // 限制範圍（0% 到 -50%）
                const minTransform = -50;
                const maxTransform = 0;
                newTransform = Math.max(minTransform, Math.min(maxTransform, newTransform));
                
                container.style.transform = `translateX(${newTransform}%)`;
            }
        }
    }
    
    function handleMonthlyChartTouchEnd(e) {
        if(!monthlyChartTouchStartX || !monthlyChartIsSwiping) {
            monthlyChartTouchStartX = null;
            return;
        }
        
        const currentX = e.changedTouches[0].clientX;
        const diffX = monthlyChartTouchStartX - currentX;
        const swiper = document.getElementById('monthlyChartSwiper');
        const container = document.getElementById('monthlyChartPageContainer');
        
        if(swiper && container) {
            const threshold = swiper.offsetWidth * 0.3;
            
            if(Math.abs(diffX) > threshold) {
                if(diffX > 0 && currentMonthlyChartIndex < 1) {
                    // 向右滑動，切換到下一個
                    currentMonthlyChartIndex++;
                } else if(diffX < 0 && currentMonthlyChartIndex > 0) {
                    // 向左滑動，切換到上一個
                    currentMonthlyChartIndex--;
                }
            }
            
            switchMonthlyChartPage(currentMonthlyChartIndex);
        }
        
        monthlyChartTouchStartX = null;
        monthlyChartIsSwiping = false;
    }
    
    function switchMonthlyChartPage(index) {
        const container = document.getElementById('monthlyChartPageContainer');
        if(container) {
            container.classList.remove('swiping');
            const transform = -index * 50;
            container.style.transform = `translateX(${transform}%)`;
            
            // 重新渲染當前圖表以觸發動畫（動畫引擎會處理平滑過渡）
            setTimeout(() => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const records = loadJournalRecords();
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                monthStart.setHours(0, 0, 0, 0);
                monthEnd.setHours(23, 59, 59, 999);
                
                const monthRecords = records.filter(record => {
                    if(!record.date) return false;
                    const recordDate = new Date(record.date);
                    recordDate.setHours(0, 0, 0, 0);
                    return recordDate >= monthStart && recordDate <= monthEnd;
                });
                
                if(index === 0) {
                    // 重新渲染支出圖表
                    const expenseRecords = monthRecords.filter(r => r.type === 'expense');
                    const expenseRecordsNormal = expenseRecords.filter(r => !r.isAdvance);
                    const expenseRecordsAdvance = expenseRecords.filter(r => r.isAdvance);
                    renderMonthlyPieChart('expense', expenseRecordsNormal, 'monthlyExpenseChart');
                    renderMonthlyPieChart('expense', expenseRecordsAdvance, 'monthlyExpenseAdvanceChart');
                } else {
                    // 重新渲染收入圖表
                    const incomeRecords = monthRecords.filter(r => r.type === 'income');
                    const incomeRecordsNormal = incomeRecords.filter(r => !r.isAdvance);
                    const incomeRecordsAdvance = incomeRecords.filter(r => r.isAdvance);
                    renderMonthlyPieChart('income', incomeRecordsNormal, 'monthlyIncomeChart');
                    renderMonthlyPieChart('income', incomeRecordsAdvance, 'monthlyIncomeAdvanceChart');
                }
            }, 50);
        }
    }
    
    // 顯示指定日期的所有記錄（固定轉帳、收入、支出、轉帳）
    function showFixedTransferDetailsForDate(date) {
        const detailsContainer = document.getElementById('calendarTransferDetails');
        if(!detailsContainer) return;
        
        const dateStr = formatLocalDate(date);
        console.log('顯示日期詳情:', dateStr);
        
        // 獲取該日期的所有固定轉帳
        const transfers = getFixedTransfersForDate(date);
        
        // 獲取該日期的所有記帳記錄
        const journalRecords = getJournalRecordsForDate(dateStr);
        console.log('該日期的記帳記錄數:', journalRecords.length);
        
        // 分類記錄
        const expenseRecords = journalRecords.filter(r => r.type === 'expense');
        const incomeRecords = journalRecords.filter(r => r.type === 'income');
        const transferRecords = journalRecords.filter(r => r.type === 'transfer');
        
        // 始終顯示詳情區域（即使沒有記錄，也可以添加新記錄）
        detailsContainer.style.display = 'block';
        
        // 計算並設置詳情區域的最大高度
        updateJournalDetailsHeight();
        
        // 渲染支出分頁（傳入日期以便計算固定轉帳金額）
        renderJournalPage('expense', expenseRecords, transfers, date);
        
        // 渲染收入分頁
        renderJournalPage('income', incomeRecords, transfers, date);
        
        // 渲染轉帳分頁
        renderJournalPage('transfer', transferRecords, transfers, date);
        
        // 重置到第一個有內容的分頁
        if(expenseRecords.length > 0 || transfers.length > 0) {
            currentJournalPageIndex = 0;
        } else if(incomeRecords.length > 0 || transfers.length > 0) {
            currentJournalPageIndex = 1;
        } else if(transferRecords.length > 0 || transfers.length > 0) {
            currentJournalPageIndex = 2;
        } else {
            // 如果所有分頁都沒有內容，默認顯示支出分頁
            currentJournalPageIndex = 0;
        }
        
        // 切換到對應分頁
        switchJournalPage(currentJournalPageIndex);
        
        // 確保滑動手勢已初始化
        setTimeout(() => {
            initJournalSwipe();
            // 再次更新高度，確保正確
            updateJournalDetailsHeight();
        }, 100);
    }
    
    // 更新記帳詳情區域的高度
    function updateJournalDetailsHeight() {
        const calendarPage = document.getElementById('calendarPage');
        const calendarContainer = document.querySelector('.calendar-container');
        const detailsContainer = document.getElementById('calendarTransferDetails');
        
        if(!calendarPage || !calendarContainer || !detailsContainer) return;
        
        // 獲取視窗高度
        const windowHeight = window.innerHeight;
        // 獲取日曆容器的實際高度（包括 padding）
        const calendarRect = calendarContainer.getBoundingClientRect();
        const calendarHeight = calendarRect.height;
        // 獲取 calendarPage 的 padding（上下各 20px）
        const pagePadding = 40;
        // 獲取詳情區域的 margin-top
        const detailsMarginTop = 20;
        // 計算可用高度
        const availableHeight = windowHeight - 60 - pagePadding - calendarHeight - detailsMarginTop;
        // 設置最小高度和最大高度（至少 200px，最多不超過可用空間）
        const minHeight = 200;
        const maxHeight = Math.max(minHeight, availableHeight - 20); // 減去一些緩衝
        
        // 為每個分頁設置最大高度
        const expensePage = document.getElementById('journalExpensePage');
        const incomePage = document.getElementById('journalIncomePage');
        const transferPage = document.getElementById('journalTransferPage');
        
        [expensePage, incomePage, transferPage].forEach(page => {
            if(page) {
                page.style.maxHeight = `${maxHeight}px`;
            }
        });
    }
    
    // 渲染記帳分頁
    function renderJournalPage(type, records, fixedTransfers, targetDate = null) {
        const listId = type === 'expense' ? 'journalExpenseList' : (type === 'income' ? 'journalIncomeList' : 'journalTransferList');
        const list = document.getElementById(listId);
        if(!list) return;
        
        // 計算總計
        let total = 0;
        records.forEach(record => {
            total += parseFloat(record.amount) || 0;
        });
        
        // 更新總計顯示
        const totalId = type === 'expense' ? 'journalExpenseTotal' : (type === 'income' ? 'journalIncomeTotal' : 'journalTransferTotal');
        const totalElement = document.getElementById(totalId);
        if(totalElement) {
            if(type === 'expense') {
                totalElement.textContent = `-$${total.toLocaleString()}`;
                totalElement.style.color = 'var(--color-down)';
            } else if(type === 'income') {
                totalElement.textContent = `+$${total.toLocaleString()}`;
                totalElement.style.color = 'var(--color-up)';
            } else {
                totalElement.textContent = `$${total.toLocaleString()}`;
                totalElement.style.color = 'var(--text-primary)';
            }
        }
        
        // 獲取圖表和列表容器
        const chartId = type === 'expense' ? 'journalExpenseChart' : (type === 'income' ? 'journalIncomeChart' : null);
        const chartContainer = chartId ? document.getElementById(chartId) : null;
        
        // 根據顯示模式決定顯示列表還是圖表
        if(type === 'transfer') {
            // 轉帳只顯示列表
            if(chartContainer) chartContainer.style.display = 'none';
            list.style.display = 'flex';
        } else if(type === 'income' || type === 'expense') {
            // 收入和支出可以切換列表/圖表
            if(journalViewMode === 'chart' && records.length > 0) {
                // 圖表模式：顯示圖表，隱藏列表
                if(chartContainer) chartContainer.style.display = 'block';
                list.style.display = 'none';
            } else {
                // 列表模式：顯示列表，隱藏圖表
                if(chartContainer) chartContainer.style.display = 'none';
                list.style.display = 'flex';
            }
        }
        
        // 渲染圓餅圖（僅收入和支出，且為圖表模式）
        if((type === 'income' || type === 'expense') && records.length > 0 && journalViewMode === 'chart' && chartContainer && typeof Highcharts !== 'undefined') {
            // 按分類統計
            const categoryData = {};
            records.forEach(record => {
                const category = record.category || '其他';
                if(!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += parseFloat(record.amount) || 0;
            });
            
            // 顏色配置
            const colors = type === 'expense' 
                ? ['#ff453a', '#ff9500', '#ffcc00', '#34c759', '#5ac8fa', '#007aff', '#5856d6', '#af52de', '#ff2d55']
                : ['#34c759', '#5ac8fa', '#007aff', '#0a84ff', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#ef4444', '#f97316', '#fbbf24', '#30d158', '#32d74b', '#4ade80', '#22c55e'];  // 收入：綠色+藍色+彩虹色
            
            // 轉換為Highcharts格式（不在此處指定顏色，使用plotOptions中的colors數組）
            const chartData = Object.keys(categoryData).map(category => ({
                name: category,
                y: categoryData[category]
            }));
            
            // 銷毀舊圖表
            if(chartContainer.chartInstance) {
                chartContainer.chartInstance.destroy();
            }
            
            // 確保圖表容器允許內容溢出
            if(chartContainer) {
                chartContainer.style.overflow = 'visible';
                chartContainer.style.position = 'relative';
            }
            
            // 創建新圖表
            const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#ffffff';
            chartContainer.chartInstance = Highcharts.chart(chartId, {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent',
                    height: 200,
                    spacing: [40, 70, 40, 70],  // 進一步增加上下左右的間距，為標籤留出更多空間
                    margin: [20, 50, 20, 50],  // 進一步增加邊距
                    plotBackgroundColor: 'transparent',
                    plotBorderWidth: 0
                },
                title: { text: '' },
                credits: { enabled: false },
                tooltip: {
                    pointFormat: '<b>{point.percentage:.1f}%</b><br/>${point.y:,.0f}'
                },
                plotOptions: {
                    pie: {
                        size: '80%',
                        innerSize: '50%',
                        dataLabels: {
                            enabled: true,
                            distance: 30,
                            format: '{point.name}<br/><span style="opacity:0.7">{point.percentage:.1f}%</span><br/><span style="font-size:10px;opacity:0.6;">${point.y:,.0f}</span>',
                            style: {
                                color: chartTextColor,
                                fontSize: '11px',
                                fontWeight: 'normal',
                                textOutline: 'none',
                                whiteSpace: 'nowrap'  // 防止文字換行
                            },
                            allowOverlap: true,
                            minFontSize: 7,
                            maxFontSize: 13,
                            connectorWidth: 1,
                            connectorColor: chartTextColor,
                            softConnector: true,
                            crop: false,  // 不裁剪標籤
                            overflow: 'allow',  // 允許標籤超出圖表區域
                            useHTML: true,  // 使用HTML渲染以支持金額顯示
                            padding: 0  // 移除內邊距
                        },
                        colors: colors,  // 設置顏色數組
                        states: {
                            hover: {
                                enabled: false,
                                opacity: 1
                            },
                            inactive: {
                                enabled: false,
                                opacity: 1
                            }
                        },
                        point: {
                            events: {
                                click: function() {
                                    // 禁用點擊事件
                                    return false;
                                }
                            },
                            states: {
                                hover: {
                                    enabled: false,
                                    opacity: 1,
                                    brightness: 0
                                },
                                inactive: {
                                    enabled: false,
                                    opacity: 1
                                },
                                select: {
                                    enabled: false,
                                    opacity: 1
                                }
                            }
                        },
                        animation: {
                            duration: 600,
                            easing: 'easeOutQuart'
                        }
                    }
                },
                series: [{
                    name: type === 'expense' ? '支出' : '收入',
                    data: chartData,
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    }
                }]
            });
        } else if((type === 'income' || type === 'expense') && chartContainer) {
            // 如果沒有記錄，隱藏圖表
            if(chartContainer.chartInstance) {
                chartContainer.chartInstance.destroy();
                chartContainer.chartInstance = null;
            }
            chartContainer.style.display = 'none';
        }
        
        list.innerHTML = '';
        
        // 先顯示該類型的記帳記錄
        records.forEach(record => {
            const detailItem = document.createElement('div');
            let borderColor = '#0a84ff';
            let icon = '';
            let title = '';
            
            if(record.type === 'income') {
                borderColor = 'var(--color-up)';
                const displayTitle = record.title || '收入';
                const account = accounts.find(acc => acc.id === record.accountId);
                const accountName = account ? account.name : '未知帳戶';
                const accountTagClass = account ? getAccountTagClass(account) : 'account-tag-account';
                const accountTagHTML = `<span class="account-tag ${accountTagClass}">${accountName}</span>`;
                const categoryTagHTML = record.category ? `<span class="account-tag account-tag-account" style="background: #e3f2fd; color: #1565c0;">${record.category}</span>` : '';
                const isAdvanceIcon = record.isAdvance ? '<i class="fas fa-hand-holding-usd" style="color: var(--text-secondary); font-size: 14px;" title="代墊"></i>' : '';
                detailItem.style.cssText = 'padding: 12px; background: var(--bg-color); border-radius: 8px; border-left: 4px solid ' + borderColor + '; width: calc(100% - 0px); max-width: 100%; box-sizing: border-box; overflow: visible; cursor: pointer;';
                detailItem.onclick = () => editJournalRecord(record.id);
                detailItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; width: 100%; box-sizing: border-box; gap: 8px;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayTitle}</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--color-up); flex-shrink: 0; white-space: nowrap;">+$${record.amount.toLocaleString()}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; width: 100%; flex-wrap: wrap;">
                        ${categoryTagHTML}
                        ${accountTagHTML}
                        ${isAdvanceIcon}
                    </div>
                    <div style="display: flex; justify-content: flex-end; width: 100%;">
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); editJournalRecord('${record.id}')" style="background: none; border: none; color: #0a84ff; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="編輯"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); deleteJournalRecord('${record.id}')" style="background: none; border: none; color: #ff453a; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="刪除"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            } else if(record.type === 'expense') {
                borderColor = 'var(--color-down)';
                const displayTitle = record.title || '支出';
                const account = accounts.find(acc => acc.id === record.accountId);
                const accountName = account ? account.name : '未知帳戶';
                const accountTagClass = account ? getAccountTagClass(account) : 'account-tag-account';
                const accountTagHTML = `<span class="account-tag ${accountTagClass}">${accountName}</span>`;
                const categoryTagHTML = record.category ? `<span class="account-tag account-tag-account" style="background: #fce4ec; color: #c2185b;">${record.category}</span>` : '';
                const isAdvanceIcon = record.isAdvance ? '<i class="fas fa-hand-holding-usd" style="color: var(--text-secondary); font-size: 14px;" title="代墊"></i>' : '';
                detailItem.style.cssText = 'padding: 12px; background: var(--bg-color); border-radius: 8px; border-left: 4px solid ' + borderColor + '; width: calc(100% - 0px); max-width: 100%; box-sizing: border-box; overflow: visible; cursor: pointer;';
                detailItem.onclick = () => editJournalRecord(record.id);
                detailItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; width: 100%; box-sizing: border-box; gap: 8px;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayTitle}</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--color-down); flex-shrink: 0; white-space: nowrap;">-$${record.amount.toLocaleString()}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; width: 100%; flex-wrap: wrap;">
                        ${categoryTagHTML}
                        ${accountTagHTML}
                        ${isAdvanceIcon}
                    </div>
                    <div style="display: flex; justify-content: flex-end; width: 100%;">
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); editJournalRecord('${record.id}')" style="background: none; border: none; color: #0a84ff; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="編輯"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); deleteJournalRecord('${record.id}')" style="background: none; border: none; color: #ff453a; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="刪除"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            } else if(record.type === 'transfer') {
                borderColor = '#0a84ff';
                const displayTitle = record.title || '轉帳';
                const fromAccount = accounts.find(acc => acc.id === record.fromAccountId);
                const toAccount = accounts.find(acc => acc.id === record.toAccountId);
                const fromAccountName = fromAccount ? fromAccount.name : '未知帳戶';
                const toAccountName = toAccount ? toAccount.name : '未知帳戶';
                
                // 生成帳戶標籤 HTML（顯示帳戶名稱，使用帳戶類型決定顏色）
                const fromAccountTagClass = fromAccount ? getAccountTagClass(fromAccount) : 'account-tag-account';
                const toAccountTagClass = toAccount ? getAccountTagClass(toAccount) : 'account-tag-account';
                const fromAccountTagHTML = `<span class="account-tag ${fromAccountTagClass}">${fromAccountName}</span>`;
                const toAccountTagHTML = `<span class="account-tag ${toAccountTagClass}">${toAccountName}</span>`;
                
                detailItem.style.cssText = 'padding: 12px; background: var(--bg-color); border-radius: 8px; border-left: 4px solid ' + borderColor + '; width: calc(100% - 0px); max-width: 100%; box-sizing: border-box; overflow: visible; cursor: pointer;';
                detailItem.onclick = () => editJournalRecord(record.id);
                detailItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; width: 100%; box-sizing: border-box; gap: 8px;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayTitle}</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); flex-shrink: 0; white-space: nowrap;">$${record.amount.toLocaleString()}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; width: 100%; flex-wrap: wrap;">
                        ${fromAccountTagHTML}
                        <i class="fas fa-arrow-right" style="color: var(--text-secondary); font-size: 12px; margin: 0 2px;"></i>
                        ${toAccountTagHTML}
                    </div>
                    <div style="display: flex; justify-content: flex-end; width: 100%;">
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); editJournalRecord('${record.id}')" style="background: none; border: none; color: #0a84ff; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="編輯"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); deleteJournalRecord('${record.id}')" style="background: none; border: none; color: #ff453a; font-size: 16px; padding: 4px 8px; cursor: pointer;" title="刪除"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }
            
            list.appendChild(detailItem);
        });
        
        // 在每個分頁下方顯示固定轉帳（如果有的話）
        if(fixedTransfers.length > 0) {
            // 如果有記錄，添加分隔線
            if(records.length > 0) {
                const separator = document.createElement('div');
                separator.style.cssText = 'margin: 12px 0; border-top: 1px solid var(--border-color);';
                list.appendChild(separator);
            }
            
            // 添加固定轉帳標題
            const fixedTransferTitle = document.createElement('div');
            fixedTransferTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; margin-top: 8px;';
            fixedTransferTitle.textContent = '固定轉帳';
            list.appendChild(fixedTransferTitle);
            
            // 顯示固定轉帳
            fixedTransfers.forEach(transfer => {
                const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
                const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
                
                const fromAccountName = fromAccount ? fromAccount.name : '未知帳戶';
                const toAccountName = toAccount ? toAccount.name : '未知帳戶';
                
                // 生成帳戶標籤 HTML（顯示帳戶名稱，使用帳戶類型決定顏色）
                const fromAccountTagClass = fromAccount ? getAccountTagClass(fromAccount) : 'account-tag-account';
                const toAccountTagClass = toAccount ? getAccountTagClass(toAccount) : 'account-tag-account';
                const fromAccountTagHTML = `<span class="account-tag ${fromAccountTagClass}">${fromAccountName}</span>`;
                const toAccountTagHTML = `<span class="account-tag ${toAccountTagClass}">${toAccountName}</span>`;
                
                // 計算顯示金額（使用固定轉帳設定的金額）
                const calculateDate = targetDate || (transfer.startDate ? new Date(transfer.startDate) : new Date());
                const dateStr = formatLocalDate(calculateDate);
                
                // 檢查是否已執行
                const isExecuted = transfer.executedDates && transfer.executedDates.includes(dateStr);
                
                // 如果已執行且有執行記錄，使用執行記錄的金額；否則使用固定轉帳設定的金額
                let displayAmount = transfer.amount || 0;
                if(isExecuted && transfer.executionRecords && transfer.executionRecords[dateStr] !== undefined) {
                    displayAmount = transfer.executionRecords[dateStr];
                }
                
                const detailItem = document.createElement('div');
                detailItem.style.cssText = 'padding: 12px; background: var(--bg-color); border-radius: 8px; border-left: 4px solid ' + transfer.tagColor + '; width: calc(100% - 0px); max-width: 100%; box-sizing: border-box; overflow: visible;';
                
                // 如果未執行，讓金額可編輯
                if(!isExecuted) {
                    detailItem.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; width: 100%; box-sizing: border-box; gap: 8px;">
                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${transfer.title}</div>
                            <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                                <span style="color: var(--text-secondary); font-size: 14px;">$</span>
                                <input type="number" id="fixedTransferAmount_${transfer.id}_${dateStr}" value="${displayAmount}" style="width: 100px; padding: 4px 8px; border: none; border-bottom: 2px solid var(--border-color); background: transparent; color: var(--text-primary); font-size: 18px; font-weight: 600; text-align: right; outline: none; transition: border-color 0.2s;" onchange="updateFixedTransferAmount('${transfer.id}', '${dateStr}')" onfocus="this.style.borderBottomColor='var(--color-up, #34c759)';" onblur="this.style.borderBottomColor='var(--border-color)';" onclick="event.stopPropagation();">
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; width: 100%; flex-wrap: wrap;">
                            ${fromAccountTagHTML}
                            <i class="fas fa-arrow-right" style="color: var(--text-secondary); font-size: 12px; margin: 0 2px;"></i>
                            ${toAccountTagHTML}
                        </div>
                    `;
                    // 未執行的固定轉帳，點擊顯示詳細資料
                    detailItem.onclick = (e) => {
                        if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'I') {
                            showFixedTransferDetail(transfer.id);
                        }
                    };
                } else {
                detailItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; width: 100%; box-sizing: border-box; gap: 8px;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${transfer.title}</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); flex-shrink: 0; white-space: nowrap;">$${displayAmount.toLocaleString()}</div>
                    </div>
                        <div style="display: flex; align-items: center; gap: 6px; width: 100%; flex-wrap: wrap;">
                            ${fromAccountTagHTML}
                            <i class="fas fa-arrow-right" style="color: var(--text-secondary); font-size: 12px; margin: 0 2px;"></i>
                            ${toAccountTagHTML}
                        </div>
                    `;
                    // 已執行的固定轉帳，點擊顯示詳細資料
                    detailItem.style.cursor = 'pointer';
                    detailItem.onclick = () => showFixedTransferDetail(transfer.id);
                }
                
                list.appendChild(detailItem);
            });
        }
        
        // 如果沒有任何內容，顯示提示
        if(records.length === 0 && fixedTransfers.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = 'text-align: center; color: var(--text-secondary); padding: 20px; font-size: 14px;';
            emptyMsg.textContent = '尚無記錄';
            list.appendChild(emptyMsg);
        }
        
        // 添加底部間距，確保最後一項不會被遮住
        const bottomSpacer = document.createElement('div');
        bottomSpacer.style.cssText = 'height: 30px; flex-shrink: 0;';
        list.appendChild(bottomSpacer);
    }
    
    // 切換記帳分頁
    function switchJournalPage(index) {
        currentJournalPageIndex = Math.max(0, Math.min(2, index)); // 限制在 0-2 之間
        const container = document.getElementById('journalPageContainer');
        if(container) {
            const transformValue = -currentJournalPageIndex * 33.333;
            container.style.transform = `translateX(${transformValue}%)`;
            // 更新當前 transform 值
            journalCurrentTransform = transformValue;
        }
    }
    
    // 記帳詳情滑動相關變數
    let journalTouchStartX = 0;
    let journalTouchStartY = 0;
    let journalTouchEndX = 0;
    let journalTouchEndY = 0;
    let journalIsSwiping = false;
    let journalCurrentTransform = 0;
    let journalSwipeStartIndex = 0;
    
    // 初始化記帳詳情的滑動手勢
    function initJournalSwipe() {
        const swiper = document.getElementById('journalSwiper');
        if(!swiper) return;
        
        // 移除舊的事件監聽器
        swiper.removeEventListener('touchstart', handleJournalTouchStart);
        swiper.removeEventListener('touchmove', handleJournalTouchMove);
        swiper.removeEventListener('touchend', handleJournalTouchEnd);
        
        // 添加新的事件監聽器
        swiper.addEventListener('touchstart', handleJournalTouchStart, { passive: true });
        swiper.addEventListener('touchmove', handleJournalTouchMove, { passive: true });
        swiper.addEventListener('touchend', handleJournalTouchEnd, { passive: true });
    }
    
    function handleJournalTouchStart(e) {
        journalTouchStartX = e.touches[0].clientX;
        journalTouchStartY = e.touches[0].clientY;
        journalIsSwiping = false;
        journalSwipeStartIndex = currentJournalPageIndex;
        journalCurrentTransform = -currentJournalPageIndex * 33.333;
    }
    
    function handleJournalTouchMove(e) {
        if(!journalTouchStartX || !journalTouchStartY) return;
        
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = journalTouchStartX - currentX;
        const diffY = journalTouchStartY - currentY;
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，不處理（允許垂直滾動）
        if(absDiffY > absDiffX) return;
        
        if(absDiffX > 10) {
            journalIsSwiping = true;
            const container = document.getElementById('journalPageContainer');
            if(container) {
                container.classList.add('swiping');
                
                const swiper = document.getElementById('journalSwiper');
                const swipePercent = -(diffX / swiper.offsetWidth) * 100;
                let newTransform = journalCurrentTransform + swipePercent;
                
                // 限制範圍（0% 到 -66.666%）
                const minTransform = -66.666;
                const maxTransform = 0;
                
                // 檢查是否在邊界
                const isAtLeftBoundary = journalSwipeStartIndex <= 0 && diffX < 0;
                const isAtRightBoundary = journalSwipeStartIndex >= 2 && diffX > 0;
                
                if(isAtLeftBoundary || isAtRightBoundary) {
                    // 添加阻力效果
                    if(newTransform > maxTransform) {
                        newTransform = maxTransform + (newTransform - maxTransform) * 0.3;
                    } else if(newTransform < minTransform) {
                        newTransform = minTransform + (newTransform - minTransform) * 0.3;
                    }
                } else {
                    // 限制在有效範圍內
                    newTransform = Math.max(minTransform, Math.min(maxTransform, newTransform));
                }
                
                container.style.transform = `translateX(${newTransform}%)`;
            }
        }
    }
    
    function handleJournalTouchEnd(e) {
        journalTouchEndX = e.changedTouches[0].clientX;
        journalTouchEndY = e.changedTouches[0].clientY;
        const container = document.getElementById('journalPageContainer');
        if(container && journalIsSwiping) {
            container.classList.remove('swiping');
        }
        
        if(journalIsSwiping) {
            handleJournalSwipe();
        }
        
        journalTouchStartX = 0;
        journalTouchStartY = 0;
        journalTouchEndX = 0;
        journalTouchEndY = 0;
        journalIsSwiping = false;
    }
    
    function handleJournalSwipe() {
        const swipeThreshold = 50;
        const diffX = journalTouchStartX - journalTouchEndX;
        const diffY = journalTouchStartY - journalTouchEndY;
        const absDiffX = Math.abs(diffX);
        const absDiffY = Math.abs(diffY);
        
        // 如果垂直滑動距離大於水平滑動距離，不觸發分頁切換
        if(absDiffY > absDiffX) {
            // 回彈到原位置
            switchJournalPage(currentJournalPageIndex);
            return;
        }
        
        if(absDiffX > swipeThreshold) {
            if(diffX > 0) {
                // 向左滑動，顯示下一個分頁
                if(currentJournalPageIndex < 2) {
                    switchJournalPage(currentJournalPageIndex + 1);
                } else {
                    // 回彈
                    switchJournalPage(currentJournalPageIndex);
                }
            } else {
                // 向右滑動，顯示上一個分頁
                if(currentJournalPageIndex > 0) {
                    switchJournalPage(currentJournalPageIndex - 1);
                } else {
                    // 回彈
                    switchJournalPage(currentJournalPageIndex);
                }
            }
        } else {
            // 滑動距離不夠，回彈
            switchJournalPage(currentJournalPageIndex);
        }
    }
    
            // 載入記帳記錄
    function loadJournalRecords() {
        try {
            const data = localStorage.getItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`);
            const records = data ? JSON.parse(data) : [];
            // 減少 debug 輸出，只在開發時需要
            return records;
        } catch(e) {
            console.error('載入記帳記錄失敗:', e);
            return [];
        }
    }
    
    // 保存記帳記錄
    function saveJournalRecords(records) {
        if (isUserSwitching) return; // 鎖定攔截
        clearJournalDatesCache();
        try {
            localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`, JSON.stringify(records));
            if (window.syncJournalToFirestore && window.firebaseUserLoggedIn) {
                window.syncJournalToFirestore(records);
            }
        } catch(e) { console.error(e); }
    }
    
    // 根據記帳記錄重新計算帳戶餘額
    // 這個函式會在記帳記錄從 Firestore 同步後被調用
    function recalculateAccountBalancesFromJournal(userId, journalRecords, accounts) {
        // 【防護機制】如果正在切換使用者，直接返回，避免資料寫入錯誤的使用者
        if (isUserSwitching) {
            console.warn(`[重新計算餘額] 正在切換使用者，跳過餘額重新計算 (使用者 ${userId})`);
            return;
        }
        
        if (!accounts || !Array.isArray(accounts)) {
            console.warn('[重新計算餘額] 沒有帳戶資料');
            return;
        }
        
        if (!journalRecords || !Array.isArray(journalRecords)) {
            console.warn('[重新計算餘額] 沒有記帳記錄');
            return;
        }
        
        // 確認當前 localStorage 中的使用者 ID 與傳入的 userId 一致，避免資料污染
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (currentUserIdFromStorage && String(currentUserIdFromStorage) !== String(userId)) {
            console.warn(`[重新計算餘額] 使用者 ID 不一致 (傳入: ${userId}, 當前: ${currentUserIdFromStorage})，跳過重新計算`);
            return;
        }
        
        // 【關鍵修正】策略改變：不反向計算，而是直接從記帳記錄計算最終餘額
        // 問題：如果帳戶餘額已經被記帳記錄影響過，反向計算會得到錯誤的初始餘額
        // 解決：使用 Firestore 同步的 accounts 作為基礎（如果有的話），或者從記帳記錄直接計算
        
        // 1. 先從 Firestore 獲取最新的 accounts 資料（如果有的話）
        // 如果沒有，則使用傳入的 accounts 作為基礎
        const STORAGE_KEY_DATA = 'my_assets_stable_data';
        const userDataKey = `${STORAGE_KEY_DATA}_${userId}`;
        const localAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 建立帳戶 ID 到帳戶的映射
        const accountMap = {};
        accounts.forEach(acc => {
            accountMap[acc.id] = acc;
        });
        
        // 2. 初始化最終餘額（使用帳戶的當前餘額作為基礎）
        // 注意：這裡假設傳入的 accounts 是從 Firestore 同步的最新資料
        const accountFinalBalances = {};
        accounts.forEach(acc => {
            // 使用帳戶的當前餘額作為初始值
            accountFinalBalances[acc.id] = parseFloat(acc.balance) || 0;
        });
        
        // 3. 按照時間順序排序記帳記錄
        const sortedRecords = [...journalRecords].sort((a, b) => {
            const dateA = a.date ? new Date(a.date).getTime() : 0;
            const dateB = b.date ? new Date(b.date).getTime() : 0;
            if (dateA !== dateB) return dateA - dateB;
            // 如果日期相同，按照創建時間排序
            const createA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const createB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            return createA - createB;
        });
        
        // 4. 重新計算：先反向計算得到初始餘額，再正向計算得到最終餘額
        // 反向計算：從當前餘額減去所有記帳記錄的影響，得到初始餘額
        const accountInitialBalances = {};
        accounts.forEach(acc => {
            let initialBalance = parseFloat(acc.balance) || 0;
            
            sortedRecords.forEach(record => {
                const amount = parseFloat(record.amount) || 0;
                
                if (record.type === 'income') {
                    // 收入：反向操作是減去
                    if (String(record.accountId) === String(acc.id)) {
                        initialBalance -= amount;
                    }
                } else if (record.type === 'expense') {
                    // 支出：反向操作是加上
                    if (String(record.accountId) === String(acc.id)) {
                        initialBalance += amount;
                    }
                } else if (record.type === 'transfer') {
                    // 轉帳：反向操作
                    if (String(record.fromAccountId) === String(acc.id)) {
                        initialBalance += amount; // 轉出帳戶反向是加上
                    }
                    if (String(record.toAccountId) === String(acc.id)) {
                        initialBalance -= amount; // 轉入帳戶反向是減去
                    }
                }
            });
            
            accountInitialBalances[acc.id] = initialBalance;
            accountFinalBalances[acc.id] = initialBalance; // 從初始餘額開始正向計算
        });
        
        // 5. 正向計算：從初始餘額加上所有記帳記錄的影響，得到最終餘額
        sortedRecords.forEach(record => {
            const amount = parseFloat(record.amount) || 0;
            
            if (record.type === 'income') {
                // 收入：增加帳戶餘額
                const accountId = String(record.accountId);
                if (accountFinalBalances[accountId] !== undefined) {
                    accountFinalBalances[accountId] += amount;
                }
            } else if (record.type === 'expense') {
                // 支出：減少帳戶餘額
                const accountId = String(record.accountId);
                if (accountFinalBalances[accountId] !== undefined) {
                    accountFinalBalances[accountId] -= amount;
                }
            } else if (record.type === 'transfer') {
                // 轉帳：轉出帳戶減少，轉入帳戶增加
                const fromAccountId = String(record.fromAccountId);
                const toAccountId = String(record.toAccountId);
                if (accountFinalBalances[fromAccountId] !== undefined) {
                    accountFinalBalances[fromAccountId] -= amount;
                }
                if (accountFinalBalances[toAccountId] !== undefined) {
                    accountFinalBalances[toAccountId] += amount;
                }
            }
        });
        
        // 6. 更新帳戶餘額（再次檢查是否正在切換使用者）
        if (isUserSwitching) {
            console.warn(`[重新計算餘額] 計算過程中偵測到使用者切換，取消寫入 (使用者 ${userId})`);
            return;
        }
        
        let hasBalanceChanges = false;
        accounts.forEach(acc => {
            const newBalance = accountFinalBalances[acc.id];
            const currentBalance = parseFloat(acc.balance) || 0;
            if (newBalance !== undefined && Math.abs(currentBalance - newBalance) > 0.01) {
                acc.balance = newBalance;
                hasBalanceChanges = true;
                // 減少 debug 輸出，只在有變化時輸出
            }
        });
        
        if (hasBalanceChanges) {
            // 最後一次檢查：確保在寫入前使用者沒有切換
            const finalCheckUserId = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
            if (finalCheckUserId && String(finalCheckUserId) !== String(userId)) {
                console.warn(`[重新計算餘額] 寫入前使用者 ID 已變更，取消寫入 (原本: ${userId}, 現在: ${finalCheckUserId})`);
                return;
            }
            
            if (isUserSwitching) {
                console.warn(`[重新計算餘額] 寫入前偵測到使用者切換，取消寫入 (使用者 ${userId})`);
                return;
            }
            
            // 保存更新後的帳戶資料
            localStorage.setItem(userDataKey, JSON.stringify(accounts));
            
            // 同步到 Firestore
            if (window.syncAccountsToFirestore && window.firebaseUserLoggedIn && !isUserSwitching) {
                window.syncAccountsToFirestore(accounts);
            }
        }
    }
    
    // 將函式暴露到 window，讓模組可以調用
    window.recalculateAccountBalancesFromJournal = recalculateAccountBalancesFromJournal;
    
    // 編輯記帳記錄
    let editingJournalRecordId = null;
    
    function editJournalRecord(recordId) {
        const records = loadJournalRecords();
        const record = records.find(r => r.id === recordId);
        if(!record) return;
        
        editingJournalRecordId = recordId;
        
        if(record.type === 'income') {
            // 打開收入編輯模態框
            openIncomeModal(record);
        } else if(record.type === 'expense') {
            // 打開支出編輯模態框
            openExpenseModal(record);
        } else if(record.type === 'transfer') {
            // 打開轉帳編輯模態框
            openTransferModal(record);
        }
    }
    
    // 刪除記帳記錄
    function deleteJournalRecord(recordId) {
        if(!confirm('確定要刪除這筆記錄嗎？')) return;
        
        const records = loadJournalRecords();
        const record = records.find(r => r.id === recordId);
        if(!record) {
            console.error('找不到要刪除的記錄:', recordId);
            return;
        }
        
        console.log('刪除記錄:', record);
        
        // 恢復帳戶餘額
        if(record.type === 'income') {
            // 收入：從帳戶餘額中減去金額（因為收入是增加餘額的）
            const account = accounts.find(acc => String(acc.id) === String(record.accountId));
            if(account) {
                const amount = parseFloat(record.amount) || 0;
                account.balance = parseFloat(account.balance) || 0;
                account.balance -= amount;
                console.log('刪除收入 - 帳戶:', account.name, '餘額:', account.balance, '金額:', amount);
            } else {
                console.error('找不到收入帳戶:', record.accountId, '所有帳戶ID:', accounts.map(a => a.id));
            }
        } else if(record.type === 'expense') {
            // 支出：向帳戶餘額中加上金額（因為支出是減少餘額的）
            const account = accounts.find(acc => String(acc.id) === String(record.accountId));
            if(account) {
                    // 正常恢復金額
                    const amount = parseFloat(record.amount) || 0;
                    account.balance = parseFloat(account.balance) || 0;
                    account.balance += amount;
                    console.log('刪除支出 - 帳戶:', account.name, '餘額:', account.balance, '金額:', amount);
            } else {
                console.error('找不到支出帳戶:', record.accountId, '所有帳戶ID:', accounts.map(a => a.id));
            }
        } else if(record.type === 'transfer') {
            // 轉帳：轉出帳戶餘額加上金額，轉入帳戶餘額減去金額
            const fromAccount = accounts.find(acc => String(acc.id) === String(record.fromAccountId));
            const toAccount = accounts.find(acc => String(acc.id) === String(record.toAccountId));
            if(fromAccount && toAccount) {
                const amount = parseFloat(record.amount) || 0;
                fromAccount.balance = parseFloat(fromAccount.balance) || 0;
                toAccount.balance = parseFloat(toAccount.balance) || 0;
                fromAccount.balance += amount;
                toAccount.balance -= amount;
                console.log('刪除轉帳 - 轉出帳戶:', fromAccount.name, '餘額:', fromAccount.balance, '轉入帳戶:', toAccount.name, '餘額:', toAccount.balance, '金額:', amount);
            } else {
                console.error('找不到轉帳帳戶 - 轉出:', record.fromAccountId, '轉入:', record.toAccountId, '所有帳戶ID:', accounts.map(a => a.id));
            }
        }
        
        // 刪除記錄
        const filtered = records.filter(r => r.id !== recordId);
        
        // 先保存到 localStorage
        clearJournalDatesCache();
        localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`, JSON.stringify(filtered));
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserId}`;
        localStorage.setItem(userDataKey, JSON.stringify(accounts));
        
        // 【關鍵修正】從 localStorage 重新讀取當前使用者的 accounts，確保資料正確
        const currentUserAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 一起同步 journal 和 accounts 到 Firestore（只更新 currentUserId）
        if (window.syncJournalAndAccountsToFirestore && window.firebaseUserLoggedIn) {
            window.syncJournalAndAccountsToFirestore(filtered, currentUserAccounts).catch(err => {
                console.error('[刪除記帳同步] 同步失敗:', err);
            });
        }
        
        console.log('資料已保存並同步');
        
        // 重新渲染
        renderAssets();
        updateChartData();
        
        // 重新渲染當前日期的記帳詳情
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        }
    }
    
    // 修改 openIncomeModal 以支持編輯模式
    function openIncomeModal(record = null, savedFormData = null) {
        currentJournalType = 'income';
        
        if(record) {
            // 編輯模式
            currentJournalDate = new Date(record.date);
            currentJournalCategory = record.category || null;
            currentJournalAccountId = record.accountId || null;
        } else if(savedFormData && savedFormData.type === 'income') {
            // 恢復保存的表單數據
            currentJournalDate = savedFormData.date ? new Date(savedFormData.date) : (selectedDate ? new Date(selectedDate) : new Date());
            currentJournalDate.setHours(0, 0, 0, 0);
            currentJournalCategory = savedFormData.category || null;
            currentJournalAccountId = savedFormData.accountId || null;
            pendingJournalFormData = null; // 清除保存的數據
        } else {
            // 新增模式：如果 currentJournalDate 已經在 openNewIncome 中設置，則保留它；否則使用今天
            if(!currentJournalDate || currentJournalDate.getTime() === new Date().getTime()) {
                // 如果沒有設置或等於當前時間，使用選中的日期或今天
                if(selectedDate) {
                    currentJournalDate = new Date(selectedDate);
                    currentJournalDate.setHours(0, 0, 0, 0);
                } else {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    currentJournalDate = today;
                }
            }
            currentJournalCategory = null;
            currentJournalAccountId = null;
        }
        
        const modal = document.getElementById('incomeModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = modal.querySelector('.modal-title');
        
        if(title) {
            title.textContent = record ? '編輯收入' : '新增收入';
        }
        
        // 初始化日期顯示
        updateIncomeDateDisplay();
        
        // 填充或重置表單
        if(record) {
            document.getElementById('incomeAmount').value = record.amount || '';
            const titleInput = document.getElementById('incomeTitle');
            if(titleInput) {
                titleInput.value = record.title || '';
            }
            document.getElementById('incomeCategory').textContent = record.category || '選擇類別';
            document.getElementById('incomeCategory').style.color = record.category ? 'var(--text-primary)' : 'var(--text-secondary)';
            const account = accounts.find(acc => acc.id === record.accountId);
            document.getElementById('incomeAccount').textContent = account ? account.name : '選擇帳戶';
            document.getElementById('incomeAccount').style.color = account ? 'var(--text-primary)' : 'var(--text-secondary)';
            const isAdvanceCheckbox = document.getElementById('incomeIsAdvance');
            if(isAdvanceCheckbox) {
                isAdvanceCheckbox.checked = record.isAdvance || false;
            }
        } else if(savedFormData && savedFormData.type === 'income') {
            // 恢復保存的表單數據
            document.getElementById('incomeAmount').value = savedFormData.amount || '';
            if(savedFormData.category) {
                document.getElementById('incomeCategory').textContent = savedFormData.category;
                document.getElementById('incomeCategory').style.color = 'var(--text-primary)';
            } else {
                document.getElementById('incomeCategory').textContent = '選擇類別';
                document.getElementById('incomeCategory').style.color = 'var(--text-secondary)';
            }
            if(savedFormData.accountId) {
                const account = accounts.find(acc => acc.id === savedFormData.accountId);
                if(account) {
                    document.getElementById('incomeAccount').textContent = account.name;
                    document.getElementById('incomeAccount').style.color = 'var(--text-primary)';
                } else {
                    document.getElementById('incomeAccount').textContent = '選擇帳戶';
                    document.getElementById('incomeAccount').style.color = 'var(--text-secondary)';
                }
            } else {
                document.getElementById('incomeAccount').textContent = '選擇帳戶';
                document.getElementById('incomeAccount').style.color = 'var(--text-secondary)';
            }
        } else {
            document.getElementById('incomeAmount').value = '';
            const titleInput = document.getElementById('incomeTitle');
            if(titleInput) {
                titleInput.value = '';
            }
            document.getElementById('incomeCategory').textContent = '選擇類別';
            document.getElementById('incomeCategory').style.color = 'var(--text-secondary)';
            document.getElementById('incomeAccount').textContent = '選擇帳戶';
            document.getElementById('incomeAccount').style.color = 'var(--text-secondary)';
            const isAdvanceCheckbox = document.getElementById('incomeIsAdvance');
            if(isAdvanceCheckbox) {
                isAdvanceCheckbox.checked = false;
            }
        }
        
        // 更新分頁樣式
        const tabs = modal.querySelectorAll('.journal-form-tab');
        tabs.forEach(t => {
            t.classList.remove('active');
            t.style.background = 'var(--border-color)';
            t.style.color = 'var(--text-secondary)';
            t.style.border = 'none';
        });
        const incomeTab = document.getElementById('journalFormTabIncome');
        if(incomeTab) {
            incomeTab.classList.add('active');
            incomeTab.style.background = 'var(--card-bg)';
            incomeTab.style.color = 'var(--color-up)';
            incomeTab.style.border = '2px solid var(--color-up)';
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping');
        }
        modal.style.display = 'block';
        modal.style.background = 'transparent';
        // 重新顯示 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'flex';
        }
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateX(0)';
                }
            }, 10);
        });
    }
    
    // 修改 openExpenseModal 以支持編輯模式
    function openExpenseModal(record = null, savedFormData = null) {
        currentJournalType = 'expense';
        
        if(record) {
            // 編輯模式
            currentJournalDate = new Date(record.date);
            currentJournalCategory = record.category || null;
            currentJournalAccountId = record.accountId || null;
        } else if(savedFormData && savedFormData.type === 'expense') {
            // 恢復保存的表單數據
            currentJournalDate = savedFormData.date ? new Date(savedFormData.date) : (selectedDate ? new Date(selectedDate) : new Date());
            currentJournalDate.setHours(0, 0, 0, 0);
            currentJournalCategory = savedFormData.category || null;
            currentJournalAccountId = savedFormData.accountId || null;
            pendingJournalFormData = null; // 清除保存的數據
        } else {
            // 新增模式：如果 currentJournalDate 已經在 openNewExpense 中設置，則保留它；否則使用今天
            if(!currentJournalDate || currentJournalDate.getTime() === new Date().getTime()) {
                // 如果沒有設置或等於當前時間，使用選中的日期或今天
                if(selectedDate) {
                    currentJournalDate = new Date(selectedDate);
                    currentJournalDate.setHours(0, 0, 0, 0);
                } else {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    currentJournalDate = today;
                }
            }
            currentJournalCategory = null;
            currentJournalAccountId = null;
        }
        
        const modal = document.getElementById('expenseModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = modal.querySelector('.modal-title');
        
        if(title) {
            title.textContent = record ? '編輯支出' : '新增支出';
        }
        
        // 初始化日期顯示
        updateExpenseDateDisplay();
        
        // 填充或重置表單
        if(record) {
            document.getElementById('expenseAmount').value = record.amount || '';
            const titleInput = document.getElementById('expenseTitle');
            if(titleInput) {
                titleInput.value = record.title || '';
            }
            document.getElementById('expenseCategory').textContent = record.category || '選擇類別';
            document.getElementById('expenseCategory').style.color = record.category ? 'var(--text-primary)' : 'var(--text-secondary)';
            const account = accounts.find(acc => acc.id === record.accountId);
            document.getElementById('expenseAccount').textContent = account ? account.name : '選擇帳戶';
            document.getElementById('expenseAccount').style.color = account ? 'var(--text-primary)' : 'var(--text-secondary)';
            const isAdvanceCheckbox = document.getElementById('expenseIsAdvance');
            if(isAdvanceCheckbox) {
                isAdvanceCheckbox.checked = record.isAdvance || false;
            }
        } else if(savedFormData && savedFormData.type === 'expense') {
            // 恢復保存的表單數據
            document.getElementById('expenseAmount').value = savedFormData.amount || '';
            if(savedFormData.category) {
                document.getElementById('expenseCategory').textContent = savedFormData.category;
                document.getElementById('expenseCategory').style.color = 'var(--text-primary)';
            } else {
                document.getElementById('expenseCategory').textContent = '選擇類別';
                document.getElementById('expenseCategory').style.color = 'var(--text-secondary)';
            }
            if(savedFormData.accountId) {
                const account = accounts.find(acc => acc.id === savedFormData.accountId);
                if(account) {
                    document.getElementById('expenseAccount').textContent = account.name;
                    document.getElementById('expenseAccount').style.color = 'var(--text-primary)';
                } else {
                    document.getElementById('expenseAccount').textContent = '選擇帳戶';
                    document.getElementById('expenseAccount').style.color = 'var(--text-secondary)';
                }
            } else {
                document.getElementById('expenseAccount').textContent = '選擇帳戶';
                document.getElementById('expenseAccount').style.color = 'var(--text-secondary)';
            }
        } else {
            document.getElementById('expenseAmount').value = '';
            const titleInput = document.getElementById('expenseTitle');
            if(titleInput) {
                titleInput.value = '';
            }
            document.getElementById('expenseCategory').textContent = '選擇類別';
            document.getElementById('expenseCategory').style.color = 'var(--text-secondary)';
            document.getElementById('expenseAccount').textContent = '選擇帳戶';
            document.getElementById('expenseAccount').style.color = 'var(--text-secondary)';
            const isAdvanceCheckbox = document.getElementById('expenseIsAdvance');
            if(isAdvanceCheckbox) {
                isAdvanceCheckbox.checked = false;
            }
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping');
        }
        modal.style.display = 'block';
        modal.style.background = 'transparent';
        // 重新顯示 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'flex';
        }
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateX(0)';
                }
            }, 10);
        });
    }
    
    // 獲取指定日期的記帳記錄
    // 格式化本地日期為 YYYY-MM-DD 格式（避免時區問題）
    function formatLocalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // 緩存所有記帳記錄的日期集合，避免重複查找
    let journalDatesCache = null;
    function getJournalDatesSet() {
        if(journalDatesCache === null) {
            const records = loadJournalRecords();
            journalDatesCache = new Set();
            records.forEach(record => {
                if(record.date) {
                    const dateStr = record.date.split('T')[0];
                    journalDatesCache.add(dateStr);
                }
            });
        }
        return journalDatesCache;
    }
    
    function getJournalRecordsForDate(dateStr) {
        const records = loadJournalRecords();
        // 確保日期格式一致（YYYY-MM-DD）
        const normalizedDateStr = dateStr.split('T')[0];
        return records.filter(record => {
            const recordDate = record.date ? record.date.split('T')[0] : '';
            return recordDate === normalizedDateStr;
        });
    }
    
    // 清除緩存（當記帳記錄更新時調用）
    function clearJournalDatesCache() {
        journalDatesCache = null;
    }
    
    // 計算記帳的今日盈虧（今日收入 - 今日支出）
    function calculateJournalDailyPnL() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = formatLocalDate(today);
        const records = getJournalRecordsForDate(todayStr);
        
        let income = 0;
        let expense = 0;
        
        records.forEach(record => {
            const amount = parseFloat(record.amount) || 0;
            if(record.type === 'income') {
                income += amount;
            } else if(record.type === 'expense') {
                expense += amount;
            }
            // 轉帳不影響盈虧計算
        });
        
        return income - expense;
    }
    
    // 損益歸零：保存當前損益值並將顯示值設為0
    function resetPnL() {
        if(!confirm('確定要將當日損益和總損益歸零嗎？此操作可以恢復。')) return;
        
        const dailyPnL = calculateJournalDailyPnL();
        const totalPnL = calculateJournalTotalPnL();
        
        // 保存原始值到 localStorage
        const backup = {
            dailyPnL: dailyPnL,
            totalPnL: totalPnL,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(`pnl_backup_${currentUserId}`, JSON.stringify(backup));
        
        // 保存偏移值（用於計算顯示值）
        localStorage.setItem(`pnl_daily_offset_${currentUserId}`, (-dailyPnL).toString());
        localStorage.setItem(`pnl_total_offset_${currentUserId}`, (-totalPnL).toString());
        
        // 重新渲染以更新顯示
        updateChartData();
        alert('損益已歸零');
        // 自動重新整理頁面
        setTimeout(() => {
            location.reload();
        }, 500);
    }
    
    // 恢復損益：恢復到歸零前的值
    function restorePnL() {
        const backup = localStorage.getItem(`pnl_backup_${currentUserId}`);
        if(!backup) {
            alert('沒有可恢復的損益記錄');
            return;
        }
        
        if(!confirm('確定要恢復損益嗎？')) return;
        
        // 清除偏移值
        localStorage.removeItem(`pnl_daily_offset_${currentUserId}`);
        localStorage.removeItem(`pnl_total_offset_${currentUserId}`);
        localStorage.removeItem(`pnl_backup_${currentUserId}`);
        
        // 重新渲染以更新顯示
        updateChartData();
        alert('損益已恢復');
        // 自動重新整理頁面
        setTimeout(() => {
            location.reload();
        }, 500);
    }
    
    // 獲取當日損益偏移值
    function getDailyPnLOffset() {
        const offset = localStorage.getItem(`pnl_daily_offset_${currentUserId}`);
        return offset ? parseFloat(offset) : 0;
    }
    
    // 獲取總損益偏移值
    function getTotalPnLOffset() {
        const offset = localStorage.getItem(`pnl_total_offset_${currentUserId}`);
        return offset ? parseFloat(offset) : 0;
    }
    
    // 計算記帳的總計盈虧（所有收入 - 所有支出）
    function calculateJournalTotalPnL() {
        const records = loadJournalRecords();
        
        let income = 0;
        let expense = 0;
        
        records.forEach(record => {
            const amount = parseFloat(record.amount) || 0;
            if(record.type === 'income') {
                income += amount;
            } else if(record.type === 'expense') {
                expense += amount;
            }
            // 轉帳不影響盈虧計算
        });
        
        return income - expense;
    }
    
    // 獲取指定日期的所有固定轉帳（使用與日曆渲染相同的邏輯）
    function getFixedTransfersForDate(date) {
        const transfers = loadFixedTransfers();
        const dateObj = new Date(date);
        dateObj.setHours(0, 0, 0, 0);
        const matchingTransfers = [];
        
        transfers.forEach(transfer => {
            const startDate = new Date(transfer.startDate);
            startDate.setHours(0, 0, 0, 0);
            const endDate = transfer.endDate ? new Date(transfer.endDate) : null;
            if(endDate) endDate.setHours(0, 0, 0, 0);
            
            // 檢查日期是否在範圍內
            if(dateObj >= startDate && (!endDate || dateObj <= endDate)) {
                // 檢查是否符合重複規則（與 renderCalendar 中的邏輯相同）
                let matches = false;
                const daysDiff = Math.floor((dateObj - startDate) / (1000 * 60 * 60 * 24));
                
                switch(transfer.repeat) {
                    case 'daily':
                        matches = true;
                        break;
                    case 'weekly':
                        matches = (daysDiff % 7 === 0);
                        break;
                    case 'monthly':
                        matches = (dateObj.getDate() === startDate.getDate());
                        break;
                    case 'yearly':
                        matches = (dateObj.getMonth() === startDate.getMonth() && dateObj.getDate() === startDate.getDate());
                        break;
                }
                
                // 如果匹配，加入結果（假日調整的邏輯在日曆渲染時已經處理，這裡直接使用匹配結果）
                if(matches) {
                    matchingTransfers.push(transfer);
                }
            }
        });
        
        return matchingTransfers;
    }
    
    // Calendar Journal Functions (新增支出/收入)
    function openCalendarJournalModal() {
        // 如果沒有選中日期，使用今天
        if(!selectedDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = new Date(today);
            renderCalendar();
        }
        
        const modal = document.getElementById('calendarJournalModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            }, 10);
        });
    }
    
    // 從日曆頁面直接打開支出新增（使用當前日期或選中的日期）
    // 注意：這個函數已被 openJournalTypeSelector 取代，但保留以向後兼容
    function openNewExpenseFromCalendar() {
        // 如果沒有選中日期，使用今天
        if(!selectedDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = new Date(today);
            renderCalendar();
        }
        // 打開四個分頁的模態框
        openJournalTypeSelector();
    }
    
    function closeCalendarJournalModal() {
        const modal = document.getElementById('calendarJournalModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    // 收入和支出類別定義
    const incomeCategories = ['工資', '獎金', '投資收益', '其他收入'];
    const expenseCategories = ['飲食', '交通', '購物', '娛樂', '醫療', '教育', '房租', '水電', '其他支出'];
    
    // 當前記帳相關的變數
    let currentJournalType = null; // 'income', 'expense', 'transfer'
    let currentJournalDate = new Date();
    let currentJournalCategory = null;
    let currentJournalAccountId = null;
    let currentTransferFromAccountId = null;
    let currentTransferToAccountId = null;
    let pendingJournalFormData = null; // 保存跳轉到新增帳戶前的表單數據
    
    // 新增支出
    function openNewExpense() {
        // 不再關閉日曆模態框，因為現在直接從右上角+號打開
        editingJournalRecordId = null;
        currentJournalType = 'expense';
        // 使用選中的日期，如果沒有選中則使用今天
        if(selectedDate) {
            currentJournalDate = new Date(selectedDate);
            currentJournalDate.setHours(0, 0, 0, 0); // 確保時間部分為 00:00:00
        } else {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentJournalDate = new Date(today);
            selectedDate = new Date(today);
            renderCalendar();
        }
        currentJournalCategory = null;
        currentJournalAccountId = null;
        openExpenseModal();
    }
    
    function closeExpenseModal() {
        const modal = document.getElementById('expenseModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 立即隱藏 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'none';
        }
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateX(100%)';
            }, 400);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function updateExpenseDateDisplay() {
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const dateStr = `${currentJournalDate.getFullYear()}年${currentJournalDate.getMonth() + 1}月${currentJournalDate.getDate()}日 ${weekdays[currentJournalDate.getDay()]}`;
        document.getElementById('expenseDate').textContent = dateStr;
        document.getElementById('expenseDateDisplay').textContent = dateStr;
        document.getElementById('expenseDateDisplay').style.color = 'var(--text-primary)';
    }
    
    function openExpenseDateSelector() {
        currentDatePickerType = 'expense';
        openDateSelector('expense');
    }
    
    // 新增收入
    function openNewIncome() {
        // 不再關閉日曆模態框，因為現在直接從右上角+號打開
        editingJournalRecordId = null;
        currentJournalType = 'income';
        // 使用選中的日期，如果沒有選中則使用今天
        if(selectedDate) {
            currentJournalDate = new Date(selectedDate);
            currentJournalDate.setHours(0, 0, 0, 0); // 確保時間部分為 00:00:00
        } else {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentJournalDate = new Date(today);
            selectedDate = new Date(today);
            renderCalendar();
        }
        currentJournalCategory = null;
        currentJournalAccountId = null;
        openIncomeModal();
    }
    
    function closeIncomeModal() {
        const modal = document.getElementById('incomeModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 立即隱藏 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'none';
        }
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateX(100%)';
            }, 400);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function updateIncomeDateDisplay() {
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const dateStr = `${currentJournalDate.getFullYear()}年${currentJournalDate.getMonth() + 1}月${currentJournalDate.getDate()}日 ${weekdays[currentJournalDate.getDay()]}`;
        document.getElementById('incomeDate').textContent = dateStr;
        document.getElementById('incomeDateDisplay').textContent = dateStr;
        document.getElementById('incomeDateDisplay').style.color = 'var(--text-primary)';
    }
    
    function openIncomeDateSelector() {
        currentDatePickerType = 'income';
        openDateSelector('income');
    }
    
    // 新增轉帳
    function openNewTransfer() {
        // 不再關閉日曆模態框，因為現在直接從右上角+號打開
        editingJournalRecordId = null;
        currentJournalType = 'transfer';
        // 使用選中的日期，如果沒有選中則使用今天
        if(selectedDate) {
            currentJournalDate = new Date(selectedDate);
            currentJournalDate.setHours(0, 0, 0, 0); // 確保時間部分為 00:00:00
        } else {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentJournalDate = new Date(today);
            selectedDate = new Date(today);
            renderCalendar();
        }
        currentTransferFromAccountId = null;
        currentTransferToAccountId = null;
        openTransferModal();
    }
    
    // 修改 openTransferModal 以支持編輯模式
    function openTransferModal(record = null, savedFormData = null) {
        currentJournalType = 'transfer';
        
        if(record) {
            // 編輯模式
            currentJournalDate = new Date(record.date);
            currentTransferFromAccountId = record.fromAccountId || null;
            currentTransferToAccountId = record.toAccountId || null;
        } else if(savedFormData && savedFormData.type === 'transfer') {
            // 恢復保存的表單數據
            currentJournalDate = savedFormData.date ? new Date(savedFormData.date) : (selectedDate ? new Date(selectedDate) : new Date());
            currentJournalDate.setHours(0, 0, 0, 0);
            currentTransferFromAccountId = savedFormData.fromAccountId || null;
            currentTransferToAccountId = savedFormData.toAccountId || null;
            pendingJournalFormData = null; // 清除保存的數據
        } else {
            // 新增模式（日期已在調用時設置）
            // currentJournalDate 已在 openNewTransfer 中設置
        }
        
        const modal = document.getElementById('transferModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = modal.querySelector('.modal-title');
        
        if(title) {
            title.textContent = record ? '編輯轉帳' : '轉帳';
        }
        
        // 初始化日期顯示
        updateTransferDateDisplay();
        
        // 填充或重置表單
        if(record) {
            document.getElementById('transferAmount').value = record.amount || '';
            const titleInput = document.getElementById('transferTitle');
            if(titleInput) {
                titleInput.value = record.title || '';
            }
            const fromAccount = accounts.find(acc => acc.id === record.fromAccountId);
            document.getElementById('transferFromAccount').textContent = fromAccount ? fromAccount.name : '選擇轉出帳戶';
            document.getElementById('transferFromAccount').style.color = fromAccount ? 'var(--text-primary)' : 'var(--text-secondary)';
            const toAccount = accounts.find(acc => acc.id === record.toAccountId);
            document.getElementById('transferToAccount').textContent = toAccount ? toAccount.name : '選擇轉入帳戶';
            document.getElementById('transferToAccount').style.color = toAccount ? 'var(--text-primary)' : 'var(--text-secondary)';
        } else if(savedFormData && savedFormData.type === 'transfer') {
            // 恢復保存的表單數據
            document.getElementById('transferAmount').value = savedFormData.amount || '';
            if(savedFormData.fromAccountId) {
                const fromAccount = accounts.find(acc => acc.id === savedFormData.fromAccountId);
                if(fromAccount) {
                    document.getElementById('transferFromAccount').textContent = fromAccount.name;
                    document.getElementById('transferFromAccount').style.color = 'var(--text-primary)';
                } else {
                    document.getElementById('transferFromAccount').textContent = '選擇轉出帳戶';
                    document.getElementById('transferFromAccount').style.color = 'var(--text-secondary)';
                }
            } else {
                document.getElementById('transferFromAccount').textContent = '選擇轉出帳戶';
                document.getElementById('transferFromAccount').style.color = 'var(--text-secondary)';
            }
            if(savedFormData.toAccountId) {
                const toAccount = accounts.find(acc => acc.id === savedFormData.toAccountId);
                if(toAccount) {
                    document.getElementById('transferToAccount').textContent = toAccount.name;
                    document.getElementById('transferToAccount').style.color = 'var(--text-primary)';
                } else {
                    document.getElementById('transferToAccount').textContent = '選擇轉入帳戶';
                    document.getElementById('transferToAccount').style.color = 'var(--text-secondary)';
                }
            } else {
                document.getElementById('transferToAccount').textContent = '選擇轉入帳戶';
                document.getElementById('transferToAccount').style.color = 'var(--text-secondary)';
            }
        } else {
            document.getElementById('transferAmount').value = '';
            const titleInput = document.getElementById('transferTitle');
            if(titleInput) {
                titleInput.value = '';
            }
            document.getElementById('transferFromAccount').textContent = '選擇轉出帳戶';
            document.getElementById('transferFromAccount').style.color = 'var(--text-secondary)';
            document.getElementById('transferToAccount').textContent = '選擇轉入帳戶';
            document.getElementById('transferToAccount').style.color = 'var(--text-secondary)';
        }
        
        // 更新分頁樣式
        const tabs = modal.querySelectorAll('.journal-form-tab');
        tabs.forEach(t => {
            t.classList.remove('active');
            t.style.background = 'var(--border-color)';
            t.style.color = 'var(--text-secondary)';
            t.style.border = 'none';
        });
        const transferTab = document.getElementById('journalFormTabTransfer');
        if(transferTab) {
            transferTab.classList.add('active');
            transferTab.style.background = 'var(--card-bg)';
            transferTab.style.color = '#0a84ff';
            transferTab.style.border = '2px solid #0a84ff';
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping');
        }
        modal.style.display = 'block';
        modal.style.background = 'transparent';
        // 重新顯示 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'flex';
        }
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateX(0)';
                }
            }, 10);
        });
    }
    
    function closeTransferModal() {
        const modal = document.getElementById('transferModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 立即隱藏 FAB 按鈕
        const fabButton = modal.querySelector('button[onclick*="openFixedTransferListFromJournal"]');
        if(fabButton) {
            fabButton.style.display = 'none';
        }
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateX(100%)';
            }, 400);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function updateTransferDateDisplay() {
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const dateStr = `${currentJournalDate.getFullYear()}年${currentJournalDate.getMonth() + 1}月${currentJournalDate.getDate()}日 ${weekdays[currentJournalDate.getDay()]}`;
        document.getElementById('transferDate').textContent = dateStr;
        document.getElementById('transferDateDisplay').textContent = dateStr;
        document.getElementById('transferDateDisplay').style.color = 'var(--text-primary)';
    }
    
    function openTransferDateSelector() {
        currentDatePickerType = 'transfer';
        openDateSelector('transfer');
    }
    
    // 從日記本模態框打開固定轉帳列表
    function openFixedTransferListFromJournal() {
        // 直接打開固定轉帳列表，不關閉當前模態框，讓過渡更順暢
        const modal = document.getElementById('fixedTransferListModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        
        // 渲染固定轉帳列表
        renderFixedTransferList();
        
        // 直接顯示固定轉帳列表，不關閉其他模態框
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.zIndex = '2010'; // 確保在最上層
        
        // 使用 requestAnimationFrame 確保動畫流暢
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            }, 10);
        });
    }
    
    // 類別選擇器
    function openCategorySelector(type) {
        const modal = document.getElementById('categorySelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = document.getElementById('categorySelectorTitle');
        const list = document.getElementById('categorySelectorList');
        
        if(title) {
            title.textContent = '選擇類別';
        }
        
        const categories = type === 'income' ? incomeCategories : expenseCategories;
        
        if(list) {
            list.innerHTML = '';
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.style.cssText = 'cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;';
                categoryItem.onclick = () => selectCategory(category, type);
                categoryItem.innerHTML = `
                    <div style="color: var(--text-primary); font-size: 16px;">${category}</div>
                `;
                list.appendChild(categoryItem);
            });
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            }, 10);
        });
    }
    
    function closeCategorySelector() {
        const modal = document.getElementById('categorySelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function selectCategory(category, type) {
        currentJournalCategory = category;
        if(type === 'income') {
            document.getElementById('incomeCategory').textContent = category;
            document.getElementById('incomeCategory').style.color = 'var(--text-primary)';
        } else if(type === 'expense') {
            document.getElementById('expenseCategory').textContent = category;
            document.getElementById('expenseCategory').style.color = 'var(--text-primary)';
        }
        closeCategorySelector();
    }
    
    // 記帳用的帳戶選擇器
    function openJournalAccountSelector(type) {
        // 先關閉可能打開的其他選擇器
        closeCategorySelector();
        
        currentAccountSelectorType = type;
        const modal = document.getElementById('accountSelectorModal');
        if(!modal) return;
        
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = document.getElementById('accountSelectorTitle');
        const list = document.getElementById('accountSelectorList');
        
        // 設置標題
        if(title) {
            if(type === 'income' || type === 'expense') {
                title.textContent = '選擇帳戶';
            } else if(type === 'transferFrom') {
                title.textContent = '選擇轉出帳戶';
            } else if(type === 'transferTo') {
                title.textContent = '選擇轉入帳戶';
            }
        }
        
        // 過濾出錢包和負債類型的帳戶
        const availableAccounts = accounts.filter(acc => acc.type === 'bank' || acc.type === 'debt');
        
        // 生成帳戶列表
        if(list) {
            list.innerHTML = '';
            if(availableAccounts.length === 0) {
                // 沒有帳戶時顯示「+」號按鈕
                const addAccountBtn = document.createElement('div');
                addAccountBtn.style.cssText = 'cursor: pointer; padding: 20px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px; text-align: center; border: 2px dashed var(--border-color);';
                addAccountBtn.onclick = () => {
                    // 記錄來源頁面類型
                    pendingJournalModalType = type;
                    
                    // 保存當前記帳頁面的表單數據
                    if(type === 'income') {
                        const incomeModal = document.getElementById('incomeModal');
                        if(incomeModal && incomeModal.style.display === 'block') {
                            pendingJournalFormData = {
                                type: 'income',
                                amount: document.getElementById('incomeAmount').value || '',
                                category: currentJournalCategory,
                                accountId: currentJournalAccountId,
                                date: currentJournalDate ? new Date(currentJournalDate) : null
                            };
                        }
                    } else if(type === 'expense') {
                        const expenseModal = document.getElementById('expenseModal');
                        if(expenseModal && expenseModal.style.display === 'block') {
                            pendingJournalFormData = {
                                type: 'expense',
                                amount: document.getElementById('expenseAmount').value || '',
                                category: currentJournalCategory,
                                accountId: currentJournalAccountId,
                                date: currentJournalDate ? new Date(currentJournalDate) : null
                            };
                        }
                    } else if(type === 'transferFrom' || type === 'transferTo') {
                        const transferModal = document.getElementById('transferModal');
                        if(transferModal && transferModal.style.display === 'block') {
                            pendingJournalFormData = {
                                type: 'transfer',
                                amount: document.getElementById('transferAmount').value || '',
                                fromAccountId: currentTransferFromAccountId,
                                toAccountId: currentTransferToAccountId,
                                date: currentJournalDate ? new Date(currentJournalDate) : null
                            };
                        }
                    }
                    
                    // 立即關閉帳戶選擇器
                    const selectorModal = document.getElementById('accountSelectorModal');
                    const selectorModalWrapper = selectorModal ? selectorModal.querySelector('.modal-content-wrapper') : null;
                    if(selectorModalWrapper) {
                        selectorModalWrapper.style.transform = 'translateY(100%)';
                    }
                    if(selectorModal) {
                        selectorModal.style.display = 'none';
                    }
                    currentAccountSelectorType = null;
                    
                    // 關閉可能打開的其他模態框
                    closeIncomeModal();
                    closeExpenseModal();
                    closeTransferModal();
                    closeFixedTransferModal();
                    
                    // 延遲一下確保模態框已關閉
                    setTimeout(() => {
                        // 設置為新增錢包帳戶
                        editingId = null;
                        editingFromDetail = false;
                        const typeSelect = document.getElementById('inpType');
                        if(typeSelect) {
                            typeSelect.value = 'bank';
                            handleTypeChange();
                        }
                        openModal();
                    }, 350);
                };
                addAccountBtn.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <i class="fas fa-plus" style="color: #0a84ff; font-size: 24px;"></i>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">新增帳戶</div>
                    </div>
                `;
                list.appendChild(addAccountBtn);
            } else {
                availableAccounts.forEach(acc => {
                    const accountItem = document.createElement('div');
                    accountItem.style.cssText = 'cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;';
                    accountItem.onclick = () => selectJournalAccount(acc, type);
                    
                    const iconClass = acc.type === 'bank' ? 'fa-university' : 'fa-credit-card';
                    const tagHTML = acc.type === 'bank' ? generateAccountTagHTML(acc) : '<span class="account-tag account-tag-debt">負債</span>';
                    
                    accountItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas ${iconClass}" style="color: var(--text-primary); font-size: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">${acc.name}</div>
                                <div style="margin-top: 4px;">${tagHTML}</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(accountItem);
                });
            }
        }
        
        // 確保模態框初始狀態正確
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        
        // 立即顯示模態框
        requestAnimationFrame(() => {
            if(modalWrapper) {
                modalWrapper.style.transform = 'translateY(0)';
            }
        });
    }
    
    function selectJournalAccount(account, type) {
        if(type === 'income') {
            currentJournalAccountId = account.id;
            document.getElementById('incomeAccount').textContent = account.name;
            document.getElementById('incomeAccount').style.color = 'var(--text-primary)';
        } else if(type === 'expense') {
            currentJournalAccountId = account.id;
            document.getElementById('expenseAccount').textContent = account.name;
            document.getElementById('expenseAccount').style.color = 'var(--text-primary)';
        } else if(type === 'transferFrom') {
            currentTransferFromAccountId = account.id;
            document.getElementById('transferFromAccount').textContent = account.name;
            document.getElementById('transferFromAccount').style.color = 'var(--text-primary)';
        } else if(type === 'transferTo') {
            currentTransferToAccountId = account.id;
            document.getElementById('transferToAccount').textContent = account.name;
            document.getElementById('transferToAccount').style.color = 'var(--text-primary)';
        }
        closeAccountSelector();
    }
    
    // 保存收入
    function saveIncome() {
        const amount = parseFloat(document.getElementById('incomeAmount').value);
        
        if(!amount || amount <= 0) {
            alert('請輸入有效的金額');
            return;
        }
        
        if(!currentJournalCategory) {
            alert('請選擇類別');
            return;
        }
        
        if(!currentJournalAccountId) {
            alert('請選擇帳戶');
            return;
        }
        
        const account = accounts.find(acc => acc.id === currentJournalAccountId);
        if(!account) {
            alert('找不到帳戶');
            return;
        }
        
        // 使用本地時間格式化日期，避免時區問題
        const year = currentJournalDate.getFullYear();
        const month = String(currentJournalDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentJournalDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        const records = loadJournalRecords();
        
        if(editingJournalRecordId) {
            // 編輯模式：更新現有記錄
            const oldRecord = records.find(r => r.id === editingJournalRecordId);
            if(oldRecord) {
                // 還原舊記錄對帳戶餘額的影響
                const oldAccount = accounts.find(acc => acc.id === oldRecord.accountId);
                if(oldAccount) {
                    oldAccount.balance -= oldRecord.amount;
                }
                
                // 更新記錄
                oldRecord.date = dateStr;
                oldRecord.amount = amount;
                oldRecord.category = currentJournalCategory;
                oldRecord.accountId = currentJournalAccountId;
                const titleInput = document.getElementById('incomeTitle');
                oldRecord.title = titleInput ? titleInput.value.trim() : '';
                const isAdvanceCheckbox = document.getElementById('incomeIsAdvance');
                oldRecord.isAdvance = isAdvanceCheckbox ? isAdvanceCheckbox.checked : false;
                oldRecord.updatedAt = new Date().toISOString();
            }
        } else {
            // 新增模式：創建新記錄
            const titleInput = document.getElementById('incomeTitle');
            const isAdvanceCheckbox = document.getElementById('incomeIsAdvance');
            const newRecord = {
                id: Date.now().toString(),
                type: 'income',
                date: dateStr,
                amount: amount,
                category: currentJournalCategory,
                accountId: currentJournalAccountId,
                title: titleInput ? titleInput.value.trim() : '',
                isAdvance: isAdvanceCheckbox ? isAdvanceCheckbox.checked : false,
                createdAt: new Date().toISOString()
            };
            records.push(newRecord);
        }
        
        // 應用新記錄對帳戶餘額的影響
        account.balance += amount;
        
        // 先保存到 localStorage
        clearJournalDatesCache();
        localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`, JSON.stringify(records));
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserId}`;
        localStorage.setItem(userDataKey, JSON.stringify(accounts));
        
        // 【關鍵修正】從 localStorage 重新讀取當前使用者的 accounts，確保資料正確
        const currentUserAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 一起同步 journal 和 accounts 到 Firestore（只更新 currentUserId）
        if (window.syncJournalAndAccountsToFirestore && window.firebaseUserLoggedIn) {
            window.syncJournalAndAccountsToFirestore(records, currentUserAccounts).catch(err => {
                console.error('[記帳同步] 同步失敗:', err);
            });
        }
        
        // 重置編輯ID
        editingJournalRecordId = null;
        
        // 重新渲染
        renderAssets();
        updateChartData();
        
        // 更新詳情顯示
        if(selectedDate) {
            const selectedDateStr = formatLocalDate(selectedDate);
            if(selectedDateStr === dateStr) {
                showFixedTransferDetailsForDate(selectedDate);
            }
        } else {
            // 如果沒有選中日期，選中今天並顯示詳情
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = today;
            renderCalendar();
            showFixedTransferDetailsForDate(today);
        }
        
        closeIncomeModal();
    }
    
    // 保存支出
    function saveExpense() {
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        
        if(!amount || amount <= 0) {
            alert('請輸入有效的金額');
            return;
        }
        
        if(!currentJournalCategory) {
            alert('請選擇類別');
            return;
        }
        
        if(!currentJournalAccountId) {
            alert('請選擇帳戶');
            return;
        }
        
        const account = accounts.find(acc => acc.id === currentJournalAccountId);
        if(!account) {
            alert('找不到帳戶');
            return;
        }
        
        // 使用本地時間格式化日期，避免時區問題
        const year = currentJournalDate.getFullYear();
        const month = String(currentJournalDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentJournalDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        const records = loadJournalRecords();
        
        if(editingJournalRecordId) {
            // 編輯模式：更新現有記錄
            const oldRecord = records.find(r => r.id === editingJournalRecordId);
            if(oldRecord) {
                // 還原舊記錄對帳戶餘額的影響
                const oldAccount = accounts.find(acc => acc.id === oldRecord.accountId);
                if(oldAccount) {
                    // 正常恢復舊記錄的金額
                    oldAccount.balance += oldRecord.amount;
                }
                
                // 更新記錄
                oldRecord.date = dateStr;
                oldRecord.amount = amount;
                oldRecord.category = currentJournalCategory;
                oldRecord.accountId = currentJournalAccountId;
                const isAdvanceCheckbox = document.getElementById('expenseIsAdvance');
                oldRecord.isAdvance = isAdvanceCheckbox ? isAdvanceCheckbox.checked : false;
                const titleInput = document.getElementById('expenseTitle');
                oldRecord.title = titleInput ? titleInput.value.trim() : '';
                oldRecord.updatedAt = new Date().toISOString();
            }
        } else {
            // 新增模式：創建新記錄（新增的記錄可以正常修改和刪除，因為創建時間在固定轉帳之後）
            const isAdvanceCheckbox = document.getElementById('expenseIsAdvance');
            const titleInput = document.getElementById('expenseTitle');
            const newRecord = {
                id: Date.now().toString(),
                type: 'expense',
                date: dateStr,
                amount: amount,
                category: currentJournalCategory,
                accountId: currentJournalAccountId,
                isAdvance: isAdvanceCheckbox ? isAdvanceCheckbox.checked : false,
                title: titleInput ? titleInput.value.trim() : '',
                createdAt: new Date().toISOString()
            };
            records.push(newRecord);
        }
        
        // 應用新記錄對帳戶餘額的影響
        // 正常更新餘額
        account.balance -= amount;
        
        // 先保存到 localStorage
        clearJournalDatesCache();
        localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`, JSON.stringify(records));
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserId}`;
        localStorage.setItem(userDataKey, JSON.stringify(accounts));
        
        // 【關鍵修正】從 localStorage 重新讀取當前使用者的 accounts，確保資料正確
        const currentUserAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 一起同步 journal 和 accounts 到 Firestore（只更新 currentUserId）
        if (window.syncJournalAndAccountsToFirestore && window.firebaseUserLoggedIn) {
            window.syncJournalAndAccountsToFirestore(records, currentUserAccounts).catch(err => {
                console.error('[記帳同步] 同步失敗:', err);
            });
        }
        
        // 重置編輯ID
        editingJournalRecordId = null;
        
        // 重新渲染
        renderAssets();
        updateChartData();
        
        // 更新詳情顯示
        if(selectedDate) {
            const selectedDateStr = formatLocalDate(selectedDate);
            if(selectedDateStr === dateStr) {
                showFixedTransferDetailsForDate(selectedDate);
            }
        } else {
            // 如果沒有選中日期，選中今天並顯示詳情
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = today;
            renderCalendar();
            showFixedTransferDetailsForDate(today);
        }
        
        closeExpenseModal();
    }
    
    // 保存轉帳
    function saveTransfer() {
        const amount = parseFloat(document.getElementById('transferAmount').value);
        
        if(!amount || amount <= 0) {
            alert('請輸入有效的金額');
            return;
        }
        
        if(!currentTransferFromAccountId) {
            alert('請選擇轉出帳戶');
            return;
        }
        
        if(!currentTransferToAccountId) {
            alert('請選擇轉入帳戶');
            return;
        }
        
        if(currentTransferFromAccountId === currentTransferToAccountId) {
            alert('轉出帳戶和轉入帳戶不能相同');
            return;
        }
        
        const fromAccount = accounts.find(acc => acc.id === currentTransferFromAccountId);
        const toAccount = accounts.find(acc => acc.id === currentTransferToAccountId);
        
        if(!fromAccount || !toAccount) {
            alert('找不到帳戶');
            return;
        }
        
        // 使用本地時間格式化日期，避免時區問題
        const year = currentJournalDate.getFullYear();
        const month = String(currentJournalDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentJournalDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        const records = loadJournalRecords();
        
        if(editingJournalRecordId) {
            // 編輯模式：更新現有記錄
            const oldRecord = records.find(r => r.id === editingJournalRecordId);
            if(oldRecord) {
                // 還原舊記錄對帳戶餘額的影響
                const oldFromAccount = accounts.find(acc => acc.id === oldRecord.fromAccountId);
                const oldToAccount = accounts.find(acc => acc.id === oldRecord.toAccountId);
                if(oldFromAccount && oldToAccount) {
                    oldFromAccount.balance += oldRecord.amount;
                    oldToAccount.balance -= oldRecord.amount;
                }
                
                // 更新記錄
                oldRecord.date = dateStr;
                oldRecord.amount = amount;
                oldRecord.fromAccountId = currentTransferFromAccountId;
                oldRecord.toAccountId = currentTransferToAccountId;
                const titleInput = document.getElementById('transferTitle');
                oldRecord.title = titleInput ? titleInput.value.trim() : '';
                oldRecord.updatedAt = new Date().toISOString();
            }
        } else {
            // 新增模式：創建新記錄
            const titleInput = document.getElementById('transferTitle');
            const newRecord = {
                id: Date.now().toString(),
                type: 'transfer',
                date: dateStr,
                amount: amount,
                fromAccountId: currentTransferFromAccountId,
                toAccountId: currentTransferToAccountId,
                title: titleInput ? titleInput.value.trim() : '',
                createdAt: new Date().toISOString()
            };
            records.push(newRecord);
        }
        
        // 應用新記錄對帳戶餘額的影響
        fromAccount.balance -= amount;
        toAccount.balance += amount;
        
        // 先保存到 localStorage
        clearJournalDatesCache();
        localStorage.setItem(`${STORAGE_KEY_JOURNAL}_${currentUserId}`, JSON.stringify(records));
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserId}`;
        localStorage.setItem(userDataKey, JSON.stringify(accounts));
        
        // 【關鍵修正】從 localStorage 重新讀取當前使用者的 accounts，確保資料正確
        const currentUserAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 一起同步 journal 和 accounts 到 Firestore（只更新 currentUserId）
        if (window.syncJournalAndAccountsToFirestore && window.firebaseUserLoggedIn) {
            window.syncJournalAndAccountsToFirestore(records, currentUserAccounts).catch(err => {
                console.error('[記帳同步] 同步失敗:', err);
            });
        }
        
        // 重置編輯ID
        editingJournalRecordId = null;
        
        // 重新渲染
        renderAssets();
        updateChartData();
        
        // 更新詳情顯示
        if(selectedDate) {
            const selectedDateStr = formatLocalDate(selectedDate);
            if(selectedDateStr === dateStr) {
                showFixedTransferDetailsForDate(selectedDate);
            }
        } else {
            // 如果沒有選中日期，選中今天並顯示詳情
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = today;
            renderCalendar();
            showFixedTransferDetailsForDate(today);
        }
        
        closeTransferModal();
    }
    
    // Calendar Settings Functions (保留用於固定轉帳)
    function openCalendarSettingsModal() {
        const modal = document.getElementById('calendarSettingsModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        
        // 渲染固定轉帳列表
        renderFixedTransferList();
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
        }
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            }, 10);
        });
    }
    
    // 計算固定轉帳的顯示金額（現在只使用固定金額，不再自動計算）
    function getFixedTransferDisplayAmount(transfer, targetDate = null) {
            return transfer.amount || 0;
    }
    
    function renderFixedTransferList() {
        const container = document.getElementById('fixedTransferListContainer');
        if(!container) return;
        
        const transfers = loadFixedTransfers();
        container.innerHTML = '';
        
        if(transfers.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 14px;">尚無固定轉帳</div>';
            return;
        }
        
        transfers.forEach(transfer => {
            const displayAmount = getFixedTransferDisplayAmount(transfer);
            const item = document.createElement('div');
            item.style.cssText = 'padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;';
            item.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="editFixedTransfer('${transfer.id}')">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background: ${transfer.tagColor};"></div>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">${transfer.title}</div>
                </div>
                <button onclick="event.stopPropagation(); deleteFixedTransfer('${transfer.id}')" style="padding: 8px 12px; background: var(--color-down); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">刪除</button>
            `;
            container.appendChild(item);
        });
    }
    
    function deleteFixedTransfer(id) {
        if(!confirm('確定要刪除這個固定轉帳嗎？')) return;
        
        const transfers = loadFixedTransfers();
        const transfer = transfers.find(t => t.id === id);
        
        // 檢查是否涉及信用卡且信用卡已被歸零
        if(transfer) {
            const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
            if(toAccount && toAccount.bankTag === '信用卡' && toAccount.isZeroedByFixedTransfer) {
                console.log('刪除固定轉帳 - 信用卡已被固定轉帳歸零，不恢復金額:', toAccount.name);
                // 不恢復金額，直接刪除固定轉帳
            } else if(transfer.useAccountBalance) {
                // 如果使用帳戶全部金額，需要恢復帳戶餘額
                const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
                const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
                
                if(fromAccount && toAccount) {
                    // 計算需要恢復的金額
                    let restoreAmount = 0;
                    if(transfer.creditCardInitialAmount !== undefined && transfer.creditCardInitialAmount !== null) {
                        // 如果涉及信用卡，使用記錄的初始金額
                        restoreAmount = transfer.creditCardInitialAmount;
                    } else if(transfer.initialAmount !== undefined && transfer.initialAmount !== null) {
                        // 使用記錄的初始金額
                        restoreAmount = transfer.initialAmount;
                    } else {
                        // 如果沒有記錄，使用當前轉入帳戶的餘額（取絕對值）
                        restoreAmount = Math.abs(toAccount.balance);
                    }
                    
                    // 恢復帳戶餘額
                    fromAccount.balance += restoreAmount;
                    toAccount.balance -= restoreAmount;
                    console.log('刪除固定轉帳 - 恢復金額:', restoreAmount, '從', fromAccount.name, '到', toAccount.name);
                }
            } else {
                // 使用固定金額，恢復帳戶餘額
                const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
                const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
                
                if(fromAccount && toAccount) {
                    const amount = transfer.amount || 0;
                    fromAccount.balance += amount;
                    toAccount.balance -= amount;
                    console.log('刪除固定轉帳 - 恢復金額:', amount, '從', fromAccount.name, '到', toAccount.name);
                }
            }
            
            // 保存資料
            saveData();
        }
        
        const filtered = transfers.filter(t => t.id !== id);
        saveFixedTransfers(filtered);
        
        // 注意：即使刪除固定轉帳，之前的支出記錄仍然不能影響信用卡餘額（通過時間戳判斷）
        
        // 重新渲染列表和日曆
        renderFixedTransferList();
        renderCalendar();
        renderAssets();
        updateChartData();
        
        // 更新日期支出資訊（如果當前有選中日期）
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        }
        
        // 如果列表模態框是打開的，確保列表已更新
        const listModal = document.getElementById('fixedTransferListModal');
        if(listModal && listModal.style.display === 'block') {
            renderFixedTransferList();
        }
    }
    
    function closeCalendarSettingsModal() {
        const modal = document.getElementById('calendarSettingsModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function openFixedTransferList() {
        closeCalendarSettingsModal();
        setTimeout(() => {
            const modal = document.getElementById('fixedTransferListModal');
            const modalWrapper = modal.querySelector('.modal-content-wrapper');
            
            // 渲染固定轉帳列表
            renderFixedTransferList();
            
            // 更新分頁樣式
            const tabs = modal.querySelectorAll('.journal-form-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.background = 'var(--border-color)';
                t.style.color = 'var(--text-secondary)';
                t.style.border = 'none';
            });
            const fixedTab = document.getElementById('journalFormTabFixed'); // 注意：这里的ID需要在HTML中对应修改，或者使用querySelector
            // 實際上 fixedTransferListModal 內的 ID 會重複，這裡需要使用 querySelector
            // 更好的做法是给 fixedTransferListModal 內的 tab 唯一的 ID 或者使用 class 選擇器
            const modalTabs = modal.querySelectorAll('.journal-form-tab');
            modalTabs.forEach(t => {
                if(t.textContent.trim() === '固定轉帳') {
                    t.classList.add('active');
                    t.style.background = 'var(--card-bg)';
                    t.style.color = '#ffd60a';
                    t.style.border = '2px solid #ffd60a';
                }
            });
            
            if(modalWrapper) {
                modalWrapper.style.transform = 'translateY(100%)';
            }
            modal.style.display = 'block';
            modal.style.background = 'rgba(0,0,0,0.5)';
            requestAnimationFrame(() => {
                setTimeout(() => {
                    if(modalWrapper) {
                        modalWrapper.style.transform = 'translateY(0)';
                    }
                }, 10);
            });
        }, 300);
    }
    
    function closeFixedTransferListModal() {
        const modal = document.getElementById('fixedTransferListModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    // 新增固定轉帳（從列表頁面的+按鈕）
    function addNewFixedTransfer() {
        // 直接打開固定轉帳表單，不關閉列表（讓表單覆蓋在列表上）
        const listModal = document.getElementById('fixedTransferListModal');
        if(listModal && listModal.style.display === 'block') {
            listModal.setAttribute('data-was-open', 'true');
        }
        // 立即打開固定轉帳表單，不延遲
        openFixedTransferModal();
    }
    
    // 當前編輯的固定轉帳ID（null表示新增模式）
    let editingFixedTransferId = null;
    
    // Fixed Transfer Functions
    function openFixedTransferModal(transferId = null) {
        const modal = document.getElementById('fixedTransferModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        
        editingFixedTransferId = transferId;
        
        // 初始化數據
        fixedTransferData = {
            repeat: 'monthly',
            byPeriod: false,
            startDate: null,
            endDate: null,
            holidayAdjust: 'none',
            tagColor: null,
            useAccountBalance: false,
            useFromAccount: true
        };
        
        // 重置表單
        const useAccountBalanceCheckbox = document.getElementById('fixedTransferUseAccountBalance');
        if(useAccountBalanceCheckbox) {
            useAccountBalanceCheckbox.checked = false;
        }
        updateFixedTransferAmountMode();
        
        // 如果是編輯模式，載入現有數據
        if(transferId) {
            const transfers = loadFixedTransfers();
            const transfer = transfers.find(t => t.id === transferId);
            if(transfer) {
                // 載入現有數據
                document.getElementById('fixedTransferTitle').value = transfer.title;
                document.getElementById('fixedTransferAmount').value = transfer.amount;
                
                // 載入帳戶信息
                const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
                const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
                if(fromAccount) {
                    document.getElementById('fixedTransferFromAccount').textContent = fromAccount.name;
                    document.getElementById('fixedTransferFromAccount').style.color = 'var(--text-primary)';
                    window.fixedTransferFromAccountId = transfer.fromAccountId;
                }
                if(toAccount) {
                    document.getElementById('fixedTransferToAccount').textContent = toAccount.name;
                    document.getElementById('fixedTransferToAccount').style.color = 'var(--text-primary)';
                    window.fixedTransferToAccountId = transfer.toAccountId;
                }
                
                // 載入重複設定
                fixedTransferData.repeat = transfer.repeat;
                const repeatNames = {
                    'daily': '每日',
                    'weekly': '每星期',
                    'monthly': '每月',
                    'yearly': '每年'
                };
                document.getElementById('fixedTransferRepeat').textContent = repeatNames[transfer.repeat] || '每月';
                
                // 載入按期數設定
                fixedTransferData.byPeriod = transfer.byPeriod || false;
                document.getElementById('fixedTransferByPeriod').checked = fixedTransferData.byPeriod;
                
                // 載入使用帳戶全部金額設定
                fixedTransferData.useAccountBalance = transfer.useAccountBalance || false;
                fixedTransferData.useFromAccount = transfer.useFromAccount !== undefined ? transfer.useFromAccount : true;
                const useAccountBalanceCheckbox = document.getElementById('fixedTransferUseAccountBalance');
                if(useAccountBalanceCheckbox) {
                    useAccountBalanceCheckbox.checked = fixedTransferData.useAccountBalance;
                }
                updateFixedTransferAmountMode();
                
                // 載入日期
                fixedTransferData.startDate = new Date(transfer.startDate);
                fixedTransferData.endDate = transfer.endDate ? new Date(transfer.endDate) : null;
                
                const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const startDateStr = `${fixedTransferData.startDate.getFullYear()}年${fixedTransferData.startDate.getMonth() + 1}月${fixedTransferData.startDate.getDate()}日 ${weekdays[fixedTransferData.startDate.getDay()]}`;
                document.getElementById('fixedTransferStartDate').textContent = startDateStr;
                document.getElementById('fixedTransferStartDate').style.color = 'var(--text-primary)';
                
                if(fixedTransferData.endDate) {
                    const endDateStr = `${fixedTransferData.endDate.getFullYear()}年${fixedTransferData.endDate.getMonth() + 1}月${fixedTransferData.endDate.getDate()}日 ${weekdays[fixedTransferData.endDate.getDay()]}`;
                    document.getElementById('fixedTransferEndDate').textContent = endDateStr;
                } else {
                    document.getElementById('fixedTransferEndDate').textContent = '永不結束';
                }
                document.getElementById('fixedTransferEndDate').style.color = 'var(--text-primary)';
                
                // 載入假日調整
                fixedTransferData.holidayAdjust = transfer.holidayAdjust || 'none';
                const adjustNames = {
                    'none': '不調整',
                    'advance': '提前',
                    'delay': '延後'
                };
                document.getElementById('fixedTransferHolidayAdjust').textContent = adjustNames[fixedTransferData.holidayAdjust] || '不調整';
                
                // 載入標籤顏色
                fixedTransferData.tagColor = transfer.tagColor;
                if(transfer.tagColor) {
                    document.getElementById('fixedTransferTagColor').textContent = '已選擇';
                    document.getElementById('fixedTransferTagColor').style.color = transfer.tagColor;
                    document.getElementById('fixedTransferTagIcon').style.color = transfer.tagColor;
                }
                
                
                updatePeriodCount();
            }
        } else {
            // 新增模式：設置默認開始日期為今天
            const today = new Date();
            fixedTransferData.startDate = today;
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const startDateStr = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日 ${weekdays[today.getDay()]}`;
            const startDateElement = document.getElementById('fixedTransferStartDate');
            if(startDateElement) {
                startDateElement.textContent = startDateStr;
                startDateElement.style.color = 'var(--text-primary)';
            }
            
            // 重置其他欄位
            document.getElementById('fixedTransferTitle').value = '';
            document.getElementById('fixedTransferAmount').value = '';
            document.getElementById('fixedTransferFromAccount').textContent = '從帳戶';
            document.getElementById('fixedTransferFromAccount').style.color = 'var(--text-secondary)';
            document.getElementById('fixedTransferToAccount').textContent = '到帳戶';
            document.getElementById('fixedTransferToAccount').style.color = 'var(--text-secondary)';
            document.getElementById('fixedTransferRepeat').textContent = '每月';
            document.getElementById('fixedTransferByPeriod').checked = false;
            document.getElementById('fixedTransferEndDate').textContent = '永不結束';
            document.getElementById('fixedTransferEndDate').style.color = 'var(--text-primary)';
            document.getElementById('fixedTransferHolidayAdjust').textContent = '不調整';
            document.getElementById('fixedTransferPeriodCount').textContent = '';
            document.getElementById('fixedTransferTagColor').textContent = '選擇顏色';
            document.getElementById('fixedTransferTagColor').style.color = 'var(--text-secondary)';
            document.getElementById('fixedTransferTagIcon').style.color = 'var(--text-secondary)';
            fixedTransferData.tagColor = null;
            window.fixedTransferFromAccountId = null;
            window.fixedTransferToAccountId = null;
            
        }
        
        updateNextDates();
        
        // 更新分頁樣式
        const tabs = modal.querySelectorAll('.journal-form-tab');
        tabs.forEach(t => {
            t.classList.remove('active');
            t.style.background = 'var(--border-color)';
            t.style.color = 'var(--text-secondary)';
            t.style.border = 'none';
        });
        const fixedTab = document.getElementById('journalFormTabFixed');
        if(fixedTab) {
            fixedTab.classList.add('active');
            fixedTab.style.background = 'var(--card-bg)';
            fixedTab.style.color = 'var(--text-primary)';
            fixedTab.style.border = '2px solid var(--text-primary)';
        }
        
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping');
        }
        modal.style.display = 'block';
        modal.style.background = 'transparent';
        modal.style.zIndex = '2010'; // 確保表單顯示在列表之上
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateX(0)';
                }
            }, 10);
        });
    }
    
    // 編輯固定轉帳
    function editFixedTransfer(id) {
        const listModal = document.getElementById('fixedTransferListModal');
        if(listModal && listModal.style.display === 'block') {
            listModal.setAttribute('data-was-open', 'true');
        }
        closeFixedTransferListModal();
        setTimeout(() => {
            openFixedTransferModal(id);
        }, 300);
    }
    
    // 顯示固定轉帳詳細資料（只讀模式）
    function showFixedTransferDetail(transferId) {
        const modal = document.getElementById('fixedTransferModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        
        const transfers = loadFixedTransfers();
        const transfer = transfers.find(t => t.id === transferId);
        if(!transfer) return;
        
        // 設置為只讀模式
        const saveBtn = modal.querySelector('.modal-header .btn-icon[onclick="saveFixedTransfer()"]');
        if(saveBtn) {
            saveBtn.style.display = 'none';
        }
        
        // 禁用所有輸入欄位
        const titleInput = document.getElementById('fixedTransferTitle');
        const amountInput = document.getElementById('fixedTransferAmount');
        const useAccountBalanceCheckbox = document.getElementById('fixedTransferUseAccountBalance');
        const byPeriodCheckbox = document.getElementById('fixedTransferByPeriod');
        
        if(titleInput) {
            titleInput.disabled = true;
            titleInput.value = transfer.title;
        }
        if(amountInput) {
            amountInput.disabled = true;
            amountInput.value = transfer.amount;
        }
        if(useAccountBalanceCheckbox) {
            useAccountBalanceCheckbox.disabled = true;
            useAccountBalanceCheckbox.checked = transfer.useAccountBalance || false;
            updateFixedTransferAmountMode();
        }
        if(byPeriodCheckbox) {
            byPeriodCheckbox.disabled = true;
            byPeriodCheckbox.checked = transfer.byPeriod || false;
        }
        
        // 禁用所有可點擊的欄位
        const clickableRows = modal.querySelectorAll('.form-row[style*="cursor: pointer"]');
        clickableRows.forEach(row => {
            row.style.pointerEvents = 'none';
            row.style.opacity = '0.7';
        });
        
        // 載入帳戶信息
        const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
        const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
        if(fromAccount) {
            document.getElementById('fixedTransferFromAccount').textContent = fromAccount.name;
            document.getElementById('fixedTransferFromAccount').style.color = 'var(--text-primary)';
        }
        if(toAccount) {
            document.getElementById('fixedTransferToAccount').textContent = toAccount.name;
            document.getElementById('fixedTransferToAccount').style.color = 'var(--text-primary)';
        }
        
        // 載入重複設定
        const repeatNames = {
            'daily': '每天',
            'weekly': '每週',
            'monthly': '每月',
            'yearly': '每年'
        };
        document.getElementById('fixedTransferRepeat').textContent = repeatNames[transfer.repeat] || '每月';
        
        // 載入日期設定
        if(transfer.startDate) {
            const startDate = new Date(transfer.startDate);
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const startDateStr = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月${startDate.getDate()}日 ${weekdays[startDate.getDay()]}`;
            document.getElementById('fixedTransferStartDate').textContent = startDateStr;
            document.getElementById('fixedTransferStartDate').style.color = 'var(--text-primary)';
        }
        
        if(transfer.endDate) {
            const endDate = new Date(transfer.endDate);
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const endDateStr = `${endDate.getFullYear()}年${endDate.getMonth() + 1}月${endDate.getDate()}日 ${weekdays[endDate.getDay()]}`;
            document.getElementById('fixedTransferEndDate').textContent = endDateStr;
            document.getElementById('fixedTransferEndDate').style.color = 'var(--text-primary)';
        } else {
            document.getElementById('fixedTransferEndDate').textContent = '永不結束';
            document.getElementById('fixedTransferEndDate').style.color = 'var(--text-primary)';
        }
        
        // 載入假日調整
        const holidayAdjustNames = {
            'none': '不調整',
            'before': '提前到前一個工作日',
            'after': '延後到下一個工作日'
        };
        document.getElementById('fixedTransferHolidayAdjust').textContent = holidayAdjustNames[transfer.holidayAdjust] || '不調整';
        
        // 載入標籤顏色
        if(transfer.tagColor) {
            document.getElementById('fixedTransferTagIcon').style.color = transfer.tagColor;
            document.getElementById('fixedTransferTagColor').textContent = '已選擇';
            document.getElementById('fixedTransferTagColor').style.color = transfer.tagColor;
        }
        
        // 更新週期入帳日程
        updateNextDatesForTransfer(transfer);
        
        // 顯示模態框
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            modalWrapper.classList.remove('swiping');
        }
        modal.style.display = 'block';
        modal.style.background = 'transparent';
        requestAnimationFrame(() => {
            setTimeout(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateX(0)';
                }
            }, 10);
        });
    }
    
    // 更新週期入帳日程（用於只讀模式）
    function updateNextDatesForTransfer(transfer) {
        if(!transfer.startDate) return;
        
        const startDate = new Date(transfer.startDate);
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        
        // 計算下回日期
        let nextDate = new Date(startDate);
        if(transfer.repeat === 'daily') {
            nextDate.setDate(nextDate.getDate() + 1);
        } else if(transfer.repeat === 'weekly') {
            nextDate.setDate(nextDate.getDate() + 7);
        } else if(transfer.repeat === 'monthly') {
            nextDate.setMonth(nextDate.getMonth() + 1);
        } else if(transfer.repeat === 'yearly') {
            nextDate.setFullYear(nextDate.getFullYear() + 1);
        }
        
        const nextDateStr = `${nextDate.getFullYear()}年${nextDate.getMonth() + 1}月${nextDate.getDate()}日 ${weekdays[nextDate.getDay()]}`;
        document.getElementById('fixedTransferNextDate').textContent = `:${nextDateStr}`;
        
        // 計算下下回日期
        let nextNextDate = new Date(nextDate);
        if(transfer.repeat === 'daily') {
            nextNextDate.setDate(nextNextDate.getDate() + 1);
        } else if(transfer.repeat === 'weekly') {
            nextNextDate.setDate(nextNextDate.getDate() + 7);
        } else if(transfer.repeat === 'monthly') {
            nextNextDate.setMonth(nextNextDate.getMonth() + 1);
        } else if(transfer.repeat === 'yearly') {
            nextNextDate.setFullYear(nextNextDate.getFullYear() + 1);
        }
        
        const nextNextDateStr = `${nextNextDate.getFullYear()}年${nextNextDate.getMonth() + 1}月${nextNextDate.getDate()}日 ${weekdays[nextNextDate.getDay()]}`;
        document.getElementById('fixedTransferNextNextDate').textContent = `:${nextNextDateStr}`;
    }
    
    function closeFixedTransferModal() {
        // 恢復所有欄位為可編輯狀態
        const titleInput = document.getElementById('fixedTransferTitle');
        const amountInput = document.getElementById('fixedTransferAmount');
        const useAccountBalanceCheckbox = document.getElementById('fixedTransferUseAccountBalance');
        const byPeriodCheckbox = document.getElementById('fixedTransferByPeriod');
        
        if(titleInput) titleInput.disabled = false;
        if(amountInput) amountInput.disabled = false;
        if(useAccountBalanceCheckbox) useAccountBalanceCheckbox.disabled = false;
        if(byPeriodCheckbox) byPeriodCheckbox.disabled = false;
        
        // 恢復所有可點擊的欄位
        const fixedTransferModal = document.getElementById('fixedTransferModal');
        const clickableRows = fixedTransferModal.querySelectorAll('.form-row[style*="cursor: pointer"]');
        clickableRows.forEach(row => {
            row.style.pointerEvents = '';
            row.style.opacity = '';
        });
        
        // 恢復儲存按鈕
        const saveBtn = fixedTransferModal.querySelector('.modal-header .btn-icon[onclick="saveFixedTransfer()"]');
        if(saveBtn) {
            saveBtn.style.display = '';
        }
        const modal = document.getElementById('fixedTransferModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateX(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateX(100%)';
                editingFixedTransferId = null; // 重置編輯狀態
                
                // 移除重新打開列表的邏輯，關閉後不再顯示固定轉帳列表
                const listModal = document.getElementById('fixedTransferListModal');
                if(listModal) {
                    listModal.removeAttribute('data-was-open');
                    // 只更新列表數據，不打開列表模態框
                    renderFixedTransferList();
                }
            }, 400);
        } else {
            modal.style.display = 'none';
            editingFixedTransferId = null; // 重置編輯狀態
            
            // 如果列表模態框之前是打開的，重新打開它
            const listModal = document.getElementById('fixedTransferListModal');
            if(listModal && listModal.getAttribute('data-was-open') === 'true') {
                listModal.removeAttribute('data-was-open');
                openFixedTransferList();
            }
        }
    }
    
    function saveFixedTransfer() {
        // 驗證必填欄位
        const title = document.getElementById('fixedTransferTitle').value.trim();
        const amount = parseFloat(document.getElementById('fixedTransferAmount').value);
        const fromAccountId = window.fixedTransferFromAccountId;
        const toAccountId = window.fixedTransferToAccountId;
        
        if(!title) {
            alert('請輸入標題');
            return;
        }
        
        // 如果使用帳戶全部金額，不需要驗證金額
        if(!fixedTransferData.useAccountBalance) {
            if(!amount || amount <= 0) {
                alert('請輸入有效的金額');
                return;
            }
        }
        
        if(!fromAccountId || !toAccountId) {
            alert('請選擇從帳戶和到帳戶');
            return;
        }
        
        if(!fixedTransferData.startDate) {
            alert('請選擇開始日期');
            return;
        }
        
        if(fixedTransferData.byPeriod && !fixedTransferData.endDate) {
            alert('按期數模式需要選擇結束日期');
            return;
        }
        
        if(!fixedTransferData.tagColor) {
            alert('請選擇標籤顏色');
            return;
        }
        
        // 載入現有列表
        const transfers = loadFixedTransfers();
        
        // 檢查是否涉及信用卡，如果是，記錄信用卡的初始絕對值金額
        const toAccount = accounts.find(acc => acc.id === toAccountId);
        const isCreditCardTransfer = toAccount && toAccount.bankTag === '信用卡';
        let creditCardInitialAmount = null;
        
        if(isCreditCardTransfer && fixedTransferData.useAccountBalance) {
            // 如果轉入帳戶是信用卡且使用帳戶全部金額，記錄信用卡的初始絕對值金額
            creditCardInitialAmount = Math.abs(toAccount.balance);
        }
        
        // 創建或更新固定轉帳對象
        let fixedTransfer;
        if(editingFixedTransferId) {
            // 編輯模式：找到現有項目並更新
            const existingIndex = transfers.findIndex(t => t.id === editingFixedTransferId);
            if(existingIndex >= 0) {
                const existing = transfers[existingIndex];
                fixedTransfer = {
                    ...existing, // 保留原有屬性（如執行記錄、initialAmount）
                    title: title,
                    amount: fixedTransferData.useAccountBalance ? 0 : amount, // 如果使用帳戶全部金額，金額設為0（執行時會計算）
                    fromAccountId: fromAccountId,
                    toAccountId: toAccountId,
                    repeat: fixedTransferData.repeat,
                    byPeriod: fixedTransferData.byPeriod,
                    startDate: fixedTransferData.startDate.toISOString(),
                    endDate: fixedTransferData.endDate ? fixedTransferData.endDate.toISOString() : null,
                    holidayAdjust: fixedTransferData.holidayAdjust,
                    tagColor: fixedTransferData.tagColor,
                    useAccountBalance: fixedTransferData.useAccountBalance,
                    useFromAccount: fixedTransferData.useFromAccount
                };
                // 如果涉及信用卡且使用帳戶全部金額，記錄信用卡的初始絕對值金額
                if(isCreditCardTransfer && fixedTransferData.useAccountBalance && creditCardInitialAmount !== null) {
                    // 如果是新增模式或編輯模式但還沒有記錄過，記錄初始金額
                    if(!fixedTransfer.creditCardInitialAmount) {
                        fixedTransfer.creditCardInitialAmount = creditCardInitialAmount;
                    }
                }
                transfers[existingIndex] = fixedTransfer;
            } else {
                alert('找不到要編輯的固定轉帳');
                return;
            }
        } else {
            // 新增模式：檢查是否已存在相同標題的固定轉帳
            const existing = transfers.find(t => t.title === title);
            if(existing) {
                // 如果已存在，切換到編輯模式
                if(confirm(`已存在標題為「${title}」的固定轉帳，是否要編輯它？`)) {
                    editingFixedTransferId = existing.id;
                    closeFixedTransferModal();
                    setTimeout(() => {
                        openFixedTransferModal(existing.id);
                    }, 300);
                    return;
                } else {
                    return;
                }
            }
            
            // 創建新的固定轉帳
            fixedTransfer = {
                id: Date.now().toString(),
                title: title,
                amount: fixedTransferData.useAccountBalance ? 0 : amount, // 如果使用帳戶全部金額，金額設為0（執行時會計算）
                useAccountBalance: fixedTransferData.useAccountBalance,
                useFromAccount: fixedTransferData.useFromAccount,
                fromAccountId: fromAccountId,
                toAccountId: toAccountId,
                repeat: fixedTransferData.repeat,
                byPeriod: fixedTransferData.byPeriod,
                startDate: fixedTransferData.startDate.toISOString(),
                endDate: fixedTransferData.endDate ? fixedTransferData.endDate.toISOString() : null,
                holidayAdjust: fixedTransferData.holidayAdjust,
                tagColor: fixedTransferData.tagColor,
                creditCardInitialAmount: creditCardInitialAmount, // 如果涉及信用卡，記錄初始絕對值金額
                createdAt: new Date().toISOString(),
                lastExecutedDate: null,
                executedDates: []
            };
            transfers.push(fixedTransfer);
        }
        
        saveFixedTransfers(transfers);
        
        // 重新渲染列表和日曆
        renderFixedTransferList();
        renderCalendar();
        
        // 更新資產列表
        renderAssets();
        
        // 更新日期支出資訊（如果當前有選中日期）
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        }
        
        editingFixedTransferId = null;
        closeFixedTransferModal();
        
        // 如果列表模態框是打開的，重新渲染列表
        const listModal = document.getElementById('fixedTransferListModal');
        if(listModal && listModal.style.display === 'block') {
            renderFixedTransferList();
        }
    }
    
    // 從測試項目轉換為固定轉帳（如果已存在就編輯，不存在就新增）
    function convertToFixedTransfer(title, amount, fromAccountId, toAccountId) {
        const transfers = loadFixedTransfers();
        const existing = transfers.find(t => t.title === title);
        
        if(existing) {
            // 如果已存在，打開編輯模式
            editFixedTransfer(existing.id);
        } else {
            // 如果不存在，打開新增模式並預填資料
            openFixedTransferModal();
            
            // 預填資料
            setTimeout(() => {
                document.getElementById('fixedTransferTitle').value = title;
                document.getElementById('fixedTransferAmount').value = amount;
                
                const fromAccount = accounts.find(acc => acc.id === fromAccountId);
                const toAccount = accounts.find(acc => acc.id === toAccountId);
                
                if(fromAccount) {
                    document.getElementById('fixedTransferFromAccount').textContent = fromAccount.name;
                    document.getElementById('fixedTransferFromAccount').style.color = 'var(--text-primary)';
                    window.fixedTransferFromAccountId = fromAccountId;
                }
                
                if(toAccount) {
                    document.getElementById('fixedTransferToAccount').textContent = toAccount.name;
                    document.getElementById('fixedTransferToAccount').style.color = 'var(--text-primary)';
                    window.fixedTransferToAccountId = toAccountId;
                }
            }, 100);
        }
    }
    
    let currentAccountSelectorType = null; // 'from' 或 'to'
    let pendingJournalModalType = null; // 記錄從哪個記帳頁面打開的帳戶選擇器：'income', 'expense', 'transferFrom', 'transferTo', 'from', 'to'
    
    function openAccountSelector(type) {
        currentAccountSelectorType = type;
        const modal = document.getElementById('accountSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = document.getElementById('accountSelectorTitle');
        const list = document.getElementById('accountSelectorList');
        
        // 確保模態框顯示在最上層
        modal.style.zIndex = '2020';
        
        // 設置標題
        if(title) {
            title.textContent = type === 'from' ? '選擇從帳戶' : '選擇到帳戶';
        }
        
        // 過濾出錢包和負債類型的帳戶
        const availableAccounts = accounts.filter(acc => acc.type === 'bank' || acc.type === 'debt');
        
        // 生成帳戶列表
        if(list) {
            list.innerHTML = '';
            if(availableAccounts.length === 0) {
                // 沒有帳戶時顯示「+」號按鈕
                const addAccountBtn = document.createElement('div');
                addAccountBtn.style.cssText = 'cursor: pointer; padding: 20px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px; text-align: center; border: 2px dashed var(--border-color);';
                addAccountBtn.onclick = () => {
                    // 記錄來源頁面類型
                    pendingJournalModalType = type;
                    
                    // 立即關閉帳戶選擇器
                    const selectorModal = document.getElementById('accountSelectorModal');
                    const selectorModalWrapper = selectorModal ? selectorModal.querySelector('.modal-content-wrapper') : null;
                    if(selectorModalWrapper) {
                        selectorModalWrapper.style.transform = 'translateY(100%)';
                    }
                    if(selectorModal) {
                        selectorModal.style.display = 'none';
                    }
                    currentAccountSelectorType = null;
                    
                    // 關閉可能打開的其他模態框
                    closeIncomeModal();
                    closeExpenseModal();
                    closeTransferModal();
                    closeFixedTransferModal();
                    
                    // 延遲一下確保模態框已關閉
                    setTimeout(() => {
                        // 設置為新增錢包帳戶
                        editingId = null;
                        editingFromDetail = false;
                        const typeSelect = document.getElementById('inpType');
                        if(typeSelect) {
                            typeSelect.value = 'bank';
                            handleTypeChange();
                        }
                        openModal();
                    }, 350);
                };
                addAccountBtn.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <i class="fas fa-plus" style="color: #0a84ff; font-size: 24px;"></i>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">新增帳戶</div>
                    </div>
                `;
                list.appendChild(addAccountBtn);
            } else {
                availableAccounts.forEach(acc => {
                    const accountItem = document.createElement('div');
                    accountItem.style.cssText = 'cursor: pointer; padding: 15px; border-radius: 12px; background: var(--bg-color); margin-bottom: 10px;';
                    accountItem.onclick = () => selectAccountForTransfer(acc);
                    
                    const iconClass = acc.type === 'bank' ? 'fa-university' : 'fa-credit-card';
                    const tagHTML = acc.type === 'bank' ? generateAccountTagHTML(acc) : '<span class="account-tag account-tag-debt">負債</span>';
                    
                    accountItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas ${iconClass}" style="color: var(--text-primary); font-size: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">${acc.name}</div>
                                <div style="margin-top: 4px;">${tagHTML}</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(accountItem);
                });
            }
        }
        
        // 打開模態框 - 立即顯示
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            // 立即觸發動畫，不等待
            requestAnimationFrame(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            });
        }
    }
    
    function closeAccountSelector() {
        const modal = document.getElementById('accountSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
        currentAccountSelectorType = null;
    }
    
    function selectAccountForTransfer(account) {
        if(!currentAccountSelectorType) return;
        
        const accountName = account.name;
        const accountElement = currentAccountSelectorType === 'from' 
            ? document.getElementById('fixedTransferFromAccount')
            : document.getElementById('fixedTransferToAccount');
        
        if(accountElement) {
            accountElement.textContent = accountName;
            accountElement.style.color = 'var(--text-primary)';
        }
        
        // 保存選擇的帳戶ID（用於後續保存）
        if(currentAccountSelectorType === 'from') {
            window.fixedTransferFromAccountId = account.id;
        } else {
            window.fixedTransferToAccountId = account.id;
        }
        
        closeAccountSelector();
    }
    
    // Fixed Transfer Data
    let fixedTransferData = {
        repeat: 'monthly', // 'daily', 'weekly', 'monthly', 'yearly'
        byPeriod: false,
        startDate: null,
        endDate: null,
        holidayAdjust: 'none', // 'none', 'advance', 'delay'
        tagColor: null, // 標籤顏色
        useAccountBalance: false, // 是否使用帳戶全部金額
        useFromAccount: true // true: 使用匯出方（從帳戶），false: 使用匯入方（到帳戶）
    };
    
    function updateFixedTransferAmountMode() {
        const useAccountBalanceCheckbox = document.getElementById('fixedTransferUseAccountBalance');
        const accountBalanceSourceRow = document.getElementById('fixedTransferAccountBalanceSourceRow');
        const amountRow = document.getElementById('fixedTransferAmountRow');
        const amountInput = document.getElementById('fixedTransferAmount');
        const labelElement = document.getElementById('fixedTransferUseAccountBalanceLabel');
        
        if(!useAccountBalanceCheckbox) return;
        
        fixedTransferData.useAccountBalance = useAccountBalanceCheckbox.checked;
        
        if(useAccountBalanceCheckbox.checked) {
            // 啟用使用帳戶全部金額
            if(accountBalanceSourceRow) accountBalanceSourceRow.style.display = 'flex';
            if(amountRow) amountRow.style.display = 'none';
            if(labelElement) labelElement.textContent = '開啟';
            updateFixedTransferAccountBalanceSourceDisplay();
        } else {
            // 關閉使用帳戶全部金額
            if(accountBalanceSourceRow) accountBalanceSourceRow.style.display = 'none';
            if(amountRow) amountRow.style.display = 'flex';
            if(labelElement) labelElement.textContent = '關閉';
        }
    }
    
    function toggleFixedTransferAccountBalanceSource() {
        fixedTransferData.useFromAccount = !fixedTransferData.useFromAccount;
        updateFixedTransferAccountBalanceSourceDisplay();
    }
    
    function updateFixedTransferAccountBalanceSourceDisplay() {
        const sourceElement = document.getElementById('fixedTransferAccountBalanceSource');
        if(sourceElement) {
            sourceElement.textContent = fixedTransferData.useFromAccount ? '匯出方（從帳戶）' : '匯入方（到帳戶）';
            sourceElement.style.color = 'var(--text-primary)';
        }
    }
    
    // 載入固定轉帳列表
    function loadFixedTransfers() {
        try {
            const data = localStorage.getItem(`${STORAGE_KEY_FIXED_TRANSFERS}_${currentUserId}`);
            const transfers = data ? JSON.parse(data) : [];
            // 向後兼容：為舊的固定轉帳添加執行記錄欄位
            transfers.forEach(transfer => {
                if(!transfer.executedDates) {
                    transfer.executedDates = [];
                }
                if(!transfer.lastExecutedDate) {
                    transfer.lastExecutedDate = null;
                }
            });
            return transfers;
        } catch(e) {
            return [];
        }
    }
    
    // 保存固定轉帳列表
    function saveFixedTransfers(transfers) {
        if (isUserSwitching) return; // 鎖定攔截
        try {
            localStorage.setItem(`${STORAGE_KEY_FIXED_TRANSFERS}_${currentUserId}`, JSON.stringify(transfers));
            if (window.syncFixedTransfersToFirestore && window.firebaseUserLoggedIn) {
                window.syncFixedTransfersToFirestore(transfers);
            }
        } catch(e) { console.error(e); }
    }
    
    function openRepeatSelector() {
        const modal = document.getElementById('repeatSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 確保模態框顯示在最上層
        modal.style.zIndex = '2020';
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            // 立即觸發動畫，不等待
            requestAnimationFrame(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            });
        }
    }
    
    function closeRepeatSelector() {
        const modal = document.getElementById('repeatSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function selectRepeat(repeat) {
        fixedTransferData.repeat = repeat;
        const repeatNames = {
            'daily': '每日',
            'weekly': '每星期',
            'monthly': '每月',
            'yearly': '每年'
        };
        const repeatElement = document.getElementById('fixedTransferRepeat');
        if(repeatElement) {
            repeatElement.textContent = repeatNames[repeat];
        }
        closeRepeatSelector();
        updatePeriodCount();
    }
    
    let currentDatePickerType = null; // 'start' 或 'end'
    let tempSelectedDate = null;
    
    function openDateSelector(type) {
        currentDatePickerType = type;
        const modal = document.getElementById('datePickerModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        const title = document.getElementById('datePickerTitle');
        
        if(title) {
            if(type === 'start') {
                title.textContent = '選擇開始日期';
            } else if(type === 'end') {
                title.textContent = '選擇結束日期';
            } else if(type === 'income' || type === 'expense' || type === 'transfer') {
                title.textContent = '選擇日期';
            }
        }
        
        // 初始化日期（如果已有選擇則使用，否則使用今天）
        let initialDate = null;
        if(type === 'start' && fixedTransferData.startDate) {
            initialDate = new Date(fixedTransferData.startDate);
        } else if(type === 'end' && fixedTransferData.endDate) {
            initialDate = new Date(fixedTransferData.endDate);
        } else if((type === 'income' || type === 'expense' || type === 'transfer') && currentJournalDate) {
            initialDate = new Date(currentJournalDate);
        } else {
            initialDate = new Date();
        }
        tempSelectedDate = new Date(initialDate);
        
        // 生成年份、月份、日期選項
        renderDatePicker(initialDate);
        
        // 確保模態框顯示在最上層
        modal.style.zIndex = '2020';
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            // 立即觸發動畫，不等待
            requestAnimationFrame(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
                // 滾動到選中的日期
                scrollToSelectedDate(initialDate);
                // 添加滾動監聽器
                addDatePickerScrollListeners();
            });
        }
    }
    
    function addDatePickerScrollListeners() {
        const yearPicker = document.getElementById('yearPicker');
        const monthPicker = document.getElementById('monthPicker');
        const dayPicker = document.getElementById('dayPicker');
        
        if(yearPicker) {
            yearPicker.addEventListener('scroll', () => {
                updateDatePickerHighlight(yearPicker, 'year');
            });
        }
        
        if(monthPicker) {
            monthPicker.addEventListener('scroll', () => {
                updateDatePickerHighlight(monthPicker, 'month');
            });
        }
        
        if(dayPicker) {
            dayPicker.addEventListener('scroll', () => {
                updateDatePickerHighlight(dayPicker, 'day');
            });
        }
    }
    
    function updateDatePickerHighlight(picker, type) {
        const items = picker.querySelectorAll('div');
        const pickerRect = picker.getBoundingClientRect();
        const centerY = pickerRect.top + pickerRect.height / 2;
        
        items.forEach((item) => {
            const itemRect = item.getBoundingClientRect();
            const itemCenterY = itemRect.top + itemRect.height / 2;
            const distance = Math.abs(itemCenterY - centerY);
            
            if(distance < 25) {
                // 在中心區域
                item.style.color = '#0a84ff';
                item.style.fontWeight = '600';
                item.style.fontSize = '20px';
                
                // 更新臨時選擇的日期
                if(type === 'year') {
                    const year = parseInt(item.textContent);
                    tempSelectedDate.setFullYear(year);
                    updateDayPicker();
                } else if(type === 'month') {
                    const month = parseInt(item.textContent);
                    tempSelectedDate.setMonth(month - 1);
                    updateDayPicker();
                } else if(type === 'day') {
                    const day = parseInt(item.textContent);
                    tempSelectedDate.setDate(day);
                }
            } else {
                item.style.color = 'var(--text-secondary)';
                item.style.fontWeight = 'normal';
                item.style.fontSize = '18px';
            }
        });
    }
    
    function renderDatePicker(selectedDate) {
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth() + 1;
        const day = selectedDate.getDate();
        
        // 生成年份（當前年份前後各10年）
        const yearPicker = document.getElementById('yearPicker');
        const monthPicker = document.getElementById('monthPicker');
        const dayPicker = document.getElementById('dayPicker');
        
        if(yearPicker) {
            yearPicker.innerHTML = '';
            for(let y = year - 10; y <= year + 10; y++) {
                const yearItem = document.createElement('div');
                yearItem.style.cssText = 'padding: 15px; text-align: center; font-size: 18px; color: var(--text-primary); scroll-snap-align: center;';
                yearItem.textContent = y + '年';
                yearItem.onclick = () => {
                    tempSelectedDate.setFullYear(y);
                    updateDayPicker();
                    scrollToSelectedDate(tempSelectedDate);
                };
                if(y === year) {
                    yearItem.style.color = '#0a84ff';
                    yearItem.style.fontWeight = '600';
                }
                yearPicker.appendChild(yearItem);
            }
        }
        
        if(monthPicker) {
            monthPicker.innerHTML = '';
            for(let m = 1; m <= 12; m++) {
                const monthItem = document.createElement('div');
                monthItem.style.cssText = 'padding: 15px; text-align: center; font-size: 18px; color: var(--text-secondary); scroll-snap-align: center; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;';
                monthItem.textContent = m + '月';
                monthItem.onclick = () => {
                    tempSelectedDate.setMonth(m - 1);
                    updateDayPicker();
                    highlightSelectedItems();
                    scrollToSelectedDate(tempSelectedDate);
                };
                if(m === month) {
                    monthItem.style.color = '#0a84ff';
                    monthItem.style.fontWeight = '600';
                    monthItem.style.fontSize = '20px';
                }
                monthPicker.appendChild(monthItem);
            }
        }
        
        updateDayPicker();
    }
    
    function updateDayPicker() {
        const dayPicker = document.getElementById('dayPicker');
        if(!dayPicker) return;
        
        const year = tempSelectedDate.getFullYear();
        const month = tempSelectedDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const currentDay = tempSelectedDate.getDate();
        
        dayPicker.innerHTML = '';
        for(let d = 1; d <= daysInMonth; d++) {
            const dayItem = document.createElement('div');
            dayItem.style.cssText = 'padding: 15px; text-align: center; font-size: 18px; color: var(--text-secondary); scroll-snap-align: center; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;';
            dayItem.textContent = d + '日';
            dayItem.onclick = () => {
                tempSelectedDate.setDate(d);
                highlightSelectedItems();
                scrollToSelectedDate(tempSelectedDate);
            };
            if(d === currentDay) {
                dayItem.style.color = '#0a84ff';
                dayItem.style.fontWeight = '600';
                dayItem.style.fontSize = '20px';
            }
            dayPicker.appendChild(dayItem);
        }
    }
    
    function scrollToSelectedDate(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        
        const yearPicker = document.getElementById('yearPicker');
        const monthPicker = document.getElementById('monthPicker');
        const dayPicker = document.getElementById('dayPicker');
        
        if(yearPicker) {
            const yearItems = yearPicker.querySelectorAll('div');
            yearItems.forEach((item, index) => {
                if(item.textContent.includes(year + '年')) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        if(monthPicker) {
            const monthItems = monthPicker.querySelectorAll('div');
            monthItems.forEach((item, index) => {
                if(item.textContent.includes(month + '月')) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        if(dayPicker) {
            const dayItems = dayPicker.querySelectorAll('div');
            dayItems.forEach((item, index) => {
                if(item.textContent.includes(day + '日')) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
    }
    
    function closeDatePicker() {
        const modal = document.getElementById('datePickerModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
        currentDatePickerType = null;
    }
    
    function confirmDatePicker() {
        if(!currentDatePickerType || !tempSelectedDate) return;
        
        const date = new Date(tempSelectedDate);
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const weekday = weekdays[date.getDay()];
        const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${weekday}`;
        
        if(currentDatePickerType === 'start') {
            fixedTransferData.startDate = date;
            const startDateElement = document.getElementById('fixedTransferStartDate');
            if(startDateElement) {
                startDateElement.textContent = dateStr;
                startDateElement.style.color = 'var(--text-primary)';
            }
        } else if(currentDatePickerType === 'end') {
            fixedTransferData.endDate = date;
            const endDateElement = document.getElementById('fixedTransferEndDate');
            if(endDateElement) {
                endDateElement.textContent = dateStr;
                endDateElement.style.color = 'var(--text-primary)';
            }
        } else if(currentDatePickerType === 'income') {
            currentJournalDate = date;
            updateIncomeDateDisplay();
        } else if(currentDatePickerType === 'expense') {
            currentJournalDate = date;
            updateExpenseDateDisplay();
        } else if(currentDatePickerType === 'transfer') {
            currentJournalDate = date;
            updateTransferDateDisplay();
        }
        
        closeDatePicker();
        if(currentDatePickerType === 'start' || currentDatePickerType === 'end') {
            updatePeriodCount();
            updateNextDates();
        }
    }
    
    function openHolidayAdjustSelector() {
        const modal = document.getElementById('holidayAdjustSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 確保模態框顯示在最上層
        modal.style.zIndex = '2020';
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            // 立即觸發動畫，不等待
            requestAnimationFrame(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            });
        }
    }
    
    function closeHolidayAdjustSelector() {
        const modal = document.getElementById('holidayAdjustSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function selectHolidayAdjust(adjust) {
        fixedTransferData.holidayAdjust = adjust;
        const adjustNames = {
            'none': '不調整',
            'advance': '提前',
            'delay': '延後'
        };
        const adjustElement = document.getElementById('fixedTransferHolidayAdjust');
        if(adjustElement) {
            adjustElement.textContent = adjustNames[adjust];
        }
        closeHolidayAdjustSelector();
    }
    
    function openTagColorSelector() {
        const modal = document.getElementById('tagColorSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        // 確保模態框顯示在最上層
        modal.style.zIndex = '2020';
        modal.style.display = 'block';
        modal.style.background = 'rgba(0,0,0,0.5)';
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            // 立即觸發動畫，不等待
            requestAnimationFrame(() => {
                if(modalWrapper) {
                    modalWrapper.style.transform = 'translateY(0)';
                }
            });
        }
    }
    
    function closeTagColorSelector() {
        const modal = document.getElementById('tagColorSelectorModal');
        const modalWrapper = modal.querySelector('.modal-content-wrapper');
        if(modalWrapper) {
            modalWrapper.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                modalWrapper.style.transform = 'translateY(100%)';
            }, 300);
        } else {
            modal.style.display = 'none';
        }
    }
    
    function selectTagColor(color) {
        fixedTransferData.tagColor = color;
        const tagColorElement = document.getElementById('fixedTransferTagColor');
        const tagIconElement = document.getElementById('fixedTransferTagIcon');
        if(tagColorElement) {
            tagColorElement.textContent = '已選擇';
            tagColorElement.style.color = color;
        }
        if(tagIconElement) {
            tagIconElement.style.color = color;
        }
        closeTagColorSelector();
    }
    
    // 檢查並執行固定轉帳
    function checkAndExecuteFixedTransfers() {
        const transfers = loadFixedTransfers();
        if(transfers.length === 0) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];
        
        let hasChanges = false;
        
        transfers.forEach(transfer => {
            // 確保有執行記錄欄位（向後兼容）
            if(!transfer.executedDates) {
                transfer.executedDates = [];
            }
            if(!transfer.lastExecutedDate) {
                transfer.lastExecutedDate = null;
            }
            
            // 檢查今天是否已經執行過
            if(transfer.executedDates.includes(todayStr)) {
                return; // 今天已經執行過，跳過
            }
            
            // 檢查日期範圍
            const startDate = new Date(transfer.startDate);
            startDate.setHours(0, 0, 0, 0);
            const endDate = transfer.endDate ? new Date(transfer.endDate) : null;
            if(endDate) endDate.setHours(0, 0, 0, 0);
            
            if(today < startDate) return; // 還沒到開始日期
            if(endDate && today > endDate) return; // 已經過了結束日期
            
            // 檢查是否符合重複規則
            let shouldExecute = false;
            const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            
            switch(transfer.repeat) {
                case 'daily':
                    shouldExecute = true;
                    break;
                case 'weekly':
                    shouldExecute = (daysDiff % 7 === 0);
                    break;
                case 'monthly':
                    shouldExecute = (today.getDate() === startDate.getDate());
                    break;
                case 'yearly':
                    shouldExecute = (today.getMonth() === startDate.getMonth() && today.getDate() === startDate.getDate());
                    break;
            }
            
            // 處理假日調整
            if(shouldExecute && transfer.holidayAdjust !== 'none') {
                const dayOfWeek = today.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                if(isWeekend) {
                    if(transfer.holidayAdjust === 'advance') {
                        // 提前到上一個工作日
                        const prevWorkday = new Date(today);
                        while(prevWorkday.getDay() === 0 || prevWorkday.getDay() === 6) {
                            prevWorkday.setDate(prevWorkday.getDate() - 1);
                        }
                        const prevWorkdayStr = prevWorkday.toISOString().split('T')[0];
                        if(!transfer.executedDates.includes(prevWorkdayStr)) {
                            // 如果上一個工作日還沒執行，則今天執行
                            shouldExecute = true;
                        } else {
                            shouldExecute = false;
                        }
                    } else if(transfer.holidayAdjust === 'delay') {
                        // 延後到下一個工作日
                        shouldExecute = false; // 今天不執行，等工作日再執行
                    }
                }
            }
            
            if(shouldExecute) {
                // 執行轉帳
                const executed = executeFixedTransfer(transfer, today);
                if(executed) {
                    hasChanges = true;
                }
            }
        });
        
        if(hasChanges) {
            saveFixedTransfers(transfers);
            renderAssets();
            updateChartData();
            // 更新固定轉帳列表顯示
            renderFixedTransferList();
            // 更新日期支出資訊（如果當前有選中日期）
            if(selectedDate) {
                showFixedTransferDetailsForDate(selectedDate);
            }
            // 更新日曆
            renderCalendar();
        }
    }
    
    // 執行固定轉帳
    function executeFixedTransfer(transfer, executeDate) {
        const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
        const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
        
        if(!fromAccount || !toAccount) {
            console.warn('固定轉帳執行失敗：找不到帳戶', transfer);
            return false;
        }
        
        // 檢查是否涉及信用卡
        const isCreditCardTransfer = toAccount && toAccount.bankTag === '信用卡';
        
        // 使用固定金額（不再自動計算）
        const transferAmount = transfer.amount || 0;
            
            if(transferAmount === 0) {
                console.warn(`固定轉帳執行失敗：金額為0`, transfer);
                return false;
            }
        
            // 檢查餘額是否足夠（只檢查匯出方）
            if(fromAccount.balance < transferAmount) {
                console.warn(`固定轉帳執行失敗：${fromAccount.name} 餘額不足`, transfer);
                return false;
        }
        
        // 更新帳戶餘額
        fromAccount.balance -= transferAmount;
        toAccount.balance += transferAmount;
        
        // 記錄執行日期
        const dateStr = executeDate.toISOString().split('T')[0];
        if(!transfer.executedDates.includes(dateStr)) {
            transfer.executedDates.push(dateStr);
        }
        transfer.lastExecutedDate = dateStr;
        
        // 記錄執行金額（用於後續編輯）
        if(!transfer.executionRecords) {
            transfer.executionRecords = {};
        }
        transfer.executionRecords[dateStr] = transferAmount;
        
        // 如果使用帳戶全部金額（非信用卡），更新 initialAmount 為執行時使用的金額（用於記錄）
        if(transfer.useAccountBalance && !isCreditCardTransfer) {
            transfer.initialAmount = transferAmount;
        }
        
        // 保存資料
        saveData();
        
        // 更新固定轉帳列表顯示（因為金額可能已改變）
        renderFixedTransferList();
        
        console.log(`固定轉帳已執行：${transfer.title}，金額：${transferAmount}，從 ${fromAccount.name} 轉到 ${toAccount.name}`);
        return true;
    }
    
    // 更新未執行的固定轉帳金額
    function updateFixedTransferAmount(transferId, dateStr) {
        const input = document.getElementById(`fixedTransferAmount_${transferId}_${dateStr}`);
        if(!input) return;
        
        const newAmount = parseFloat(input.value) || 0;
        if(newAmount < 0) {
            alert('金額不能為負數');
            input.value = 0;
            return;
        }
        
        const transfers = loadFixedTransfers();
        const transfer = transfers.find(t => t.id === transferId);
        if(!transfer) {
            alert('找不到固定轉帳');
            return;
        }
        
        // 檢查是否已執行
        const isExecuted = transfer.executedDates && transfer.executedDates.includes(dateStr);
        if(isExecuted) {
            alert('此固定轉帳在該日期已執行，無法修改金額');
            input.value = transfer.executionRecords && transfer.executionRecords[dateStr] !== undefined 
                ? transfer.executionRecords[dateStr] 
                : transfer.amount;
            return;
        }
        
        // 更新固定轉帳的金額
        const oldAmount = transfer.amount || 0;
        transfer.amount = newAmount;
        
        // 保存資料
        saveFixedTransfers(transfers);
        
        // 更新顯示
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        }
        
        console.log(`已更新固定轉帳金額：${transfer.title}，舊金額：${oldAmount}，新金額：${newAmount}`);
    }
    
    // 更新已執行的固定轉帳金額
    function updateFixedTransferExecutionAmount(transferId, dateStr) {
        const input = document.getElementById(`fixedTransferAmount_${transferId}_${dateStr}`);
        if(!input) return;
        
        const newAmount = parseFloat(input.value) || 0;
        if(newAmount < 0) {
            alert('金額不能為負數');
            input.value = 0;
            return;
        }
        
        const transfers = loadFixedTransfers();
        const transfer = transfers.find(t => t.id === transferId);
        if(!transfer) {
            alert('找不到固定轉帳');
            return;
        }
        
        // 檢查是否已執行
        if(!transfer.executedDates || !transfer.executedDates.includes(dateStr)) {
            alert('此固定轉帳在該日期尚未執行');
            return;
        }
        
        // 獲取舊金額
        const oldAmount = transfer.executionRecords && transfer.executionRecords[dateStr] !== undefined 
            ? transfer.executionRecords[dateStr] 
            : getFixedTransferDisplayAmount(transfer, new Date(dateStr));
        
        if(Math.abs(newAmount - oldAmount) < 0.01) {
            // 金額沒有變化，不需要更新
            return;
        }
        
        // 計算金額差異
        const amountDiff = newAmount - oldAmount;
        
        // 獲取帳戶
        const fromAccount = accounts.find(acc => acc.id === transfer.fromAccountId);
        const toAccount = accounts.find(acc => acc.id === transfer.toAccountId);
        
        if(!fromAccount || !toAccount) {
            alert('找不到帳戶');
            return;
        }
        
        // 更新帳戶餘額
        fromAccount.balance -= amountDiff;
        toAccount.balance += amountDiff;
        
        // 保存執行記錄的金額
        if(!transfer.executionRecords) {
            transfer.executionRecords = {};
        }
        transfer.executionRecords[dateStr] = newAmount;
        
        // 保存資料
        saveFixedTransfers(transfers);
        saveData();
        
        // 更新顯示
        renderAssets();
        updateChartData();
        if(selectedDate) {
            showFixedTransferDetailsForDate(selectedDate);
        }
        
        console.log(`已更新固定轉帳執行金額：${transfer.title}，日期：${dateStr}，舊金額：${oldAmount}，新金額：${newAmount}`);
    }
    
    function updatePeriodCount() {
        const byPeriodCheckbox = document.getElementById('fixedTransferByPeriod');
        const periodCountElement = document.getElementById('fixedTransferPeriodCount');
        
        if(!byPeriodCheckbox || !periodCountElement) return;
        
        fixedTransferData.byPeriod = byPeriodCheckbox.checked;
        
        if(!byPeriodCheckbox.checked) {
            periodCountElement.textContent = '';
            return;
        }
        
        if(!fixedTransferData.startDate || !fixedTransferData.endDate) {
            periodCountElement.textContent = '';
            return;
        }
        
        // 計算期數
        const startDate = new Date(fixedTransferData.startDate);
        const endDate = new Date(fixedTransferData.endDate);
        let count = 0;
        const currentDate = new Date(startDate);
        
        while(currentDate <= endDate) {
            count++;
            switch(fixedTransferData.repeat) {
                case 'daily':
                    currentDate.setDate(currentDate.getDate() + 1);
                    break;
                case 'weekly':
                    currentDate.setDate(currentDate.getDate() + 7);
                    break;
                case 'monthly':
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'yearly':
                    currentDate.setFullYear(currentDate.getFullYear() + 1);
                    break;
            }
        }
        
        periodCountElement.textContent = count + '期';
    }
    
    function updateNextDates() {
        if(!fixedTransferData.startDate || !fixedTransferData.repeat) return;
        
        const startDate = new Date(fixedTransferData.startDate);
        const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        
        // 計算下回日期
        const nextDate = new Date(startDate);
        switch(fixedTransferData.repeat) {
            case 'daily':
                nextDate.setDate(nextDate.getDate() + 1);
                break;
            case 'weekly':
                nextDate.setDate(nextDate.getDate() + 7);
                break;
            case 'monthly':
                nextDate.setMonth(nextDate.getMonth() + 1);
                break;
            case 'yearly':
                nextDate.setFullYear(nextDate.getFullYear() + 1);
                break;
        }
        
        // 計算下下回日期
        const nextNextDate = new Date(nextDate);
        switch(fixedTransferData.repeat) {
            case 'daily':
                nextNextDate.setDate(nextNextDate.getDate() + 1);
                break;
            case 'weekly':
                nextNextDate.setDate(nextNextDate.getDate() + 7);
                break;
            case 'monthly':
                nextNextDate.setMonth(nextNextDate.getMonth() + 1);
                break;
            case 'yearly':
                nextNextDate.setFullYear(nextNextDate.getFullYear() + 1);
                break;
        }
        
        const nextDateElement = document.getElementById('fixedTransferNextDate');
        const nextNextDateElement = document.getElementById('fixedTransferNextNextDate');
        
        if(nextDateElement) {
            const nextWeekday = weekdays[nextDate.getDay()];
            nextDateElement.textContent = `:${nextDate.getFullYear()}年${nextDate.getMonth() + 1}月${nextDate.getDate()}日 ${nextWeekday}`;
        }
        
        if(nextNextDateElement) {
            const nextNextWeekday = weekdays[nextNextDate.getDay()];
            nextNextDateElement.textContent = `:${nextNextDate.getFullYear()}年${nextNextDate.getMonth() + 1}月${nextNextDate.getDate()}日 ${nextNextWeekday}`;
        }
    }
    
    init();
</script>

<script type="module">
    // Firebase 初始化
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, getDocs, writeBatch, Timestamp, limit, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAyebCTYX0SdZbO_wTKVjMyQXmGsnmSkzs",
        authDomain: "travel-30c43.firebaseapp.com",
        databaseURL: "https://travel-30c43-default-rtdb.firebaseio.com",
        projectId: "travel-30c43",
        storageBucket: "travel-30c43.firebasestorage.app",
        messagingSenderId: "402035619902",
        appId: "1:402035619902:web:f492adf217821c093f396f",
        measurementId: "G-SPF452S4LR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentFirebaseUser = null;

    // 將 Firebase 功能暴露到全域
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseSignIn = () => {
        const provider = new GoogleAuthProvider();
        // 強制每次都跳出帳號選擇畫面
        provider.setCustomParameters({
            prompt: 'select_account'
        });
        return signInWithPopup(auth, provider);
    };
    window.firebaseSignOut = () => signOut(auth);
    window.getCurrentFirebaseUser = () => currentFirebaseUser;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseDoc = doc;

    // Firestore 同步相關變數
    let firestoreSyncEnabled = false;
    let accountsUnsubscribe = null;
    let journalUnsubscribe = null;
    let settingsUnsubscribe = null;
    let fixedTransfersUnsubscribe = null;
    let usersUnsubscribe = null;
    let currentUserUnsubscribe = null;
    let isSyncingFromFirestore = false; // 防止同步循環

    // 監聽登入狀態
    onAuthStateChanged(auth, (user) => {
        currentFirebaseUser = user;
        if (user) {
            window.firebaseUserLoggedIn = true;
            // 觸發自訂事件通知主程式
            window.dispatchEvent(new CustomEvent('firebaseAuthStateChanged', { detail: { user } }));
            // 登入後從 Firestore 載入資料（先載入，再啟動監聽，避免監聽器立即觸發）
            loadDataFromFirestore().then(() => {
                // 載入完成後再啟動 Firestore 同步監聽
                startFirestoreSync();
            });
        } else {
            window.firebaseUserLoggedIn = false;
            // 停止 Firestore 同步監聽
            stopFirestoreSync();
            window.dispatchEvent(new CustomEvent('firebaseAuthStateChanged', { detail: { user: null } }));
        }
    });
    
    // 先從雲端決定真正的 currentUserId，確保跨裝置用同一組 appUsers（以 Google UID 為主）
    async function resolveCurrentUserFromFirestore() {
        const STORAGE_KEY_USERS = 'my_assets_users';
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const usersRef = doc(db, "users", currentFirebaseUser.uid, "data", "users");
        const currentUserRef = doc(db, "users", currentFirebaseUser.uid, "data", "currentUser");
        
        // 取雲端 users 清單
        let resolvedUsers = users;
        try {
            const usersSnap = await getDoc(usersRef);
            if (usersSnap.exists()) {
                const firestoreUsers = usersSnap.data().users || [];
                if (firestoreUsers.length > 0) {
                    resolvedUsers = firestoreUsers;
                    users = firestoreUsers;
                    localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(firestoreUsers));
                }
            }
        } catch (err) {
            console.error('[同步] 取得 users 列表失敗', err);
        }
        
        // 取雲端 currentUser
        let resolvedCurrentUserId = localStorage.getItem(STORAGE_KEY_CURRENT_USER) || currentUserId || null;
        try {
            const currentUserSnap = await getDoc(currentUserRef);
            if (currentUserSnap.exists()) {
                const firestoreCurrentUser = currentUserSnap.data().currentUserId;
                if (firestoreCurrentUser) {
                    resolvedCurrentUserId = firestoreCurrentUser;
                }
            }
        } catch (err) {
            console.error('[同步] 取得 currentUser 失敗', err);
        }
        
        // 若仍無，改用雲端使用者列表的第一筆
        if (!resolvedCurrentUserId && resolvedUsers && resolvedUsers.length > 0) {
            resolvedCurrentUserId = resolvedUsers[0].id;
        }
        
        // 寫回本地/記憶體，確保後續使用同一個 ID
        if (resolvedCurrentUserId) {
            currentUserId = resolvedCurrentUserId;
            localStorage.setItem(STORAGE_KEY_CURRENT_USER, resolvedCurrentUserId);
        }
        
        return resolvedCurrentUserId;
    }
    
    // 從 Firestore 載入資料 (自動同步版)
    async function loadDataFromFirestore() {
        if (!currentFirebaseUser) return;
        
        // 【防護機制】如果正在切換使用者，延遲載入
        if (isUserSwitching) {
            console.warn('[同步] 正在切換使用者，延遲載入 Firestore 資料');
            // 等待使用者切換完成後再載入
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!isUserSwitching) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                // 最多等待 5 秒
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
            // 如果仍然在切換，直接返回
            if (isUserSwitching) {
                console.warn('[同步] 使用者切換時間過長，取消載入');
                return;
            }
        }
        
        try {
            isSyncingFromFirestore = true;
            
            // 1. 先用 Google 帳號決定共用的 appUsers，再取 currentUserId（子帳）做分流
            const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
            const resolvedCurrentUserId = await resolveCurrentUserFromFirestore();
            if (!resolvedCurrentUserId) {
                console.warn('[同步] 無法決定 currentUserId，停止載入');
                return;
            }
            
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", resolvedCurrentUserId);
            const userDataSnap = await getDoc(userDataRef);
            
            // 準備本地儲存的 Key
            const STORAGE_KEY_DATA = 'my_assets_stable_data';
            const STORAGE_KEY_JOURNAL = 'my_assets_journal';
            const STORAGE_KEY_SETTINGS = 'my_assets_stable_settings';
            const STORAGE_KEY_FIXED_TRANSFERS = 'my_assets_fixed_transfers';
            const STORAGE_KEY_DATE_NOTES = 'my_assets_date_notes';
            
            const userDataKey = `${STORAGE_KEY_DATA}_${resolvedCurrentUserId}`;
            const userJournalKey = `${STORAGE_KEY_JOURNAL}_${resolvedCurrentUserId}`;
            const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${resolvedCurrentUserId}`;
            const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${resolvedCurrentUserId}`;
            const userDateNotesKey = `${STORAGE_KEY_DATE_NOTES}_${resolvedCurrentUserId}`;
            
            // 讀取本地現有資料 (用於判斷是否需要初始化上傳)
            const localAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
            const localJournal = JSON.parse(localStorage.getItem(userJournalKey) || '[]');
            const localSettings = JSON.parse(localStorage.getItem(userSettingsKey) || '{}');
            const localFixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey) || '[]');
            const localDateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
            
            // 檢查本地是否為空（沒有歷史記錄）
            const isLocalEmpty = localAccounts.length === 0 && localJournal.length === 0 && localFixedTransfers.length === 0 && Object.keys(localSettings).length === 0 && Object.keys(localDateNotes).length === 0;
            
            // 保存 Firestore 資料變數，以便後續 UI 更新時使用
            let firestoreAccounts = [];
            let firestoreJournal = [];
            let firestoreFixedTransfers = [];
            let firestoreSettings = {};
            let firestoreDateNotes = {};
            let hasFirestoreDataLoaded = false;
            
            if (userDataSnap.exists()) {
                const userData = userDataSnap.data();
                firestoreAccounts = userData.accounts || [];
                firestoreJournal = userData.journal || [];
                firestoreFixedTransfers = userData.fixedTransfers || [];
                firestoreSettings = userData.settings || {};
                firestoreDateNotes = userData.dateNotes || {};
                const hasFirestoreData = firestoreAccounts.length > 0 || firestoreJournal.length > 0 || firestoreFixedTransfers.length > 0 || Object.keys(firestoreSettings).length > 0 || Object.keys(firestoreDateNotes).length > 0;
                hasFirestoreDataLoaded = true;
                
                // 【關鍵修正】如果本地為空且 Firestore 有資料，強制同步
                if (isLocalEmpty && hasFirestoreData) {
                    console.log(`[同步] 本地為空，自動從 Firestore 同步使用者 ${resolvedCurrentUserId} 的資料`);
                } else {
                    console.log(`[同步] 強制同步使用者 ${resolvedCurrentUserId} 資料`);
                }
                
                // 直接覆蓋本地資料（以 Firestore 為主）
                localStorage.setItem(userDataKey, JSON.stringify(firestoreAccounts));
                localStorage.setItem(userJournalKey, JSON.stringify(firestoreJournal));
                localStorage.setItem(userFixedTransfersKey, JSON.stringify(firestoreFixedTransfers));
                
                if (firestoreSettings && Object.keys(firestoreSettings).length > 0) {
                    const merged = { ...localSettings, ...firestoreSettings };
                    localStorage.setItem(userSettingsKey, JSON.stringify(merged));
                }
                
                // 同步日期記事（無論是否為空都同步，以 Firestore 為主）
                if (firestoreDateNotes !== undefined) {
                    localStorage.setItem(userDateNotesKey, JSON.stringify(firestoreDateNotes));
                }
                
                // 觸發資料載入事件，更新 UI
                window.dispatchEvent(new CustomEvent('firebaseDataLoaded'));
                
            } else {
                // 雲端無資料 -> 如果本地有資料，上傳本地
                if (!isLocalEmpty) {
                    console.log(`[同步] 雲端無資料，上傳本地資料到 Firestore`);
                    if (window.syncAllDataToFirestore) await window.syncAllDataToFirestore();
                } else {
                    console.log(`[同步] 本地和雲端都為空，無需同步`);
                }
            }
            
            // 3. 同步全域使用者列表 (Users List)
            const STORAGE_KEY_USERS = 'my_assets_users';
            const usersRef = doc(db, "users", currentFirebaseUser.uid, "data", "users");
            const usersSnap = await getDoc(usersRef);
            const localUsers = JSON.parse(localStorage.getItem(STORAGE_KEY_USERS) || '[]');
            
            if (usersSnap.exists()) {
                const firestoreUsers = usersSnap.data().users || [];
                // 如果雲端有使用者列表，以雲端為主更新本地
                if (firestoreUsers.length > 0) {
                    localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(firestoreUsers));
                    if (typeof window !== 'undefined' && window.users !== undefined) {
                        window.users = firestoreUsers;
                    }
                } else if (localUsers.length > 0) {
                    // 雲端列表為空但本地有，上傳本地
                    await window.syncUsersToFirestore(localUsers);
                }
            } else if (localUsers.length > 0) {
                // 雲端文件不存在，上傳本地列表
                await window.syncUsersToFirestore(localUsers);
            }
            
            // 4. 同步「上次登入的使用者 ID」(Current User)
            // 這裡保持之前的邏輯：如果本地有紀錄，以本地為主(避免切換跳轉)；如果本地沒有，才用雲端的
            const currentUserRef = doc(db, "users", currentFirebaseUser.uid, "data", "currentUser");
            const currentUserSnap = await getDoc(currentUserRef);
            const localCurrentUser = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
            
            if (currentUserSnap.exists()) {
                const firestoreCurrentUser = currentUserSnap.data().currentUserId;
                
                // 本地無紀錄 -> 用雲端的
                if (firestoreCurrentUser && !localCurrentUser) {
                    localStorage.setItem(STORAGE_KEY_CURRENT_USER, firestoreCurrentUser);
                    if (typeof window !== 'undefined') window.currentUserId = firestoreCurrentUser;
                }
                // 本地有紀錄且不同 -> 更新雲端 (以本地當下操作的使用者為主)
                else if (localCurrentUser && firestoreCurrentUser && localCurrentUser !== firestoreCurrentUser) {
                    await window.syncCurrentUserToFirestore(localCurrentUser);
                }
            } else if (localCurrentUser) {
                await window.syncCurrentUserToFirestore(localCurrentUser);
            }
            
            // 確保記憶體變數是最新的，並刷新 UI
            if (typeof loadUserData === 'function') {
                const userData = loadUserData(resolvedCurrentUserId);
                if (userData) {
                    const previousAccountsLength = accounts.length;
                    const previousSettingsKeys = Object.keys(settings).length;
                    
                    accounts = userData.accounts;
                    settings = userData.settings;
                    
                    // 同步 UI 狀態（從 settings 讀取）
                    if (settings.pageVisibility) pageVisibility = settings.pageVisibility; 
                    if (settings.pageOrder) pageOrder = settings.pageOrder; 
                    if (settings.displayCurrency) currentDisplayCurrency = settings.displayCurrency;
                    
                    // 更新幣別顯示
                    const ctt = document.getElementById('currencyToggleText');
                    if (ctt) ctt.textContent = currentDisplayCurrency;
                    
                    // 更新主題
                    if (typeof applyTheme === 'function') applyTheme();
                    
                    // 檢查是否需要更新 UI：
                    // 1. 本地原本為空，且從 Firestore 載入了資料
                    // 2. 或者資料有變化（從 Firestore 同步後）
                    // 3. 或者從 Firestore 載入了資料（確保清空瀏覽器後登入也能更新 UI）
                    // 檢查是否有新資料或資料變化
                    const hasNewData = (isLocalEmpty && (accounts.length > 0 || Object.keys(settings).length > 0)) ||
                                      (accounts.length !== previousAccountsLength || Object.keys(settings).length !== previousSettingsKeys);
                    
                    // 如果從 Firestore 載入了資料，或者本地原本為空但現在有資料，都應該更新 UI
                    // 特別是在清空瀏覽器後登入時，確保 UI 會更新
                    // 簡化條件：只要從 Firestore 載入了資料，或者有資料變化，就更新 UI
                    if (hasNewData || hasFirestoreDataLoaded) {
                        console.log(`[同步] 從 Firestore 載入資料後，刷新 UI (本地原本為空: ${isLocalEmpty}, 從 Firestore 載入: ${hasFirestoreDataLoaded})`);
                        
                        // 使用 setTimeout 確保所有資料都已寫入 localStorage 後再更新 UI
                        setTimeout(() => {
                            // 更新使用者頭像
                            if (typeof updateUserAvatar === 'function') updateUserAvatar();
                            
                            // 刷新資產列表
                            if (typeof renderAssets === 'function') renderAssets();
                            
                            // 更新圖表
                            if (typeof updateChartData === 'function') updateChartData();
                            
                            // 更新分頁順序
                            if (typeof reorderPageItems === 'function') reorderPageItems();
                            
                            // 更新分頁指示器
                            if (typeof renderPageIndicator === 'function') renderPageIndicator();
                            
                            // 更新分頁顯示設定
                            if (typeof renderPageVisibilitySettings === 'function') renderPageVisibilitySettings();
                            
                            // 更新日曆
                            if (typeof renderCalendar === 'function') renderCalendar();
                            
                            // 更新固定轉帳列表
                            if (typeof renderFixedTransferList === 'function') renderFixedTransferList();
                            
                            // 如果當前正在顯示記帳分頁，更新記帳詳情
                            if (typeof showFixedTransferDetailsForDate === 'function' && selectedDate) {
                                showFixedTransferDetailsForDate(selectedDate);
                            }
                            
                            // 清除記帳日期快取
                            if (typeof clearJournalDatesCache === 'function') clearJournalDatesCache();
                        }, 100); // 延遲 100ms 確保資料已寫入
                    }
                }
            }
            
            console.log('自動同步完成');
            
        } catch (err) {
            console.error('自動同步失敗:', err);
        } finally {
            isSyncingFromFirestore = false;
        }
    }
    
    // 啟動 Firestore 同步監聽 (修正版：監聽所有使用者)
    function startFirestoreSync() {
        if (!currentFirebaseUser) {
            console.warn('[同步啟動] 沒有 Firebase 使用者，無法啟動');
            return;
        }
        
        if (firestoreSyncEnabled) {
            console.warn('[同步啟動] 監聽器已經啟動，先停止舊監聽器');
            stopFirestoreSync();
            // 等待一下確保舊監聽器完全停止
            setTimeout(() => {
                startFirestoreSync();
            }, 100);
            return;
        }
        
        console.log(`[同步啟動] 開始監聽所有使用者的資料變化`);
        firestoreSyncEnabled = true;
        
        // 監聽所有使用者的資料變化（使用 collection 監聽整個 appUsers 集合）
        const appUsersCollectionRef = collection(db, "users", currentFirebaseUser.uid, "appUsers");
        
        accountsUnsubscribe = onSnapshot(appUsersCollectionRef, (snapshot) => {
            if (isSyncingFromFirestore) return;
            
            // 【防護機制】如果正在切換使用者，忽略所有同步更新
            if (isUserSwitching) {
                return;
            }
            
            const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
            const currentUserIdNow = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
            
            // 處理每個使用者的資料變化
            snapshot.docChanges().forEach((change) => {
                // 【防護機制】在處理每個變更時再次檢查，避免處理過程中使用者切換
                if (isUserSwitching) {
                    return;
                }
                
                const userId = change.doc.id; // 這是使用者的 ID
                const snap = change.doc;
                
                // 【關鍵修正】忽略本地尚未寫入伺服器的快照 (防止自己覆寫自己)
                if (snap.metadata && snap.metadata.hasPendingWrites) {
                    return;
                }
                
                if (snap.exists()) {
                    const userData = snap.data();
                    const firestoreAccounts = userData.accounts || [];
                    const firestoreJournal = userData.journal || [];
                    const firestoreSettings = userData.settings || {};
                    const firestoreFixedTransfers = userData.fixedTransfers || [];
                    const firestoreDateNotes = userData.dateNotes || {};
                    
                    // 使用變化的使用者 ID 來產生 Key
                    const userDataKey = `${STORAGE_KEY_DATA}_${userId}`;
                    const userJournalKey = `${STORAGE_KEY_JOURNAL}_${userId}`;
                    const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${userId}`;
                    const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${userId}`;
                    const userDateNotesKey = `${STORAGE_KEY_DATE_NOTES}_${userId}`;
                    
                    const localAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
                    const localJournal = JSON.parse(localStorage.getItem(userJournalKey) || '[]');
                    const currentSettings = JSON.parse(localStorage.getItem(userSettingsKey) || '{}');
                    const localFixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey) || '[]');
                    const localDateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
                    
                    let hasChanges = false;
                    
                    // Accounts 同步邏輯
                    // 【關鍵修正】不檢查 length，直接比較和覆蓋（包括空陣列的情況，例如刪除所有資產後）
                    if (JSON.stringify(firestoreAccounts) !== JSON.stringify(localAccounts)) {
                        // 【防護機制】再次檢查使用者是否切換
                        if (isUserSwitching) {
                            return;
                        }
                        
                        isSyncingFromFirestore = true;
                        localStorage.setItem(userDataKey, JSON.stringify(firestoreAccounts));
                        hasChanges = true;
                    }
                    
                    // Journal 同步邏輯
                    // 【關鍵修正】不檢查 length，直接比較和覆蓋（包括空陣列的情況，例如刪除所有記帳記錄後）
                    if (JSON.stringify(firestoreJournal) !== JSON.stringify(localJournal)) {
                        // 【防護機制】再次檢查使用者是否切換
                        if (isUserSwitching) {
                            return;
                        }
                        
                        isSyncingFromFirestore = true;
                        localStorage.setItem(userJournalKey, JSON.stringify(firestoreJournal));
                        hasChanges = true;
                        
                        // 【關鍵修正】記帳資料更新後，需要重新計算帳戶餘額
                        // 因為記帳記錄會影響帳戶餘額（收入增加、支出減少、轉帳會轉移）
                        // 使用 async/await 確保計算完成後再繼續
                        (async () => {
                            // 【防護機制】檢查是否正在切換使用者
                            if (isUserSwitching) {
                                return;
                            }
                            
                            try {
                                if (window.recalculateAccountBalancesFromJournal) {
                                    // 重新讀取最新的帳戶資料（使用 Firestore 同步的 accounts，如果有的話）
                                    // 優先使用 Firestore 的 accounts，因為它們是未受記帳記錄影響的原始資料
                                    let accountsToUse = firestoreAccounts.length > 0 ? firestoreAccounts : JSON.parse(localStorage.getItem(userDataKey) || '[]');
                                    
                                    if (accountsToUse.length > 0) {
                                        // 再次檢查使用者是否切換
                                        if (isUserSwitching) {
                                            return;
                                        }
                                        
                                        // 重新計算帳戶餘額（這個函式會自動同步到 Firestore）
                                        window.recalculateAccountBalancesFromJournal(userId, firestoreJournal, accountsToUse);
                                        
                                        // 等待一下確保同步完成（但減少等待時間，避免延長同步過程）
                                        await new Promise(resolve => setTimeout(resolve, 100));
                                        
                                        // 重新讀取更新後的帳戶資料，確保後續邏輯使用最新的資料
                                        if (isUserSwitching) {
                                            return;
                                        }
                                        
                                        const recalculatedAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
                                        if (recalculatedAccounts.length > 0) {
                                            // 標記 accounts 也需要更新（觸發 UI 刷新）
                                            hasChanges = true;
                                        }
                                    }
                                }
                            } catch (err) {
                                console.error('[同步更新] 重新計算帳戶餘額時發生錯誤:', err);
                            }
                        })();
                    }
                    
                    // Settings 同步邏輯
                    const mergedSettings = { ...currentSettings, ...firestoreSettings };
                    if (JSON.stringify(mergedSettings) !== JSON.stringify(currentSettings)) {
                        // 【防護機制】再次檢查使用者是否切換
                        if (isUserSwitching) {
                            return;
                        }
                        
                        isSyncingFromFirestore = true;
                        localStorage.setItem(userSettingsKey, JSON.stringify(mergedSettings));
                        hasChanges = true;
                    }
                    
                    // FixedTransfers 同步邏輯
                    // 【關鍵修正】不檢查 length，直接比較和覆蓋（包括空陣列的情況，例如刪除所有固定轉帳後）
                    if (JSON.stringify(firestoreFixedTransfers) !== JSON.stringify(localFixedTransfers)) {
                        // 【防護機制】再次檢查使用者是否切換
                        if (isUserSwitching) {
                            return;
                        }
                        
                        isSyncingFromFirestore = true;
                        localStorage.setItem(userFixedTransfersKey, JSON.stringify(firestoreFixedTransfers));
                        hasChanges = true;
                    }
                    
                    // DateNotes 同步邏輯
                    // 【關鍵修正】不檢查 length，直接比較和覆蓋（包括空物件的情況，例如刪除所有日期記事後）
                    if (JSON.stringify(firestoreDateNotes) !== JSON.stringify(localDateNotes)) {
                        // 【防護機制】再次檢查使用者是否切換
                        if (isUserSwitching) {
                            return;
                        }
                        
                        isSyncingFromFirestore = true;
                        localStorage.setItem(userDateNotesKey, JSON.stringify(firestoreDateNotes));
                        hasChanges = true;
                        
                        // 如果當前正在顯示記帳分頁，更新日曆顯示
                        if (currentUserIdNow === userId && typeof renderCalendar === 'function') {
                            renderCalendar();
                        }
                    }
                    
                    // 如果有變更，且是當前使用者，則刷新介面
                    if (hasChanges && currentUserIdNow === userId) {
                        // 【防護機制】再次檢查使用者是否切換，避免刷新錯誤使用者的介面
                        if (isUserSwitching) {
                            return;
                        }
                        
                        // 檢查是否是記帳記錄更新（需要等待餘額計算完成）
                        const isJournalUpdate = JSON.stringify(firestoreJournal) !== JSON.stringify(localJournal);
                        
                        if (isJournalUpdate) {
                            // 記帳記錄更新：延遲刷新，確保餘額計算和同步完成
                            setTimeout(() => {
                                // 【防護機制】檢查使用者是否在延遲期間切換
                                if (isUserSwitching) {
                                    setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                                    return;
                                }
                                
                                // 確認當前使用者仍然是原本的使用者
                                const currentUserIdCheck = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
                                if (currentUserIdCheck !== currentUserIdNow) {
                                    setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                                    return;
                                }
                                
                                // 重新讀取最新的帳戶資料（因為餘額可能已經被重新計算）
                                const finalAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
                                
                                // 呼叫橋樑函式更新介面
                                if (window.applyCloudUpdate && window.loadUserData) {
                                    const updatedData = window.loadUserData(currentUserIdNow);
                                    if (updatedData) {
                                        window.applyCloudUpdate(updatedData);
                                    }
                                } else if (typeof loadUserData === 'function' && typeof renderAssets === 'function') {
                                    // 備用方案：如果沒有橋樑函式，使用原本的更新邏輯
                                    const userData = loadUserData(currentUserIdNow);
                                    if (userData) {
                                        accounts = userData.accounts;
                                        settings = userData.settings;
                                        
                                        // 同步 UI 狀態
                                        if (settings.pageVisibility) pageVisibility = settings.pageVisibility; 
                                        if (settings.pageOrder) pageOrder = settings.pageOrder; 
                                        if (settings.displayCurrency) currentDisplayCurrency = settings.displayCurrency;
                                        
                                        const ctt = document.getElementById('currencyToggleText');
                                        if (ctt) ctt.textContent = currentDisplayCurrency;
                                        
                                        if (typeof applyTheme === 'function') applyTheme();
                                        
                                        renderAssets();
                                        if (typeof updateChartData === 'function') updateChartData();
                                        if (typeof reorderPageItems === 'function') reorderPageItems(); 
                                        if (typeof renderPageIndicator === 'function') renderPageIndicator(); 
                                        if (typeof renderPageVisibilitySettings === 'function') renderPageVisibilitySettings(); 
                                        
                                        if (typeof renderCalendar === 'function') renderCalendar();
                                        if (typeof showFixedTransferDetailsForDate === 'function' && selectedDate) showFixedTransferDetailsForDate(selectedDate);
                                        if (typeof renderFixedTransferList === 'function') renderFixedTransferList();
                                    }
                                }
                                setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                            }, 300); // 減少等待時間，從 500ms 降到 300ms
                        } else {
                            // 非記帳記錄更新，立即刷新
                            // 呼叫橋樑函式更新介面
                            if (window.applyCloudUpdate && window.loadUserData) {
                                const updatedData = window.loadUserData(currentUserIdNow);
                                if (updatedData) {
                                    window.applyCloudUpdate(updatedData);
                                }
                            } else if (typeof loadUserData === 'function' && typeof renderAssets === 'function') {
                                // 備用方案：如果沒有橋樑函式，使用原本的更新邏輯
                                const userData = loadUserData(currentUserIdNow);
                                if (userData) {
                                    accounts = userData.accounts;
                                    settings = userData.settings;
                                    
                                    // 同步 UI 狀態
                                    if (settings.pageVisibility) pageVisibility = settings.pageVisibility; 
                                    if (settings.pageOrder) pageOrder = settings.pageOrder; 
                                    if (settings.displayCurrency) currentDisplayCurrency = settings.displayCurrency;
                                    
                                    const ctt = document.getElementById('currencyToggleText');
                                    if (ctt) ctt.textContent = currentDisplayCurrency;
                                    
                                    if (typeof applyTheme === 'function') applyTheme();
                                    
                                    renderAssets();
                                    if (typeof updateChartData === 'function') updateChartData();
                                    if (typeof reorderPageItems === 'function') reorderPageItems(); 
                                    if (typeof renderPageIndicator === 'function') renderPageIndicator(); 
                                    if (typeof renderPageVisibilitySettings === 'function') renderPageVisibilitySettings(); 
                                    
                                    if (typeof renderCalendar === 'function') renderCalendar();
                                    if (typeof showFixedTransferDetailsForDate === 'function' && selectedDate) showFixedTransferDetailsForDate(selectedDate);
                                    if (typeof renderFixedTransferList === 'function') renderFixedTransferList();
                                }
                            }
                            setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                        }
                    } else if (hasChanges) {
                        // 其他使用者的資料更新，只更新 localStorage，不刷新 UI
                        setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                    }
                }
            });
        });
        
        // 設定其他監聽器的 Unsubscribe 參照（實際上都是同一個監聽器，因為資料存在同一個文件中）
        // 注意：在 stopFirestoreSync 中只會取消 accountsUnsubscribe，其他變數直接設為 null
        journalUnsubscribe = accountsUnsubscribe;
        settingsUnsubscribe = accountsUnsubscribe;
        fixedTransfersUnsubscribe = accountsUnsubscribe;
        
        // 監聽 Users List (全域，不需鎖定 App User ID)
        const usersRef = doc(db, "users", currentFirebaseUser.uid, "data", "users");
        usersUnsubscribe = onSnapshot(usersRef, (snap) => {
            if (isSyncingFromFirestore) return;
            
            // 【防護機制】如果正在切換使用者，忽略同步更新
            if (isUserSwitching) {
                return;
            }
            
            if (snap.exists()) {
                const firestoreUsers = snap.data().users || [];
                const localUsers = JSON.parse(localStorage.getItem(STORAGE_KEY_USERS) || '[]');
                
                if (JSON.stringify(firestoreUsers) !== JSON.stringify(localUsers)) {
                    isSyncingFromFirestore = true;
                    localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(firestoreUsers));
                    users = firestoreUsers;
                    if (typeof renderUserList === 'function') renderUserList();
                    setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                }
            }
        });
        
        // 監聽 Current User (全域)
        const currentUserRef = doc(db, "users", currentFirebaseUser.uid, "data", "currentUser");
        currentUserUnsubscribe = onSnapshot(currentUserRef, (snap) => {
            if (isSyncingFromFirestore) return;
            
            // 【防護機制】如果正在切換使用者，忽略同步更新（避免衝突）
            if (isUserSwitching) {
                return;
            }
            
            if (snap.exists()) {
                const firestoreCurrentUser = snap.data().currentUserId;
                const localCurrentUser = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
                
                // 只有當雲端有變，且跟本地不同時才切換
                if (firestoreCurrentUser && firestoreCurrentUser !== localCurrentUser) {
                    // 再次檢查是否正在切換（避免競態條件）
                    if (isUserSwitching) {
                        return;
                    }
                    
                    isSyncingFromFirestore = true;
                    localStorage.setItem(STORAGE_KEY_CURRENT_USER, firestoreCurrentUser);
                    if (typeof window !== 'undefined') window.currentUserId = firestoreCurrentUser;
                    
                    // 如果當前使用者不一致，執行切換
                    // 注意：這裡可能會跟 switchUser 衝突，所以要小心
                    const currentUserIdFromStorage = localStorage.getItem('my_assets_current_user');
                    if (typeof switchUser === 'function' && firestoreCurrentUser !== currentUserIdFromStorage) {
                        switchUser(firestoreCurrentUser);
                    }
                    setTimeout(() => { isSyncingFromFirestore = false; }, 100);
                }
            }
        });
        
        console.log('Firestore 同步監聽已啟動');
    }
    
    // 停止 Firestore 同步監聽 (修正版)
    function stopFirestoreSync() {
        // 只需取消主監聽器，避免重複呼叫導致錯誤
        if (accountsUnsubscribe) {
            try {
                accountsUnsubscribe();
            } catch (e) {
                console.error("取消監聽失敗:", e);
            }
            accountsUnsubscribe = null;
        }
        
        // 將其他引用直接設為 null
        journalUnsubscribe = null;
        settingsUnsubscribe = null;
        fixedTransfersUnsubscribe = null;
        
        if (usersUnsubscribe) {
            try { usersUnsubscribe(); } catch(e) {}
            usersUnsubscribe = null;
        }
        if (currentUserUnsubscribe) {
            try { currentUserUnsubscribe(); } catch(e) {}
            currentUserUnsubscribe = null;
        }
        
        firestoreSyncEnabled = false;
        console.log('Firestore 同步監聽已停止');
    }
    
    // 同步 accounts 到 Firestore（使用 currentUserId 區分不同應用內使用者）
    window.syncAccountsToFirestore = async function(accountsData) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId（因為模組作用域無法直接訪問主腳本的全域變數）
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 accounts');
            return;
        }
        
        // 【關鍵修正】防止初始空資料覆蓋有資料的情況，但允許編輯後變成空的情況
        // 如果本地資料是空的，檢查是否為初始狀態（沒有歷史記錄）
        if (accountsData.length === 0) {
            try {
                const STORAGE_KEY_DATA = 'my_assets_stable_data';
                const userDataKey = `${STORAGE_KEY_DATA}_${currentUserIdFromStorage}`;
                const hasLocalHistory = localStorage.getItem(userDataKey) !== null; // 檢查是否有歷史記錄
                
                // 如果沒有本地歷史記錄，且 Firestore 有資料，則不推送（這是初始狀態為空）
                if (!hasLocalHistory) {
                    const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
                    const userDataSnap = await getDoc(userDataRef);
                    if (userDataSnap.exists()) {
                        const firestoreData = userDataSnap.data();
                        const firestoreAccounts = firestoreData.accounts || [];
                        // 如果 Firestore 有資料，且本地沒有歷史記錄，不推送（避免初始空資料覆蓋）
                        if (firestoreAccounts.length > 0) {
                            console.log(`[同步保護] 本地 accounts 為空且無歷史記錄，但 Firestore 已有 ${firestoreAccounts.length} 筆資料，跳過推送以避免覆蓋`);
                            return;
                        }
                    }
                }
                // 如果有本地歷史記錄，即使現在是空的，也推送（這是編輯後變成空，是用戶的明確操作）
            } catch (err) {
                console.error('[同步保護] 檢查 Firestore 資料時發生錯誤:', err);
                // 如果檢查失敗，繼續推送（避免阻塞正常流程）
            }
        }
        
        // 注意：這裡不檢查 isSyncingFromFirestore，因為這是本地操作觸發的同步
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                accounts: accountsData,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`accounts 已同步到 Firestore (使用者: ${currentUserIdFromStorage}, ${accountsData.length} 筆)`);
        } catch (err) {
            console.error('同步 accounts 到 Firestore 失敗:', err);
        }
    };
    
    // 同步 journal 到 Firestore（使用 currentUserId 區分不同應用內使用者）
    window.syncJournalToFirestore = async function(records) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 journal');
            return;
        }
        
        // 【關鍵修正】防止初始空資料覆蓋有資料的情況，但允許編輯後變成空的情況
        // 如果本地資料是空的，檢查是否為初始狀態（沒有歷史記錄）
        if (records.length === 0) {
            try {
                const STORAGE_KEY_JOURNAL = 'my_assets_journal';
                const userJournalKey = `${STORAGE_KEY_JOURNAL}_${currentUserIdFromStorage}`;
                const hasLocalHistory = localStorage.getItem(userJournalKey) !== null; // 檢查是否有歷史記錄
                
                // 如果沒有本地歷史記錄，且 Firestore 有資料，則不推送（這是初始狀態為空）
                if (!hasLocalHistory) {
                    const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
                    const userDataSnap = await getDoc(userDataRef);
                    if (userDataSnap.exists()) {
                        const firestoreData = userDataSnap.data();
                        const firestoreJournal = firestoreData.journal || [];
                        // 如果 Firestore 有資料，且本地沒有歷史記錄，不推送（避免初始空資料覆蓋）
                        if (firestoreJournal.length > 0) {
                            console.log(`[同步保護] 本地 journal 為空且無歷史記錄，但 Firestore 已有 ${firestoreJournal.length} 筆資料，跳過推送以避免覆蓋`);
                            return;
                        }
                    }
                }
                // 如果有本地歷史記錄，即使現在是空的，也推送（這是編輯後變成空，是用戶的明確操作）
            } catch (err) {
                console.error('[同步保護] 檢查 Firestore 資料時發生錯誤:', err);
                // 如果檢查失敗，繼續推送（避免阻塞正常流程）
            }
        }
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                journal: records,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`journal 已同步到 Firestore (使用者: ${currentUserIdFromStorage}, ${records.length} 筆)`);
        } catch (err) {
            console.error('同步 journal 到 Firestore 失敗:', err);
        }
    };
    
    // 同步 settings 到 Firestore（使用 currentUserId 區分不同應用內使用者）
    window.syncSettingsToFirestore = async function(settingsData) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 settings');
            return;
        }
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                settings: settingsData,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`settings 已同步到 Firestore (使用者: ${currentUserIdFromStorage})`);
        } catch (err) {
            console.error('同步 settings 到 Firestore 失敗:', err);
        }
    };
    
    // 同步 fixedTransfers 到 Firestore（使用 currentUserId 區分不同應用內使用者）
    window.syncFixedTransfersToFirestore = async function(transfers) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 fixedTransfers');
            return;
        }
        
        // 【關鍵修正】防止初始空資料覆蓋有資料的情況，但允許編輯後變成空的情況
        // 如果本地資料是空的，檢查是否為初始狀態（沒有歷史記錄）
        if (transfers.length === 0) {
            try {
                const STORAGE_KEY_FIXED_TRANSFERS = 'my_assets_fixed_transfers';
                const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${currentUserIdFromStorage}`;
                const hasLocalHistory = localStorage.getItem(userFixedTransfersKey) !== null; // 檢查是否有歷史記錄
                
                // 如果沒有本地歷史記錄，且 Firestore 有資料，則不推送（這是初始狀態為空）
                if (!hasLocalHistory) {
                    const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
                    const userDataSnap = await getDoc(userDataRef);
                    if (userDataSnap.exists()) {
                        const firestoreData = userDataSnap.data();
                        const firestoreFixedTransfers = firestoreData.fixedTransfers || [];
                        // 如果 Firestore 有資料，且本地沒有歷史記錄，不推送（避免初始空資料覆蓋）
                        if (firestoreFixedTransfers.length > 0) {
                            console.log(`[同步保護] 本地 fixedTransfers 為空且無歷史記錄，但 Firestore 已有 ${firestoreFixedTransfers.length} 筆資料，跳過推送以避免覆蓋`);
                            return;
                        }
                    }
                }
                // 如果有本地歷史記錄，即使現在是空的，也推送（這是編輯後變成空，是用戶的明確操作）
            } catch (err) {
                console.error('[同步保護] 檢查 Firestore 資料時發生錯誤:', err);
                // 如果檢查失敗，繼續推送（避免阻塞正常流程）
            }
        }
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                fixedTransfers: transfers,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`fixedTransfers 已同步到 Firestore (使用者: ${currentUserIdFromStorage}, ${transfers.length} 筆)`);
        } catch (err) {
            console.error('同步 fixedTransfers 到 Firestore 失敗:', err);
        }
    };
    
    // 同步日期記事到 Firestore
    window.syncDateNotesToFirestore = async function(dateNotes) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 dateNotes');
            return;
        }
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                dateNotes: dateNotes,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`dateNotes 已同步到 Firestore (使用者: ${currentUserIdFromStorage})`);
        } catch (err) {
            console.error('同步 dateNotes 到 Firestore 失敗:', err);
        }
    };
    
    // 一起同步 journal 和 accounts 到 Firestore（記帳後使用）
    window.syncJournalAndAccountsToFirestore = async function(journalRecords, accountsData) {
        if (!currentFirebaseUser) return;
        
        // 從 localStorage 讀取 currentUserId
        const STORAGE_KEY_CURRENT_USER = 'my_assets_current_user';
        const currentUserIdFromStorage = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
        if (!currentUserIdFromStorage) {
            console.warn('[同步] 沒有 currentUserId，無法同步 journal 和 accounts');
            return;
        }
        
        // 【關鍵修正】驗證傳入的 accountsData 是否屬於當前使用者
        // 從 localStorage 讀取當前使用者的 accounts 進行比對
        const STORAGE_KEY_DATA = 'my_assets_stable_data';
        const userDataKey = `${STORAGE_KEY_DATA}_${currentUserIdFromStorage}`;
        const currentUserAccountsFromStorage = JSON.parse(localStorage.getItem(userDataKey) || '[]');
        
        // 確保同步的是當前使用者的資料（檢查 accounts 數量是否一致）
        if (accountsData.length !== currentUserAccountsFromStorage.length) {
            console.warn(`[記帳同步] 警告：傳入的 accounts 數量 (${accountsData.length}) 與 localStorage 中的數量 (${currentUserAccountsFromStorage.length}) 不一致，使用 localStorage 中的資料`);
            accountsData = currentUserAccountsFromStorage;
        }
        
        // 【關鍵修正】防止初始空資料覆蓋有資料的情況，但允許編輯後變成空的情況
        // 如果本地資料是空的，檢查是否為初始狀態（沒有歷史記錄）
        if (accountsData.length === 0 && journalRecords.length === 0) {
            try {
                const STORAGE_KEY_DATA = 'my_assets_stable_data';
                const STORAGE_KEY_JOURNAL = 'my_assets_journal';
                const userDataKey = `${STORAGE_KEY_DATA}_${currentUserIdFromStorage}`;
                const userJournalKey = `${STORAGE_KEY_JOURNAL}_${currentUserIdFromStorage}`;
                const hasAccountsHistory = localStorage.getItem(userDataKey) !== null;
                const hasJournalHistory = localStorage.getItem(userJournalKey) !== null;
                const hasLocalHistory = hasAccountsHistory || hasJournalHistory; // 任一有歷史記錄即可
                
                // 如果沒有本地歷史記錄，且 Firestore 有資料，則不推送（這是初始狀態為空）
                if (!hasLocalHistory) {
                    const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
                    const userDataSnap = await getDoc(userDataRef);
                    if (userDataSnap.exists()) {
                        const firestoreData = userDataSnap.data();
                        const firestoreAccounts = firestoreData.accounts || [];
                        const firestoreJournal = firestoreData.journal || [];
                        // 如果 Firestore 有資料，且本地沒有歷史記錄，不推送（避免初始空資料覆蓋）
                        if (firestoreAccounts.length > 0 || firestoreJournal.length > 0) {
                            console.log(`[同步保護] 本地 accounts 和 journal 為空且無歷史記錄，但 Firestore 已有資料 (accounts: ${firestoreAccounts.length}, journal: ${firestoreJournal.length})，跳過推送以避免覆蓋`);
                            return;
                        }
                    }
                }
                // 如果有本地歷史記錄，即使現在是空的，也推送（這是編輯後變成空，是用戶的明確操作）
            } catch (err) {
                console.error('[同步保護] 檢查 Firestore 資料時發生錯誤:', err);
                // 如果檢查失敗，繼續推送（避免阻塞正常流程）
            }
        }
        
        try {
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", currentUserIdFromStorage);
            await setDoc(userDataRef, {
                journal: journalRecords,
                accounts: accountsData,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log(`[記帳同步] journal 和 accounts 已一起同步到 Firestore (使用者: ${currentUserIdFromStorage}, journal: ${journalRecords.length} 筆, accounts: ${accountsData.length} 筆)`);
        } catch (err) {
            console.error('[記帳同步] 同步 journal 和 accounts 到 Firestore 失敗:', err);
        }
    };
    
    // 同步所有資料到 Firestore（用於匯入資料後）
    window.syncAllDataToFirestore = async function() {
        if (!currentFirebaseUser) {
            console.log('未登入 Firebase，跳過同步');
            return;
        }
        
        // 如果沒有 currentUserId，嘗試從 localStorage 獲取
        let targetUserId = currentUserId;
        if (!targetUserId) {
            const users = JSON.parse(localStorage.getItem('my_assets_users') || '[]');
            if (users.length > 0) {
                targetUserId = users[0].id;
            } else {
                console.error('無法確定要同步的使用者 ID');
                return;
            }
        }
        
        try {
            const STORAGE_KEY_DATA = 'my_assets_stable_data';
            const STORAGE_KEY_JOURNAL = 'my_assets_journal';
            const STORAGE_KEY_SETTINGS = 'my_assets_stable_settings';
            const STORAGE_KEY_FIXED_TRANSFERS = 'my_assets_fixed_transfers';
            
            const userDataKey = `${STORAGE_KEY_DATA}_${targetUserId}`;
            const userJournalKey = `${STORAGE_KEY_JOURNAL}_${targetUserId}`;
            const userSettingsKey = `${STORAGE_KEY_SETTINGS}_${targetUserId}`;
            const userFixedTransfersKey = `${STORAGE_KEY_FIXED_TRANSFERS}_${targetUserId}`;
            
            const accounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
            const journal = JSON.parse(localStorage.getItem(userJournalKey) || '[]');
            const settings = JSON.parse(localStorage.getItem(userSettingsKey) || '{}');
            const fixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey) || '[]');
            
            // 【關鍵修正】匯入資料時，如果本地有資料，直接推送（不檢查 Firestore）
            // 因為這是匯入操作，應該以本地匯入的資料為主
            // 但如果本地完全為空，則檢查 Firestore 是否有資料
            const hasLocalData = accounts.length > 0 || journal.length > 0 || fixedTransfers.length > 0 || Object.keys(settings).length > 0;
            
            if (!hasLocalData) {
                // 本地完全為空，檢查 Firestore 是否有資料
                const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", targetUserId);
                const userDataSnap = await getDoc(userDataRef);
                if (userDataSnap.exists()) {
                    const firestoreData = userDataSnap.data();
                    const firestoreAccounts = firestoreData.accounts || [];
                    const firestoreJournal = firestoreData.journal || [];
                    const firestoreFixedTransfers = firestoreData.fixedTransfers || [];
                    // 如果 Firestore 有資料，且本地是空的，不推送（避免覆蓋）
                    if (firestoreAccounts.length > 0 || firestoreJournal.length > 0 || firestoreFixedTransfers.length > 0) {
                        console.log(`[同步保護] 本地資料為空，但 Firestore 已有資料，跳過推送以避免覆蓋`);
                        return;
                    }
                }
            }
            
            // 讀取日期記事
            const STORAGE_KEY_DATE_NOTES = 'my_assets_date_notes';
            const userDateNotesKey = `${STORAGE_KEY_DATE_NOTES}_${targetUserId}`;
            const dateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
            
            // 一次性同步所有資料
            const userDataRef = doc(db, "users", currentFirebaseUser.uid, "appUsers", targetUserId);
            await setDoc(userDataRef, {
                accounts: accounts,
                journal: journal,
                settings: settings,
                fixedTransfers: fixedTransfers,
                dateNotes: dateNotes,
                updatedAt: Timestamp.now()
            }, { merge: true });
            
            console.log(`使用者 ${targetUserId} 的所有資料已同步到 Firestore`);
        } catch (err) {
            console.error('同步所有資料到 Firestore 失敗:', err);
            throw err;
        }
    };
    
    // 同步 users 到 Firestore
    window.syncUsersToFirestore = async function(usersData) {
        if (!currentFirebaseUser) return;
        
        try {
            const usersRef = doc(db, "users", currentFirebaseUser.uid, "data", "users");
            await setDoc(usersRef, {
                users: usersData,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log('users 已同步到 Firestore');
        } catch (err) {
            console.error('同步 users 到 Firestore 失敗:', err);
        }
    };
    
    // 同步 currentUser 到 Firestore
    window.syncCurrentUserToFirestore = async function(currentUserId) {
        if (!currentFirebaseUser) return;
        
        try {
            const currentUserRef = doc(db, "users", currentFirebaseUser.uid, "data", "currentUser");
            await setDoc(currentUserRef, {
                currentUserId: currentUserId,
                updatedAt: Timestamp.now()
            }, { merge: true });
            console.log('currentUser 已同步到 Firestore');
        } catch (err) {
            console.error('同步 currentUser 到 Firestore 失敗:', err);
        }
    };

    // 備份功能
    window.firebasePerformBackup = async function(jsonStr, isAuto = false) {
        if (!currentFirebaseUser) {
            throw new Error('請先登入 Firebase');
        }

        try {
            // 如果沒有傳入 jsonStr，從 localStorage 生成
            if (!jsonStr) {
                const allUsersData = {};
                const users = JSON.parse(localStorage.getItem('my_assets_users') || '[]');
                users.forEach(user => {
                    const userDataKey = `my_assets_stable_data_${user.id}`;
                    const userSettingsKey = `my_assets_stable_settings_${user.id}`;
                    const userJournalKey = `my_assets_journal_${user.id}`;
                    const userFixedTransfersKey = `my_assets_fixed_transfers_${user.id}`;
                    const userDateNotesKey = `my_assets_date_notes_${user.id}`;
                    const userAccounts = JSON.parse(localStorage.getItem(userDataKey) || '[]');
                    const userSettings = JSON.parse(localStorage.getItem(userSettingsKey) || '{}');
                    const userJournal = JSON.parse(localStorage.getItem(userJournalKey) || '[]');
                    const userFixedTransfers = JSON.parse(localStorage.getItem(userFixedTransfersKey) || '[]');
                    const userDateNotes = JSON.parse(localStorage.getItem(userDateNotesKey) || '{}');
                    allUsersData[user.id] = {
                        user: user,
                        data: userAccounts,
                        settings: userSettings,
                        journal: userJournal,
                        fixedTransfers: userFixedTransfers,
                        dateNotes: userDateNotes
                    };
                });

                const backupData = {
                    version: '2.0',
                    users: users,
                    usersData: allUsersData,
                    exportDate: new Date().toISOString()
                };

                jsonStr = JSON.stringify(backupData);
            }

            if (!jsonStr || jsonStr.length === 0) {
                if (isAuto) return;
                throw new Error('沒有資料可備份');
            }

            // 準備寫入 backups 集合
            const backupsRef = collection(db, "users", currentFirebaseUser.uid, "backups");
            const newBackupData = {
                backupTime: Timestamp.now(),
                jsonData: jsonStr
            };

            // 檢查數量限制 (Rolling Logic)
            const q = query(backupsRef, orderBy("backupTime", "asc"));
            const backupSnapshot = await getDocs(q);

            const MAX_BACKUPS = 10;
            if (backupSnapshot.size >= MAX_BACKUPS) {
                const deleteCount = backupSnapshot.size - MAX_BACKUPS + 1;
                for (let i = 0; i < deleteCount; i++) {
                    const docToDelete = backupSnapshot.docs[i];
                    await deleteDoc(docToDelete.ref);
                }
            }

            // 寫入新備份
            await addDoc(backupsRef, newBackupData);
            console.log("Firebase 備份完成");
            // 不在此處顯示 alert，由調用者統一處理
        } catch (error) {
            console.error("Firebase 備份失敗", error);
            // 不在此處顯示 alert，由調用者統一處理
            throw error;
        }
    };

    // 列出備份
    window.firebaseListBackups = async function() {
        if (!currentFirebaseUser) {
            alert('請先登入 Firebase');
            return;
        }

        try {
            const backupsRef = collection(db, "users", currentFirebaseUser.uid, "backups");
            const q = query(backupsRef, orderBy("backupTime", "desc"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                alert('尚未有備份文件');
                return;
            }

            const backups = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                backups.push({
                    id: docSnap.id,
                    name: `備份 ${new Date(data.backupTime.toDate()).toLocaleString('zh-TW')}`,
                    createdTime: data.backupTime.toDate().toISOString(),
                    backupTime: data.backupTime
                });
            });

            // 顯示備份列表
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '3001';
            modal.innerHTML = `
                <div class="modal-content-wrapper" style="max-width: 500px; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px;">備份列表</div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${backups.map((backup, index) => `
                            <div style="padding: 12px; margin-bottom: 8px; background: var(--card-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">備份 #${index + 1}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                        ${new Date(backup.createdTime).toLocaleString('zh-TW')}
                                    </div>
                                </div>
                                <button onclick="window.firebaseRestoreBackup('${backup.id}')" style="padding: 8px 16px; background: var(--color-up); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    還原
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: var(--border-color); color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">關閉</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
            modal.style.display = 'block';
        } catch (err) {
            alert('獲取備份列表失敗：' + err.message);
        }
    };

    // 還原備份
    window.firebaseRestoreBackup = async function(backupId) {
        if (!currentFirebaseUser) {
            alert('請先登入 Firebase');
            return;
        }

        if (!confirm('確定要還原此備份嗎？這將覆蓋現有的所有資料。')) return;

        try {
            const targetBackupRef = doc(db, "users", currentFirebaseUser.uid, "backups", backupId);
            const snap = await getDoc(targetBackupRef);

            if (!snap.exists()) {
                alert("備份檔不存在");
                return;
            }

            const jsonStr = snap.data().jsonData;
            const data = JSON.parse(jsonStr);

            // 使用現有的匯入邏輯
            if (data.version === '2.0' && data.users && data.usersData) {
                localStorage.setItem('my_assets_users', JSON.stringify(data.users));
                Object.keys(data.usersData).forEach(userId => {
                    const userData = data.usersData[userId];
                    localStorage.setItem(`my_assets_stable_data_${userId}`, JSON.stringify(userData.data || []));
                    localStorage.setItem(`my_assets_stable_settings_${userId}`, JSON.stringify(userData.settings || {}));
                    if (userData.journal !== undefined) {
                        localStorage.setItem(`my_assets_journal_${userId}`, JSON.stringify(userData.journal || []));
                    }
                    if (userData.fixedTransfers !== undefined) {
                        localStorage.setItem(`my_assets_fixed_transfers_${userId}`, JSON.stringify(userData.fixedTransfers || []));
                    }
                    if (userData.dateNotes !== undefined) {
                        localStorage.setItem(`my_assets_date_notes_${userId}`, JSON.stringify(userData.dateNotes || {}));
                    }
                });
                alert('還原成功！頁面將重新載入。');
                setTimeout(() => location.reload(), 500);
            } else {
                alert('備份文件格式錯誤');
            }
        } catch (err) {
            alert('還原失敗：' + err.message);
        }
    };

    // 自動檢查與備份
    window.firebaseCheckAndAutoBackup = async function() {
        if (!currentFirebaseUser) return;

        const backupsRef = collection(db, "users", currentFirebaseUser.uid, "backups");
        const q = query(backupsRef, orderBy("backupTime", "desc"), limit(1));
        const snapshot = await getDocs(q);

        let shouldBackup = false;
        if (snapshot.empty) {
            shouldBackup = true;
        } else {
            const lastTime = snapshot.docs[0].data().backupTime.toDate();
            const now = new Date();
            const diffHours = (now - lastTime) / (1000 * 60 * 60);

            if (diffHours >= 1) {
                shouldBackup = true;
            }
        }

        if (shouldBackup) {
            try {
                await window.firebasePerformBackup(null, true);
            } catch (e) {
                console.error('自動備份失敗:', e);
            }
        }
    };

    // 定時器：每分鐘檢查一次是否該備份了
    setInterval(() => {
        if (window.firebaseUserLoggedIn) {
            window.firebaseCheckAndAutoBackup();
        }
    }, 60 * 1000);
    
    // ========== 計算機功能（記帳用，統一使用錢包的計算機）==========
    // 記帳的計算機直接使用錢包的計算機函數（openCalculator 和 closeCalculator）
    window.openCalculatorModal = function(targetInputId) {
        // 使用錢包的計算機
        if (typeof openCalculator === 'function') {
            openCalculator(targetInputId);
        } else {
            console.error('openCalculator function not found');
        }
    };

    function openCalculatorModal(targetInputId) {
        // 使用錢包的計算機
        openCalculator(targetInputId);
    }
    
    function closeCalculatorModal() {
        // 使用錢包的計算機關閉函數
        closeCalculator();
    }
    
    function confirmCalculator() {
        // 使用錢包的計算機確認函數
        closeCalculator();
    }
    
    function calculatorInput(input) {
        // 使用錢包的計算機輸入函數
        calcInput(input);
    }
    
    function updateCalculatorDisplay() {
        // 使用錢包的計算機顯示更新函數
        updateCalcDisplay();
    }
    
    // ========== 修改記帳金額輸入為計算機 ==========
    // 在收入、支出、轉帳的金額輸入欄位加入點擊事件
    document.addEventListener('DOMContentLoaded', function() {
        // 為金額輸入欄位加入點擊事件（使用事件委派）
        setTimeout(() => {
            const incomeAmount = document.getElementById('incomeAmount');
            const expenseAmount = document.getElementById('expenseAmount');
            const transferAmount = document.getElementById('transferAmount');
            
            // 金額輸入欄位現在使用按鈕打開計算機，不需要 focus 事件監聽器
        }, 100);
    });
    
    // ========== 修改右上+號為四個分頁 ==========
    // 注意：openNewExpenseFromCalendar 和 openJournalTypeSelector 已在前面定義
</script>
</body>
</html>


